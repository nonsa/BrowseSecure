/**
 * MASKME Copyright (c) 2008-2013 by Abine, Inc. All Rights Reserved.
 *
 * This software is the confidential and proprietary information
 * of Abine, Inc. ("Confidential Information"), subject
 * to the Non-Disclosure Agreement and/or License Agreement you entered
 * into with Abine. You shall use such Confidential Information only
 * in accordance with the terms of said Agreement(s). Abine makes
 * no representations or warranties about the suitability of the
 * software. The software is provided with ABSOLUTELY NO WARRANTY
 * and Abine will NOT BE LIABLE for ANY DAMAGES resulting from
 * the use of the software.
 *
 * Contact license@getabine.com with any license-related questions.
 *
 * https://www.abine.com
 * @license
 *
 */
/*Copyright (c) 2009 pidder <www.pidder.com>*/
function pidCrypt(){function e(e){e||(e=8);for(var t=new Array(e),n=[],i=0;256>i;i++)n[i]=i;for(i=0;t.length>i;i++)t[i]=n[Math.floor(Math.random()*n.length)];return t}this.setDefaults=function(){this.params.nBits=256,this.params.salt=e(8),this.params.salt=pidCryptUtil.byteArray2String(this.params.salt),this.params.salt=pidCryptUtil.convertToHex(this.params.salt),this.params.blockSize=16,this.params.UTF8=!0,this.params.A0_PAD=!0},this.debug=!0,this.params={},this.params.dataIn="",this.params.dataOut="",this.params.decryptIn="",this.params.decryptOut="",this.params.encryptIn="",this.params.encryptOut="",this.params.key="",this.params.iv="",this.params.clear=!0,this.setDefaults(),this.errors="",this.warnings="",this.infos="",this.debugMsg="",this.setParams=function(e){e||(e={});for(var t in e)this.params[t]=e[t]},this.getParams=function(){return this.params},this.getParam=function(e){return this.params[e]||""},this.clearParams=function(){this.params={}},this.getNBits=function(){return this.params.nBits},this.getOutput=function(){return this.params.dataOut},this.setError=function(e){this.error=e},this.appendError=function(e){return this.errors+=e,""},this.getErrors=function(){return this.errors},this.isError=function(){return this.errors.length>0?!0:!1},this.appendInfo=function(e){return this.infos+=e,""},this.getInfos=function(){return this.infos},this.setDebug=function(e){this.debug=e},this.appendDebug=function(e){return this.debugMsg+=e,""},this.isDebug=function(){return this.debug},this.getAllMessages=function(e){var t={lf:"\n",clr_mes:!1,verbose:15};e||(e=t);for(var n in t)"undefined"==typeof e[n]&&(e[n]=t[n]);var i="",r="";for(var a in this.params){switch(a){case"encryptOut":r=pidCryptUtil.toByteArray(this.params[a].toString()),r=pidCryptUtil.fragment(r.join(),64,e.lf);break;case"key":case"iv":r=pidCryptUtil.formatHex(this.params[a],48);break;default:r=pidCryptUtil.fragment(this.params[a].toString(),64,e.lf)}i+="<p><b>"+a+"</b>:<pre>"+r+"</pre></p>"}return this.debug&&(i+="debug: "+this.debug+e.lf),this.errors.length>0&&1==(1&e.verbose)&&(i+="Errors:"+e.lf+this.errors+e.lf),this.warnings.length>0&&2==(2&e.verbose)&&(i+="Warnings:"+e.lf+this.warnings+e.lf),this.infos.length>0&&4==(4&e.verbose)&&(i+="Infos:"+e.lf+this.infos+e.lf),this.debug&&8==(8&e.verbose)&&(i+="Debug messages:"+e.lf+this.debugMsg+e.lf),e.clr_mes&&(this.errors=this.infos=this.warnings=this.debug=""),i},this.getRandomBytes=function(t){return e(t)}}var ABINEMASKME=ABINEMASKME||{};ABINEMASKME.startTime=Date.now(),window.ABINEMASKME=window.ABINEMASKME||ABINEMASKME,define.unordered=!0,ABINEMASKME.require=require,ABINEMASKME.define=define,ABINEMASKME.define("jquery",["abine/timer"],function(e){function t(e,t,n,i,r){var a="@mozilla.org/parserutils;1";if(a in Components.classes){var o=Components.classes[a].getService(Components.interfaces.nsIParserUtils);if("parseFragment"in o)return o.parseFragment(t,n?o.SanitizerAllowStyle:0,!!r,i,e.documentElement)}return Components.classes["@mozilla.org/feed-unescapehtml;1"].getService(Components.interfaces.nsIScriptableUnescapeHTML).parseFragment(t,!!r,i,e.documentElement)}function n(n){if(!n.abineMaskmejQuery){var i={window:n,document:n.document,navigator:n.navigator,location:n.location,setTimeout:e.setTimeout,clearTimeout:e.clearTimeout,setInterval:e.setInterval,clearInterval:e.clearInterval},r=Components.classes["@mozilla.org/moz/jssubscript-loader;1"].getService(Components.interfaces.mozIJSSubScriptLoader);r.loadSubScript("resource://idme/content/vendor/jquery-min.js",i),n.abineMaskmejQuery=n.jQuery.noConflict(!0);var a=n.abineMaskmejQuery.prototype.html;n.abineMaskmejQuery.prototype.html=function(){if(arguments.length>0&&"string"==typeof arguments[0]){var e=t(n.document,arguments[0],!0);arguments[0]=e}return a.apply(this,arguments)}}return n.abineMaskmejQuery}function i(e,t){try{var i=null;if(e&&e.jquery)return e;if(t&&t.jquery)return t.find(e);if(t&&(i=(t.ownerDocument||t).defaultView||t),!i&&e&&"string"!=typeof e&&(i=(e.ownerDocument||e).defaultView||e),i&&!i.abineMaskmejQuery&&(i=i.top),i)return i.abineMaskmejQuery||n(i),i.abineMaskmejQuery.apply(i,arguments);to.get=stack.trace}catch(r){if("string"==typeof e){var a="Please use a node/document as context to use jQuery from that window sandbox";throw true&&ABINEMASKME.log.error(a+"\n"+e+"\n"+r.stack),a}throw"Could not get window object from parameters to stub. Node disconnected from DOM?"}}return"undefined"==typeof $?i:$}),ABINEMASKME.define("abine/config",[],function(){var e=ABINEMASKME.config={version:"1.40.367",buildNum:"367.d32f9099fa98a9fe3e4057cc977de37bd3fa1565",appName:"MaskMe",environment:"production",tags:["chromestore"],crypt:!0,silent:!1,payments:!0,browser:"Chrome",serverHost:"mm.abine.com",webHost:"www.abine.com",webappHost:"https://dnt.abine.com",mappingServerHost:"mapping.abine.com",phoneServerHost:"phone.abine.com",licenseServerHost:"license.abine.com",emailServerHost:"emails.abine.com",disposableDomain:"opayq.com",paymentsServerHost:"payments.abine.com",logLevel:"ERROR",pfVersion:".790 Chrome development",mmVersion:"0.0.1 development",features:"export"};return e.protocol="production"===ABINEMASKME.config.environment?"https://":"http://",document.documentElement.hasAttribute("abine_webapp")&&(document.documentElement.setAttribute("maskme",e.mmVersion),document.documentElement.setAttribute("maskme-features",e.features)),e}),ABINEMASKME.require("abine/config"),ABINEMASKME.define("abine/timer",[],function(){var e=function(e,t){var n=Components.classes["@mozilla.org/timer;1"].createInstance(Components.interfaces.nsITimer),i={notify:function(){e(),n.cancel()}};return n.initWithCallback(i,t,Components.interfaces.nsITimer.TYPE_ONE_SHOT),n},t=function(e){try{e.cancel()}catch(t){}},n=function(e,t){var n=Components.classes["@mozilla.org/timer;1"].createInstance(Components.interfaces.nsITimer),i={notify:function(){e()}};return n.initWithCallback(i,t,Components.interfaces.nsITimer.TYPE_REPEATING_SLACK),n},i=function(e){try{e.cancel()}catch(t){}},r={};return r.setTimeout="undefined"!=typeof window&&"function"==typeof window.setTimeout?function(){return ABINEMASKME.log,window.setTimeout.apply(window,arguments)}:e,r.clearTimeout="undefined"!=typeof window&&"function"==typeof window.clearTimeout?function(){window.clearTimeout.apply(window,arguments)}:t,r.setInterval="undefined"!=typeof window&&"function"==typeof window.setInterval?function(){return window.setInterval.apply(window,arguments)}:n,r.clearInterval="undefined"!=typeof window&&"function"==typeof window.clearInterval?function(){window.clearInterval.apply(window,arguments)}:i,r}),ABINEMASKME.define(["documentcloud/underscore"],function(){return _}),ABINEMASKME.define("documentcloud/underscore/async",["documentcloud/underscore","abine/timer"],function(e,t){var n=t.setTimeout,i={},r=e,a=e.async;r.async=i,i.noConflict=function(){return r.async=a,i};var o=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;e.length>n;n+=1)t(e[n],n,e)},s=function(e,t){if(e.map)return e.map(t);var n=[];return o(e,function(e,i,r){n.push(t(e,i,r))}),n},c=function(e,t,n){return e.reduce?e.reduce(t,n):(o(e,function(e,i,r){n=t(n,e,i,r)}),n)},u=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};i.nextTick="undefined"!=typeof process&&process.nextTick?process.nextTick:function(e){n(e,0)},i.forEach=function(e,t,n){if(n=n||function(){},!e.length)return n();var i=0;o(e,function(r){t(r,function(t){t?(n(t),n=function(){}):(i+=1,i===e.length&&n(null))})})},i.forEachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var i=0,r=function(){t(e[i],function(t){t?(n(t),n=function(){}):(i+=1,i===e.length?n(null):r())})};r()},i.forEachLimit=function(e,t,n,i){if(i=i||function(){},!e.length||0>=t)return i();var r=0,a=0,o=0;(function s(){if(r===e.length)return i();for(;t>o&&e.length>a;)a+=1,o+=1,n(e[a-1],function(t){t?(i(t),i=function(){}):(r+=1,o-=1,r===e.length?i():s())})})()};var d=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[i.forEach].concat(t))}},l=function(e){return function(){var t=Array.prototype.slice.call(arguments);return e.apply(null,[i.forEachSeries].concat(t))}},h=function(e,t,n,i){var r=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,i){r[e.index]=i,t(n)})},function(e){i(e,r)})};i.map=d(h),i.mapSeries=l(h),i.reduce=function(e,t,n,r){i.forEachSeries(e,function(e,i){n(t,e,function(e,n){t=n,i(e)})},function(e){r(e,t)})},i.inject=i.reduce,i.foldl=i.reduce,i.reduceRight=function(e,t,n,r){var a=s(e,function(e){return e}).reverse();i.reduce(a,t,n,r)},i.foldr=i.reduceRight;var f=function(e,t,n,i){var r=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&r.push(e),t()})},function(){i(s(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};i.filter=d(f),i.filterSeries=l(f),i.select=i.filter,i.selectSeries=i.filterSeries;var p=function(e,t,n,i){var r=[];t=s(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||r.push(e),t()})},function(){i(s(r.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};i.reject=d(p),i.rejectSeries=l(p);var m=function(e,t,n,i){e(t,function(e,t){n(e,function(n){n?(i(e),i=function(){}):t()})},function(){i()})};i.detect=d(m),i.detectSeries=l(m),i.some=function(e,t,n){i.forEach(e,function(e,i){t(e,function(e){e&&(n(!0),n=function(){}),i()})},function(){n(!1)})},i.any=i.some,i.every=function(e,t,n){i.forEach(e,function(e,i){t(e,function(e){e||(n(!1),n=function(){}),i()})},function(){n(!0)})},i.all=i.every,i.sortBy=function(e,t,n){i.map(e,function(e,n){t(e,function(t,i){t?n(t):n(null,{value:e,criteria:i})})},function(e,t){if(e)return n(e);var i=function(e,t){var n=e.criteria,i=t.criteria;return i>n?-1:n>i?1:0};n(null,s(t.sort(i),function(e){return e.value}))})},i.auto=function(e,t){t=t||function(){};var n=u(e);if(!n.length)return t(null);var i={},r=[],a=function(e){r.unshift(e)},s=function(e){for(var t=0;r.length>t;t+=1)if(r[t]===e)return r.splice(t,1),void 0},d=function(){o(r.slice(0),function(e){e()})};a(function(){u(i).length===n.length&&(t(null,i),t=function(){})}),o(n,function(n){var r=e[n]instanceof Function?[e[n]]:e[n],o=function(e){if(e)t(e),t=function(){};else{var r=Array.prototype.slice.call(arguments,1);1>=r.length&&(r=r[0]),i[n]=r,d()}},u=r.slice(0,Math.abs(r.length-1))||[],l=function(){return c(u,function(e,t){return e&&i.hasOwnProperty(t)},!0)&&!i.hasOwnProperty(n)};if(l())r[r.length-1](o,i);else{var h=function(){l()&&(s(h),r[r.length-1](o,i))};a(h)}})},i.waterfall=function(e,t){if(t=t||function(){},!e.length)return t();var n=function(e){return function(r){if(r)t(r),t=function(){};else{var a=Array.prototype.slice.call(arguments,1),o=e.next();o?a.push(n(o)):a.push(t),i.nextTick(function(){e.apply(null,a)})}}};n(i.iterator(e))()},i.parallel=function(e,t){if(t=t||function(){},e.constructor===Array)i.map(e,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};i.forEach(u(e),function(t,i){e[t](function(e){var r=Array.prototype.slice.call(arguments,1);1>=r.length&&(r=r[0]),n[t]=r,i(e)})},function(e){t(e,n)})}},i.series=function(e,t){if(t=t||function(){},e.constructor===Array)i.mapSeries(e,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);1>=n.length&&(n=n[0]),t.call(null,e,n)})},t);else{var n={};i.forEachSeries(u(e),function(t,i){e[t](function(e){var r=Array.prototype.slice.call(arguments,1);1>=r.length&&(r=r[0]),n[t]=r,i(e)})},function(e){t(e,n)})}},i.iterator=function(e){var t=function(n){var i=function(){return e.length&&e[n].apply(null,arguments),i.next()};return i.next=function(){return e.length-1>n?t(n+1):null},i};return t(0)},i.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var g=function(e,t,n,i){var r=[];e(t,function(e,t){n(e,function(e,n){r=r.concat(n||[]),t(e)})},function(e){i(e,r)})};i.concat=d(g),i.concatSeries=l(g),i.whilst=function(e,t,n){e()?t(function(r){return r?n(r):(i.whilst(e,t,n),void 0)}):n()},i.until=function(e,t,n){e()?n():t(function(r){return r?n(r):(i.until(e,t,n),void 0)})},i.queue=function(e,t){var n=0,r={tasks:[],concurrency:t,saturated:null,empty:null,drain:null,push:function(e,n){e.constructor!==Array&&(e=[e]),o(e,function(e){r.tasks.push({data:e,callback:"function"==typeof n?n:null}),r.saturated&&r.tasks.length==t&&r.saturated(),i.nextTick(r.process)})},process:function(){if(r.concurrency>n&&r.tasks.length){var t=r.tasks.shift();r.empty&&0==r.tasks.length&&r.empty(),n+=1,e(t.data,function(){n-=1,t.callback&&t.callback.apply(t,arguments),r.drain&&0==r.tasks.length+n&&r.drain(),r.process()})}},length:function(){return r.tasks.length},running:function(){return n}};return r};var y=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(t?console.error&&console.error(t):console[e]&&o(n,function(t){console[e](t)}))}]))}};return i.log=y("log"),i.dir=y("dir"),i.memoize=function(e,t){var n={},i={};t=t||function(e){return e};var r=function(){var r=Array.prototype.slice.call(arguments),a=r.pop(),o=t.apply(null,r);o in n?a.apply(null,n[o]):o in i?i[o].push(a):(i[o]=[a],e.apply(null,r.concat([function(){n[o]=arguments;var e=i[o];delete i[o];for(var t=0,r=e.length;r>t;t++)e[t].apply(null,arguments)}])))};return r.unmemoized=e,r},i.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},e}),ABINEMASKME.require(["documentcloud/underscore/async"],function(){}),ABINEMASKME.define("abine/eventLogger",["abine/config"],function(e){function t(t){var n={},i=t&&t.split?t.split("#"):[];return 4==i.length?(n.error_tag=i[0],n.module=i[1],n.method=i[2],n.message=i[3]):(n.error_tag=n.module=n.method="not well-formed",n.message=t+""),n.browser=e.browser,n.build=e.buildNum,n.environment=e.environment,n.build_tag=e.tags[0],n.server_host=e.serverHost,n.mapping_server_host=e.mappingServerHost,n.license_server_host=e.licenseServerHost,n.phone_server_host=e.phoneServerHost,n.crypt=e.crypt,n.version=e.version,n.user_agent=ABINEMASKME.userAgent,n}function n(t){var n={error:t},i=ABINEMASKME.user||ABINEMASKME.contentuser||ABINEMASKME.bguser;i&&(n.email_salt=i.getEmailSalt()),ABINEMASKME.require(["abine/ajax"],function(t){t.ajax({type:"POST",url:e.protocol+e.serverHost+"/api/errors",data:n,success:function(){a.debug("error reporting successful")},error:function(){a.debug("error reporting failed")}})})}function i(){if("undefined"!=typeof console)return{finest:function(e){console.debug("[FINEST]["+(new Date).toUTCString()+"]: "+e)},debug:function(e){console.debug("[DEBUG]["+(new Date).toUTCString()+"]: "+e)},info:function(e){console.info("[INFO]["+(new Date).toUTCString()+"]: "+e)},warn:function(e){console.warn("[WARNING]["+(new Date).toUTCString()+"]: "+e)},error:function(e){console.error("[ERROR]["+(new Date).toUTCString()+"]: "+e);var i=ABINEMASKME.user||ABINEMASKME.contentuser||ABINEMASKME.bguser;i&&i.shouldSendErrorReports()&&n(t(e))}};if("undefined"!=typeof Components){var e=Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService);return{finest:function(t){e.logStringMessage("[FINEST]["+(new Date).toUTCString()+"]: "+t),dump("FINEST: "+t+"\n")},debug:function(t){e.logStringMessage("[DEBUG]["+(new Date).toUTCString()+"]: "+t),dump("DEBUG: "+t+"\n")},info:function(t){e.logStringMessage("[INFO]["+(new Date).toUTCString()+"]: "+t),dump("INFO: "+t+"\n")},warn:function(t){e.logStringMessage("[WARNING]["+(new Date).toUTCString()+"]: "+t),dump("WARNING: "+t+"\n")},error:function(i){e.logStringMessage("[ERROR]["+(new Date).toUTCString()+"]: "+i),dump("ERROR: "+i+"\n");var r=ABINEMASKME.user||ABINEMASKME.contentuser||ABINEMASKME.bguser;r&&r.shouldSendErrorReports()&&n(t(i))}}}}var r=function(){},a=i();switch(a.dumpObj=function(e){var t=typeof e;if("object"!=t||null===e)return"string"==t&&(e='"'+e+'"'),String(e);var n,i,r=[],o=e&&e.constructor==Array;for(n in e)i=e[n],t=typeof i,"string"==t?i='"'+i+'"':"object"==t&&null!==i&&(i=a.dumpObj(i)),r.push((o?"":'"'+n+'":')+String(i));return(o?"[":"{")+String(r)+(o?"]":"}")},e.logLevel){case"NONE":a.error=r;case"ERROR":a.warn=r;case"WARN":a.info=r;case"INFO":a.debug=r;case"DEBUG":a.finest=r}return a.info("Log level set to "+e.logLevel),ABINEMASKME.log=a,a}),ABINEMASKME.define("abine/url",function(){function e(e){return e?e.toLowerCase().replace(/\w+/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1)}):e}function t(e){var t=e.match(o);return t&&t.length>1?t[1].toString():e}function n(e){var n=t(e);if(n.match(s)||n.match(c))return n;var i=n.split(".");if(2>i.length)return null;var o=i.pop(),u=i.pop(),d=u+"."+o;if(r.test(d)&&i.length>0&&(o=d,u=i.pop(),d=u+"."+o),a.test(d)&&i.length>0){var l=i.pop();d=l+"."+d}return d}function i(t){if(t=n(t),t.match(s))return t;var i=t.split(".");if(i.length>2){var o=i.pop(),c=i.pop(),t=c+"."+o;if(r.test(t)&&i.length>0&&(o=t,c=i.pop(),t=c+"."+o),a.test(t)&&i.length>0){var u=i.pop();return e(c+" "+u)}return e(c)}return e(i[0])}var r=/^(((co|ac|go|ed|ga|mn|nj|nc|or|ne|in|gr|ca|on|pa|qc|bc|sh|at|va|us|il|tv|me|lg|at|ny|gv|com|edu|org|net|gov|mil|biz)\...)|(163\.com)|(kiev\.ua)|(gob\.pe)|(gen\.tr)|(waw.pl)|(jus.br))$/,a=/^(((go|typepad|tumblr|blogspot|squarespace|wordpress|myshopify|blogfa|blog|blogs|blinkweb|ning|posterous|over-blog|mihanblog|appspot|webs|weebly|onsugar|ucoz|uk|pch|ecwid)(\.com|\.in))|(nic\.in)|((ucoz|spb|narod)\.ru)|(blog\.163\.com)|((gouv|free)\.fr)|(uol\.com\.br)|(web\.id)|(gob\.mx)|(blogg\.se)|(home.pl))$/,o=/^(?:http(?:s)?\:)?\/\/([^/]+)/im,s=/^[0-9\.]+(:[0-9]+)?$/,c=/^localhost(:[0-9]+)?$/;return{getHostname:t,getTLD:n,getSiteName:i}}),ABINEMASKME.define("abine/pluralizer",[],function(){var e=function(e,t){return 1==e?t:t+"s"},t={};return t.pluralize=e,t}),ABINEMASKME.define("abine/saveForms",["documentcloud/underscore","abine/formSubmitDetector","abine/core","abine/formAnalyzer","storage","persistence","abine/url","abine/failedSubmitDetector","abine/securityManager"],function(e,t,n,i,r,a,o,s,c){function u(e){if(c.isLocked())return K.trigger("background:saveField:locked",{}),void 0;var t=o.getTLD(e.formData.pageUrl||e.formData.url);r.Site.findBy("domain",t,function(t){var n=t?1===t.blacklisted:!1;r.Preference.findBy("key","rememberAccounts",function(t){r.Preference.findBy("key","rememberOnlyMaskMe",function(i){return!t||!i||t.isFalse()||n||i.isTrue()&&"MaskMe"!==e.formData.origin?(K.trigger("background:saveField:aborted",{}),void 0):(p(e),void 0)})})})}function d(e){return c.isLocked()?(K.trigger("background:saveForm:locked",{}),void 0):(r.Preference.findBy("key","rememberAccounts",function(t){r.Preference.findBy("key","rememberOnlyMaskMe",function(n){return!t||!n||t.isFalse()||n.isTrue()&&"MaskMe"!==e.data.origin?(K.trigger("background:saveForm:aborted",{}),void 0):(e.fakeSubmit=!0,m(e),void 0)})}),void 0)}function l(e){return c.isLocked()?(K.trigger("background:saveForm:locked",{}),void 0):(r.Preference.findBy("key","rememberAccounts",function(t){r.Preference.findBy("key","rememberOnlyMaskMe",function(n){return!t||!n||t.isFalse()||n.isTrue()&&"MaskMe"!==e.data.origin?(K.trigger("background:saveForm:aborted",{}),void 0):(e.data.insuranceSubmit=!0,m(e),void 0)})}),void 0)}function h(e){if(R.saveInProgress=!0,c.isLocked())return K.trigger("background:saveForm:locked",{}),void 0;var t=o.getTLD(e.data.pageUrl||e.data.url);r.Site.findBy("domain",t,function(t){var n=t?1===t.blacklisted:!1;r.Preference.findBy("key","rememberAccounts",function(t){r.Preference.findBy("key","rememberOnlyMaskMe",function(i){return!t||!i||t.isFalse()||n||i.isTrue()&&"MaskMe"!==e.data.origin?(K.trigger("background:saveForm:aborted",{}),void 0):(R.rollbackPending(e.tabId,function(){m(e)}),void 0)})})})}function f(e,t,n){"/contact/email"==e.dataType?r.DisposableEmail.listCached("guid",e.disposableGUID,function(e){e.length>0&&(e[0].accountId=t.id,a.flush(function(){n()}))}):"/contact/phone"==e.dataType&&r.DisposablePhone.load(e.disposableGUID,function(e){e&&(e.accountId=t.id,a.flush(function(){n()}))})}function p(t){var n=t.formData,i=t.fieldData,a=[],s={},c={};if(e.each(n.data,function(t){t.dataType&&""!=t.dataType||(t.dataType="/unknown"),t.origin=t.name==i.name||t.id==i.id?i.origin:"",""!=t.value&&a.push(t),("/contact/email"==t.dataType||"/nameperson/friendly"==t.dataType)&&(t.dataType=t.value.match(/.+\@.+\..+/i)?"/contact/email":"/nameperson/friendly"),s[t.dataType]||(s[t.dataType]=[]),s[t.dataType].push(t),""!=t.value&&(c[t.dataType]?e.isString(c[t.dataType])?(c[t.dataType]=[c[t.dataType]],c[t.dataType].push(t.value)):c[t.dataType].push(t.value):c[t.dataType]=t.value)}),s["/contact/phone"]||"/contact/phone"!=i.dataType||(a.push(i),s["/contact/phone"]=[i],c["/contact/phone"]=i.value),e.all(e.keys(F),function(e){return!(e in s)}))return K.trigger("background:saveField:missing1",null),void 0;if(!t.fromFill&&s["/password"]&&e.all(s["/password"],function(e){return""==e.value}))return K.trigger("background:saveField:missing2",null),void 0;var u=o.getTLD(n.pageUrl||n.url);L[t.tabId]={accountId:void 0,domain:u,type:n.type,protocol:n.protocol,page_domain:n.page_domain,form_domain:n.form_domain},r.Site.findOrCreate({payload:{domain:u,name:o.getSiteName(u)}},function(o){function s(e){return e.siteId==o.id&&"fill"==e.type}r.Account.listCached(s,function(s){if(s&&0!=s.length){var d=s[0];d&&(i.disposableGUID&&f(i,d,function(){}),e.async.forEach(a,function(e,t){r.AccountField.createVersioned({payload:{name:e.name,value:e.value,dataType:e.dataType,accountId:d.id,origin:e.origin,modifiedAt:new Date}},function(){t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/save_forms]#[saveFields]# error while saving most recent fill account fields"),B[t.tabId]={accountId:d.id,domain:u,type:n.type,protocol:n.protocol,page_domain:n.page_domain,form_domain:n.form_domain},t.fromFill&&K.trigger("background:saveField:saved",null)}))}else x(o,c,"fill",n,function(o){i.disposableGUID&&f(i,o,function(){}),e.async.forEach(a,function(e,t){r.AccountField.createVersioned({payload:{name:e.name,value:e.value,dataType:e.dataType,accountId:o.id,origin:e.origin,modifiedAt:new Date}},function(){t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/save_forms]#[saveField]# error while creating account fields async.forEach"),B[t.tabId]={accountId:o.id,domain:u,type:n.type,protocol:n.protocol,page_domain:n.page_domain,form_domain:n.form_domain},t.fromFill&&K.trigger("background:saveField:saved",null)})})})})}function m(t){var n=t.data;n.tabId=t.tabId,n.fixture=t.fixture,L[t.tabId]&&delete L[t.tabId],B[t.tabId]&&delete B[t.tabId];for(var s={dataType:"/contact/phone",value:"",origin:"",name:"dynamic"},c=g(n),u=c.fieldsWithData,d=c.dataTypeMap,l=c.typeValueMap,h=c.fieldsWithDataTypeMap,f=o.getTLD(n.pageUrl||n.url),p=0;n.data.length>p;p++){var m=n.data[p].value||"";""!=m&&(m=(m+"").replace(/[A-Z]/g,"A").replace(/[a-z]/g,"a").replace(/\d/g,"D").replace(/\s/g,"S").replace(/[^a-zA-Z0-9.@]/g,"C")),a.add(new r.FormData({dataType:n.data[p].dataType,origin:n.data[p].origin,value:m,formType:n.type,field_signature:n.data[p].name,form_signature:n.formSignature,domain:f,createdAt:new Date,latest:1}))}return a.flush(),l["/contact/phone"]||(l["/contact/phone/countrycode"],l["/contact/phone/areacode"]&&(s.value+="("+M(l,"/contact/phone/areacode")+") "),l["/contact/phone/exchange"]&&l["/contact/phone/local"]?s.value+=M(l,"/contact/phone/exchange")+"-"+M(l,"/contact/phone/local"):l["/contact/phone/number"]&&(s.value+=M(l,"/contact/phone/number")),l["/contact/phone/extension"]&&(s.value+=" x"+M(l,"contact/phone/extension")),""!=s.value&&(l["/contact/phone"]=s.value,u.push(s),h["/contact/phone"]=1,d["/contact/phone"]=[s])),d["/password"]||(n.noPassword="yes"),e.all(e.keys(F),function(e){return!(e in h)})?(K.trigger("background:saveForm:missing",null),void 0):(r.Site.findOrCreate({payload:{domain:f,name:o.getSiteName(f)}},function(e){A(e.id,function(r){S(r,u,l),n.type==i.CHANGEPASSWORD_FORM?E(e.id,d,function(e){e&&r.cleanRemove(function(){b(e,d["/password"][0],function(){R.monitor(t.tabId,n,"changepass",e.id)})})}):w(e.id,l,function(t){t?v(r.id,t.id,function(){r.cleanRemove(function(){P(t,u,function(e,i){y(t,e,i,n)})})}):_(e.id,l,function(t){t?v(r.id,t.id,function(){r.cleanRemove(function(){P(t,u,function(e,i){y(t,e,i,n)})})}):x(e,l,n.type,n,function(e){v(r.id,e.id,function(){r.cleanRemove(function(){P(e,u,function(t,i){y(e,t,i,n,!0)})})})})})})})}),void 0)}function g(t){var n=[],i={},r={},a={};return e.each(t.data,function(t){t.dataType&&""!=t.dataType||(t.dataType="/unknown"),t.origin=t.origin?t.origin:"",""!=t.value&&(n.push(t),i[t.dataType]=1),("/contact/email"==t.dataType||"/nameperson/friendly"==t.dataType)&&(t.dataType=t.value.match(/.+\@.+\..+/i)?"/contact/email":"/nameperson/friendly"),r[t.dataType]||(r[t.dataType]=[]),r[t.dataType].push(t),""!=t.value&&(a[t.dataType]?e.isString(a[t.dataType])?(a[t.dataType]=[a[t.dataType]],a[t.dataType].push(t.value)):a[t.dataType].push(t.value):a[t.dataType]=t.value)}),{fieldsWithData:n,dataTypeMap:r,typeValueMap:a,fieldsWithDataTypeMap:i}}function y(t,n,r,a,o){var s=e.find(n,function(e){return"/password"==e.dataType?!0:void 0}),c=[];e.async.forEach(r,function(e,n){C(t,e,function(e){e&&c.push(e),n()})},function(n){n&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/save_forms]#[postProcessAccountUpdate]# error while processing fields for activity"),t.updateInfo(a.type,function(){var n=a.type===i.LOGIN_FORM?"login":"register",u=o?"new":"update";if(o)s||(t.type="passwordless"),K.trigger("background:saveForm:new",{account:t,subActivities:c,activityType:"new "+n});else if(0==r.length)u="login",K.trigger("background:saveForm:login",{account:t,activityType:"login"});else{var d=e.find(r,function(e){return"/password"===e.dataType});d?("passwordless"==t.type&&(t.type=n),u="changepass",K.trigger("background:saveForm:update",{account:t,accountField:d,activityType:"update password"})):K.trigger("background:saveForm:update",{account:t,activityType:"update"})}a.fixture||R.monitor(a.tabId,a,u,t.id,t.type)})})}function v(t,n,i){return-1==t?(i(),void 0):(r.DisposableEmail.listCached("accountId",t,function(o){e(o).each(function(e){e.accountId=n}),r.DisposablePhone.listCached("accountId",t,function(t){e(t).each(function(e){e.accountId=n}),a.flush(function(e,t){i(t)})})}),void 0)}function b(t,n,i){function a(e){return e.accountId==t.id&&1==e.latest&&"/password"==e.dataType}var o=null;r.AccountField.listCached(a,function(a){e.async.forEach(a,function(e,i){r.AccountField.createVersioned({payload:{name:e.name,value:n.value,dataType:e.dataType,accountId:t.id,origin:e.origin,modifiedAt:new Date}},function(e){o||(o=e),i()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/save_forms]#[doPasswordChange]# error while doing password field changes"),K.trigger("background:saveForm:update",{account:t,accountField:o,activityType:"update password"}),i()})})}function E(t,n,i){function a(e){return e.siteId==t}r.Account.listCached(a,function(t){e.async.filter(t,function(t,i){function a(e){return e.accountId==t.id&&1==e.latest&&"/password"==e.dataType}r.AccountField.listCached(a,function(t){var r=e(t).find(function(e){return e.value==n["/passwordold"][0].value?!0:!1});r?i(!0):i(!1)})},function(t){if(t&&0!=t.length){var n=t[0];e(t).each(function(e){e.modifiedAt>n.modifiedAt&&(n=e)}),i(n)}else i(null)})})}function A(e,t){r.Account.all().filter("siteId","=",e).filter("type","=",r.Account.encryptedQueryValue("fill")).order("createdAt",!1).one(function(e){e?t(e):t({id:-1,cleanRemove:function(e){e&&e()}})})}function _(t,n,i){function a(e){return e.siteId==t&&"fill"!=e.type}var o=e.intersection(e.keys(F),e.keys(n));(N in n||I in n)&&(o.push(N),o.push(I));var s={};e.each(o,function(e){s[e]=M(n,e)}),r.Account.listCached(a,function(t){e.async.filter(t,function(e,t){function n(t){return t.accountId==e.id&&1==t.latest&&t.dataType in s&&!("/password"==t.dataType&&t.value==s[t.dataType])}r.AccountField.listCached(n,function(e){t(0===e.length)})},function(t){var n=null;e.each(t,function(e){(!n||e.createdAt>n.createdAt)&&(n=e)}),i(n)})})}function S(t,n,i){t&&-1!=t.id&&r.AccountField.getLatestForAccountId(t.id,function(t){var r=[];e.each(t,function(t){var i=!1;e.each(n,function(e){e.dataType==t.dataType&&e.name==t.name&&(e.origin=t.origin),e.dataType==t.dataType&&""!=e.value&&(i=!0)}),i||r.push(t)}),e.each(r,function(t){n.push({name:t.name,value:t.value,dataType:t.dataType,origin:t.origin}),i[t.dataType]?e.isString(i[t.dataType])?(i[t.dataType]=[i[t.dataType]],i[t.dataType].push(t.value)):i[t.dataType].push(t.value):i[t.dataType]=t.value})})}function T(t,n,i){return e.isString(t[n])?t[n].toLowerCase()===i.toLowerCase():e.isArray(t[n])?e.any(t[n],function(e){return e.toLowerCase()===i.toLowerCase()}):!1}function M(t,n){return t[n]?e.isString(t[n])?t[n]:e.isArray(t[n])?e.find(t[n],function(e){return""!=e.value?!0:void 0}):void 0:null}function w(t,n,i){function a(e){return e.siteId==t&&"fill"!=e.type}var o=[];if((N in n||I in n)&&(o.push(N),o.push(I)),0==o.length)return i(null),void 0;var s={};e.each(o,function(e){s[e]=1}),r.Account.listCached(a,function(t){function a(e){return e.accountId in o&&1==e.latest&&e.dataType in s}var o={};e.each(t,function(e){o[e.id]=e}),r.AccountField.listCached(a,function(t){var r=e.find(t,function(e){return T(n,N,e.value)||T(n,I,e.value)});r?i(o[r.accountId]):i(null)})})}function k(e){var t=null;return I in e?t=M(e,I):N in e&&(t=M(e,N)),t}function C(e,t,n){var i=t.origin?t.origin:"",a=t.dataType?t.dataType:"",o=null,s={"/contact/email":"email","/contact/phone":"phone","/password":"password"},c={disposable:1,primary:1,strong:1};"/contact/email"===a&&t.value.indexOf("opayq.com")>=0&&(i="disposable"),"/password"===a?t.passwordReuseCount(function(i){o=1==i?new r.AccountActivity({accountId:e.id,accountFieldId:t.id,activityType:"strong password",createdAt:new Date,modifiedAt:new Date}):new r.AccountActivity({accountId:e.id,accountFieldId:t.id,activityType:"reused password",createdAt:new Date,modifiedAt:new Date}),n(o)}):(i in c&&a in s&&(o=new r.AccountActivity({accountId:e.id,accountFieldId:t.id,activityType:i+" "+s[a],createdAt:new Date,modifiedAt:new Date})),n(o))}function P(t,n,i){var o=0,s=[],c=n.length,u=[],d=function(n,r){o++,u.push(n),(r||"fill"==t.type)&&n.dataType in F&&s.push(n),o==c&&(0==s.length?(e.each(u,function(e){e.version--}),a.flush(function(){i(u,s)})):a.flush(function(){i(u,s)}))};e.each(n,function(e){r.AccountField.createVersioned({payload:{name:e.name,value:e.value,dataType:e.dataType,accountId:t.id,origin:e.origin,modifiedAt:new Date}},d)})}function x(e,t,n,o,s){var c=k(t);c||(c="password account");var u=n;"fill"!==n&&(u=n===i.LOGIN_FORM?"login":"register");var d="fill"==u?"":e.name+" "+u+" account",l=new r.Account({name:c,description:d,siteId:e.id,active:1,createdAt:new Date,modifiedAt:new Date,type:u,protocol:o.protocol?o.protocol:null,page_domain:o.page_domain?o.page_domain:null,form_domain:o.form_domain?o.form_domain:null});a.add(l),a.flush(function(){s(l)})}var I="/nameperson/friendly",N="/contact/email",O="/password",D="/contact/phone",F={};F[I]=1,F[N]=1,F[O]=1,F[D]=1;var R=s,B={},L={},q=n.BaseClass.extend({init:function(t,n,i){this.messenger=t,R=n||s,R.init(t,this),R.on("background:saveForm:rollback",function(e){K.trigger("background:saveForm:rollback",e)}),this.messenger.on("contentManager:init",function(t,n){if(B[n]){var i={data:{data:[],type:B[n].type,pageUrl:B[n].domain,protocol:B[n].protocol,page_domain:B[n].page_domain,form_domain:B[n].form_domain},tabId:n};r.AccountField.getLatestForAccountId(B[n].accountId,function(t){e.each(t,function(e){i.data.data.push({name:e.name,value:e.value,dataType:e.dataType,origin:e.origin})}),m(i)}),delete B[n]}else if(L[n]){var i={data:{data:[],type:L[n].type,pageUrl:L[n].domain,protocol:L[n].protocol,page_domain:L[n].page_domain,form_domain:L[n].form_domain},tabId:n};m(i),delete L[n]}else{var i={data:{data:[],type:"unknown",pageUrl:t.domain},tabId:0};m(i)}}),this.messenger.on("contentManager:filledAccount",function(e,n){r.Account.load(e.accountId,function(e){e.modifiedAt=new Date,a.flush(function(){B[n]?r.Account.load(B[n].accountId,function(e){e.cleanRemove(function(){delete B[n],t.send("broadcast:filledAccount:rolledback",null,n)})}):t.send("broadcast:filledAccount:rolledback",null,n)})})}),R.on("background:saveForm:fakeSubmit",d),R.on("background:saveForm:insuranceSubmit",l),c=i||c
}}),K=new q;K.fillAccountTabIdMap=B,K.noFillAccountTabIdMap=L;var U=function(e){R.saveInProgress=!1,K.trigger("background:saveForm:finished",e)};return K.on("all",function(e){}),K.on("background:saveForm:locked",function(e){e=e||{},e.eventName="background:saveForm:locked",U(e)}),K.on("background:saveForm:aborted",function(e){e=e||{},e.eventName="background:saveForm:aborted",U(e)}),K.on("background:saveForm:missing",function(e){e=e||{},e.eventName="background:saveForm:missing",U(e)}),K.on("background:saveForm:new",function(t){t=t||{},t.eventName="background:saveForm:new";var n=new r.AccountActivity({accountId:t.account.id,activityType:t.activityType,createdAt:new Date,modifiedAt:new Date}),i=t.subActivities||[],o=e.map(i,function(e){return e.activityType});o=e.uniq(o),"new login"==t.activityType&&o.push("life easier"),n.extraActivityTypes=o.join(","),t.account.computeFullyProtected(!0,function(e){n.protectionLevel=e,a.add(n),a.flush(function(){U(t),K.messenger.broadcast("broadcast:saveForm:new"),K.messenger.broadcast("broadcast:accountActivity:new",n)})})}),K.on("background:saveForm:update",function(e){e=e||{},e.eventName="background:saveForm:update";var t=new r.AccountActivity({accountId:e.account.id,activityType:e.activityType,accountFieldId:e.accountField?e.accountField.id:null,createdAt:new Date,modifiedAt:new Date});e.account.computeFullyProtected(!0,function(n){t.protectionLevel=n,a.add(t),a.flush(function(){U(e),K.messenger.broadcast("broadcast:saveForm:update"),K.messenger.broadcast("broadcast:accountActivity:new",t)})})}),K.on("background:saveForm:login",function(e){e=e||{},e.eventName="background:saveForm:login";var t=new r.AccountActivity({accountId:e.account.id,activityType:e.activityType,createdAt:new Date,modifiedAt:new Date});e.account.computeFullyProtected(!0,function(n){t.protectionLevel=n,a.add(t),a.flush(function(){U(e),K.messenger.broadcast("broadcast:saveForm:login")})})}),K.on("background:saveField:saved",function(){K.messenger.broadcast("broadcast:saveForm:new")}),t.formSubmitDetector.on("background:formSubmit",h),t.formSubmitDetector.on("background:formFieldChanged",u),t.formSubmitDetector.on("background:fixtureSubmit",m),K}),pidCryptUtil={},pidCryptUtil.encodeBase64=function(e,t){e||(e="");var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t="undefined"==typeof t?!1:t;var i,r,a,o,s,c,u,d,l,h,f,p=[],m="";if(h=t?pidCryptUtil.encodeUTF8(e):e,l=h.length%3,l>0)for(;3>l++;)m+="=",h+="\0";for(l=0;h.length>l;l+=3)i=h.charCodeAt(l),r=h.charCodeAt(l+1),a=h.charCodeAt(l+2),o=i<<16|r<<8|a,s=63&o>>18,c=63&o>>12,u=63&o>>6,d=63&o,p[l/3]=n.charAt(s)+n.charAt(c)+n.charAt(u)+n.charAt(d);return f=p.join(""),f=f.slice(0,f.length-m.length)+m},pidCryptUtil.decodeBase64=function(e,t){e||(e="");var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t="undefined"==typeof t?!1:t;var i,r,a,o,s,c,u,d,l,h,f=[];h=t?pidCryptUtil.decodeUTF8(e):e;for(var p=0;h.length>p;p+=4)o=n.indexOf(h.charAt(p)),s=n.indexOf(h.charAt(p+1)),c=n.indexOf(h.charAt(p+2)),u=n.indexOf(h.charAt(p+3)),d=o<<18|s<<12|c<<6|u,i=255&d>>>16,r=255&d>>>8,a=255&d,f[p/4]=String.fromCharCode(i,r,a),64==u&&(f[p/4]=String.fromCharCode(i,r)),64==c&&(f[p/4]=String.fromCharCode(i));return l=f.join(""),l=t?pidCryptUtil.decodeUTF8(l):l},pidCryptUtil.encodeUTF8=function(e){return e||(e=""),e=e.replace(/[\u0080-\u07ff]/g,function(e){var t=e.charCodeAt(0);return String.fromCharCode(192|t>>6,128|63&t)}),e=e.replace(/[\u0800-\uffff]/g,function(e){var t=e.charCodeAt(0);return String.fromCharCode(224|t>>12,128|63&t>>6,128|63&t)})},pidCryptUtil.decodeUTF8=function(e){return e||(e=""),e=e.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(e){var t=(31&e.charCodeAt(0))<<6|63&e.charCodeAt(1);return String.fromCharCode(t)}),e=e.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(e){var t=(15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2);return String.fromCharCode(t)})},pidCryptUtil.convertToHex=function(e){e||(e="");for(var t="",n="",i=0;e.length>i;i++)n=e.charCodeAt(i).toString(16),t+=1==n.length?"0"+n:n;return t},pidCryptUtil.convertFromHex=function(e){e||(e="");for(var t="",n=0;e.length>n;n+=2)t+=String.fromCharCode(parseInt(e.substring(n,n+2),16));return t},pidCryptUtil.stripLineFeeds=function(e){e||(e="");var t="";return t=e.replace(/\n/g,""),t=t.replace(/\r/g,"")},pidCryptUtil.toByteArray=function(e){e||(e="");for(var t=[],n=0;e.length>n;n++)t[n]=e.charCodeAt(n);return t},pidCryptUtil.fragment=function(e,t,n){if(e||(e=""),!t||t>=e.length)return e;n||(n="\n");for(var i="",r=0;e.length>r;r+=t)i+=e.substr(r,t)+n;return i},pidCryptUtil.formatHex=function(e,t){e||(e=""),t||(t=45);for(var n="",i=e.toLowerCase(),r=0;i.length>r;r+=2)n+=i.substr(r,2)+":";return i=this.fragment(n,t)},pidCryptUtil.byteArray2String=function(e){for(var t="",n=0;e.length>n;n++)t+=String.fromCharCode(e[n]);return t},"undefined"!=typeof pidCrypt&&(pidCrypt.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,i,r,a,o;return r=2147483648&e,a=2147483648&t,n=1073741824&e,i=1073741824&t,o=(1073741823&e)+(1073741823&t),n&i?2147483648^o^r^a:n|i?1073741824&o?3221225472^o^r^a:1073741824^o^r^a:o^r^a}function i(e,t,n){return e&t|~e&n}function r(e,t,n){return e&n|t&~n}function a(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function s(e,r,a,o,s,c,u){return e=n(e,n(n(i(r,a,o),s),u)),n(t(e,c),r)}function c(e,i,a,o,s,c,u){return e=n(e,n(n(r(i,a,o),s),u)),n(t(e,c),i)}function u(e,i,r,o,s,c,u){return e=n(e,n(n(a(i,r,o),s),u)),n(t(e,c),i)}function d(e,i,r,a,s,c,u){return e=n(e,n(n(o(i,r,a),s),u)),n(t(e,c),i)}function l(e){for(var t,n=e.length,i=n+8,r=(i-i%64)/64,a=16*(r+1),o=Array(a-1),s=0,c=0;n>c;)t=(c-c%4)/4,s=8*(c%4),o[t]=o[t]|e.charCodeAt(c)<<s,c++;return t=(c-c%4)/4,s=8*(c%4),o[t]=o[t]|128<<s,o[a-2]=n<<3,o[a-1]=n>>>29,o}function h(e){var t,n,i="",r="";for(n=0;3>=n;n++)t=255&e>>>8*n,r="0"+t.toString(16),i+=r.substr(r.length-2,2);return i}var f,p,m,g,y,v,b,E,A,_=Array(),S=7,T=12,M=17,w=22,k=5,C=9,P=14,x=20,I=4,N=11,O=16,D=23,F=6,R=10,B=15,L=21;for(_=l(e),v=1732584193,b=4023233417,E=2562383102,A=271733878,f=0;_.length>f;f+=16)p=v,m=b,g=E,y=A,v=s(v,b,E,A,_[f+0],S,3614090360),A=s(A,v,b,E,_[f+1],T,3905402710),E=s(E,A,v,b,_[f+2],M,606105819),b=s(b,E,A,v,_[f+3],w,3250441966),v=s(v,b,E,A,_[f+4],S,4118548399),A=s(A,v,b,E,_[f+5],T,1200080426),E=s(E,A,v,b,_[f+6],M,2821735955),b=s(b,E,A,v,_[f+7],w,4249261313),v=s(v,b,E,A,_[f+8],S,1770035416),A=s(A,v,b,E,_[f+9],T,2336552879),E=s(E,A,v,b,_[f+10],M,4294925233),b=s(b,E,A,v,_[f+11],w,2304563134),v=s(v,b,E,A,_[f+12],S,1804603682),A=s(A,v,b,E,_[f+13],T,4254626195),E=s(E,A,v,b,_[f+14],M,2792965006),b=s(b,E,A,v,_[f+15],w,1236535329),v=c(v,b,E,A,_[f+1],k,4129170786),A=c(A,v,b,E,_[f+6],C,3225465664),E=c(E,A,v,b,_[f+11],P,643717713),b=c(b,E,A,v,_[f+0],x,3921069994),v=c(v,b,E,A,_[f+5],k,3593408605),A=c(A,v,b,E,_[f+10],C,38016083),E=c(E,A,v,b,_[f+15],P,3634488961),b=c(b,E,A,v,_[f+4],x,3889429448),v=c(v,b,E,A,_[f+9],k,568446438),A=c(A,v,b,E,_[f+14],C,3275163606),E=c(E,A,v,b,_[f+3],P,4107603335),b=c(b,E,A,v,_[f+8],x,1163531501),v=c(v,b,E,A,_[f+13],k,2850285829),A=c(A,v,b,E,_[f+2],C,4243563512),E=c(E,A,v,b,_[f+7],P,1735328473),b=c(b,E,A,v,_[f+12],x,2368359562),v=u(v,b,E,A,_[f+5],I,4294588738),A=u(A,v,b,E,_[f+8],N,2272392833),E=u(E,A,v,b,_[f+11],O,1839030562),b=u(b,E,A,v,_[f+14],D,4259657740),v=u(v,b,E,A,_[f+1],I,2763975236),A=u(A,v,b,E,_[f+4],N,1272893353),E=u(E,A,v,b,_[f+7],O,4139469664),b=u(b,E,A,v,_[f+10],D,3200236656),v=u(v,b,E,A,_[f+13],I,681279174),A=u(A,v,b,E,_[f+0],N,3936430074),E=u(E,A,v,b,_[f+3],O,3572445317),b=u(b,E,A,v,_[f+6],D,76029189),v=u(v,b,E,A,_[f+9],I,3654602809),A=u(A,v,b,E,_[f+12],N,3873151461),E=u(E,A,v,b,_[f+15],O,530742520),b=u(b,E,A,v,_[f+2],D,3299628645),v=d(v,b,E,A,_[f+0],F,4096336452),A=d(A,v,b,E,_[f+7],R,1126891415),E=d(E,A,v,b,_[f+14],B,2878612391),b=d(b,E,A,v,_[f+5],L,4237533241),v=d(v,b,E,A,_[f+12],F,1700485571),A=d(A,v,b,E,_[f+3],R,2399980690),E=d(E,A,v,b,_[f+10],B,4293915773),b=d(b,E,A,v,_[f+1],L,2240044497),v=d(v,b,E,A,_[f+8],F,1873313359),A=d(A,v,b,E,_[f+15],R,4264355552),E=d(E,A,v,b,_[f+6],B,2734768916),b=d(b,E,A,v,_[f+13],L,1309151649),v=d(v,b,E,A,_[f+4],F,4149444226),A=d(A,v,b,E,_[f+11],R,3174756917),E=d(E,A,v,b,_[f+2],B,718787259),b=d(b,E,A,v,_[f+9],L,3951481745),v=n(v,p),b=n(b,m),E=n(E,g),A=n(A,y);var q=h(v)+h(b)+h(E)+h(A);return q.toLowerCase()}),"undefined"!=typeof pidCrypt&&(pidCrypt.SHA1=function(e){function t(e,t){var n=e<<t|e>>>32-t;return n}function n(e){var t,n,i="";for(t=7;t>=0;t--)n=15&e>>>4*t,i+=n.toString(16);return i}var i,r,a,o,s,c,u,d,l,h=new Array(80),f=1732584193,p=4023233417,m=2562383102,g=271733878,y=3285377520,v=e.length,b=new Array;for(r=0;v-3>r;r+=4)a=e.charCodeAt(r)<<24|e.charCodeAt(r+1)<<16|e.charCodeAt(r+2)<<8|e.charCodeAt(r+3),b.push(a);switch(v%4){case 0:r=2147483648;break;case 1:r=8388608|e.charCodeAt(v-1)<<24;break;case 2:r=32768|(e.charCodeAt(v-2)<<24|e.charCodeAt(v-1)<<16);break;case 3:r=128|(e.charCodeAt(v-3)<<24|e.charCodeAt(v-2)<<16|e.charCodeAt(v-1)<<8)}for(b.push(r);14!=b.length%16;)b.push(0);for(b.push(v>>>29),b.push(4294967295&v<<3),i=0;b.length>i;i+=16){for(r=0;16>r;r++)h[r]=b[i+r];for(r=16;79>=r;r++)h[r]=t(h[r-3]^h[r-8]^h[r-14]^h[r-16],1);for(o=f,s=p,c=m,u=g,d=y,r=0;19>=r;r++)l=4294967295&t(o,5)+(s&c|~s&u)+d+h[r]+1518500249,d=u,u=c,c=t(s,30),s=o,o=l;for(r=20;39>=r;r++)l=4294967295&t(o,5)+(s^c^u)+d+h[r]+1859775393,d=u,u=c,c=t(s,30),s=o,o=l;for(r=40;59>=r;r++)l=4294967295&t(o,5)+(s&c|s&u|c&u)+d+h[r]+2400959708,d=u,u=c,c=t(s,30),s=o,o=l;for(r=60;79>=r;r++)l=4294967295&t(o,5)+(s^c^u)+d+h[r]+3395469782,d=u,u=c,c=t(s,30),s=o,o=l;f=4294967295&f+o,p=4294967295&p+s,m=4294967295&m+c,g=4294967295&g+u,y=4294967295&y+d}var l=n(f)+n(p)+n(m)+n(g)+n(y);return l.toLowerCase()}),"undefined"!=typeof pidCrypt&&(pidCrypt.SHA256=function(e){function t(e,t){var n=(65535&e)+(65535&t),i=(e>>16)+(t>>16)+(n>>16);return i<<16|65535&n}function n(e,t){return e>>>t|e<<32-t}function i(e,t){return e>>>t}function r(e,t,n){return e&t^~e&n}function a(e,t,n){return e&t^e&n^t&n}function o(e){return n(e,2)^n(e,13)^n(e,22)}function s(e){return n(e,6)^n(e,11)^n(e,25)}function c(e){return n(e,7)^n(e,18)^i(e,3)}function u(e){return n(e,17)^n(e,19)^i(e,10)}function d(e,n){var i,d,l,h,f,p,m,g,y,v,b,E,A=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),_=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),S=new Array(64);e[n>>5]|=128<<24-n%32,e[(n+64>>9<<4)+15]=n;for(var y=0;e.length>y;y+=16){i=_[0],d=_[1],l=_[2],h=_[3],f=_[4],p=_[5],m=_[6],g=_[7];for(var v=0;64>v;v++)S[v]=16>v?e[v+y]:t(t(t(u(S[v-2]),S[v-7]),c(S[v-15])),S[v-16]),b=t(t(t(t(g,s(f)),r(f,p,m)),A[v]),S[v]),E=t(o(i),a(i,d,l)),g=m,m=p,p=f,f=t(h,b),h=l,l=d,d=i,i=t(b,E);_[0]=t(i,_[0]),_[1]=t(d,_[1]),_[2]=t(l,_[2]),_[3]=t(h,_[3]),_[4]=t(f,_[4]),_[5]=t(p,_[5]),_[6]=t(m,_[6]),_[7]=t(g,_[7])}return _}function l(e){for(var t=Array(),n=(1<<f)-1,i=0;e.length*f>i;i+=f)t[i>>5]|=(e.charCodeAt(i/f)&n)<<24-i%32;return t}function h(e){for(var t=0,n=t?"0123456789ABCDEF":"0123456789abcdef",i="",r=0;4*e.length>r;r++)i+=n.charAt(15&e[r>>2]>>8*(3-r%4)+4)+n.charAt(15&e[r>>2]>>8*(3-r%4));return i}var f=8;return h(d(l(e),e.length*f))}),/*Copyright (c) 2009 pidder <www.pidder.com>*/
"undefined"!=typeof pidCrypt&&(pidCrypt.AES=function(e){this.env=e?e:new pidCrypt,this.blockSize=16,this.ShiftRowTabInv,this.xtime,this.SBox=new Array(99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22),this.SBoxInv=new Array(82,9,106,213,48,54,165,56,191,64,163,158,129,243,215,251,124,227,57,130,155,47,255,135,52,142,67,68,196,222,233,203,84,123,148,50,166,194,35,61,238,76,149,11,66,250,195,78,8,46,161,102,40,217,36,178,118,91,162,73,109,139,209,37,114,248,246,100,134,104,152,22,212,164,92,204,93,101,182,146,108,112,72,80,253,237,185,218,94,21,70,87,167,141,157,132,144,216,171,0,140,188,211,10,247,228,88,5,184,179,69,6,208,44,30,143,202,63,15,2,193,175,189,3,1,19,138,107,58,145,17,65,79,103,220,234,151,242,207,206,240,180,230,115,150,172,116,34,231,173,53,133,226,249,55,232,28,117,223,110,71,241,26,113,29,41,197,137,111,183,98,14,170,24,190,27,252,86,62,75,198,210,121,32,154,219,192,254,120,205,90,244,31,221,168,51,136,7,199,49,177,18,16,89,39,128,236,95,96,81,127,169,25,181,74,13,45,229,122,159,147,201,156,239,160,224,59,77,174,42,245,176,200,235,187,60,131,83,153,97,23,43,4,126,186,119,214,38,225,105,20,99,85,33,12,125),this.ShiftRowTab=new Array(0,5,10,15,4,9,14,3,8,13,2,7,12,1,6,11)},pidCrypt.AES.prototype.init=function(){this.env.setParams({blockSize:this.blockSize}),this.ShiftRowTabInv=new Array(16);for(var e=0;16>e;e++)this.ShiftRowTabInv[this.ShiftRowTab[e]]=e;for(this.xtime=new Array(256),e=0;128>e;e++)this.xtime[e]=e<<1,this.xtime[128+e]=27^e<<1},pidCrypt.AES.prototype.expandKey=function(e){var t,n=e.slice(),i=n.length,r=1;switch(i){case 16:t=176;break;case 24:t=208;break;case 32:t=240;break;default:alert("AESCore.expandKey: Only key lengths of 16, 24 or 32 bytes allowed!")}for(var a=i;t>a;a+=4){var o=n.slice(a-4,a);0==a%i?(o=new Array(this.SBox[o[1]]^r,this.SBox[o[2]],this.SBox[o[3]],this.SBox[o[0]]),(r<<=1)>=256&&(r^=283)):i>24&&16==a%i&&(o=new Array(this.SBox[o[0]],this.SBox[o[1]],this.SBox[o[2]],this.SBox[o[3]]));for(var s=0;4>s;s++)n[a+s]=n[a+s-i]^o[s]}return n},pidCrypt.AES.prototype.encrypt=function(e,t){var n=t.length,i=e.slice();this.addRoundKey(i,t.slice(0,16));for(var r=16;n-16>r;r+=16)this.subBytes(i),this.shiftRows(i),this.mixColumns(i),this.addRoundKey(i,t.slice(r,r+16));return this.subBytes(i),this.shiftRows(i),this.addRoundKey(i,t.slice(r,n)),i},pidCrypt.AES.prototype.decrypt=function(e,t){var n=t.length,i=e.slice();this.addRoundKey(i,t.slice(n-16,n)),this.shiftRows(i,1),this.subBytes(i,1);for(var r=n-32;r>=16;r-=16)this.addRoundKey(i,t.slice(r,r+16)),this.mixColumns_Inv(i),this.shiftRows(i,1),this.subBytes(i,1);return this.addRoundKey(i,t.slice(0,16)),i},pidCrypt.AES.prototype.subBytes=function(e,t){for(var n="undefined"==typeof t?this.SBox.slice():this.SBoxInv.slice(),i=0;16>i;i++)e[i]=n[e[i]]},pidCrypt.AES.prototype.addRoundKey=function(e,t){for(var n=0;16>n;n++)e[n]^=t[n]},pidCrypt.AES.prototype.shiftRows=function(e,t){for(var n="undefined"==typeof t?this.ShiftRowTab.slice():this.ShiftRowTabInv.slice(),i=(new Array).concat(e),r=0;16>r;r++)e[r]=i[n[r]]},pidCrypt.AES.prototype.mixColumns=function(e){for(var t=0;16>t;t+=4){var n=e[t+0],i=e[t+1],r=e[t+2],a=e[t+3],o=n^i^r^a;e[t+0]^=o^this.xtime[n^i],e[t+1]^=o^this.xtime[i^r],e[t+2]^=o^this.xtime[r^a],e[t+3]^=o^this.xtime[a^n]}},pidCrypt.AES.prototype.mixColumns_Inv=function(e){for(var t=0;16>t;t+=4){var n=e[t+0],i=e[t+1],r=e[t+2],a=e[t+3],o=n^i^r^a,s=this.xtime[o],c=this.xtime[this.xtime[s^n^r]]^o,u=this.xtime[this.xtime[s^i^a]]^o;e[t+0]^=c^this.xtime[n^i],e[t+1]^=u^this.xtime[i^r],e[t+2]^=c^this.xtime[r^a],e[t+3]^=u^this.xtime[a^n]}},pidCrypt.AES.prototype.xOr_Array=function(e,t){var n,i=Array();for(n=0;e.length>n;n++)i[n]=e[n]^t[n];return i},pidCrypt.AES.prototype.getCounterBlock=function(){for(var e=new Array(this.blockSize),t=(new Date).getTime(),n=Math.floor(t/1e3),i=t%1e3,r=0;4>r;r++)e[r]=255&n>>>8*r;for(var r=0;4>r;r++)e[r+4]=255&i;return e.slice()}),"undefined"!=typeof pidCrypt&&"undefined"!=typeof pidCrypt.AES&&"undefined"!=typeof pidCrypt.MD5&&(pidCrypt.AES.CBC=function(){this.pidcrypt=new pidCrypt,this.aes=new pidCrypt.AES(this.pidcrypt),this.getOutput=function(){return this.pidcrypt.getOutput()},this.getAllMessages=function(e){return this.pidcrypt.getAllMessages(e)},this.isError=function(){return this.pidcrypt.isError()}},pidCrypt.AES.CBC.prototype.init=function(e,t){t||(t={});var n=this.pidcrypt;n.setDefaults();var i=this.pidcrypt.getParams();for(var r in t)i[r]=t[r];var a=this.createKeyAndIv({password:e,salt:i.salt,bits:i.nBits});i.key=a.key,i.iv=a.iv,i.dataOut="",n.setParams(i),this.aes.init()},pidCrypt.AES.CBC.prototype.initEncrypt=function(e,t,n){this.init(t,n),this.pidcrypt.setParams({dataIn:e,encryptIn:pidCryptUtil.toByteArray(e)})},pidCrypt.AES.CBC.prototype.initDecrypt=function(e,t,n){n||(n={});var i=this.pidcrypt;i.setParams({dataIn:e}),t||i.appendError("pidCrypt.AES.CBC.initFromEncryption: Sorry, can not crypt or decrypt without password.\n");var r=pidCryptUtil.decodeBase64(e);0!=r.indexOf("Salted__")&&i.appendError("pidCrypt.AES.CBC.initFromCrypt: Sorry, unknown encryption method.\n");var a=r.substr(8,8);n.salt=pidCryptUtil.convertToHex(a),this.init(t,n),r=r.substr(16),i.setParams({decryptIn:pidCryptUtil.toByteArray(r)})},pidCrypt.AES.CBC.prototype.initByValues=function(e,t,n,i){var r={};this.init("",i),r.dataIn=e,r.key=t,r.iv=n,this.pidcrypt.setParams(r)},pidCrypt.AES.CBC.prototype.getAllMessages=function(e){return this.pidcrypt.getAllMessages(e)},pidCrypt.AES.CBC.prototype.createKeyAndIv=function(e){var t=this.pidcrypt,n={},i=1,r="3";e||(e={}),e.salt||(e.salt=t.getRandomBytes(8),e.salt=pidCryptUtil.convertToHex(pidCryptUtil.byteArray2String(e.salt)),t.setParams({salt:e.salt}));var a=e.password+pidCryptUtil.convertFromHex(e.salt),o="",s="",c=[],u=0;c[u++]=a;for(var d=0;r>d;d++){0==d?s=a:(o=pidCryptUtil.convertFromHex(s),o+=a,s=o);for(var l=0;i>l;l++)s=pidCrypt.MD5(s);c[u++]=s}switch(e.bits){case 128:n.key=c[1],n.iv=c[2];break;case 192:n.key=c[1]+c[2].substr(0,16),n.iv=c[3];break;case 256:n.key=c[1]+c[2],n.iv=c[3];break;default:t.appendError("pidCrypt.AES.CBC.createKeyAndIv: Sorry, only 128, 192 and 256 bits are supported.\nBits("+typeof e.bits+") = "+e.bits)}return n},pidCrypt.AES.CBC.prototype.encryptRaw=function(e){var t=this.pidcrypt,n=this.aes,i=t.getParams();e||(e=i.encryptIn),t.setParams({encryptIn:e}),i.dataIn||t.setParams({dataIn:e});var r=pidCryptUtil.convertFromHex(i.iv),a=i.blockSize-(e.length+1)%i.blockSize;i.A0_PAD&&(e[e.length]=10);for(var o=0;a>o;o++)e[e.length]=a;for(var s=Math.floor(i.nBits/8),c=new Array(s),u=pidCryptUtil.convertFromHex(i.key),d=0;s>d;d++)c[d]=isNaN(u.charCodeAt(d))?0:u.charCodeAt(d);for(var l=n.expandKey(c),h=Math.ceil(e.length/i.blockSize),f=new Array(h),p=[],m=pidCryptUtil.toByteArray(r),g=0;h>g;g++)p=e.slice(g*i.blockSize,g*i.blockSize+i.blockSize),m=n.xOr_Array(m,p),m=n.encrypt(m.slice(),l),f[g]=pidCryptUtil.byteArray2String(m);var y=f.join("");return t.setParams({dataOut:y,encryptOut:y}),!t.isDebug()&&t.clear&&t.clearParams(),y||""},pidCrypt.AES.CBC.prototype.encrypt=function(e){var t=this.pidcrypt,n="",i=t.getParams();e||(e=i.dataIn),i.UTF8&&(e=pidCryptUtil.encodeUTF8(e)),t.setParams({dataIn:e,encryptIn:pidCryptUtil.toByteArray(e)});var r=this.encryptRaw();return n="Salted__"+pidCryptUtil.convertFromHex(i.salt),r=n+r,r=pidCryptUtil.encodeBase64(r),t.setParams({dataOut:r}),!t.isDebug()&&t.clear&&t.clearParams(),r||""},pidCrypt.AES.CBC.prototype.encryptText=function(e,t,n){return this.initEncrypt(e,t,n),this.encrypt()},pidCrypt.AES.CBC.prototype.decryptRaw=function(e){var t=this.aes,n=this.pidcrypt,i=n.getParams();if(e||(e=i.decryptIn),n.setParams({decryptIn:e}),i.dataIn||n.setParams({dataIn:e}),i.iv.length/2<i.blockSize)return n.appendError("pidCrypt.AES.CBC.decrypt: Sorry, can not decrypt without complete set of parameters.\n Length of key,iv:"+i.key.length+","+i.iv.length);var r=pidCryptUtil.convertFromHex(i.iv);if(0!=e.length%i.blockSize)return n.appendError("pidCrypt.AES.CBC.decrypt: Sorry, the encrypted text has the wrong length for aes-cbc mode\n Length of ciphertext:"+e.length+e.length%i.blockSize);for(var a=Math.floor(i.nBits/8),o=new Array(a),s=pidCryptUtil.convertFromHex(i.key),c=0;a>c;c++)o[c]=isNaN(s.charCodeAt(c))?0:s.charCodeAt(c);for(var u=t.expandKey(o),d=Math.ceil(e.length/i.blockSize),l=new Array(d.length),h=pidCryptUtil.toByteArray(r),f=[],p=[],m=0;d>m;m++)f=e.slice(m*i.blockSize,m*i.blockSize+i.blockSize),p=t.decrypt(f,u),l[m]=pidCryptUtil.byteArray2String(t.xOr_Array(h,p)),h=f.slice();var g=l.join("");n.isDebug()&&n.appendDebug("Padding after decryption:"+pidCryptUtil.convertToHex(g)+":"+g.length+"\n");var y=g.charCodeAt(g.length-1);if(i.A0_PAD)g=g.substr(0,g.length-(y+1));else{var v=g.length-(g.length-y),b=g.charCodeAt(g.length-y);y==b&&y==v&&(g=g.substr(0,g.length-y))}return n.setParams({dataOut:g,decryptOut:g}),!n.isDebug()&&n.clear&&n.clearParams(),g||""},pidCrypt.AES.CBC.prototype.decrypt=function(e){var t=this.pidcrypt,n=t.getParams();if(e&&t.setParams({dataIn:e}),!n.decryptIn){var i=pidCryptUtil.decodeBase64(n.dataIn);0==i.indexOf("Salted__")&&(i=i.substr(16)),t.setParams({decryptIn:pidCryptUtil.toByteArray(i)})}var r=this.decryptRaw();return n.UTF8&&(r=pidCryptUtil.decodeUTF8(r)),t.isDebug()&&t.appendDebug("Removed Padding after decryption:"+pidCryptUtil.convertToHex(r)+":"+r.length+"\n"),t.setParams({dataOut:r}),!t.isDebug()&&t.clear&&t.clearParams(),r||""},pidCrypt.AES.CBC.prototype.decryptText=function(e,t,n){return this.initDecrypt(e,t,n),this.decrypt()}),ABINEMASKME.define("pidcrypt",function(){return pidCrypt.util=pidCryptUtil,pidCrypt.AES.CBC.prototype.encrypt=function(e){var t=this.pidcrypt,n=t.getParams();e||(e=n.dataIn),n.UTF8&&(e=pidCryptUtil.encodeUTF8(e)),t.setParams({dataIn:e,encryptIn:pidCryptUtil.toByteArray(e)});var i=this.encryptRaw();return i=pidCryptUtil.encodeBase64(i),t.setParams({dataOut:i}),!t.isDebug()&&t.clear&&t.clearParams(),i||""},pidCrypt.AES.CBC.prototype.decryptRaw=function(e){var t=this.aes,n=this.pidcrypt,i=n.getParams();if(e||(e=i.decryptIn),n.setParams({decryptIn:e}),i.dataIn||n.setParams({dataIn:e}),i.iv.length/2<i.blockSize)throw"incomplete parameters";var r=pidCryptUtil.convertFromHex(i.iv);if(0!=e.length%i.blockSize)throw"wrong length for aes-cbc mode";for(var a=Math.floor(i.nBits/8),o=new Array(a),s=pidCryptUtil.convertFromHex(i.key),c=0;a>c;c++)o[c]=isNaN(s.charCodeAt(c))?0:s.charCodeAt(c);for(var u=t.expandKey(o),d=Math.ceil(e.length/i.blockSize),l=new Array(d.length),h=pidCryptUtil.toByteArray(r),f=[],p=[],m=0;d>m;m++)f=e.slice(m*i.blockSize,m*i.blockSize+i.blockSize),p=t.decrypt(f,u),l[m]=pidCryptUtil.byteArray2String(t.xOr_Array(h,p)),h=f.slice();var g=l.join("");n.isDebug()&&n.appendDebug("Padding after decryption:"+pidCryptUtil.convertToHex(g)+":"+g.length+"\n");var y=g.charCodeAt(g.length-1);if(i.A0_PAD)g=g.substr(0,g.length-(y+1));else{var v=g.length-(g.length-y),b=g.charCodeAt(g.length-y);y==b&&y==v&&(g=g.substr(0,g.length-y))}return n.setParams({dataOut:g,decryptOut:g}),!n.isDebug()&&n.clear&&n.clearParams(),g||""},pidCrypt}),ABINEMASKME.define("abine/crypto",["pidcrypt","abine/eventLogger"],function(e){function t(t){return e.MD5(t)}function n(t){return e.SHA256(t)}function i(t){return e.SHA1(t)}function r(t,n){var i=new e.AES.CBC;i.init(t,{salt:n,clear:!1});var r=i.pidcrypt.getParams();return{key:r.key,iv:r.iv,salt:n}}function a(t,n){var i=new e.AES.CBC;i.initByValues("",t.key,t.iv,{salt:t.salt});try{return i.encrypt(n)}catch(r){}return n}function o(t,n){var i=new e.AES.CBC;i.initByValues("",t.key,t.iv,{salt:t.salt});try{return i.decrypt(n)}catch(r){}return n}function s(){return c.convertToHex(c.byteArray2String((new e).getRandomBytes(8)))}var c=e.util;return{md5:t,sha256:n,sha1:i,salt:s,createKeyAndIV:r,encrypt:a,decrypt:o}}),/**
 * Copyright (c) 2010 Zef Hemel <zef@zef.me>
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
ABINEMASKME.define("persistence",[],function(){function initPersistence(e){if(e.isImmutable)return e;e.isImmutable=function(e){return"id"==e},e.defineProp=function(e,t,n,i){e.__defineSetter__(t,function(e){n(e)}),e.__defineGetter__(t,function(){return i()})},e.set=function(t,n,i){if(e.isImmutable(n))throw new Error("immutable field: "+n);t[n]=i},e.get=function(e,t){return 1==arguments.length?e:e[t]},function(){function n(e){return E[e]}function i(e){this.trackedObjects={},this.trackedObjectsByEntity={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.conn=e}function r(i){function a(n,r){var a=t.getArgs(arguments,[{name:"session",optional:!0,check:e.isSession,defaultValue:e},{name:"obj",optional:!0,check:function(e){return e},defaultValue:{}}]);if(c.isMixin)throw new Error("Cannot instantiate mixin");n=a.session,r=a.obj;var s=this;this.id=r.id||e.createUUID(),this._new=!0,this._type=i,this._dirtyProperties={},this._data={},this._data_obj={},this._session=n||e,this.subscribers={};for(var u in c.fields)(function(){if(c.fields.hasOwnProperty(u)){var t=u;e.defineProp(s,t,function(e){var i=s._data[t];(i!==e||i&&e&&i.getTime&&e.getTime)&&(s._data[t]=e,s._dirtyProperties[t]=i,s.triggerEvent("set",s,t,e),s.triggerEvent("change",s,t,e),n.propertyChanged(s,t,i,e))},function(){return s._data[t]}),s._data[u]=o(c.fields[u])}})();for(var d in c.hasOne)c.hasOne.hasOwnProperty(d)&&function(){var t=d,i=c.hasOne[d].type.meta.isMixin?t+"_class":null;e.defineProp(s,t,function(e){var r=s._data[t],a=s._data_obj[t]||n.trackedObjects[s._data[t]];if(null==e?(s._data[t]=null,s._data_obj[t]=void 0,i&&(s[i]="")):e.id?(s._data[t]=e.id,s._data_obj[t]=e,i&&(s[i]=e._type),n.add(e),n.add(s)):s._data[t]=e,s._dirtyProperties[t]=r,s.triggerEvent("set",s,t,e),s.triggerEvent("change",s,t,e),c.hasOne[t].inverseProperty){var o=s[t];if(o){var u=o[c.hasOne[t].inverseProperty];u.list&&u._filter&&u.triggerEvent("change",s,t,e)}if(a){var u=a[c.hasOne[t].inverseProperty];u.list&&u._filter&&u.triggerEvent("change",s,t,e)}}},function(){if(s._data[t]){if(void 0!==s._data_obj[t])return s._data_obj[t];if(s._data[t]&&n.trackedObjects[s._data[t]])return s._data_obj[t]=n.trackedObjects[s._data[t]],s._data_obj[t];throw new Error("Property '"+t+"' of '"+c.name+"' with id: "+s._data[t]+" not fetched, either prefetch it or fetch it manually.")}return null})}();for(var d in c.hasMany)c.hasMany.hasOwnProperty(d)&&function(){var t=d;c.hasMany[t].manyToMany?e.defineProp(s,t,function(n){if(!n||!n._items)throw new Error("Not yet supported.");for(var i=n._items,r=0;i.length>r;r++)e.get(s,t).add(i[r])},function(){if(s._data[t])return s._data[t];var i=c.hasMany[t],r=i.type.meta,a=r.hasMany[i.inverseProperty],o=i.mixin?i.mixin.meta.name:c.name,u=a.mixin?a.mixin.meta.name:r.name,d=new e.ManyToManyDbQueryCollection(n,r.name);return d.initManyToMany(s,t),d._manyToManyFetch={table:i.tableName,prop:o+"_"+t,inverseProp:u+"_"+i.inverseProperty,id:s.id},s._data[t]=d,n.uniqueQueryCollection(d)}):e.defineProp(s,t,function(n){if(!n||!n._items)throw new Error("Not yet supported.");for(var i=n._items,r=0;i.length>r;r++)e.get(s,t).add(i[r])},function(){if(s._data[t])return s._data[t];var i=n.uniqueQueryCollection(new e.DbQueryCollection(n,c.hasMany[t].type.meta.name).filter(c.hasMany[t].inverseProperty,"=",s));return s._data[t]=i,i})}();this.initialize&&this.initialize();for(var l in r)r.hasOwnProperty(l)&&"id"!==l&&e.set(s,l,r[l])}function s(t,i,r,a){t._session;var o=[],c=n(t._type),u=c.fields;for(var d in r)r.hasOwnProperty(d)&&o.push(d);var l=[],h=[];o.forEach(function(e){r[e]!==!0||c.hasMany[e]?h.push(e):l.push(e)});var f=t._data,p={};l.forEach(function(n){"id"===n?p.id=t.id:p[n]=c.hasOne[n]?f[n]?{id:f[n]}:null:e.entityValToJson(f[n],u[n])}),o=h.slice(),e.asyncForEach(o,function(n,a){c.hasOne[n]?t.fetch(i,n,function(e){e?s(e,i,r[n],function(e){p[n]=e,a()}):(p[n]=null,a())}):c.hasMany[n]&&e.get(t,n).list(function(t){p[n]=[],e.asyncForEach(t,function(e,a){var e=t.pop();r[n]===!0?(p[n].push({id:e.id}),a()):s(e,i,r[n],function(e){p[n].push(e),a()})},a)})},function(){a(p)})}if(A[i])return A[i];var c=E[i];a.prototype=new d,a.meta=c,a.prototype.equals=function(e){return this.id==e.id},a.prototype.toJSON=function(){var e={id:this.id};for(var t in this._data)this._data.hasOwnProperty(t)&&("object"==typeof this._data[t]&&null!=this._data[t]?void 0!=this._data[t].toJSON&&(e[t]=this._data[t].toJSON()):e[t]=this._data[t]);return e},a.prototype.selectJSON=function(n,i,r){var a=this,o=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]);if(n=o.tx,i=o.props,r=o.callback,!n)return this._session.transaction(function(e){a.selectJSON(e,i,r)}),void 0;var u={};i.forEach(function(e){for(var t=u,n=e.split("."),i=0;n.length>i;i++){var r=n[i];if(i===n.length-1)if("*"===r){t.id=!0;for(var a in c.fields)c.fields.hasOwnProperty(a)&&(t[a]=!0);for(var a in c.hasOne)c.hasOne.hasOwnProperty(a)&&(t[a]=!0);for(var a in c.hasMany)c.hasMany.hasOwnProperty(a)&&(t[a]=!0)}else if("["===r[0]){r=r.substring(1,r.length-1);var o=r.split(/,\s*/);o.forEach(function(e){t[e]=!0})}else t[r]=!0;else t[r]=t[r]||{},t=t[r]}}),s(this,n,u,r)},a.prototype.fetch=function(n,i,a){var o=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"rel",optional:!1,check:t.hasType("string")},{name:"callback",optional:!1,check:t.isCallback()}]);n=o.tx,i=o.rel,a=o.callback;var s=this,u=this._session;if(!n)return u.transaction(function(e){s.fetch(e,i,a)}),void 0;if(this._data[i])if(this._data_obj[i])a&&a(this._data_obj[i]);else{var d=c.hasOne[i].type;d.meta.isMixin&&(d=r(this._data[i+"_class"])),d.load(u,n,this._data[i],function(e){s._data_obj[i]=e,a&&a(e)})}else a&&a(null)},a.prototype.markDirty=function(e){this._dirtyProperties[e]=!0},a.all=function(n){var r=t.getArgs(arguments,[{name:"session",optional:!0,check:e.isSession,defaultValue:e}]);return n=r.session,n.uniqueQueryCollection(new y(n,i))},a.query=function(t,n){e.transaction(function(e){var r="";t&&(r=" where "+t),e.executeSql("SELECT * FROM "+i+r,null,function(e){n(e)})})},a.deleteQuery=function(t,n){e.transaction(function(e){var r="";t&&(r=" where "+t),e.executeSql("DELETE FROM "+i+r,null,function(e){n(e)})})},a.fromSelectJSON=function(n,i,r,o){function s(t){t||(t=new a(n),r.id&&(t.id=r.id)),n.add(t);var s=[];for(var u in r)if(r.hasOwnProperty(u)){if("id"===u)continue;c.fields[u]?e.set(t,u,e.jsonToEntityVal(r[u],c.fields[u])):(c.hasOne[u]||c.hasMany[u])&&s.push(u)}e.asyncForEach(s,function(a,o){if(c.hasOne[a])c.hasOne[a].type.fromSelectJSON(n,i,r[a],function(n){e.set(t,a,n),o()});else if(c.hasMany[a]){var s=e.get(t,a),u=r[a].slice(0),d=c.hasMany[a].type;s.list(i,function(t){e.asyncForEach(u,function(e,r){d.fromSelectJSON(n,i,e,function(e){for(var n=0;t.length>n;n++)if(t[n].id===e.id)return r(),void 0;s.add(e),r()})},function(){o()})})}},function(){o(t)})}var u=t.getArgs(arguments,[{name:"session",optional:!0,check:e.isSession,defaultValue:e},{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"jsonObj",optional:!1},{name:"callback",optional:!1,check:t.isCallback()}]);return n=u.session,i=u.tx,r=u.jsonObj,o=u.callback,i?("string"==typeof r&&(r=JSON.parse(r)),r?(r.id?a.load(n,i,r.id,s):s(new a(n)),void 0):(o(null),void 0)):(n.transaction(function(e){a.fromSelectJSON(n,e,r,o)}),void 0)},a.load=function(){var n=t.getArgs(arguments,[{name:"session",optional:!0,check:e.isSession,defaultValue:e},{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"id",optional:!1,check:t.hasType("string")},{name:"callback",optional:!0,check:t.isCallback(),defaultValue:function(){}}]);a.findBy(n.session,n.tx,"id",n.id,n.callback)},a.findBy=function(n,i,r,o,s){var c=t.getArgs(arguments,[{name:"session",optional:!0,check:e.isSession,defaultValue:e},{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"property",optional:!1,check:t.hasType("string")},{name:"value",optional:!1},{name:"callback",optional:!0,check:t.isCallback(),defaultValue:function(){}}]);if(n=c.session,i=c.tx,r=c.property,o=c.value,s=c.callback,"id"===r&&o in n.trackedObjects)return s(n.trackedObjects[o]),void 0;var u=a.meta;if(u.alternatePK&&r===u.alternatePK&&n.trackedObjectsByEntity){var d=u.name+"."+u.alternatePK;if(!(d in n.trackedObjectsByEntity&&o in n.trackedObjectsByEntity[d]))return a.cached?(s(null),void 0):(a.initCache(function(){a.findBy(n,i,r,o,s)}),void 0);if(n.trackedObjectsByEntity[d][o]in n.trackedObjects)return s(n.trackedObjects[n.trackedObjectsByEntity[d][o]]),void 0;delete n.trackedObjectsByEntity[d][o]}return i?(u.secured&&u.secureMode==e.security.TABLE_SALT&&r in u.secureFieldsMap&&(o=a.encryptedQueryValue(o)),a.all(n).filter(r,"=",o).one(i,function(e){s(e)}),void 0):(n.transaction(function(e){a.findBy(n,e,r,o,s)}),void 0)},a.index=function(e,t){var n=t||{};"string"==typeof e&&(e=[e]),n.columns=e,c.indexes.push(n)},a.hasMany=function(t,n,i){var r=n.meta;if(r.hasMany[i]){var o=c.name+"_"+t+"_"+r.name,s=r.name+"_"+i+"_"+c.name;o>s&&(o=s),c.hasMany[t]={type:n,inverseProperty:i,manyToMany:!0,tableName:o},r.hasMany[i]={type:a,inverseProperty:t,manyToMany:!0,tableName:o},delete c.hasOne[t],delete c.fields[t+"_class"]}else c.hasMany[t]={type:n,inverseProperty:i},r.hasOne[i]={type:a,inverseProperty:t},c.isMixin&&(r.fields[i+"_class"]=e.typeMapper?e.typeMapper.classNameType:"TEXT")},a.hasOne=function(t,n,i){c.hasOne[t]={type:n,inverseProperty:i},n.meta.isMixin&&(c.fields[t+"_class"]=e.typeMapper?e.typeMapper.classNameType:"TEXT")},a.is=function(e){var t=e.meta;if(!t.isMixin)throw new Error("not a mixin: "+e);e.meta.mixedIns=e.meta.mixedIns||[],e.meta.mixedIns.push(c);for(var n in t.fields)t.fields.hasOwnProperty(n)&&(c.fields[n]=t.fields[n]);for(var i in t.hasOne)t.hasOne.hasOwnProperty(i)&&(c.hasOne[i]=t.hasOne[i]);for(var i in t.hasMany)t.hasMany.hasOwnProperty(i)&&(t.hasMany[i].mixin=e,c.hasMany[i]=t.hasMany[i])};for(var u=e.entityDecoratorHooks,l=0;u.length>l;l++)u[l](a);return A[i]=a,a}function a(){if(e.typeMapper&&e.typeMapper.newUuid)return e.typeMapper.newUuid();for(var t=[],n="0123456789ABCDEF",i=0;32>i;i++)t[i]=n.substr(Math.floor(16*Math.random()),1);t[12]="4",t[16]=n.substr(8|3&t[16],1);var r=t.join("");return r}function o(t){if(e.typeMapper&&e.typeMapper.defaultValue)return e.typeMapper.defaultValue(t);switch(t){case"TEXT":return"";case"BOOL":return!1;default:return-1!==t.indexOf("INT")?0:-1!==t.indexOf("CHAR")?"":null}}function s(e,t){for(var n=e.length,i=0;n>i;i++){var r=e[i];if(r.equals&&r.equals(t))return!0;if(r===t)return!0}return!1}function c(e,t){for(var n=e.length,i=0;n>i;i++){var r=e[i];if(r.equals&&r.equals(t))return e.splice(i,1),void 0;if(r===t)return e.splice(i,1),void 0}}function u(e,t,n){this.obj=e,this.eventType=t,this.fn=n}function d(){this.subscribers={}}function l(){}function h(e,t){this.left=e,this.right=t}function f(e,t){this.left=e,this.right=t}function p(e,t,n){this.property=e,this.operator=t.toLowerCase(),this.value=n}function m(){}function g(e,t){this.init(e,t,g)}function y(e,t){this.init(e,t,y)}function v(t,n){this.init(t,n,e.ManyToManyDbQueryCollection),this._localAdded=[],this._localRemoved=[]}function b(t){this.init(e,null,b),this._items=t||[]}var E={},A={};e.getEntityMeta=function(){return E},e.trackedObjects={},e.trackedObjectsByEntity={},e.objectsToRemove={},e.objectsRemoved=[],e.globalPropertyListeners={},e.queryCollectionCache={},e.getObjectsToRemove=function(){return this.objectsToRemove},e.getTrackedObjects=function(){return this.trackedObjects},e.entityDecoratorHooks=[],e.flushHooks=[],e.schemaSyncHooks=[],e.debug=!1,e.subscribeToGlobalPropertyListener=function(e,t,n){var i=t+"__"+n;if(i in this.globalPropertyListeners){for(var r=this.globalPropertyListeners[i],a=0;r.length>a;a++)if(r[a]===e)return;this.globalPropertyListeners[i].push(e)}else this.globalPropertyListeners[i]=[e]},e.unsubscribeFromGlobalPropertyListener=function(e,t,n){for(var i=t+"__"+n,r=this.globalPropertyListeners[i],a=0;r.length>a;a++)if(r[a]===e)return r.splice(a,1),void 0},e.propertyChanged=function(e,t,n,i){if(this.trackedObjects[e.id]){var r=e._type,a=r+"__"+t;if(a in this.globalPropertyListeners)for(var o=this.globalPropertyListeners[a],s=0;o.length>s;s++){var c=o[s],u=e._data;u[t]=n;var d=c._filter.match(u);u[t]=i;var l=c._filter.match(u);d!=l&&c.triggerEvent("change",c,e)}}},e.objectRemoved=function(e){var t=e._type;if(this.queryCollectionCache[t]){var n=this.queryCollectionCache[t];for(var i in n)if(n.hasOwnProperty(i)){var r=n[i];r._filter.match(e)&&r.triggerEvent("change",r,e)}}},e.getMeta=n,i.prototype=e,e.Session=i,e.undefine=function(e){A[e]&&delete A[e],e in E&&delete E[e]},e.define=function(e,t){if(E[e])return r(e);var n={name:e,fields:t,isMixin:!1,indexes:[],hasMany:{},hasOne:{}};return E[e]=n,r(e)},e.isDefined=function(e){return!!E[e]},e.defineMixin=function(e,t){var n=this.define(e,t);return n.meta.isMixin=!0,n},e.isTransaction=function(e){return!e||e&&e.executeSql},e.isSession=function(e){return!e||e&&e.schemaSync},e.addToEntityCache=function(e){var t=A[e._type];if(t.meta.cached){var n=t.meta.alternatePK||"id";if(n){var i=e._type+"."+n;i in this.trackedObjectsByEntity||(this.trackedObjectsByEntity[i]={}),this.trackedObjectsByEntity[i][e[n]]=e.id}}},e.clearFromEntityCache=function(e){if(e){var t=A[e._type];if(t.meta.cached){var n=t.meta.alternatePK||"id";if(n){var i=e._type+"."+n;i in this.trackedObjectsByEntity&&e.id==this.trackedObjectsByEntity[i][e[n]]&&delete this.trackedObjectsByEntity[i][e[n]]}}}},e.getEntityByAlternatePK=function(e,t){var n=e.meta.alternatePK;if(n){var i=e.meta.name+"."+n;if(i in this.trackedObjectsByEntity&&t in this.trackedObjectsByEntity[i])return this.trackedObjects[this.trackedObjectsByEntity[i][t]]}return null},e.getCachedEntities=function(e){var t=[];if(e.meta.cached){var n=e.meta.alternatePK||"id";if(n){var i=e.meta.name+"."+n;if(i in this.trackedObjectsByEntity){var r=this.trackedObjectsByEntity[i];for(var a in r)r[a]in this.trackedObjects?t.push(this.trackedObjects[r[a]]):delete r[a]}}}return t},e.add=function(e){if(e){if(!this.trackedObjects[e.id]&&(this.trackedObjects[e.id]=e,this.addToEntityCache(e),e._new))for(var t in e._data)e._data.hasOwnProperty(t)&&this.propertyChanged(e,t,void 0,e._data[t]);return this}},e.forceAdd=function(t){if(t){if(!this.trackedObjects[t.id]||this.trackedObjects[t.id]!=t){var n=A[t._type];if(n.meta.cached){var i=n.meta.alternatePK;if(i){var r=e.getEntityByAlternatePK(n,t[i]);!r||r.id in this.objectsToRemove||r.id!=t.id&&(t.id=r.id)}}if(this.trackedObjects[t.id]=t,this.addToEntityCache(t),t._new)for(var a in t._data)t._data.hasOwnProperty(a)&&this.propertyChanged(t,a,void 0,t._data[a])}return this}},e.remove=function(e){return this.objectsToRemove[e.id]||(this.objectsToRemove[e.id]=e),this.objectsRemoved.push({id:e.id,entity:e._type}),this.objectRemoved(e),this},e.clean=function(){this.trackedObjects={},this.objectsToRemove={},this.objectsRemoved=[],this.globalPropertyListeners={},this.queryCollectionCache={},this.trackedObjectsByEntity={},e.GlobalEvent.triggerEvent("clean")},e.asyncForEach=function(e,t,n){function i(){var r=e.pop();t(r,function(t,r){e.length>0?i():n(t,r)})}e=e.slice(0),e.length>0?i():n()},e.asyncParForEach=function(e,t,n){var i=0,r=e.length;0===r&&n();for(var a=0;r>a;a++)t(e[a],function(e,t){i++,i===r&&n(e,t)})},e.jsonToEntityVal=function(e,t){if(!t)return e;switch(t){case"DATE":return"number"==typeof e?e>1e12?new Date(e):new Date(1e3*e):null;default:return e}},e.entityValToJson=function(e,t){if(!t)return e;switch(t){case"DATE":return e?(e=new Date(e),Math.round(e.getTime()/1e3)):null;default:return e}},e.dump=function(n,i,r){var a=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(e){return!e||e&&e.length&&!e.apply},defaultValue:null},{name:"callback",optional:!1,check:t.isCallback(),defaultValue:function(){}}]);if(n=a.tx,i=a.entities,r=a.callback,!i){i=[];for(var o in A)A.hasOwnProperty(o)&&i.push(A[o])}var s={};e.asyncParForEach(i,function(t,i){t.all().list(n,function(r){var a=[];e.asyncParForEach(r,function(i,r){var o={},s=t.meta.fields;for(var c in s)s.hasOwnProperty(c)&&(o[c]=e.entityValToJson(i._data[c],s[c]));var u=t.meta.hasOne;for(var d in u)u.hasOwnProperty(d)&&(o[d]=i._data[d]);var l=t.meta.hasMany,h=[];for(var f in l)l.hasOwnProperty(f)&&h.push(f);e.asyncParForEach(h,function(t,r){var a=e.get(i,t);a.list(n,function(e){o[t]=e.map(function(e){return e.id}),r()})},function(){o.id=i.id,a.push(o),r()})},function(){s[t.meta.name]=a,i()})})},function(){r(s)})},e.load=function(n,i,a){var o=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"dump",optional:!1},{name:"callback",optional:!0,check:t.isCallback(),defaultValue:function(){}}]);n=o.tx,i=o.dump,a=o.callback;var s=[],c=this;for(var u in i)if(i.hasOwnProperty(u))for(var d=r(u),l=d.meta.fields,h=i[u],f=0;h.length>f;f++){var p=h[f],m=new d;m.id=p.id;for(var g in p)if(p.hasOwnProperty(g))if(e.isImmutable(g))m[g]=p[g];else if(d.meta.hasMany[g]){var y=d.meta.hasMany[g];if(y.manyToMany&&d.meta.name<y.type.meta.name)continue;var v=e.get(m,g);p[g].length>0&&p[g].forEach(function(e){s.push({Entity:d,coll:v,id:e})})}else e.set(m,g,e.jsonToEntityVal(p[g],l[g]));this.add(m)}c.flush(n,function(){e.asyncForEach(s,function(e,t){e.Entity.load(c,n,e.id,function(n){e.coll.add(n),t()})},function(){c.flush(n,a)})})},e.dumpToJson=function(n,i,r){var a=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"entities",optional:!0,check:function(e){return e&&e.length&&!e.apply},defaultValue:null},{name:"callback",optional:!1,check:t.isCallback(),defaultValue:function(){}}]);n=a.tx,i=a.entities,r=a.callback,this.dump(n,i,function(e){r(JSON.stringify(e))})},e.dumpDatabaseForSync=function(n,i){var r=t.getArgs(arguments,[{name:"entities",optional:!1,check:function(e){return e},defaultValue:null},{name:"callback",optional:!1,check:t.isCallback(),defaultValue:function(){}}]);n=r.entities,i=r.callback,ABINEMASKME.require(["documentcloud/underscore"],function(t){var r={};t.async.forEach(t.keys(n),function(t,i){e.transaction(function(e){var a="";"all"!=n[t]&&(a=" where "+n[t]),e.executeSql("SELECT * FROM "+t+a,null,function(e){r[t]=e,i()})})},function(){i(r)})})},e.loadFromJson=function(n,i,r){var a=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"jsonDump",optional:!1},{name:"callback",optional:!0,check:t.isCallback(),defaultValue:function(){}}]);n=a.tx,i=a.jsonDump,r=a.callback,this.load(n,JSON.parse(i),r)},e.createUUID=a,u.prototype.unsubscribe=function(){this.obj.removeEventListener(this.eventType,this.fn)},d.prototype.addEventListener=function(e,t){return this.subscribers[e]||(this.subscribers[e]=[]),this.subscribers[e].push(t),new u(this,e,t)},d.prototype.removeEventListener=function(e,t){for(var n=this.subscribers[e],i=0;n.length>i;i++)if(n[i]==t)return this.subscribers[e].splice(i,1),!0;return!1},d.prototype.triggerEvent=function(e){if(this.subscribers[e])for(var t=this.subscribers[e].slice(0),n=0;t.length>n;n++)t[n].apply(null,arguments)},l.prototype.match=function(){return!0},l.prototype.makeFit=function(){},l.prototype.makeNotFit=function(){},l.prototype.toUniqueString=function(){return"NULL"},l.prototype.subscribeGlobally=function(){},l.prototype.unsubscribeGlobally=function(){},h.prototype.match=function(e){return this.left.match(e)&&this.right.match(e)},h.prototype.makeFit=function(e){this.left.makeFit(e),this.right.makeFit(e)},h.prototype.makeNotFit=function(e){this.left.makeNotFit(e),this.right.makeNotFit(e)},h.prototype.toUniqueString=function(){return this.left.toUniqueString()+" AND "+this.right.toUniqueString()},h.prototype.subscribeGlobally=function(e,t){this.left.subscribeGlobally(e,t),this.right.subscribeGlobally(e,t)},h.prototype.unsubscribeGlobally=function(e,t){this.left.unsubscribeGlobally(e,t),this.right.unsubscribeGlobally(e,t)},f.prototype.match=function(e){return this.left.match(e)||this.right.match(e)},f.prototype.makeFit=function(e){this.left.makeFit(e),this.right.makeFit(e)},f.prototype.makeNotFit=function(e){this.left.makeNotFit(e),this.right.makeNotFit(e)},f.prototype.toUniqueString=function(){return this.left.toUniqueString()+" OR "+this.right.toUniqueString()},f.prototype.subscribeGlobally=function(e,t){this.left.subscribeGlobally(e,t),this.right.subscribeGlobally(e,t)},f.prototype.unsubscribeGlobally=function(e,t){this.left.unsubscribeGlobally(e,t),this.right.unsubscribeGlobally(e,t)},p.prototype.match=function(t){var n=this.value,i=e.get(t,this.property);switch(n&&n.getTime&&(n=1e3*Math.round(n.getTime()/1e3),i&&i.getTime&&(i=1e3*Math.round(i.getTime()/1e3))),this.operator){case"=":return i===n;case"!=":return i!==n;case"<":return n>i;case"<=":return n>=i;case">":return i>n;case">=":return i>=n;case"in":return s(n,i);case"not in":return!s(n,i)}},p.prototype.makeFit=function(t){if("="!==this.operator)throw new Error("Sorry, can't perform makeFit for other filters than =");e.set(t,this.property,this.value)},p.prototype.makeNotFit=function(t){if("="!==this.operator)throw new Error("Sorry, can't perform makeNotFit for other filters than =");e.set(t,this.property,null)},p.prototype.subscribeGlobally=function(t,n){e.subscribeToGlobalPropertyListener(t,n,this.property)},p.prototype.unsubscribeGlobally=function(t,n){e.unsubscribeFromGlobalPropertyListener(t,n,this.property)},p.prototype.toUniqueString=function(){var e=this.value;return e&&e._type&&(e=e.id),this.property+this.operator+e},e.NullFilter=l,e.AndFilter=h,e.OrFilter=f,e.PropertyFilter=p,e.uniqueQueryCollection=function(e){var t=e._entityName;if(e._items)return e;this.queryCollectionCache[t]||(this.queryCollectionCache[t]={});var n=e.toUniqueString();return this.queryCollectionCache[t][n]||(this.queryCollectionCache[t][n]=e),this.queryCollectionCache[t][n]},m.prototype=new d,m.prototype.oldAddEventListener=m.prototype.addEventListener,m.prototype.setupSubscriptions=function(){this._filter.subscribeGlobally(this,this._entityName)},m.prototype.teardownSubscriptions=function(){this._filter.unsubscribeGlobally(this,this._entityName)},m.prototype.addEventListener=function(e,t){var n=this,i=this.oldAddEventListener(e,t);return 1===this.subscribers[e].length&&this.setupSubscriptions(),i.oldUnsubscribe=i.unsubscribe,i.unsubscribe=function(){this.oldUnsubscribe(),0===n.subscribers[e].length&&n.teardownSubscriptions()},i},m.prototype.persistQueries=function(){return[]},m.prototype.init=function(t,n,i){this._filter=new l,this._orderColumns=[],this._prefetchFields=[],this._entityName=n,this._constructor=i,this._limit=-1,this._skip=0,this._reverse=!1,this._session=t||e,this.subscribers={}},m.prototype.toUniqueString=function(){var e=this._constructor.name+": "+this._entityName;e+="|Filter:";var t=[];e+=this._filter.toUniqueString(),e+="|Values:";for(var n=0;t.length>n;n++)e+=t+"|^|";e+="|Order:";for(var n=0;this._orderColumns.length>n;n++){var i=this._orderColumns[n];e+=i[0]+", "+i[1]+", "+i[2]}e+="|Prefetch:";for(var n=0;this._prefetchFields.length>n;n++)e+=this._prefetchFields[n];return e+="|Limit:",e+=this._limit,e+="|Skip:",e+=this._skip,e+="|Reverse:",e+=this._reverse},m.prototype.clone=function(e){var t=new this._constructor(this._session,this._entityName);if(t._filter=this._filter,t._prefetchFields=this._prefetchFields.slice(0),t._orderColumns=this._orderColumns.slice(0),t._limit=this._limit,t._skip=this._skip,t._reverse=this._reverse,e){var n={};for(var i in this.subscribers)this.subscribers.hasOwnProperty(i)&&(n[i]=this.subscribers[i].slice(0));t.subscribers=n}else t.subscribers=this.subscribers;return t},m.prototype.filter=function(e,t,n){var i=this.clone(!0);i._filter=new h(this._filter,new p(e,t,n));var r=this._session;return i=r.uniqueQueryCollection(i),r.uniqueQueryCollection(i)},m.prototype.or=function(e){var t=this.clone(!0);return t._filter=new f(this._filter,e),this._session.uniqueQueryCollection(t)},m.prototype.and=function(e){var t=this.clone(!0);return t._filter=new h(this._filter,e),this._session.uniqueQueryCollection(t)},m.prototype.order=function(e,t,n){t=void 0===t?!0:t,n=void 0===n?!0:n;var i=this.clone();return i._orderColumns.push([e,t,n]),this._session.uniqueQueryCollection(i)},m.prototype.limit=function(e){var t=this.clone();return t._limit=e,this._session.uniqueQueryCollection(t)},m.prototype.skip=function(e){var t=this.clone();return t._skip=e,this._session.uniqueQueryCollection(t)},m.prototype.reverse=function(){var e=this.clone();return e._reverse=!0,this._session.uniqueQueryCollection(e)},m.prototype.prefetch=function(e){var t=this.clone();return t._prefetchFields.push(e),this._session.uniqueQueryCollection(t)},m.prototype.selectJSON=function(n,i,a){var o=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"props",optional:!1},{name:"callback",optional:!1}]),s=this._session,c=this;return n=o.tx,i=o.props,a=o.callback,n?(r(this._entityName),this.list(function(t){var r=[];e.asyncForEach(t,function(e,t){e.selectJSON(n,i,function(e){r.push(e),t()})},function(){a(r)})}),void 0):(s.transaction(function(e){c.selectJSON(e,i,a)}),void 0)},m.prototype.add=function(e){if(!e.id||!e._type)throw new Error("Cannot add object of non-entity type onto collection.");this._session.add(e),this._filter.makeFit(e),this.triggerEvent("add",this,e),this.triggerEvent("change",this,e)},m.prototype.addAll=function(e){for(var t=0;e.length>t;t++){var n=e[t];this._session.add(n),this._filter.makeFit(n),this.triggerEvent("add",this,n)}this.triggerEvent("change",this)},m.prototype.remove=function(e){if(!e.id||!e._type)throw new Error("Cannot remove object of non-entity type from collection.");this._filter.makeNotFit(e),this.triggerEvent("remove",this,e),this.triggerEvent("change",this,e)},m.prototype.each=function(n,i){var r=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"eachFn",optional:!0,check:t.isCallback()}]);n=r.tx,i=r.eachFn,this.list(n,function(e){for(var t=0;e.length>t;t++)i(e[t])})},m.prototype.forEach=m.prototype.each,m.prototype.one=function(n,i){var r=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"oneFn",optional:!1,check:t.isCallback()}]);n=r.tx,i=r.oneFn,this.limit(1).list(n,function(e){0===e.length?i(null):i(e[0])})},g.prototype=new m,y.prototype=new g,y.prototype.add=function(e){this._session.add(e),this.triggerEvent("add",this,e),this.triggerEvent("change",this,e)},y.prototype.remove=function(e){this._session.remove(e),this.triggerEvent("remove",this,e),this.triggerEvent("change",this,e)},v.prototype=new g,v.prototype.initManyToMany=function(e,t){this._obj=e,this._coll=t},v.prototype.add=function(e){s(this._localAdded,e)||(this._session.add(e),this._localAdded.push(e),this.triggerEvent("add",this,e),this.triggerEvent("change",this,e))},v.prototype.addAll=function(e){for(var t=0;e.length>t;t++){var n=e[t];s(this._localAdded,n)||(this._session.add(n),this._localAdded.push(n),this.triggerEvent("add",this,n))}this.triggerEvent("change",this)},v.prototype.clone=function(){var e=g.prototype.clone.call(this);return e._localAdded=this._localAdded,e._localRemoved=this._localRemoved,e._obj=this._obj,e._coll=this._coll,e},v.prototype.remove=function(e){s(this._localAdded,e)?c(this._localAdded,e):s(this._localRemoved,e)||this._localRemoved.push(e),this.triggerEvent("remove",this,e),this.triggerEvent("change",this,e)},b.prototype=new m,b.prototype.clone=function(){var e=g.prototype.clone.call(this);return e._items=this._items,e},b.prototype.add=function(e){s(this._items,e)||(this._session.add(e),this._items.push(e),this.triggerEvent("add",this,e),this.triggerEvent("change",this,e))},b.prototype.addAll=function(e){for(var t=0;e.length>t;t++){var n=e[t];s(this._items,n)||(this._session.add(n),this._items.push(n),this.triggerEvent("add",this,n))}this.triggerEvent("change",this)},b.prototype.remove=function(e){for(var t=this._items,n=0;t.length>n;n++)t[n]===e&&(this._items.splice(n,1),this.triggerEvent("remove",this,e),this.triggerEvent("change",this,e))},b.prototype.list=function(n,i){var r=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:t.isCallback()}]);i=r.callback,(!i||i.executeSql)&&(i=arguments[1]);for(var a=this._items.slice(0),o=this,s=[],c=0;a.length>c;c++)this._filter.match(a[c])&&s.push(a[c]);return s.sort(function(t,n){for(var i=0;o._orderColumns.length>i;i++){var r=o._orderColumns[i][0],a=o._orderColumns[i][1],s=o._orderColumns[i][2],c=e.get(t,r),u=e.get(n,r);if(s||(c=c.toLowerCase(),u=u.toLowerCase()),u>c)return a?-1:1;if(c>u)return a?1:-1}return 0}),this._skip&&s.splice(0,this._skip),this._limit>-1&&(s=s.slice(0,this._limit)),this._reverse&&s.reverse(),i?(i(s),void 0):s},b.prototype.destroyAll=function(e){(!e||e.executeSql)&&(e=arguments[1]),this._items=[],this.triggerEvent("change",this),e&&e()},b.prototype.count=function(n,i){var r=t.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:t.isCallback()}]);n=r.tx,i=r.callback;var a=this.list();return i?(i(a.length),void 0):a.length},e.QueryCollection=m,e.DbQueryCollection=g,e.ManyToManyDbQueryCollection=v,e.LocalQueryCollection=b,e.Observable=d,e.Subscription=u,e.AndFilter=h,e.OrFilter=f,e.PropertyFilter=p,e.GlobalEvent=new d}();var t={};return function(){t.getArgs=function(e,t){for(var n=0,i=0,r={};t.length>i;){var a=t[i],o=e[n];if(a.optional)void 0!==o&&a.check(o)?(r[a.name]=o,n++,i++):(void 0!==a.defaultValue&&(r[a.name]=a.defaultValue),i++);else{if(a.check&&!a.check(o))throw new Error("Invalid value for argument: "+a.name+" Value: "+o);r[a.name]=o,i++,n++}}return r},t.hasProperty=function(e){return function(t){return t&&void 0!==t[e]}},t.hasType=function(e){return function(t){return typeof t===e}},t.isCallback=function(){return function(e){return e&&e.apply}}}(),e.argspec=t,e}var persistence=initPersistence("undefined"!=typeof window&&window.persistence||{});return"undefined"==typeof JSON&&(JSON={}),JSON.stringify||function(){function f(e){return 10>e?"0"+e:e}function quote(e){return escapable.lastIndex=0,escapable.test(e)?'"'+e.replace(escapable,function(e){var t=meta[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+e+'"'}function str(e,t){var n,i,r,a,o,s=gap,c=t[e];switch(c&&"object"==typeof c&&"function"==typeof c.toJSON&&(c=c.toJSON(e)),"function"==typeof rep&&(c=rep.call(t,e,c)),typeof c){case"string":return quote(c);case"number":return isFinite(c)?String(c):"null";case"boolean":case"null":return String(c);case"object":if(!c)return"null";if(gap+=indent,o=[],"[object Array]"===Object.prototype.toString.apply(c)){for(a=c.length,n=0;a>n;n+=1)o[n]=str(n,c)||"null";return r=0===o.length?"[]":gap?"[\n"+gap+o.join(",\n"+gap)+"\n"+s+"]":"["+o.join(",")+"]",gap=s,r}if(rep&&"object"==typeof rep)for(a=rep.length,n=0;a>n;n+=1)i=rep[n],"string"==typeof i&&(r=str(i,c),r&&o.push(quote(i)+(gap?": ":":")+r));else for(i in c)Object.hasOwnProperty.call(c,i)&&(r=str(i,c),r&&o.push(quote(i)+(gap?": ":":")+r));return r=0===o.length?"{}":gap?"{\n"+gap+o.join(",\n"+gap)+"\n"+s+"}":"{"+o.join(",")+"}",gap=s,r}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(e,t,n){var i;if(gap="",indent="","number"==typeof n)for(i=0;n>i;i+=1)indent+=" ";else"string"==typeof n&&(indent=n);if(rep=t,t&&"function"!=typeof t&&("object"!=typeof t||"number"!=typeof t.length))throw new Error("JSON.stringify");return str("",{"":e})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(e,t){var n,i,r=e[t];if(r&&"object"==typeof r)for(n in r)Object.hasOwnProperty.call(r,n)&&(i=walk(r,n),void 0!==i?r[n]=i:delete r[n]);return reviver.call(e,t,r)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)
})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),persistence}),ABINEMASKME.define("persistence/store/memory",["persistence"],function(e){e.store||(e.store={}),e.store.memory={},e.store.memory.config=function(e,t){function n(t){var n=r[t._entityName];return n||(n=new e.LocalQueryCollection),n=n.clone(),n._filter=t._filter,n._prefetchFields=t._prefetchFields,n._orderColumns=t._orderColumns,n._limit=t._limit,n._skip=t._skip,n._reverse=t._reverse,n}var i=e.argspec;t=t||"persistenceData";var r={};e.getAllObjects=function(){return r};var a=e.add;e.add=function(t){if(!this.trackedObjects[t.id]){a.call(this,t);var n=t._type;r[n]||(r[n]=new e.LocalQueryCollection,r[n]._session=e),r[n].add(t)}return this};var o=e.remove;e.remove=function(e){o.call(this,e);var t=e._type;r[t].remove(e)},e.schemaSync=function(){var t=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:i.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:i.hasType("boolean")}]);t.callback()},e.flush=function(t){var n=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction},{name:"callback",optional:!0,check:i.isCallback(),defaultValue:function(){}}]),r=e.flushHooks,a=this;e.asyncForEach(r,function(e,n){e(a,t,n)},function(){var t=e.trackedObjects;for(var i in t)t.hasOwnProperty(i)&&(e.objectsToRemove.hasOwnProperty(i)?delete t[i]:t[i]._dirtyProperties={});n.callback()})},e.transaction=function(e){setTimeout(function(){e({executeSql:function(){}})},0)},e.loadFromLocalStorage=function(e){var n=window.localStorage.getItem(t);n?this.loadFromJson(n,e):e&&e()},e.saveToLocalStorage=function(e){this.dumpToJson(function(n){window.localStorage.setItem(t,n),e&&e()})},e.reset=function(t,n){var a=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:i.isCallback(),defaultValue:function(){}}]);t=a.tx,n=a.callback,r={},this.clean(),n()},e.close=function(){},e.DbQueryCollection.prototype.list=function(t,r){var a=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:i.isCallback()}]);t=a.tx,r=a.callback;var o=n(this);o.list(null,r)},e.DbQueryCollection.prototype.destroyAll=function(t,r){var a=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:i.isCallback(),defaultValue:function(){}}]);t=a.tx,r=a.callback;var o=n(this);o.destroyAll(null,r)},e.DbQueryCollection.prototype.count=function(t,r){var a=i.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:i.isCallback()}]);t=a.tx,r=a.callback;var o=n(this);o.count(null,r)},e.ManyToManyDbQueryCollection=function(t,n){this.init(t,n,e.ManyToManyDbQueryCollection),this._items=[]},e.ManyToManyDbQueryCollection.prototype=new e.LocalQueryCollection,e.ManyToManyDbQueryCollection.prototype.initManyToMany=function(e,t){this._obj=e,this._coll=t},e.ManyToManyDbQueryCollection.prototype.add=function(t,n){if(e.LocalQueryCollection.prototype.add.call(this,t),!n){var i=e.getMeta(this._obj._type),r=i.hasMany[this._coll].inverseProperty;e.get(t,r).add(this._obj,!0)}},e.ManyToManyDbQueryCollection.prototype.remove=function(t,n){if(e.LocalQueryCollection.prototype.remove.call(this,t),!n){var i=e.getMeta(this._obj._type),r=i.hasMany[this._coll].inverseProperty;e.get(t,r).remove(this._obj,!0)}}}}),ABINEMASKME.define("persistence/store/sql",["persistence","abine/eventLogger"],function(e,t){function n(e,n){function r(t,n,i,r){if(r=r||"",t.trackedObjects[i[r+"id"]])return t.trackedObjects[i[r+"id"]];var a=e.typeMapper,o=e.getMeta(n),s=e.define(n);if(!i[r+"id"])return null;var c=new s(t,void 0,!0);c.id=a.dbValToEntityVal(i[r+"id"],a.idType),c._new=!1;for(var u in i)if(i.hasOwnProperty(u)&&u.substring(0,r.length)===r){var d=u.substring(r.length);"id"!=d&&(c._data[d]=a.dbValToEntityVal(i[u],o.fields[d]||a.idType))}return s.meta.secured&&s.decrypt(c),c}function a(t,n,i){var r=e.getMeta(t._type),a=e.typeMapper,o=[],c=[],u=[],d=[],l=[];if(t._new)for(var h in r.fields)r.fields.hasOwnProperty(h)&&(t._dirtyProperties[h]=!0,l.push(h));else for(var h in t._dirtyProperties)t._dirtyProperties.hasOwnProperty(h)&&l.push(h);var f=t._data;if(l.length>0){if(r.autoDate){var p=e.define(t._type);p.updateDates(t,l)}if(r.secured){var p=e.define(t._type);f=p.encrypt(t)}}for(var m=0;l.length>m;m++){var h=l[m];o.push("`"+h+"`");var g=r.fields[h]||a.idType;c.push(a.entityValToDbVal(f[h],g)),u.push(a.outVar("?",g)),d.push("`"+h+"` = "+a.outVar("?",g))}var y=[];for(var h in r.hasMany)r.hasMany.hasOwnProperty(h)&&(y=y.concat(e.get(t,h).persistQueries()));s(n,y,function(){if(!t._new&&0===o.length)return i&&i(),void 0;if(t._dirtyProperties={},t._new){o.push("id"),c.push(a.entityIdToDbId(t.id)),u.push(a.outIdVar("?"));var e="INSERT INTO `"+t._type+"` ("+o.join(", ")+") VALUES ("+u.join(", ")+")";t._new=!1,n.executeSql(e,c,i,i)}else{var e="UPDATE `"+t._type+"` SET "+d.join(",")+" WHERE id = "+a.outId(t.id);n.executeSql(e,c,i,i)}})}function o(t,n,i){var r=e.define(t._type);r.saveDirty();var a=e.getMeta(t._type),o=e.typeMapper,c=[["DELETE FROM `"+t._type+"` WHERE id = "+o.outId(t.id),null]];for(var u in a.hasMany)if(a.hasMany.hasOwnProperty(u)&&a.hasMany[u].manyToMany){var d=a.hasMany[u].tableName;c.push(["DELETE FROM `"+d+"` WHERE `"+a.name+"_"+u+"` = "+o.outId(t.id),null])}s(n,c,i)}function s(n,i,r){for(var a=[],o=3;arguments.length>o;o++)a.push(arguments[o]);e.asyncForEach(i,function(e,i){n.executeSql(e[0],e[1],i,function(e,n){t.error(n.message),i(e,n)})},function(e,t){return t&&r?(r(e,t),void 0):(r&&r.apply(null,a),void 0)})}var c=e.argspec;e.typeMapper=n.typeMapper||i,e.generatedTables={},e.schemaSync=function(t,i,r){var a=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}},{name:"emulate",optional:!0,check:c.hasType("boolean")}]);if(t=a.tx,i=a.callback,r=a.emulate,!t){var o=this;return this.transaction(function(e){o.schemaSync(e,i,r)}),void 0}var u,d,l,h,f=[],p=e.typeMapper,m=e.getEntityMeta();for(var g in m)if(m.hasOwnProperty(g)){if(u=m[g],!u.isMixin){d=[];for(var y in u.fields)u.fields.hasOwnProperty(y)&&d.push([y,u.fields[y]]);for(var v in u.hasOne)u.hasOne.hasOwnProperty(v)&&(l=u.hasOne[v].type.meta,d.push([v,p.idType]),f.push([n.createIndex(u.name,[v]),null]));for(var b=0;u.indexes.length>b;b++)f.push([n.createIndex(u.name,u.indexes[b].columns,u.indexes[b]),null])}for(var v in u.hasMany)if(u.hasMany.hasOwnProperty(v)&&u.hasMany[v].manyToMany&&(h=u.hasMany[v].tableName,!e.generatedTables[h])){var l=u.hasMany[v].type.meta,E=u.hasMany[v].inverseProperty;if(l.hasMany[E].type.meta!=u)continue;var A=u.name+"_"+v,_=l.name+"_"+E;f.push([n.createIndex(h,[A]),null]),f.push([n.createIndex(h,[_]),null]);var S=[[A,p.idType],[_,p.idType]];u.isMixin&&S.push([A+"_class",p.classNameType]),l.isMixin&&S.push([_+"_class",p.classNameType]),f.push([n.createTable(h,S),null]),e.generatedTables[h]=!0}u.isMixin||(d.push(["id",p.idType,"PRIMARY KEY"]),e.generatedTables[u.name]=!0,f.push([n.createTable(u.name,d),null]))}for(var T=e.schemaSyncHooks,b=0;T.length>b;b++)T[b](t);r?i(t):s(t,f,function(e,n){i(t,n)})},e.flush=function(t,n){var i=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:null}]);t=i.tx,n=i.callback;var r=this;if(!t)return this.transaction(function(e){r.flush(e,n)}),void 0;var s=e.flushHooks;e.asyncForEach(s,function(e,n){e(r,t,n)},function(){var i=[];for(var s in r.trackedObjects)r.trackedObjects.hasOwnProperty(s)&&i.push(r.trackedObjects[s]);var c=[];for(var s in r.objectsToRemove)r.objectsToRemove.hasOwnProperty(s)&&(c.push(r.objectsToRemove[s]),r.clearFromEntityCache(r.trackedObjects[s]),delete r.trackedObjects[s]);if(r.objectsToRemove={},n)e.asyncParForEach(c,function(e,n){o(e,t,n)},function(r,o){return o?n(r,o):(e.asyncParForEach(i,function(e,n){a(e,t,n)},n),void 0)});else{for(var u=0;i.length>u;u++)a(i[u],t);for(var u=0;c.length>u;u++)o(c[u],t)}})},e.reset=function(t,n){var i=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);t=i.tx,n=i.callback;var r=this;return t?(this.schemaSync(t,function(){function i(){var e=o.pop();t.executeSql("DROP TABLE IF EXISTS `"+e+"`",null,function(){o.length>0?i():a()},a)}function a(t,i){r.clean(),e.generatedTables={},n&&n(t,i)}var o=[];for(var s in e.generatedTables)e.generatedTables.hasOwnProperty(s)&&o.push(s);o.length>0?i():a()},!0),void 0):(r.transaction(function(e){r.reset(e,n)}),void 0)},e.save=a,e.executeQueriesSeq=s,e.QueryCollection.prototype.persistQueries=function(){return[]};var u=e.QueryCollection.prototype.clone;e.QueryCollection.prototype.clone=function(e){var t=u.call(this,e);return t._additionalJoinSqls=this._additionalJoinSqls.slice(0),t._additionalWhereSqls=this._additionalWhereSqls.slice(0),t._additionalGroupSqls=this._additionalGroupSqls.slice(0),t._manyToManyFetch=this._manyToManyFetch,t};var d=e.QueryCollection.prototype.init;e.QueryCollection.prototype.init=function(e,t,n){d.call(this,e,t,n),this._manyToManyFetch=null,this._additionalJoinSqls=[],this._additionalWhereSqls=[],this._additionalGroupSqls=[]};var l=e.QueryCollection.prototype.toUniqueString;e.QueryCollection.prototype.toUniqueString=function(){var e=l.call(this);e+="|JoinSQLs:";for(var t=0;this._additionalJoinSqls.length>t;t++)e+=this._additionalJoinSqls[t];e+="|WhereSQLs:";for(var t=0;this._additionalWhereSqls.length>t;t++)e+=this._additionalWhereSqls[t];e+="|GroupSQLs:";for(var t=0;this._additionalGroupSqls.length>t;t++)e+=this._additionalGroupSqls[t];return this._manyToManyFetch&&(e+="|ManyToManyFetch:",e+=JSON.stringify(this._manyToManyFetch)),e},e.NullFilter.prototype.sql=function(){return"1=1"},e.AndFilter.prototype.sql=function(e,t,n){return"("+this.left.sql(e,t,n)+" AND "+this.right.sql(e,t,n)+")"},e.OrFilter.prototype.sql=function(e,t,n){return"("+this.left.sql(e,t,n)+" OR "+this.right.sql(e,t,n)+")"},e.PropertyFilter.prototype.sql=function(t,n,i){var r=e.typeMapper,a=n?"`"+n+"`.":"",o=t.fields[this.property]||r.idType;if("="===this.operator&&null===this.value)return a+"`"+this.property+"` IS NULL";if("!="===this.operator&&null===this.value)return a+"`"+this.property+"` IS NOT NULL";if("in"===this.operator){for(var s=this.value,c=[],u=0;s.length>u;u++)c.push("?"),i.push(r.entityValToDbVal(s[u],o));return 0===s.length?"1 = 0":a+"`"+this.property+"` IN ("+c.join(", ")+")"}if("not in"===this.operator){for(var s=this.value,c=[],u=0;s.length>u;u++)c.push("?"),i.push(r.entityValToDbVal(s[u],o));return 0===s.length?"1 = 1":a+"`"+this.property+"` NOT IN ("+c.join(", ")+")"}var d=this.value;return(d===!0||d===!1)&&(d=d?1:0),i.push(r.entityValToDbVal(d,o)),a+"`"+this.property+"` "+this.operator+" "+r.outVar("?",o)},e.DbQueryCollection.prototype.list=function(n,i){function a(e,t,n){var i=[h.inIdVar("`"+t+"`.id")+" AS "+n+"id"];for(var r in e.fields)e.fields.hasOwnProperty(r)&&i.push(h.inVar("`"+t+"`.`"+r+"`",e.fields[r])+" AS `"+n+r+"`");for(var r in e.hasOne)e.hasOne.hasOwnProperty(r)&&i.push(h.inIdVar("`"+t+"`.`"+r+"`")+" AS `"+n+r+"`");return i}var o=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);n=o.tx,i=o.callback;var s=this,u=this._session;if(!n)return u.transaction(function(e){s.list(e,i)}),void 0;var d=this._entityName,l=e.getMeta(d),h=e.typeMapper;if(l.isMixin){var f=[];return e.asyncForEach(l.mixedIns,function(e,t){var i=s.clone();i._entityName=e.name,i.list(n,function(e){f=f.concat(e),t()})},function(){var t=new e.LocalQueryCollection(f);t._orderColumns=s._orderColumns,t._reverse=s._reverse,t.list(null,i)}),void 0}var o=[],p=d+"_",m="root",g=a(l,m,p),y="",v=this._additionalWhereSqls.slice(0),b=this._manyToManyFetch;b&&(y+="LEFT JOIN `"+b.table+"` AS mtm ON mtm.`"+b.inverseProp+"` = `root`.`id` ",v.push("mtm.`"+b.prop+"` = "+h.outId(b.id))),y+=this._additionalJoinSqls.join(" ");for(var E=0;this._prefetchFields.length>E;E++){var A=this._prefetchFields[E],_=l.hasOne[A].type.meta;if(_.isMixin)throw new Error("cannot prefetch a mixin");var S=_.name+"_"+A+"_tbl";g=g.concat(a(_,S,A+"_")),y+="LEFT JOIN `"+_.name+"` AS `"+S+"` ON `"+S+"`.`id` = `"+m+"`.`"+A+"` "}var T="WHERE "+[this._filter.sql(l,m,o)].concat(v).join(" AND "),M="SELECT "+g.join(", ")+" FROM `"+d+"` AS `"+m+"` "+y+" "+T;this._additionalGroupSqls.length>0&&(M+=this._additionalGroupSqls.join(" ")),this._orderColumns.length>0&&(M+=" ORDER BY "+this._orderColumns.map(function(e){return(e[2]?"`":"LOWER(`")+p+e[0]+(e[2]?"` ":"`) ")+(e[1]?"ASC":"DESC")}).join(", ")),this._limit>=0&&(M+=" LIMIT "+this._limit),this._skip>0&&(M+=" OFFSET "+this._skip),u.flush(n,function(){n.executeSql(M,o,function(e){var t=[];s._reverse&&e.reverse();for(var n=0;e.length>n;n++){for(var a=e[n],o=r(u,d,a,p),c=0;s._prefetchFields.length>c;c++){var h=s._prefetchFields[c],f=l.hasOne[h].type.meta;o._data_obj[h]=r(u,f.name,a,h+"_"),u.add(o._data_obj[h])}t.push(o),u.add(o)}i(t),s.triggerEvent("list",s,t)},function(e,n){var i=n?n.message:"unknown SQL error.";t.error("SQL ERROR: "+i)})})},e.DbQueryCollection.prototype.destroyAll=function(t,n){var i=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!0,check:c.isCallback(),defaultValue:function(){}}]);t=i.tx,n=i.callback;var r=this,a=this._session;if(!t)return a.transaction(function(e){r.destroyAll(e,n)}),void 0;var o=this._entityName,s=e.getMeta(o),u=e.typeMapper;if(s.isMixin)return e.asyncForEach(s.mixedIns,function(e){var i=r.clone();i._entityName=e.name,i.destroyAll(t,n)},n),void 0;var d="",l=this._additionalWhereSqls.slice(0),h=this._manyToManyFetch;h&&(d+="LEFT JOIN `"+h.table+"` AS mtm ON mtm.`"+h.inverseProp+"` = `root`.`id` ",l.push("mtm.`"+h.prop+"` = "+u.outId(h.id))),d+=this._additionalJoinSqls.join(" ");var i=[],f="WHERE "+[this._filter.sql(s,null,i)].concat(l).join(" AND "),p="SELECT id FROM `"+o+"` "+d+" "+f,m="DELETE FROM `"+o+"` "+d+" "+f,g=i.slice(0);a.flush(t,function(){t.executeSql(p,i,function(e){for(var i=0;e.length>i;i++)a.clearFromEntityCache(a.trackedObjects[e[i].id]),delete a.trackedObjects[e[i].id],a.objectsRemoved.push({id:e[i].id,entity:o});r.triggerEvent("change",r),t.executeSql(m,g,n,n)},n)})},e.DbQueryCollection.prototype.count=function(t,n){var i=c.getArgs(arguments,[{name:"tx",optional:!0,check:e.isTransaction,defaultValue:null},{name:"callback",optional:!1,check:c.isCallback()}]);t=i.tx,n=i.callback;var r=this,a=this._session;if(t&&!t.executeSql&&(n=t,t=null),!t)return a.transaction(function(e){r.count(e,n)}),void 0;var o=this._entityName,s=e.getMeta(o),u=e.typeMapper;if(s.isMixin){var d=0;return e.asyncForEach(s.mixedIns,function(e,n){var i=r.clone();i._entityName=e.name,i.count(t,function(e){d+=e,n()})},function(){n(d)}),void 0}var l="",h=this._additionalWhereSqls.slice(0),f=this._manyToManyFetch;f&&(l+="LEFT JOIN `"+f.table+"` AS mtm ON mtm.`"+f.inverseProp+"` = `root`.`id` ",h.push("mtm.`"+f.prop+"` = "+u.outId(f.id))),l+=this._additionalJoinSqls.join(" ");var i=[],p="WHERE "+[this._filter.sql(s,"root",i)].concat(h).join(" AND "),m="SELECT COUNT(*) AS cnt FROM `"+o+"` AS `root` "+l+" "+p;a.flush(t,function(){t.executeSql(m,i,function(e){n(parseInt(e[0].cnt,10))})})},e.ManyToManyDbQueryCollection.prototype.persistQueries=function(){for(var t=[],n=e.getMeta(this._obj._type),i=n.hasMany[this._coll].type.meta,r=e.typeMapper,a=n.hasMany[this._coll],o=i.hasMany[a.inverseProperty],s=a.mixin?a.mixin.meta.name:n.name,c=o.mixin?o.mixin.meta.name:i.name,u=0;this._localAdded.length>u;u++){var d=[s+"_"+this._coll,c+"_"+a.inverseProperty],l=[r.outIdVar("?"),r.outIdVar("?")],h=[r.entityIdToDbId(this._obj.id),r.entityIdToDbId(this._localAdded[u].id)];a.mixin&&(d.push(s+"_"+this._coll+"_class"),l.push("?"),h.push(n.name)),o.mixin&&(d.push(c+"_"+a.inverseProperty+"_class"),l.push("?"),h.push(i.name)),t.push(["INSERT INTO "+a.tableName+" (`"+d.join("`, `")+"`) VALUES ("+l.join(",")+")",h])}this._localAdded=[];for(var u=0;this._localRemoved.length>u;u++)t.push(["DELETE FROM  "+a.tableName+" WHERE `"+s+"_"+this._coll+"` = "+r.outIdVar("?")+" AND `"+c+"_"+a.inverseProperty+"` = "+r.outIdVar("?"),[r.entityIdToDbId(this._obj.id),r.entityIdToDbId(this._localRemoved[u].id)]]);return this._localRemoved=[],t}}var i={idType:"VARCHAR(32)",classNameType:"TEXT",columnType:function(e){switch(e){case"JSON":return"TEXT";case"BOOL":return"INT";case"DATE":return"INT";default:return e}},inVar:function(e){return e},outVar:function(e){return e},outId:function(e){return"'"+e+"'"},dbValToEntityVal:function(e,t){if(null===e||void 0===e)return e;switch(t){case"DATE":return e>1e12?new Date(parseInt(e,10)):new Date(1e3*parseInt(e,10));case"BOOL":return 1===e||"1"===e;case"INT":return+e;case"BIGINT":return+e;case"JSON":return e?JSON.parse(e):e;default:return e}},entityValToDbVal:function(e,t){return void 0===e||null===e?null:"JSON"===t&&e?JSON.stringify(e):e.id?e.id:"BOOL"===t?"false"===e?0:e?1:0:"DATE"===t||e.getTime?(e=new Date(e),Math.round(e.getTime()/1e3)):e},inIdVar:function(e){return this.inVar(e,this.idType)},outIdVar:function(e){return this.outVar(e,this.idType)},entityIdToDbId:function(e){return this.entityValToDbVal(e,this.idType)}};e.store="undefined"!=typeof window&&window.persistence?window.persistence.store||{}:{},e.store.sql={defaultTypeMapper:i,config:n}}),ABINEMASKME.define("persistence/store/websql",["persistence","persistence/store/sql","abine/eventLogger"],function(e,t,n){e.store||(e.store={}),e.store.websql={},e.store.websql.config=function(e,t,i,r){var a=null;if(e.transaction=function(e){if(!a)throw new Error("No ongoing database connection, please connect first.");a.transaction(e)},e.db=e.db||{},e.db.implementation="unsupported",e.db.conn=null,"undefined"!=typeof window&&window.openDatabase)e.db.implementation="html5";else if("undefined"!=typeof window&&window.google&&google.gears)e.db.implementation="gears";else if("undefined"!=typeof Components)e.db.implementation="storage";else try{openDatabaseSync&&(e.db.implementation="html5-sync")}catch(o){}if(e.db.html5={},e.db.html5.connect=function(t,n,i){var r={},a=openDatabase(t,"1.0",n,i);return r.transaction=function(t){return a.transaction(function(n){return t(e.db.html5.transaction(n))})},r},e.db.html5.transaction=function(e){var t={};return t.executeSql=function(t,i,r,a){a||(a=function(e){n.error("SQL error"),n.error(e)}),e.executeSql(t,i,function(e,t){if(r){for(var n=[],i=0;t.rows.length>i;i++)n.push(t.rows.item(i));r(n)}},a)},t},e.db.html5Sync={},e.db.html5Sync.connect=function(t,n,i){var r={},a=openDatabaseSync(t,"1.0",n,i);return r.transaction=function(t){return a.transaction(function(n){return t(e.db.html5Sync.transaction(n))})},r},e.db.html5Sync.transaction=function(e){var t={};return t.executeSql=function(t,n,i){null==n&&(n=[]);var r=e.executeSql(t,n);if(r&&i){for(var a=[],o=0;r.rows.length>o;o++)a.push(r.rows.item(o));i(a)}},t},e.db.gears={},e.db.storage={},e.db.storage.connect=function(t){"undefined"==typeof FileUtils&&(Components.utils.import("resource://gre/modules/Services.jsm"),Components.utils.import("resource://gre/modules/FileUtils.jsm"));var n=FileUtils.getFile("ProfD",[t+"-db.sqlite"]),i=Services.storage.openDatabase(n);e.store.websql.deleteDB=function(){if(i)try{i.asyncClose(function(){n.exists()&&n.remove(!0),i=null})}catch(e){}};var r={};return r.transaction=function(t){t(e.db.storage.transaction(i))},r},e.db.storage.transaction=function(e){var t={};return t.executeSql=function(t,i,r,a){try{var o=e.createStatement(t);if(i&&i.length){for(var s=o.newBindingParamsArray(),c=s.newBindingParams(),u=0;i.length>u;u++)c.bindByIndex(u,i[u]);s.addParams(c),o.bindParameters(s)}}catch(d){n.error("Error: "+d+"\n"),a&&a(d)}var l=[];o.executeAsync({handleResult:function(e){for(var t=e.getNextRow();t;t=e.getNextRow()){for(var n={},i=0;t.numEntries>i;i++){var r=o.getColumnName(i),a=t.getResultByIndex(i);n[r]=a}l.push(n)}},handleError:function(e){n.error("SQL Error: "+e.message+"\n"),a(e)},handleCompletion:function(e){e!=Components.interfaces.mozIStorageStatementCallback.REASON_FINISHED&&n.error("Query canceled or aborted!\n"),r&&r(l)}})},t},e.db.connect=function(t,n,i){return"html5"==e.db.implementation?e.db.html5.connect(t,n,i):"html5-sync"==e.db.implementation?e.db.html5Sync.connect(t,n,i):"gears"==e.db.implementation?e.db.gears.connect(t):"storage"==e.db.implementation?e.db.storage.connect(t):void 0},e.store.websql.sqliteDialect={createTable:function(t,n){for(var i=e.typeMapper,r="CREATE TABLE IF NOT EXISTS `"+t+"` (",a=[],o=0;n.length>o;o++){var s=n[o];a.push("`"+s[0]+"` "+i.columnType(s[1])+(s[2]?" "+s[2]:""))}return r+=a.join(", "),r+=")"},createIndex:function(e,t,n){return n=n||{},"CREATE "+(n.unique?"UNIQUE ":"")+"INDEX IF NOT EXISTS `"+e+"__"+t.join("_")+"` ON `"+e+"` ("+t.map(function(e){return"`"+e+"`"}).join(", ")+")"}},e.store.sql.config(e,e.store.websql.sqliteDialect),a=e.db.connect(t,i,r),!a)throw new Error("No supported database found in this browser.")}}),/**
 * @license
 * Copyright (c) 2010 Fbio Rehm <fgrehm@gmail.com>
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
ABINEMASKME.define("persistence/migrations",["persistence","abine/eventLogger"],function(e,t){var n={migrations:[],version:function(t){e.transaction(function(e){e.executeSql("SELECT current_version FROM schema_version",null,function(n){0==n.length?e.executeSql("INSERT INTO schema_version VALUES (0)",null,function(){ABINEMASKME.schemaVersion=0,t(0)}):(ABINEMASKME.schemaVersion=n[0].current_version,t(n[0].current_version))})})},setVersion:function(t,i){e.transaction(function(e){e.executeSql("UPDATE schema_version SET current_version = ?",[t],function(){n._version=t,ABINEMASKME.schemaVersion=t,i&&i()})})},setup:function(t){e.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS schema_version (current_version INTEGER)",null,function(){n.migration(0,{up:function(){},down:function(){}}),t&&t()})})},reset:function(e){n.migrations=[],n.migration(0,{up:function(){},down:function(){}}),n.setVersion(0,e)},migration:function(e,t){return n.migrations[e]=new i(e,t),n.migrations[e]},migrateUpTo:function(e,i){function r(){var e=a.pop();if(!e)return i&&i(),void 0;var o=Date.now(),s=function(){if(t.debug("Time to run migration #"+e.version+" "+(Date.now()-o)+"ms"),e._skipAll){for(var s=e;a.length>0;)s=a.pop();return n.setVersion(s.version,i),void 0}a.length>0?r():i&&i()};e.body.up?e.up(s):n.setVersion(e.version,s)}var a=[];if(n.migrations.length>1&&n.migrations[1].body.postMigrate){var o=n.migrations[1].body.postMigrate,s=i;i=function(){var e=Date.now();o(function(){t.debug("Time to run post migrate script "+(Date.now()-e)+"ms"),s()})}}this.version(function(t){for(var o=t+1;e>=o;o++)a.unshift(n.migrations[o]);a.length>0?r():i&&i()})},migrateDownTo:function(e,t){function i(){var e=r.pop();return e?(e.down(function(){r.length>0?i():t&&t()}),void 0):(t&&t(),void 0)}var r=[];this.version(function(a){for(var o=a;o>=e;o--)r.unshift(n.migrations[o]);r.length>0?i():t&&t()})},migrate:function(e,t){1===arguments.length&&(t=e,e=this.migrations.length-1),this.version(function(i){e>i?n.migrateUpTo(e,t):i>e?n.migrateDownTo(e,t):t()})}},i=function(e,t){this.version=e,this.body=t,this.actions=[]};i.prototype.executeActions=function(t){var i=this.actions,r=this.version;e.transaction(function(e){function a(){if(0==i.length)n.setVersion(r,t);else{var o=i.pop();o(e,a)}}a()})},i.prototype.up=function(e){this.body.up&&this.body.up.apply(this),this.executeActions(e)},i.prototype.down=function(e){this.body.down&&this.body.down.apply(this),this.executeActions(e)},i.prototype.createTable=function(e,t){var n=new r;t&&t(n);for(var i,a="CREATE TABLE IF NOT EXISTS "+e+" (id VARCHAR(32) PRIMARY KEY";i=n.columns.pop();)a+=", "+i;this.executeSql(a+")")},i.prototype.dropTable=function(e){var t="DROP TABLE "+e;this.executeSql(t)},i.prototype.addColumn=function(e,t,n){var i="ALTER TABLE "+e+" ADD "+t+" "+n;this.executeSql(i)},i.prototype.removeColumn=function(t,n){this.action(function(i,r){var a='select sql from sqlite_master where type = "table" and name == "'+t+'"';i.executeSql(a,null,function(a){for(var o=new RegExp("CREATE TABLE `\\w+` |\\w+ \\((.+)\\)").exec(a[0].sql)[1].split(", "),s=[],c=[],u=0;o.length>u;u++){var d=new RegExp("((`\\w+`)|(\\w+)) .+").exec(o[u])[1];d!=n&&(c.push(o[u]),s.push(d))}c=c.join(", "),s=s.join(", ");var l=[];l.unshift(["ALTER TABLE "+t+" RENAME TO "+t+"_bkp;",null]),l.unshift(["CREATE TABLE "+t+" ("+c+");",null]),l.unshift(["INSERT INTO "+t+" SELECT "+s+" FROM "+t+"_bkp;",null]),l.unshift(["DROP TABLE "+t+"_bkp;",null]),e.executeQueriesSeq(i,l,r)})})},i.prototype.addIndex=function(e,t,n){var i="CREATE "+(n===!0?"UNIQUE":"")+" INDEX "+e+"_"+t+" ON "+e+" ("+t+")";this.executeSql(i)},i.prototype.removeIndex=function(e,t){var n="DROP INDEX "+e+"_"+t;this.executeSql(n)},i.prototype.executeSql=function(e,t){this.action(function(n,i){n.executeSql(e,t,i)})},i.prototype.action=function(e){this.actions.unshift(e)},i.prototype.skipAll=function(){var e=this;this.actions.unshift(function(t,n){e._skipAll=!0,n()})};var r=function(){this.columns=[]};return r.prototype.text=function(e,t){t?this.columns.unshift(e+" VARCHAR("+t+")"):this.columns.unshift(e+" TEXT")},r.prototype.integer=function(e,t,n){n=n||!1,t=t||32;var i=e;switch(n||(i+=" UNSIGNED "),t){case 1:i+="INT2";break;case 2:i+="INT2";break;case 8:i+="TINYINT";break;case 16:i+="SMALLINT";break;case 24:i+="MEDIUMINT";break;case 64:i+="BIGINT";break;default:i+="INTEGER"}this.columns.unshift(i)},r.prototype.real=function(e){this.columns.unshift(e+" REAL")},r.prototype["boolean"]=function(e){this.columns.unshift(e+" BOOL")},r.prototype.date=function(e){this.columns.unshift(e+" DATE")},r.prototype.json=function(e){this.columns.unshift(e+" TEXT")},e.migrations={},e.migrations.Migrator=n,e.migrations.Migration=i,e.migrations.init=function(){n.setup.apply(n,Array.prototype.slice.call(arguments,0))},e.migrate=function(){n.migrate.apply(n,Array.prototype.slice.call(arguments,0))},e.defineMigration=function(){n.migration.apply(n,Array.prototype.slice.call(arguments,0))},e.migrations}),ABINEMASKME.define("persistence/security",["documentcloud/underscore","abine/core","persistence","abine/securityManager","abine/timer","abine/eventLogger"],function(e,t,n,i){n.security=new t.BaseClass,n.security.TABLE_SALT=1,n.security.ROW_SALT=2,n.security.CUSTOM_SALT=3,n.entityDecoratorHooks.push(function(t){t.secure=function(i,r,a,o){i==n.security.ROW_SALT&&(a="id");var s={};e.each(r,function(e){s[e]=1}),t.meta.secured=!0,t.meta.secureMode=i,t.meta.saltColumn=a,t.meta.secureFields=r,t.meta.secureFieldsMap=s,t.meta.encryptFilter=o},t.encryptedQueryValue=function(e){if(t.meta.secureMode==n.security.TABLE_SALT)return i.encrypt(t.meta.salt,e);throw"encryptedQueryValue works only for tables with TABLE_SALT"},t.decrypt=function(r){var a=t.meta.encryptFilter;if(!a||r[t.meta.encryptFilter.field]in t.meta.encryptFilter.value){var o;o=t.meta.secureMode==n.security.TABLE_SALT?t.meta.salt:r[t.meta.saltColumn].substr(0,16).toLowerCase(),e.each(t.meta.secureFields,function(e){if(e in r._data){var t=r._data[e];if(t&&""!==t){var n=t+"";if(a){if(0==n.indexOf("ENC:")){var s=n.substr(4);n=i.decrypt(o,s,!0),s==n&&(n=t)}}else n=i.decrypt(o,n,!0);n!==t&&(r._data[e]=n)}}})}},t.encrypt=function(r){var a=t.meta.encryptFilter;if(!a||r[t.meta.encryptFilter.field]in t.meta.encryptFilter.value){var o,s,c=!1;if(o=t.meta.secureMode==n.security.TABLE_SALT?t.meta.salt:r[t.meta.saltColumn].substr(0,16).toLowerCase(),s=e.clone(r._data),e.each(t.meta.secureFields,function(e){var t=r._data[e];if(e in r._dirtyProperties&&r._dirtyProperties.hasOwnProperty(e)){c=!0;var n=t;(!a||n)&&(t=i.encrypt(o,n,!0)),a&&(n&&t!=n&&-1==n.indexOf("ENC:")?t="ENC:"+t:(t=n,c=!1))}s[e]=t}),c)return s}return r._data},t.encryptAll=function(i){t.all().list(function(r){e.each(r,function(n){e.each(t.meta.secureFields,function(e){var i=t.meta.encryptFilter;(!i||n[t.meta.encryptFilter.field]in t.meta.encryptFilter.value)&&n.markDirty(e)})}),n.flush(i)})},t.decryptForMerge=function(r,a){var o=t.meta.encryptFilter;if(!o||r[t.meta.encryptFilter.field]in t.meta.encryptFilter.value){var s;s=t.meta.secureMode==n.security.TABLE_SALT?a||t.meta.salt:a||r[t.meta.saltColumn].substr(0,16).toLowerCase(),e.each(t.meta.secureFields,function(e){if(e in r){var t=r[e];if(t&&""!==t){var n=t+"";if(o){if(0==n.indexOf("ENC:")){var a=n.substr(4);n=i.decrypt(s,a,!0),a==n&&(n=t)}}else n=i.decrypt(s,n,!0);n!==t&&(r[e]=n)}}})}},t.encryptForMerge=function(r,a){var o;o=t.meta.secureMode==n.security.TABLE_SALT?a||t.meta.salt:a||r[t.meta.saltColumn].substr(0,16).toLowerCase();var s=t.meta.encryptFilter;(!s||r[t.meta.encryptFilter.field]in t.meta.encryptFilter.value)&&e.each(t.meta.secureFields,function(e){var t=r[e],n=t;(!s||t)&&(n=i.encrypt(o,t,!0)),s&&(n=t&&n!=t&&-1==t.indexOf("ENC:")?"ENC:"+n:t),r[e]=n})}})}),ABINEMASKME.define("persistence/autodate",["documentcloud/underscore","abine/core","persistence","abine/eventLogger","abine/timer"],function(e,t,n,i,r){function a(){var e=1e3*Math.floor((new Date).getTime()/1e3)-2e3;c?c.findBy("key","lastLocalModifiedAt",function(t){t?t.value=e:n.add(new c({key:"lastLocalModifiedAt",value:e})),n.flush(function(){u.dirtyStatePendingSave=!1})}):ABINEMASKME.require(["abine/storage/preference"],function(e){c=e,a()})}var o=null,s={lastLocalModifiedAt:1,lastSync:1,lastTouch:1,lastDataVersion:1,authToken:1},c=null,u={dirtyStatePendingSave:!1,resetForTest:function(){r.clearTimeout(o),this.dirtyStatePendingSave=!1}};return n.entityDecoratorHooks.push(function(e){e.autoDate=function(){e.meta.autoDate=!0},e.prototype.touch=function(){this.modifiedAt=new Date},e.saveDirty=function(){a()},e.updateDates=function(e,t){if(e.skipDateChange)return delete e.skipDateChange,void 0;if(t.length>1||!("pushVersion"in e._dirtyProperties)){var n="modifiedAt"in e._dirtyProperties;e.modifiedAt&&n||(e.modifiedAt=new Date,n||t.push("modifiedAt")),e.createdAt||(e.createdAt=e.modifiedAt,"createdAt"in e._dirtyProperties||t.push("createdAt"))}"key"in e&&e.key&&e.key in s||(u.dirtyStatePendingSave=!0,r.clearTimeout(o),o=r.setTimeout(a,2e3))}}),u}),ABINEMASKME.define("persistence/caching",["documentcloud/underscore","abine/core","persistence","abine/eventLogger","abine/timer"],function(e,t,n){return n.entityDecoratorHooks.push(function(e){e.enableCaching=function(t,i){"function"==typeof t&&(i=t,t=null),e.cached=!1,e.meta.cached=!0,e.meta.alternatePK=t,n.GlobalEvent.addEventListener("clean",function(){e.cached=!1,i&&i()})}}),null}),ABINEMASKME.require("persistence/store/websql",function(){}),ABINEMASKME.define("abine/ajax",["jquery"],function(e){return{ajax:e.ajax,get:e.get,getJSON:e.getJSON,post:e.post,getScript:e.getScript}}),ABINEMASKME.define("abine/assets",["wycats/handlebars"],function(e){function t(e){return chrome.extension.getURL(e)}return e.registerHelper("assetUrl",t),{assetUrl:t}}),ABINEMASKME.define("abine/backgroundMessenger",["documentcloud/underscore","abine/core"],function(e,t){var n=function n(e,t){t&&t.tab&&this.trigger(e.eventName,e.payload,t.tab.id)},i=function(){throw"Error. Attempt to call destroyed BackgroundMessenger."},r=t.BaseClass.extend({initialize:function(){this.listener=e.bind(n,this),chrome.extension.onRequest.addListener(this.listener)},send:function(e,t,n){if(this.trigger(e,t,n),"test"!=n)if(n&&-1!=n||!chrome.tabs){if(!n||"background"==n||-1==n)return;chrome.tabs.sendRequest(n,{eventName:e,payload:"undefined"==typeof t?{}:t})}else chrome.tabs.getSelected(null,function(i){n=i.id,chrome.tabs.sendRequest(n,{eventName:e,payload:"undefined"==typeof t?{}:t})})},broadcast:function(t,n){n=n||{},this.trigger(t,n),chrome.tabs.query({url:chrome.extension.getURL("pages/index.html")},function(i){e(i).each(function(e){chrome.tabs.sendRequest(e.id,{eventName:t,payload:n})})})},broadcastToAllTabs:function(t,n){n=n||{},this.trigger(t,n),chrome.tabs.query({},function(i){e(i).each(function(e){chrome.tabs.sendRequest(e.id,{eventName:t,payload:n})})})},destroy:function(){this.off(),chrome.extension.onRequest.removeListener(n),this.on=this.off=this.trigger=i}});return{implementation:"Chrome",BackgroundMessenger:r}}),ABINEMASKME.define("abine/browserSyncStorage",["documentcloud/underscore","abine/core"],function(e,t){var n;n=chrome&&chrome.storage&&chrome.storage.sync?t.BaseClass.extend({initialize:function(){},set:function(e,t){chrome.storage.sync.set(e,t)},remove:function(e,t){chrome.storage.sync.remove(e,t)},get:function(e,t){chrome.storage.sync.get(e,t)},clear:function(e){chrome.storage.sync.clear(e)}}):t.BaseClass.extend({initialize:function(){this.storage={}},set:function(t,n){e.extend(this.storage,t),n&&n()},remove:function(t,n){t="string"==typeof t?[t]:t,e.each(t,e.bind(function(e){delete this.storage[e]},this)),n&&n()},get:function(t,n){t="string"==typeof t?[t]:t,n&&n(e.pick(this.storage,t))},clear:function(e){this.storage={},e&&e()}});var i=new n({});return i}),ABINEMASKME.define("abine/clipboard",["abine/eventLogger"],function(){return{copyToClipboard:function(e){var t=document.createElement("textarea");document.getElementById("navbar").appendChild(t),t.focus(),t.value=e,document.execCommand("selectAll"),document.execCommand("copy"),document.getElementById("navbar").removeChild(t)}}}),ABINEMASKME.define("abine/contentMessenger",["documentcloud/underscore","abine/core"],function(e,t){var n=function n(e){this.trigger(e.eventName,e.payload)},i=function(){throw"Error. Attempt to call destroyed ContentMessenger."},r=t.BaseClass.extend({initialize:function(){this.listener=e.bind(n,this),chrome.extension.onRequest.addListener(this.listener)},send:function(e,t){this.trigger(e,t),chrome&&chrome.extension&&chrome.extension.sendRequest({eventName:e,payload:"undefined"==typeof t?{}:t})},destroy:function(){this.off(),chrome.extension.onRequest.removeListener(n),this.on=this.off=this.trigger=i}});return{ContentMessenger:r}}),ABINEMASKME.define("abine/contextMenu",["documentcloud/underscore","abine/core","abine/contextHelper","storage","abine/securityManager"],function(e,t,n,i,r){var a=t.BaseClass.extend({init:function(t){chrome.contextMenus.onClicked.addListener(e.bind(this.onClick,this)),t.on("contentscript:contextmenu:refresh",this.refreshMenu,this),t.on("background:contextmenu:refresh",this.refreshMenu,this),this.messenger=t},refreshMenu:function(t){this.alreadyRefreshing||(this.domain=t.domain,this.alreadyRefreshing=!0,chrome.contextMenus.removeAll(e.bind(function(){return this.domain.indexOf("chrome-extension://")>=0?(this.alreadyRefreshing=!1,void 0):(i.Preference.findBy("key","hasRegistered",e.bind(function(n){return!n||n.isFalse()?(this.alreadyRefreshing=!1,void 0):(r.isLocked()?chrome.contextMenus.create({title:"MaskMe",contexts:["editable"],id:"abine_maskme_context_root"},e.bind(function(){chrome.contextMenus.create({title:"locked, click to unlock",contexts:["editable"],id:"abine_maskme_unlock",parentId:"abine_maskme_context_root"},e.bind(function(){this.alreadyRefreshing=!1},this))},this)):i.Site.showWithAccountsForDomain({params:[t.domain]},e.bind(function(t){1==t.blacklisted||"1"==t.blacklisted?chrome.contextMenus.create({title:"MaskMe",contexts:["editable"],id:"abine_maskme_context_root"},e.bind(function(){chrome.contextMenus.create({title:"You have asked MaskMe to ignore this website",contexts:["editable"],id:"abine_maskme_blacklisted",parentId:"abine_maskme_context_root"},e.bind(function(){this.alreadyRefreshing=!1},this))},this)):this.createStaticMenu(e.bind(function(){this.createDynamicMenu(t,e.bind(function(){this.alreadyRefreshing=!1},this))},this))},this)),void 0)},this)),void 0)},this)))},onClick:function(e,t){n.onClick(this.messenger,e.menuItemId,t.id,this.domain)},createDynamicMenu:function(t,n){chrome.contextMenus.create({title:"Logins for "+t.domain,contexts:["editable"],id:"abine_maskme_logins",parentId:"abine_maskme_context_root"},function(){if(0==t.accounts.length)chrome.contextMenus.create({title:"You have no accounts here",contexts:["editable"],id:"abine_maskme_no_accounts",parentId:"abine_maskme_logins"},n);else{var i=!0;e.async.forEachSeries(t.accounts,function(t,n){i||chrome.contextMenus.create({type:"separator",contexts:["editable"],id:"abine_maskme_sep_"+t.id,parentId:"abine_maskme_logins"});var r=null,a=null,o=null;e.each(t.accountFields,function(e){"/contact/email"==e.dataType?r=e:"/nameperson/friendly"==e.dataType?a=e:"/password"==e.dataType&&(o=e,o.value=o.value.charAt(0)+"**********")});var s=0,c=function(){s++,3==s&&n()};r?(i=!1,chrome.contextMenus.create({title:r.value,contexts:["editable"],id:"abine_maskme_accountfield_"+r.id,parentId:"abine_maskme_logins"},c)):c(),a?(i=!1,chrome.contextMenus.create({title:a.value,contexts:["editable"],id:"abine_maskme_accountfield_"+a.id,parentId:"abine_maskme_logins"},c)):c(),o?(i=!1,chrome.contextMenus.create({title:o.value,contexts:["editable"],id:"abine_maskme_accountfield_"+o.id,parentId:"abine_maskme_logins"},c)):c()},n)}})},createStaticMenu:function(t){e.async.series([function(e){chrome.contextMenus.create({title:"MaskMe",contexts:["editable"],id:"abine_maskme_context_root"},e)},function(e){chrome.contextMenus.create({title:"Email",contexts:["editable"],parentId:"abine_maskme_context_root",id:"abine_maskme_email_parent"},e)},function(e){chrome.contextMenus.create({title:"Mask My Email",contexts:["editable"],parentId:"abine_maskme_email_parent",id:"abine_maskme_email_mask"},e)},function(e){chrome.contextMenus.create({title:"Use My Email",contexts:["editable"],parentId:"abine_maskme_email_parent",id:"abine_maskme_email_disclose"},e)},function(e){chrome.contextMenus.create({title:"Password",contexts:["editable"],parentId:"abine_maskme_context_root",id:"abine_maskme_password_parent"},e)},function(e){chrome.contextMenus.create({title:"Generate strong password",contexts:["editable"],parentId:"abine_maskme_password_parent",id:"abine_maskme_password_mask"},e)},function(e){chrome.contextMenus.create({title:"Phone",contexts:["editable"],parentId:"abine_maskme_context_root",id:"abine_maskme_phone_parent"},e)},function(e){i.DisposablePhone.index(null,function(t){t.length>0?chrome.contextMenus.create({title:"Mask my Phone",contexts:["editable"],parentId:"abine_maskme_phone_parent",id:"abine_maskme_phone_mask"},e):e()})},function(e){i.ShieldedPhone.index(null,function(t){t.length>0?chrome.contextMenus.create({title:"Disclose my phone",contexts:["editable"],parentId:"abine_maskme_phone_parent",id:"abine_maskme_phone_disclose"},e):chrome.contextMenus.create({title:"Set up your phone",contexts:["editable"],parentId:"abine_maskme_phone_parent",id:"abine_maskme_setup_phone"},e)})},function(e){i.Preference.findBy("key","entitledToPayments",function(t){t&&t.isTrue()?chrome.contextMenus.create({title:"Credit Card",contexts:["editable"],parentId:"abine_maskme_context_root",id:"abine_maskme_card_parent"},function(){i.Preference.findBy("key","hasEnabledPayments",function(t){t&&t.isTrue()?chrome.contextMenus.create({title:"Mask my Credit Card",contexts:["editable"],parentId:"abine_maskme_card_parent",id:"abine_maskme_card_mask"},e):chrome.contextMenus.create({title:"Activate Masked Cards",contexts:["editable"],parentId:"abine_maskme_card_parent",id:"abine_maskme_activate_card"},e)})}):e()})}],function(){t()})}});return{contextMenuHelper:new a}}),ABINEMASKME.define("abine/formSubmitDetector",["documentcloud/underscore","jquery","abine/formAnalyzer","abine/core","abine/eventLogger"],function(e,t,n,i,r){var a=i.BaseClass.extend({init:function(e,t){var n=this,i={};e.on("contentManager:formSubmit",function(e,t){"clear"===e?t in i&&delete i[t]:i[t]=e}),e.on("contentManager:formFieldChanged",function(e,t){n.trigger("background:formFieldChanged",{formData:e.formData,fieldData:e.fieldData,tabId:t})}),e.on("panel:fill",function(e,t){n.trigger("background:formFieldChanged",{fromFill:!0,formData:e.formData,fieldData:e.fieldData,tabId:t})}),t=t||chrome.webRequest.onBeforeRequest,t.addListener(function(e){var t=e.tabId;if(t in i){var r=i[t],a=e.url;if(r.url&&""!=r.url&&(0===r.url.indexOf(a)||0===a.indexOf(r.url)))return n.trigger("background:formSubmit",{data:r,tabId:t}),delete i[t],void 0;r.url=a,n.trigger("background:formSubmit",{data:r,tabId:t}),delete i[t]}},{urls:["<all_urls>"],types:["main_frame","sub_frame","xmlhttprequest","script"]},[])}}),o=i.BaseClass.extend({initialize:function(e,t){function i(i){var r=i.target;"FORM"===r.nodeName&&e.send("contentManager:formSubmit",n.getFormData(r,t.location.href))}t=t||window,t.addEventListener("submit",i),t.addEventListener("abinemaskmesubmit",i),e.send("contentManager:formSubmit","clear")}});return{formSubmitDetector:new a,FormSubmitContentHelper:o}}),ABINEMASKME.define("abine/intl",[],function(){return{getText:function(e,t){var n=null;e=e.replace(/\./g,"_");try{n=chrome.i18n.getMessage(e,t)}catch(i){}return n&&""!=n||(n="***"+e),n}}}),ABINEMASKME.define("abine/preregister",["documentcloud/underscore","abine/core"],function(e,t){var n=function(){},r=t.BaseClass.extend({initialize:function(){},checkForRegistration:function(t){t=t||n,chrome.cookies.getAll({name:"maskme_prereg"},function(n){var r=e.find(n,function(e){return e.domain.indexOf("abine.com")>=0||e.domain.indexOf("localhost")>=0?!0:void 0}),a=null;if(r)try{a=JSON.parse(n[i].value)}catch(o){}t(null,a)})}}),a=new r({});return a}),ABINEMASKME.define("abine/tabs",["abine/core","abine/url"],function(e,t){var n=e.BaseClass.extend({init:function(e){chrome.tabs.onActivated.addListener(function(n){chrome.tabs.get(n.tabId,function(n){n&&n.url&&(n.url.match("https?://")||n.url.match("chrome-extension://"))&&e.send("background:contextmenu:refresh",{domain:t.getTLD(n.url)})})}),chrome.windows.onFocusChanged.addListener(function(n){chrome.windows.get(n,{populate:!0},function(n){if(n&&n.tabs)for(var i=0;n.tabs.length>i;i++)n.tabs[i].active&&n.tabs[i].url&&(n.tabs[i].url.match("https?://")||n.tabs[i].url.match("chrome-extension://"))&&e.send("background:contextmenu:refresh",{domain:t.getTLD(n.tabs[i].url)})})})}});return{tabHelper:new n}}),ABINEMASKME.define("abine/toolbar",["documentcloud/underscore","abine/timer","jquery","abine/securityManager","storage"],function(e,t,n,i,r){function a(){}function o(){chrome.browserAction.setIcon({path:"pages/images/icon-lock.png"})}function s(){chrome.browserAction.setIcon({path:"images/Icon.png"})}function c(){chrome.browserAction.setIcon({path:"pages/images/Icon-warn.png"})}function u(){r.Preference.findBy("key","hasRegistered",e.bind(function(e){e&&e.isTrue()?s():c()},this))}return i.on("background:securityManager:initialized",function(){i.on("background:securityManager:locked",function(){o()}),i.on("background:securityManager:unlocked",function(){u()}),i.on("background:securityManager:passwordChanged",function(){u()}),i.isLocked()?o():u()}),{freshInstall:a}}),ABINEMASKME.define("abine/window",["documentcloud/underscore","abine/timer","jquery"],function(e,t,n){APPLICATION_CSS="pages/application.css";var i=function(){},r=function(e,n){e.documentElement?e.documentElement.appendChild(n):t.setTimeout(function(){r(e,n)},100)},a=function(e){var t,i=e.getElementsByTagName("head")[0];i&&(t=e.createElement("link"),t.setAttribute("rel","stylesheet"),t.setAttribute("href",chrome.extension.getURL(APPLICATION_CSS)),i.appendChild(t)),n("body",e).css("backgroundColor","transparent")};return{createTab:function(e,t){function n(i){return 1>i.length&&-1==a.indexOf("?")?(a+="?",chrome.tabs.query({url:a},n),void 0):(1>i.length&&!e.doNotOpenNewTab?(chrome.tabs.create({active:!0,url:r}),t()):(chrome.tabs.update(i[0].id,{active:!0,url:r}),chrome.windows.get(i[0].windowId,function(e){"minimized"==e.state&&chrome.windows.update(e.id,{state:"normal"}),chrome.windows.update(e.id,{focused:!0}),t()})),void 0)}t=t||i;var r=e.localUrl?chrome.extension.getURL(e.localUrl):e.url;if(e.force)return chrome.tabs.create({active:!0,url:r}),t(),void 0;var a=r.split("#")[0];chrome.tabs.query({url:a},n)},createPanel:function(t){var n=t.localUrl?chrome.extension.getURL(t.localUrl):t.url,i=t.document||document||window.document,o=t.panelWidth?t.panelWidth:368;if(!i)throw"Error. abine/window createPanel called without a document context.";var s=i.createElement("div");s.className=t.className||"abineContentPanel",e.extend(s.style,{background:"transparent"},t.style);var c=i.createElement("iframe");return e.extend(c,{className:"abineContentFrame",width:o+"px",allowTransparency:"true",frameborder:0,height:t.panelHeight+"px",scrolling:"no",src:n?n:""}),e.extend(c.style,{background:"transparent",borderWidth:"0px",opacity:1,margin:"0",padding:"0",height:t.panelHeight+"px",width:o+"px"}),s.appendChild(c),c.onload=function(){a(c.contentDocument),t.ready&&t.ready.call(c,c.contentDocument,c)},r(i,s,c),c},openWindow:function(e,t,n){chrome.windows.create({url:e,width:t,height:n,focused:!0,type:"popup"})},autoResizePanels:function(t){var i=t.document||document||window.document;i.getElementsByTagName("body")[0];var r=i.getElementsByClassName(t.className||"abineContentPanel");e(r).each(function(e){var t=n("iframe",e)[0];t.scrolling="no";var i=t.contentDocument.body.offsetHeight,r=n(t).width();n(t).height(i),e.style.width=r+"px",e.style.height=i+"px";try{var a=parseInt(e.style.left),o=a+e.offsetWidth,s=e.ownerDocument.defaultView.innerWidth,c=e.ownerDocument.documentElement.scrollLeft+s;if(o>c){var u=o-c;if(a-u>0)e.style.left=a-u+"px";else if(e.style.left="0px",o-a>s){var d=Math.round(100*(s/(o-a)));d-=1,80>d&&(d=80),t.style.zoom=d+"%",t.contentDocument.body.style.zoom=d+"%"}}}catch(l){}})},removePanels:function(t){var n=t.document||document||window.document;if(t.iframe){var i=t.iframe.parentNode;return i&&i.parentNode&&i.parentNode.removeChild(i),void 0}var r=n.getElementsByClassName("abineContentPanel");e(r).each(function(e){e&&e.parentNode&&e.parentNode.removeChild(e)})}}}),ABINEMASKME.define("abine/backgroundEventLogger",["abine/config","storage","persistence","documentcloud/underscore"],function(e,t,n,i){function r(t){var n={},i=t?t.split("#"):[];return 4==i.length?(n.error_tag=i[0],n.module=i[1],n.method=i[2],n.message=i[3]):(n.error_tag=n.module=n.method="not well-formed",n.message=t),n.browser=e.browser,n.build=e.buildNum,n.environment=e.environment,n.build_tag=e.tags[0],n.server_host=e.serverHost,n.mapping_server_host=e.mappingServerHost,n.license_server_host=e.licenseServerHost,n.phone_server_host=e.phoneServerHost,n.crypt=e.crypt,n.version=e.version,n.user_agent=ABINEMASKME.userAgent,n}function a(n){var r={error:n},a=function(t){t&&(r.email_salt=t),ABINEMASKME.require(["abine/ajax"],function(t){t.ajax({type:"POST",url:e.protocol+e.serverHost+"/api/errors",data:r,success:function(){c.debug("error reporting successful")},error:function(){c.debug("error reporting failed")}})})};t.Preference?t.Preference.findBy("key","Salt.ShieldedEmail",i.bind(function(e){a(e.value)},this)):a()}function o(){var e=(new Date).toUTCString();if("undefined"!=typeof console)return{finest:function(t){console.debug("[FINEST]["+e+"]: "+t)},debug:function(t){console.debug("[DEBUG]["+e+"]: "+t)},info:function(t){console.info("[INFO]["+e+"]: "+t)},warn:function(t){console.warn("[WARNING]["+e+"]: "+t)},error:function(n){console.error("[ERROR]["+e+"]: "+n),t.Preference&&t.Preference.findBy("key","shouldSendErrorReports",function(e){e.isTrue()&&a(r(n))})}};if("undefined"!=typeof Components){var n=Components.classes["@mozilla.org/consoleservice;1"].getService(Components.interfaces.nsIConsoleService);return{finest:function(t){n.logStringMessage("[FINEST]["+e+"]: "+t),dump("FINEST: "+t+"\n")},debug:function(t){n.logStringMessage("[DEBUG]["+e+"]: "+t),dump("DEBUG: "+t+"\n")},info:function(t){n.logStringMessage("[INFO]["+e+"]: "+t),dump("INFO: "+t+"\n")},warn:function(t){n.logStringMessage("[WARNING]["+e+"]: "+t),dump("WARNING: "+t+"\n")},error:function(i){n.logStringMessage("[ERROR]["+e+"]: "+i),dump("ERROR: "+i+"\n"),t.Preference&&t.Preference.findBy("key","shouldSendErrorReports",function(e){e&&e.isTrue()&&a(r(i))})}}}}var s=function(){},c=o();switch(c.dumpObj=function(e){var t=typeof e;if("object"!=t||null===e)return"string"==t&&(e='"'+e+'"'),String(e);var n,i,r=[],a=e&&e.constructor==Array;for(n in e)i=e[n],t=typeof i,"string"==t?i='"'+i+'"':"object"==t&&null!==i&&(i=c.dumpObj(i)),r.push((a?"":'"'+n+'":')+String(i));return(a?"[":"{")+String(r)+(a?"]":"}")},e.logLevel){case"NONE":c.error=s;case"ERROR":c.warn=s;case"WARN":c.info=s;case"INFO":c.debug=s;case"DEBUG":c.finest=s}return c.info("Log level set to "+e.logLevel),ABINEMASKME.log=c,c}),ABINEMASKME.define("abine/backgroundInit",["abine/storageRouter","abine/storage/registry","abine/formSubmitDetector","abine/saveForms","abine/window","storage","abine/securityManager","abine/stubs","abine/toolbar","abine/timer","abine/ajax","abine/config","abine/pageEvents","abine/tabs","persistence","abine/mappingServer","modules","documentcloud/underscore","abine/browserSyncStorage","abine/core","documentcloud/underscore"],function(e,t,n,i,r,a,o,s,c,u,d,l,h,f,p,m,g,y,v,b,y){function E(n){if(!w){w=!0,y.each(y.values(g),function(e){e.setMessenger&&e.setMessenger(n)}),f.tabHelper.init(n);var i=new e.StorageRouter({messenger:n,noMigrations:!1,ready:function(){A(n)}});t.registerStorageEntities(i),s.start(n),M(n)}}function A(e){C.trigger("storage:initialized"),n.formSubmitDetector.init(e),i.init(e),h.initialize(e),o.load(e),g.criticalProcess.setMessenger(e),T(function(e){e?u.setTimeout(y.bind(function(){g.mappingsModule.startDailyMappingCheck(function(){g.panelsModule.ensureDynamicPanels()})},this),36e5):g.mappingsModule.startDailyMappingCheck(function(){g.panelsModule.ensureDynamicPanels(function(){})})})}function _(e){e=e||k,a.Preference.findOrCreate({key:"installUserAgent",value:ABINEMASKME.userAgent},function(){a.Preference.findOrCreate({key:"installVersion",value:l.version},function(){a.Preference.findOrCreate({key:"installTags",value:l.tags[0]},function(){p.flush(function(){e()})})})})}function S(e){e=e||k;var t="http://";"production"==ABINEMASKME.config.environment&&(t="https://");var n=t+ABINEMASKME.config.webHost+"/maskme/v2/tag.php?currentTag="+l.tags[0];d.ajax({url:n,success:function(t){try{t=JSON.parse(t)}catch(n){e()}t&&""!=t&&t.abineMaskMeTag&&""!=t.abineMaskMeTag?(l.tags.unshift(t.abineMaskMeTag),a.Preference.createOrModify({key:"dynamicTag",value:t.abineMaskMeTag},function(){e()})):e()},error:function(){e()}})}function T(e){e=e||k,a.Preference.findBy("key","autoOpenEditUser",function(t){if(!t||"false"===t.value)return a.Preference.findBy("key","dynamicTag",function(t){t&&l.tags.unshift(t.value),g.licenseModule.startDailyTouch(function(){e()})}),void 0;var n=!0;t.value="false",c.freshInstall(),_(function(){S(function(){v.get("hasRegistered",function(t){var i=t.hasRegistered?"pages/index.html#userLogin":"pages/index.html#userRegistration";t.hasRegistered||g.licenseModule.autoRegister(),g.licenseModule.startDailyTouch(function(){l.silent||r.createTab({localUrl:i}),e(n)})})})})})}function M(e){e.on("window:createTab",function(e){e.panelData&&(ABINEMASKME.lastPanel||(ABINEMASKME.lastPanel={}),ABINEMASKME.lastPanel[e.panelData.action]=e.panelData.type),r.createTab(e)})}var w=!1,k=function(){};ABINEMASKME.bguser={shouldSendErrorReports:function(){var e=a.Preference.getSync("shouldSendErrorReports");return e&&e.isTrue()},getEmailSalt:function(){var e=a.Preference.getSync("Salt.ShieldedEmail");return e&&e.value}};var C={initialize:E};return y.extend(C,b.Events),C}),ABINEMASKME.define("abine/contentManager",["documentcloud/underscore","jquery","abine/core","abine/contentMessenger","abine/window","abine/timer","abine/formAnalyzer","abine/formStrategy","models","abine/config","abine/url","abine/proxies","abine/views/unlockPanel","abine/views/notificationPanel","abine/assets","abine/views/paymentHelperPanel"],function(e,t,n,i,r,a,o,s,c,u,d,l,h,f,p,m){function g(e){var t=0,n=0;if(e.ownerDocument,e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(e=e.offsetParent);return{left:t,top:n}}var y={zIndex:"2147483647",position:"absolute",top:"20px",right:"20px",overflow:"hidden",borderWidth:"0px",background:"transparent",backgroundColor:"transparent"};allowedHostsRegex="development"==u.environment?/(^(.+\.)?abine\.com$)|(^(.+\.)?idme\.dev$)|(^(.+\.)?license-platform\.dev$)|(^(.+\.)?idme-platform\.dev$)|(^localhost(:[0-9]+)?$)/i:/^(.+\.)?abine\.com$/i;var v=n.BaseClass.extend({initialize:function(n){return this.document=n.document,this.href=this.document.location?this.document.location.href:null,this.domain=n.domain||(this.href?d.getTLD(this.href):null),this.document.documentElement.hasAttribute("abine_webapp")&&(this.document.documentElement.setAttribute("maskme",u.mmVersion),this.document.documentElement.setAttribute("maskme-features",u.features)),n.force||this.document.defaultView==this.document.defaultView.top?(this.messenger=new i.ContentMessenger({eventAggregator:n.eventAggregator,document:n.document}),this.document.defaultView&&this.document.defaultView==this.document.defaultView.top&&(this.messenger.on("background:saveForm:notification",e.bind(this.showNotification,this)),this.messenger.on("contentManager:processNewFrame",e.bind(function(e){var t=this.document.getElementById(e);if(t){var n=t.contentWindow||t.contentDocument;n&&(n.document&&(n=n.document),this.setupFormsInFrame(n,t))}},this))),t(this.document).ready(e.bind(this.hookDocumentEventHandlers,this,this.document)),this.messenger.on("background:failedSubmitDetector:recheckForms",e.bind(function(){this.startFormHelpers()},this)),"Firefox"==ABINEMASKME.config.browser?l.connect(null):l.connect(this.messenger),this.lockedCB=e.bind(this.locked,this),this.unlockedCB=e.bind(this.unlocked,this),l.securityManager.on("background:securityManager:locked",this.lockedCB),l.securityManager.on("background:securityManager:unlocked",this.unlockedCB),this._locked=null,l.securityManager.isLocked(e.bind(function(e){this._locked=e},this)),this.domain&&this.messenger.send("contentscript:contextmenu:refresh",{domain:this.domain}),t(this.document).bind("contextmenu",e.bind(this.trackLastElementClicked,this)),this.messenger.on("background:contextmenu:fill",e.bind(this.fillField,this)),this.messenger.on("background:contextmenu:maskcard",e.bind(this.maskCardContextMenu,this)),this.messenger.on("broadcast:preference:reload",e.bind(function(){this.loadUserPreferences()
},this)),ABINEMASKME.contentuser={shouldSendErrorReports:e.bind(function(){return this.preferences&&this.preferences.isPrefTrue("shouldSendErrorReports")},this),getEmailSalt:e.bind(function(){return this.preferences?this.preferences.getPref("Salt.ShieldedEmail"):"NULL PREFERENCES"},this),hasRegEmail:e.bind(function(){return this.preferences?this.preferences.hasPref("regEmail"):!1},this),hasRegPassword:e.bind(function(){return this.preferences?this.preferences.hasPref("regPassword"):!1},this),shieldedEmails:new c.ShieldedEmailCollection},ABINEMASKME.contentuser.shieldedEmails.fetchAll(),this.notifyInit(),void 0):(this.messenger={send:function(){}},void 0)},triggerKeyboardEvent:function(e,t){var n=this.document.createEvent("KeyboardEvent");n.initKeyboardEvent?n.initKeyboardEvent(e,!0,!0,null,!1,!1,!1,!1,9,0):n.initKeyEvent&&n.initKeyEvent(e,!0,!0,null,!1,!1,!1,!1,9,0),t.dispatchEvent(n)},maskCardContextMenu:function(){if(this.lastElementClicked){var n={element:this.lastElementClicked,dataType:"/financial/creditcard/number"};this.createPanel({style:{},secured:!0,panelWidth:400,field:n,ready:e.bind(function(i){var r=new m({field:n,formEl:this.lastElementClicked.parentNode,contentManager:this,fromContextMenu:!0,authToken:this.preferences.getPref("authToken"),beginnerMode:this.preferences.getPref("beginnerMode"),hasRegistered:this.preferences.isPrefTrue("hasRegistered"),entitledToPayments:this.preferences.isPrefTrue("entitledToPayments"),hasEnabledPayments:this.preferences.isPrefTrue("hasEnabledPayments"),dynamicPanel:null,dynamicPanelsJSON:"",fields:[n],domain:this.domain,el:t("<div></div>",i).get(0)});t(n.element).one("mm.closepanel",e.bind(r.closePanel,r)),r.bind("remove",function(){t(n.element).unbind("mm.closepanel");try{r.remove()}catch(e){}this.removePanels()},this),r.bind("render resize",function(){this.autoResizePanels()},this),t("body",i).append(r.el)},this)})}},fillField:function(e){var n=e.element||this.lastElementClicked;if(n){"/password"==e.dataType&&(!this.generatedPassword&&e.generatedNow?this.generatedPassword=e.value:this.generatedPassword&&e.generatedNow&&(e.value=this.generatedPassword)),t(n).val(e.value),e.name=n.getAttribute("name"),e.id=n.getAttribute("id"),this.contextForm||(this.contextForm=t("<form maskMeFilled='yes'></form>",this.document));var i=t(n).clone();i.attr("abinedatatype",e.dataType),this.contextForm.append(i),t(this.contextForm.get(0)).data("mmFields",null),this.messenger.send("panel:fill",{fieldData:e,formData:o.getFormData(this.contextForm.get(0),this.domain)})}},trackLastElementClicked:function(e){("input"==e.target.localName||"textarea"==e.target.localName)&&(this.lastElementClicked=e.target)},isLocked:function(){return this._locked},locked:function(){this._locked=!0,this.trigger("locked"),this.domain&&this.messenger.send("contentscript:contextmenu:refresh",{domain:this.domain})},unlocked:function(){this._locked=!1,this.trigger("unlocked"),this.domain&&this.messenger.send("contentscript:contextmenu:refresh",{domain:this.domain})},notifyInit:function(){if(this.href){var e={url:this.href,domain:this.domain};this.messenger.send("contentManager:init",e),this.trigger("contentManager:init",e)}},start:function(t){return t=t||0,null===this._locked?(20>t&&a.setTimeout(e.bind(function(){this.start(t+1)},this),100),void 0):(this.blacklistedSites?this.loadUserPreferences(e.bind(this.startFormHelpers,this)):(this.blacklistedSites=new c.BlacklistedSiteCollection,this.blacklistedSites.loadBlacklistedForDomain(this.domain,e.bind(function(t){this.blacklisted=t,this.loadUserPreferences(e.bind(this.startFormHelpers,this))},this))),void 0)},loadUserPreferences:function(t){t=t||function(){},this.preferences=new c.PreferenceCollection({}),this.preferences.bind("sync:success",e.once(e.bind(function(){t.call(this)},this))),this.preferences.bind("sync:error",e.bind(function(){t.call(this)},this)),this.preferences.fetchAll()},arrayFromNodeList:function(e){return Array.prototype.slice.call(e)},hookForUserIntent:function(){this.userIntent=!0},hookNewFormsOnClick:function(n){if(!this.blacklisted){this.formHelpers=this.formHelpers||[];var i=n.target;if("input"===i.nodeName.toLowerCase()){var r=i.form||t(i).closest("form").get(0),s=null;r?(s=e(this.formHelpers).find(function(e){return e.formEl==r?!0:void 0}),s&&o.hasFormChanged(r)&&(s.cleanup(),this.formHelpers=e(this.formHelpers).filter(function(e){return e!=s}),s=null,o.clearFormCache(r)),s||this.setupFormHelperForFormEl(r,[],function(){a.setTimeout(function(){t(i).trigger("focus")},50)})):(s=e(this.formHelpers).find(function(e){for(var t=i.parentNode;t&&t!=e.formEl;)t=t.parentNode;return e.formEl==t?!0:void 0}),s?a.setTimeout(function(){t(i).trigger("focus")},50):this.startFormHelpers(function(){s=e(this.formHelpers).find(function(e){for(var t=i.parentNode;t&&t!=e.formEl;)t=t.parentNode;return e.formEl==t?!0:void 0}),a.setTimeout(function(){t(i).trigger("focus")},50)}))}}},setupFormHelperForFormEl:function(t,n,i){var r=null,a=null;if(this.domain&&this.domain.match(allowedHostsRegex)&&t.hasAttribute("datatype-ignore"))return i(),void 0;var u=o.getFormSignature(this.domain,t),d=null;if(this.formMappings&&(d=this.formMappings.find(function(e){return e.get("signature")==u?!0:!1})),a=d?d.get("formType"):o.getFormType(t),a==o.LOGIN_FORM?r=s.LoginHelper:a==o.REGISTRATION_FORM?r=s.RegistrationHelper:a==o.OTHER_FORM?r=s.OtherHelper:a==o.CHANGEPASSWORD_FORM?r=s.ChangePasswordHelper:a==o.LOGIN_REGISTRATION_FORM?r="loginRegisterHelper":a==o.CHECKOUT_FORM&&(r=s.CheckoutHelper),r){var l={};if(t.elements)for(var h=0;t.elements.length>h;h++)t.elements[h].name&&(l[t.elements[h].name]=1);var f=t.hasAttribute("action")?t.getAttribute("action"):"";n.push({url:f,type:a,fields:l});var p,m;if(d&&(m={},e.each(d.fields.models,function(e){m[e.get("signature")]=e.get("dataType")})),"loginRegisterHelper"==r||r==s.LoginHelper){var g=new c.Site({domain:this.domain}),y=e.bind(function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/content_manager]#[setupFormHelperForFormEl]# error while loading accounts for site"),r=e||!g.accounts||0==g.accounts.length?"loginRegisterHelper"==r?s.RegistrationHelper:r:s.LoginHelper,p=new r({el:t,mappedFields:m,contentManager:this,preferences:this.preferences,site:g}),this.formHelpers.push(p),i()},this);this.domain?g.loadAccounts(!1,y):y()}else p=new r({el:t,mappedFields:m,contentManager:this,preferences:this.preferences}),this.formHelpers.push(p),i()}},hookDocumentEventHandlers:function(n){this.userIntentHandler?(t(n).off("keydown",this.userIntentHandler),t(n).off("mousedown",this.userIntentHandler),t(n).off("mousedown",this.hookNewFormsOnClickHandler)):(this.userIntentHandler=e.bind(this.hookForUserIntent,this),this.hookNewFormsOnClickHandler=e.bind(this.hookNewFormsOnClick,this)),t(n).on("keydown",this.userIntentHandler),t(n).on("mousedown",this.userIntentHandler),t(n).on("mousedown",this.hookNewFormsOnClickHandler)},startFormHelpers:function(t){if(this.blacklisted)return t&&t(),void 0;this.hookDocumentEventHandlers(this.document);var n=Date.now();this.formHelpers=this.formHelpers||[],this.innerFrames=this.innerFrames||{};var i=this.arrayFromNodeList(this.document.getElementsByTagName("form")),r=this.arrayFromNodeList(this.document.getElementsByTagName("iframe"));if(e(r).each(function(t){try{var n=t.contentWindow||t.contentDocument;if(n){n.document&&(n=n.document),n.documentElement.mmFormsProcessed=!0;var r=this.arrayFromNodeList(n.getElementsByTagName("form"));if(r.length>0){var a="iframe."+Math.random();this.innerFrames[a]=t,e(r).each(function(e){e.setAttribute("abFrameId",a)}),i=i.concat(r)}}}catch(o){}},this),i=i.concat(o.getFieldGroupsWithoutForm(this.document)),i=e(i).filter(e.bind(function(e){for(var t=0;this.formHelpers.length>t;t++)if(this.formHelpers[t].formEl==e)return!1;return!0},this)),this.formsData=this.formsData||[],0==i.length)return t&&t(),void 0;var a=e.bind(function(){e.async.forEachSeries(i,e.bind(function(e,t){this.setupFormHelperForFormEl(e,this.formsData,t)},this),e.bind(function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/content_manager]#[startFormHandlers]# error event in setupFormHelperForFormEl while doing formElements async.forEach"),this.messenger.send("contentManager:formsInitialized",{forms:this.formsData,domain:this.domain}),this.trigger("contentManager:formsInitialized",{forms:this.formsData,domain:this.domain});{Date.now()-n}t&&t()},this))},this);!this.formMappings&&0!==i.length&&this.domain?(this.formMappings=new c.MappedFormCollection({}),this.formMappings.fetchAllByDomain(this.domain,e.bind(function(){a()},this))):a()},stopFormHelpers:function(){e(this.formHelpers).each(function(e){e.cleanup()}),this.formHelpers=[],this.formData=[],this.innerFrames=[]},setupFormsInFrame:function(n,i){if(n.documentElement&&!n.documentElement.mmFormsProcessed&&!this.blacklisted){this.hookDocumentEventHandlers(n),this.formHelpers=this.formHelpers||[],this.innerFrames=this.innerFrames||{},this.formsData=this.formsData||[];var r=null;!i&&n.defaultView&&n.defaultView.frameElement&&(i=n.defaultView.frameElement),i&&(r="iframe."+Math.random(),this.innerFrames[r]=i),n.documentElement.mmFormsProcessed=!0,t(n).bind("click",e.bind(this.hookNewFormsOnClick,this));var a=this.arrayFromNodeList(n.getElementsByTagName("form"));a=a.concat(o.getFieldGroupsWithoutForm(n));var s=[];e.async.forEachSeries(a,e.bind(function(e,t){r&&e.setAttribute("abFrameId",r),this.setupFormHelperForFormEl(e,s,t)},this),e.bind(function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/content_manager]#[setupFormsInFrame]# error in setupFormHelperForFormEl while doing formElements async.forEach"),this.formsData=this.formsData.concat(s),this.messenger.send("contentManager:formsInitialized",{forms:s,domain:this.domain}),this.trigger("contentManager:formsInitialized",{forms:s,domain:this.domain})},this))}},triggerFocusOnElement:function(e){t(e).trigger("focus")},getPanelForDataType:function(t,n){var i=e.find(t,function(e){return e.field_type==n});return i?i:!1},createPanel:function(t){if(t.style=e.extend({},y,t.style),t.document=this.document,t.field){var n=this.innerFrames;t.ready=e.wrap(t.ready,function(e,i,r){b(i,r.parentElement,t.field.element,n),e(i,r)}),this.closeCurrentPanel(),this._currentPanelField=t.field}return t.secured&&this.isLocked()&&this.createLoginPanel(t),t.panelWidth||(t.panelWidth=350),r.createPanel(t)},/**
       * @license
       * Array Remove Copyright (c) John Resig (MIT Licensed)
       */
removeFromArray:function(e,t,n){var i=e.slice((n||t)+1||e.length);return e.length=0>t?e.length+t:t,e.push.apply(e,i)},showNotification:function(n){if(this.preferences.getPref("showNotifications")&&n){var i=parseInt(this.preferences.getPref("countNotifications"))+1;this.preferences.setPref("countNotifications",i);var r=i>10?3e3:1e4;n.height=n.height?n.height:35,this.createPanel({className:"abineNotificationPanel",panelWidth:n.panelWidth,panelHeight:n.height,style:{borderRadius:"8px",height:n.height+"px",position:"Firefox"==ABINEMASKME.config.browser?"absolute":"fixed"},ready:e.bind(function(i,a){var o=f.NotificationPanelView;"card"==n.type?o=f.CardNotificationPanelView:"post-register"==n.type&&(o=f.PostRegisterNotificationPanelView);var s=new o({notification:n,domain:this.domain,el:t("<div></div>",i).get(0),timeout:r});this.notificationViews||(this.notificationViews=[]),this.notificationViews.unshift(a),s.bind("hide",function(){var t=e.find(this.notificationViews,function(e){return e==a});t&&(t.style.display="none")},this),s.bind("remove",function(){for(var e=0,n=0;this.notificationViews.length>n;n++)this.notificationViews[n]==a&&(e=n);if(this.removeFromArray(this.notificationViews,e),s.remove(),t(a.parentElement).remove(),this.notificationViews.length>0)for(var i=10,n=this.notificationViews.length-1;n>=0;n--)this.notificationViews[n].parentElement.style.top=i+"px",i+=this.notificationViews[n].parentElement.offsetHeight+5},this);var c=10;e.each(this.notificationViews,function(e){e!=a&&(c+=e.parentElement.offsetHeight+5)}),a.parentElement.style.top=c+"px",s.bind("render resize",function(){this.autoResizePanels("abineNotificationPanel")},this),t("body",i).append(s.el)},this)})}},createLoginPanel:function(n){n.contentManager=this,n.ready=e.bind(function(i,r){var a=this.innerFrames,o=n.field.element;b(i,r.parentElement,o,a);var s=new h({field:n.field,contentManager:n.contentManager,preferences:n.contentManager.preferences,el:t("<div></div>",i).get(0),doc:i});s.iframe=r,t(o).one("mm.closepanel",e.bind(s.closePanel,s)),s.bind("remove",function(){t(o).unbind("mm.closepanel"),s.remove(),this.removePanels(r),o.hasAttribute("mmHasFocusRemoved")?(o.removeAttribute("mmHasFocusRemoved"),o.setAttribute("mmHasFocus","yes")):o.removeAttribute("mmIgnoreBlur")},this),s.bind("render resize",function(){this.autoResizePanels()},this),t("body",i).append(s.el)},this)},isPanelShown:function(e){return this._currentPanelField&&this._currentPanelField==e},closeCurrentPanel:function(){this._currentPanelField&&(t(this._currentPanelField.element).trigger("mm.closepanel"),this._currentPanelField=null)},autoResizePanels:function(e){r.autoResizePanels({className:e,document:this.document})},removePanels:function(e){r.removePanels({document:this.document,iframe:e})},destroy:function(){try{l.securityManager.off("background:securityManager:locked",this.lockedCB)}catch(e){}try{l.securityManager.off("background:securityManager:unlocked",this.unlockedCB)}catch(e){}if("Firefox"!=ABINEMASKME.config.browser)try{l.disconnect()}catch(e){}try{this.disableFormHelpers()}catch(e){}if(this.messenger){try{this.messenger.send("contentManager:destroy")}catch(e){}this.messenger.off(),this.messenger.destroy(),delete this.messenger}}}),b=function(e,n,i,r){function a(){var e=null;if(i.form){var n=i.form.getAttribute("abFrameId");n&&n in r&&(e=r[n])}if(!e)try{e=i.ownerDocument.defaultView.frameElement}catch(a){}if(e){var s;try{s=t(e).offset()}catch(a){s=g(e)}o.top+=s.top+1-i.ownerDocument.body.scrollTop,o.left+=s.left-i.ownerDocument.body.scrollLeft}}var o;try{try{o=t(i).offset();try{i.ownerDocument!=n.ownerDocument&&a()}catch(s){}}catch(s){o=g(i),a()}o.top+=t(i,e).outerHeight()}catch(s){o={top:0,left:0}}n.style.top=o.top+"px",n.style.left=o.left+"px"};return{ContentManager:v}}),ABINEMASKME.define("abine/contextHelper",["documentcloud/underscore","abine/window","storage","abine/password","abine/config"],function(e,t,n,i,r){return{onClick:function(a,o,s,c,u){if(o.indexOf("abine_maskme_accountfield_")>=0){var d=o.split("accountfield_")[1];n.AccountField.load(d,e.bind(function(e){this.fillFieldInTab(a,s,{element:u,value:e.value,dataType:e.dataType,origin:e.origin})},this))}else switch(o){case"abine_maskme_email_mask":n.ShieldedEmail.index(null,e.bind(function(t){n.DisposableEmail.createOnServer({sender:s,payload:{targetGuid:t[0].guid,label:c}},e.bind(function(e){this.fillFieldInTab(a,s,{element:u,value:e.getAddress(),dataType:"/contact/email",origin:"disposable",disposableGUID:e.guid})},this))},this));break;case"abine_maskme_email_disclose":n.Preference.findBy("key","regEmail",e.bind(function(i){i?t.createTab({localUrl:"pages/index.html#editUser/email"}):n.ShieldedEmail.index(null,e.bind(function(e){this.fillFieldInTab(a,s,{element:u,value:e[0].email,dataType:"/contact/email",origin:""})},this))},this));break;case"abine_maskme_phone_mask":n.DisposablePhone.index(null,e.bind(function(e){this.fillFieldInTab(a,s,{element:u,value:e[0].getPrettyNumber(),origin:"disposable",disposableGUID:e[0].id,dataType:"/contact/phone"})},this));break;case"abine_maskme_phone_disclose":n.ShieldedPhone.index(null,e.bind(function(e){this.fillFieldInTab(a,s,{element:u,value:e[0].getPrettyNumber(),origin:"",dataType:"/contact/phone"})},this));break;case"abine_maskme_card_mask":this.triggerCreditCardPanelInTab(a,s,{});break;case"abine_maskme_activate_card":t.createTab({localUrl:"pages/index.html#payments"});break;case"abine_maskme_password_mask":this.fillFieldInTab(a,s,{element:u,value:i.generateRandomPassword(),origin:"strong",generatedNow:!0,dataType:"/password"});break;case"abine_maskme_unlock":t.createTab({forceReload:!0,localUrl:"pages/index.html#unlock"});break;case"abine_maskme_setup_phone":var l=function(){t.createTab({forceReload:!0,localUrl:"pages/index.html#userInfo"})};n.Preference.batchFindBy([{by:"key",value:"entitledToPhone"},{by:"key",value:"authToken"},{by:"key",value:"regEmail"},{by:"key",value:"regPassword"}],function(e){var i=e.entitledToPhone,a=e.authToken,o=e.regEmail,s=e.regPassword;!i||i.isFalse()?a&&a.value&&""!=a.value?n.ShieldedEmail.getDefault({},function(e){if(e&&""!=e.email){var n=r.protocol+r.licenseServerHost+"/subscriptions/id_me?auth_token="+a.value+"&email="+e.email+"&feature=phone";o&&s?n+="&notsetup=3":o?n+="&notsetup=1":s&&(n+="&notsetup=2"),t.createTab({force:!0,url:n})}else l()}):l():t.createTab({localUrl:"pages/index.html#editUser/phone"})});break;case"abine_maskme_blacklisted":t.createTab({localUrl:"pages/index.html#blacklist"})}},fillFieldInTab:function(e,t,n){e.send("background:contextmenu:fill",n,t)},triggerCreditCardPanelInTab:function(e,t,n){e.send("background:contextmenu:maskcard",n,t)}}}),ABINEMASKME.define("abine/core",["documentcloud/underscore"],function(e){Events={on:function(e,t,n){var i=this._callbacks||(this._callbacks={}),r=i[e]||(i[e]={}),a=r.tail||(r.tail=r.next={});return a.callback=t,a.context=n,r.tail=a.next={},this},off:function(e,t){var n,i,r;if(e){if(n=this._callbacks)if(t){if(i=n[e])for(;(r=i)&&(i=i.next);)if(i.callback===t){r.next=i.next,i.context=i.callback=null;break}}else n[e]={}}else this._callbacks=null;return this},trigger:function(e){var t,n,i,r,a,o=["all",e];if(!(n=this._callbacks))return this;for(;a=o.pop();)if(t=n[a])for(r="all"==a?arguments:Array.prototype.slice.call(arguments,1);t=t.next;)(i=t.callback)&&i.apply(t.context||this,r);return this},once:function(e,t,n){function i(){return r.off(e,i),t.apply(this,arguments)}var r=this;return this.on(e,i,n)},onceAny:function(){function e(){for(var n=0;t.length>n;n++)this.off.apply(this,[t[n][0],e]),this.off.apply(this,t[n])}for(var t=arguments,n=0;arguments.length>n;n++)this.on.apply(this,arguments[n]),this.on.apply(this,[arguments[n][0],e]);return this}};var t=function(){},n=function(n,i,r){var a;return a=i&&i.hasOwnProperty("constructor")?i.constructor:function(){return n.apply(this,arguments)},e.extend(a,n),t.prototype=n.prototype,a.prototype=new t,i&&e.extend(a.prototype,i),r&&e.extend(a,r),a.prototype.constructor=a,a.__super__=n.prototype,a},i=function(e,t){var i=n(this,e,t);return i.extend=this.extend,i},r=function r(){this.initialize.apply(this,arguments)};return e.extend(r.prototype,Events,{initialize:function(){}}),r.extend=i,{BaseClass:r,Events:Events}}),ABINEMASKME.define("abine/emailServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core"],function(e,t,n,i,r){var a=n.protocol+n.emailServerHost,o=a+"/api/v2/disableDisposable",s=a+"/api/v2/enableDisposable",c=a+"/api/v2/readDisposables",u=a+"/api/v2/readTarget",d=a+"/api/v2/generateDisposable",l=a+"/api/v2/disposableDomains",h=a+"/api/v2/disableAndDeleteDisposable",f=a+"/api/v2/webmail",p=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},getInbox:function(e,t){this.server.makeRequest({server:"email",action:"getInbox",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:f,type:"GET"})},getMail:function(e,t){this.server.makeRequest({server:"email",action:"getMail",defaults:{},required:["mid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:f+"/"+e.mid,type:"GET"})},getDisposableDomains:function(e,t){this.server.makeRequest({server:"email",action:"getDisposableDomains",defaults:{},required:["guid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:l,type:"GET"})},disableDisposable:function(e,t){this.server.makeRequest({server:"email",action:"disableDisposable",defaults:{},required:["guid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"PUT"})},disableAndDeleteDisposable:function(e,t){this.server.makeRequest({server:"email",action:"disableAndDeleteDisposable",defaults:{},required:["guid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:h,type:"DELETE"})},enableDisposable:function(e,t){this.server.makeRequest({server:"email",action:"enableDisposable",defaults:{},required:["guid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"PUT"})},readDisposables:function(e,t){this.server.makeRequest({server:"email",action:"readDisposables",defaults:{},required:["guid"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:c,type:"GET"})},readTarget:function(e,t){this.server.makeRequest({server:"email",action:"readTarget",defaults:{},required:["target_email"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:u,type:"GET"})},generateDisposable:function(e,t){this.server.makeRequest({server:"email",action:"generateDisposable",defaults:{domain:n.disposableDomain},required:["guid","domain"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:d,type:"POST"})}});return p}),ABINEMASKME.define("abine/failedSubmitDetector",["documentcloud/underscore","abine/core","storage","abine/timer","persistence","abine/url"],function(e,t,n,i,r,a){function o(t,n,i,r){if(l(n),n in v){var a=v[n],o=a.submitData;if(delete v[n],i)return s(a,r),void 0;var c=!1;e.each(t.forms,function(t){if(t.type==o.type&&t.fields){var n=0,i=0;e.each(o.data,function(e){e.name in t.fields?n++:i++}),n>=2&&n>i&&(c=!0)}}),c&&s(a,r),c||E.trigger("background:saveForm:retained",{type:a.type,formType:a.submitData.type,accountId:a.accountId,tabId:n,insuranceSubmit:a.submitData.insuranceSubmit,noPassword:a.submitData.noPassword,accountType:a.accountType})}else E.trigger("background:saveForm:retained",null),r&&r()}function s(t,i){var a=t.submitData,o=function(){E.trigger("background:saveForm:rollback",{accountId:t.accountId}),i&&i()};t.type==h||t.type==p?n.AccountActivity.all().filter("accountId","=",t.accountId).destroyAll(function(){n.Account.load(t.accountId,function(t){var i=function(e){return e.siteId==t.siteId};n.Account.listCached(i,function(i){var a=e.find(i,function(e){return"fill"==e.type&&e.id!=t.id});a?n.AccountField.getLatestForAccountId(a.id,function(e){n.AccountField.getLatestForAccountId(t.id,function(n){for(var i=0;n.length>i;i++){for(var s=!1,c=0;e.length>c;c++)n[i].dataType==e[c].dataType&&(s=!0,n[i].value==e[c].value&&(e[c].origin=n[i].origin));s?r.remove(n[i]):n[i].accountId=a.id}r.remove(t),r.flush(o)})}):(t.type="fill",r.flush(o))})})}):t.type==m?c(t.accountId,a.data,o):t.type!=g&&u(t.accountId,a.data,o)}function c(t,i,a){function o(e){return e.accountId==t&&1==e.latest&&"/password"==e.dataType}n.AccountField.listCached(o,function(i){e.async.forEach(i,function(e,i){n.AccountField.rollbackVersioned({payload:{name:e.name,value:e.value,dataType:e.dataType,accountId:t,modifiedAt:new Date}},function(){i()})},function(i){i&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/common/failed_submit_detector]#[rollbackAccountPassword]# error while rolling back password fields"),n.AccountActivity.all().filter("accountId","=",t).list(function(t){var n=null;e(t).each(function(e){n||"update password"!=e.activityType||(n=e)}),r.remove(n),r.flush(a)})})})}function u(t,i,r){var a=0,o=e.size(i),s=function(){a++,a==o&&r()};e.each(i,function(e){n.AccountField.rollbackVersioned({payload:{name:e.name,value:e.value,dataType:e.dataType,accountId:t,modifiedAt:new Date}},s)})}function d(t){l(t),v[t].failureTimer=i.setTimeout(e.bind(function(){t in v&&v[t].failureTimer&&(l(t),E.trigger("submitFailureDetector:recheckForms",t))},this),y)}function l(e){e in v&&v[e].failureTimer&&(i.clearTimeout(v[e].failureTimer),delete v[e].failureTimer)}var h=1,f=2,p=3,m=4,g=5,y=8e3,v={},b=t.BaseClass.extend({saveInProgress:!1,formsInitialized:function(t,n){this.saveInProgress?i.setTimeout(e.bind(function(){this.formsInitialized(t,n)},this),250):o(t,n)},contentManagerInit:function(t,n){this.saveInProgress?i.setTimeout(e.bind(function(){this.contentManagerInit(t,n)},this),250):l(n)},init:function(t){this.backgroundMessenger=t,t.on("contentManager:formsInitialized",this.formsInitialized,this),t.on("contentManager:init",this.contentManagerInit,this),this.on("submitFailureDetector:recheckForms",e.bind(function(e){t.send("background:failedSubmitDetector:recheckForms",{},e)},this)),this.on("background:saveForm:rollback",e.bind(function(){t.send("broadcast:saveForm:rollback")},this)),this.on("background:saveForm:retained",e.bind(function(e){if(e&&e.accountId){var r;if(e.type==h){if("passwordless"==e.accountType)return;e.msg="MaskMe will help you login here in the future.",r=340}else if(e.type==f)e.msg="MaskMe has saved the changes to your account.",r=340;else if(e.type==m)e.msg="MaskMe has updated this account's password",r=340;else if(e.type==g)return;n.Preference.findBy("key","rememberAccounts",function(a){var o=a?a.value:"false";n.Preference.findBy("key","rememberOnlyMaskMe",function(n){var a=n?n.value:"false";("false"!==o&&("true"!==o||"true"!==a)||"loginForm"!==e.formType)&&(e.noPassword||e.insuranceSubmit||i.setTimeout(function(){t.send("background:saveForm:notification",{msg:e.msg,targetUrl:"pages/index.html#sites",panelWidth:r},e.tabId)},2e3))})})}},this))},monitor:function(e,t,n,i,r){var a={fill:p,"new":h,changepass:m,update:f,login:g};n=a[n],v[e]={submitData:t,accountId:i,type:n,accountType:r},d(e)},rollbackPending:function(e,t){o([],e,!0,t)},setTimeout:function(e){y=e}}),E=new b;return E}),ABINEMASKME.define("abine/formAnalyzer",["documentcloud/underscore","jquery","pidcrypt","abine/phoneHeuristics","abine/paymentHeuristics","abine/url"],function(e,t,n,i,r,a){var o="loginForm",s="registrationForm",c="checkoutForm",u="changepasswordForm",d="otherForm",l="loginRegistrationForm",h="emailField",f="passwordField",p="phoneField",m="usernameField",g="paymentField",y={checkbox:1,radio:1,hidden:1,button:1,submit:1,file:1,image:1},v={LOGIN_FORM:o,REGISTRATION_FORM:s,CHECKOUT_FORM:c,CHANGEPASSWORD_FORM:u,OTHER_FORM:d,LOGIN_REGISTRATION_FORM:l,EMAIL_FIELD:h,PASSWORD_FIELD:f,PHONE_FIELD:p,USERNAME_FIELD:m,PAYMENT_FIELD:g,getFormType:function(t){var n=v.getFields(t),i=0,r=0,a=0,l=0,h={},f=0;e(n).each(function(e){"/ignore"!=e.dataType&&("password"==e.fieldType||"/password"==e.dataType||"/passwordold"==e.dataType?(i++,h[e.fieldType]||(h[e.fieldType]=0),h[e.fieldType]++):(e.fieldType in{text:1,email:1,tel:1}&&r++,"/contact/email"==e.dataType?a++:"/nameperson/friendly"==e.dataType&&l++,e.dataType&&e.dataType.indexOf("financial")>=0&&f++))}),h.text&&h.password&&(i-=h.text);var p=d;return 0===i?a>=1?p=s:1===l&&(p=o):1===i?p=r>1?s:o:2===i?p=s:3===i&&(p=u),f>0&&(p=c),p},hasFormChanged:function(e){for(var n=t(e).find("input, textarea").toArray(),i=0;n.length>i;i++)if(!t(n[i]).data("mmProcessed"))return!0;var r=this.getFields(e);for(var i in r)if(!r[i].element.parentNode)return!0;return!1},clearFormCache:function(e){t(e).removeData("mmSignature"),t(e).removeData("mmFields")},getFormSignature:function(e,i){var r,a,o,s={},c=t(i).find("input, textarea").toArray(),u=t(i).data("mmSignature");if(u)return u;u="",u+=e;for(var d=[],l=0;c.length>l;l++)if(o=c[l],!(o.hasAttribute("type")&&o.getAttribute("type").toLowerCase()in y||o.hasAttribute("readonly"))){if(a=o.nodeName.toLowerCase(),r=o.name||o.id||a,s[r]){for(var h=2;s[r+h];)h++;r+=h}d.push(r),s[r]=1}d.sort();for(var l=0;d.length>l;l++)u+=d[l]+"_";return u=n.SHA1(u),t(i).data("mmSignature",u),u},getFields:function(e,n){var a,o,s,c,u,d,l,h,f=[],p=0,m=0,g=t(e).data("mmFields");if(g)return g;g={},t(e).data("mmFields",g);for(var b=t(e).find("input, textarea, select").toArray(),A=v.getLabelMapFor(e),_=0;b.length>_;_++)if(d=b[_],t(d).data("mmProcessed",1),!(d.hasAttribute("type")&&d.getAttribute("type").toLowerCase()in y||d.hasAttribute("readonly"))){if(p+=1,o=d.nodeName.toLowerCase(),a=d.name||d.id||o,g[a]){for(var S=2;g[a+S];)S++;a+=S}u=A[d.id||d.name]?A[d.id||d.name].text:null,null==u&&d.hasAttribute("placeholder")&&(u=d.getAttribute("placeholder")),""==u&&(u=null),"select"==o?l="select":"textarea"==o?l="textarea":"input"==o&&(l=d.getAttribute("type")?d.getAttribute("type").toLowerCase():"text"),"email"==l?c="/contact/email":"tel"==l?c="/contact/phone":(h=d.name||E(d.id)||d.className||"",c=v.getDataTypeByRegExRules(h,u,l,d.innerHTML),"password"!=l||"/passwordold"==c||c&&-1!=c.indexOf("/financial")||(c="/password"),"/password"==c&&(m++,s||(s=a))),n&&n[a]&&(c=n[a]),d.hasAttribute("abinedatatype")&&(c=d.getAttribute("abinedatatype")),g[a]={position:p,element:d,fieldType:l,id:d.id,className:d.className,name:d.name,dataType:c,label:u,signature:a,maxlength:d.hasAttribute("maxlength")?parseInt(d.getAttribute("maxlength")):null,size:d.size?d.size:null},f[p]=g[a],f[p].key=a}return n||(3==m&&(g[s].dataType="/passwordold"),i.apply(g,f),r.apply(g,f)),g},getProtocol:function(e,t){var n=e.getAttribute("action");return n&&0===n.indexOf("http")||(n=t),n.replace(/:.*/,"")},getPageDomain:function(e){return a.getHostname(e)},getFormDomain:function(e,t){var n=e.getAttribute("action");return n?n.match(/(http[s]?:)?\/\//i)?a.getHostname(n):a.getHostname(t):""},getFormData:function(n,i){var r=n.hasAttribute("action")?n.getAttribute("action"):i,a=v.getFields(n),o=v.getFormType(n),s=v.getFormSignature(i,n),c={url:r,type:o,data:[],pageUrl:i,formSignature:s};return"yes"===t(n).attr("maskMeFilled")&&(c.origin="MaskMe"),c.protocol=this.getProtocol(n,i),c.page_domain=this.getPageDomain(i),c.form_domain=this.getFormDomain(n,i),e.each(a,function(e){-1=="submit.image.button".indexOf(e.fieldType)&&(-1=="checkbox.radio".indexOf(e.fieldType)||e.element.checked)&&c.data.push({name:e.name,id:e.id,dataType:e.dataType,value:t(e.element).val()||""})}),c},getFieldType:function(e){var t=e.nodeName.toLowerCase();if("select"==t)return"select";if("textarea"==t)return"textarea";if("input"==t){var n=e.getAttribute("type");return n?n.toLowerCase():"text"}},getLabelMapFor:function(e){var n,i={};return t(e).find("label").each(function(e,r){if(n=r.getAttribute("for"))i[n]||(i[n]={element:r,text:t(r).text()||r.name||r.id});else{var a=r.nextSibling;for(a||(a=r.parentNode.nextSibling);a&&1!=a.nodeType;)a=a.nextSibling;if(a&&!a.form&&a.firstChild)for(a=a.firstChild;a&&1!=a.nodeType;)a=a.nextSibling;a&&a.form&&(a.id||a.name)&&(i[a.id||a.name]={element:r,text:t(r).text()||r.name||r.id})}}),i},getLabelFor:function(e,n){var i=e.id||e.name;return i?t(n).find('label[for="'+i+'"]').get(0):null},getDataTypeByRegExRules:function(t,n,i,r){var a=t&&t.length>0,o=n&&n.length>0,s=a?t.replace(A.nonAlphanumeric,""):null,c=o?n.replace(A.nonAlphanumeric,""):null;s==t&&(alternameName=null),c==n&&(alternameLabel=null);var u=n+t,d=c+s,l=b[i];if(!l)return null;for(var h=[],f=0;l.length>f;f++){var p=l[f],m="undefined"!=typeof p.label,g="undefined"!=typeof p.name;if(!p.negative||!(t&&t.match(p.negative)||n&&n.match(p.negative))){if(o&&!m&&g&&n.match(p.name)||o&&m&&n.match(p.label)||a&&g&&t.match(p.name)||c&&!m&&g&&c.match(p.name)||c&&m&&c.match(p.label)||s&&g&&s.match(p.name)){if(p.options&&r&&!r.match(p.options))continue;h.push(p.data_type);break}if(p.label_name&&o&&a&&(!m&&g&&u.match(p.name)||m&&u.match(p.label)||g&&u.match(p.name)||d&&!m&&g&&d.match(p.name)||d&&m&&d.match(p.label)||d&&g&&d.match(p.name))){h.push(p.data_type);break}if(p.matchByOptions&&p.options&&r&&r.match(p.options)){h.push(p.data_type);break}}}if(1==h.length)return h[0];if(h.length>1){var y=e(h).find(function(e){return"/contact/email"==e?!0:void 0});return y?y:h[0]}return null},getFieldGroupsWithoutForm:function(t){for(var n={text:1,password:1,email:1,tel:1},i=t.getElementsByTagName("input"),r=(e(i).filter(function(e){if(e.form)return!1;var t=e.type?e.type.toLowerCase():"text";return t in n},this)),a=[],o=[],s=[1],c={},u=0;r.length>u;u++){for(var d=r[u].parentNode,l={},h=0,f=!1;d&&3>h;){if(d.id=d.id||"abId"+Math.random(),u>0&&d.id in o[u-1]){s[u]=s[u-1],l=o[u-1],(!(s[u-1]in c)||h>c[s[u-1]].depth)&&(c[s[u-1]]={lca:d,depth:h}),f=!0;break}l[d.id]=1,d=d.parentNode,h++}o.push(l),f||(s[u]=0==u?1:s[u-1]+1,c[s[u]]={lca:r[u].parentNode,depth:0})}var p={};for(var m in c)c[m].lca.id in p||(p[c[m].lca.id]=1,a.push(c[m].lca));return a.length>0,a}},b={text:[{name:/.*captcha.*/i,data_type:"/ignore"},{name:/^q$|find|search|terms/i,data_type:"/ignore"},{name:/hint/i,data_type:"/ignore"},{name:/email|e\-mail/i,label:/windowsliveid|email|e\-mail/i,negative:/search|friend|reference|recipient|reference|receiver/i,data_type:"/contact/email"},{name:/user|userid|alias|login|uname|yahooid|onlineid|session_key|(?:(?:nick|screen|member|usr|user|account|login|display).*(name|id))/i,label:/alias|shortname|login|handle|display.*name|user[\s]*(name|id)/i,negative:/credit|password|full/i,data_type:"/nameperson/friendly"},{name:/(?:title|salutation)/i,data_type:"/nameperson/prefix"},{name:/(?:lname|last|sur).*(?:name)?/i,label:/last.*name/i,data_type:"/nameperson/last",negative:/full/i},{name:/(?:fname|first).*(?:name)?/i,label:/first.*name/i,data_type:"/nameperson/first",negative:/full/i},{name:/(?:.*(?:full|invoice|real|bill|(?:ship.*to)).*name)|(?:^name$)/i,negative:/holder|credit/i,data_type:"/nameperson/full"},{label:/(?:middle|middleinitial)/i,data_type:"/nameperson/middle"},{label:/(?:suffix)/i,data_type:"/nameperson/suffix"},{name:/(?:(?:confirm|new|create|re\-enter)[\s]*)?password(?:(?:confirm|new|create|re\-enter)[\s]*)?/i,label:/(?:(?:confirm|new|create|re\-enter)[\s]*)?password/i,negative:/hint|old|current/i,data_type:"/password"},{name:/(?:old|current)[\s]*(?:pass|pwd)/i,label:/[\s]*(?:(?:current|old)[\s]*)password/i,data_type:"/passwordold"},{label:/.*twitter.*/i,data_type:"/contact/im/twitter"},{label:/.*linkedin.*/i,data_type:"/contact/web/linkedin"},{label:/.*blog.*/i,data_type:"/contact/web/blog"},{label:/.*aim/i,data_type:"/contact/IM/aim"},{label:/.*icq.*/i,data_type:"/contact/IM/icq"},{label:/.*msn(?:m)?/i,data_type:"/contact/IM/msn"},{label:/.*jabber/i,data_type:"/contact/IM/jabber"},{label:/.*skypq/i,data_type:"/contact/IM/skype"},{label:/.*(?:yim|yahoo)/i,data_type:"/contact/IM/yahoo"},{name:/(?:home).*phone.*(?:num|number)/i,label:/even.*phone/,negative:/gift|loyalty/i,data_type:"/contact/phone"},{name:/.*(?:cell|mob(?:ile)?).*/i,data_type:"/contact/phone/mobile"},{name:/.*fax.*/i,data_type:"/contact/phone/fax"},{name:/(?:day|daytime|work|business).*phone/i,label:/(?:day|daytime|work|business).*phone/,data_type:"/contact/phone/work"},{name:/(?:night|nighttime|home).*phone/i,label:/(?:night|nighttime|home).*phone/,data_type:"/contact/phone/home"},{name:/area.*code.*/i,data_type:"/contact/phone/areacode",negative:/zip/i},{name:/(?:phone.*(?:area|1).*)/i,data_type:"/contact/phone/areacode",negative:/zip/i},{name:/(?:phone.*(?:exch|prefix|first|2).*)|(?:exchange)/i,data_type:"/contact/phone/exchange"},{name:/phone.*(?:suffix|end|last|3).*/i,data_type:"/contact/phone/local",negative:/zip/i},{name:/phone.*(?:country|countrycode).*/i,label:/\+1/,data_type:"/contact/phone/countrycode"},{name:/home.*(?:exch|prefix).*/i,data_type:"/contact/phone/exchange"},{name:/home.*area.*/i,data_type:"/contact/phone/areacode",negative:/zip/i},{name:/home.*(?:num|suffix|end).*/i,data_type:"/contact/phone/local"},{name:/home.*(?:country|countrycode).*/i,data_type:"/contact/phone/countrycode"},{name:/area.*code/i,data_type:"/contact/phone/areacode",negative:/zip/i},{name:/exchange/i,data_type:"/contact/phone/exchange"},{name:/local/i,data_type:"/contact/phone/local"},{name:/phone.*(?:ext|extension)/i,data_type:"/contact/phone/extension",negative:/text/i},{name:/extension/i,data_type:"/contact/phone/extension"},{name:/phone/i,label:/phone/i,data_type:"/contact/phone"},{name:/(?:bill|b).*(?:zip|postal|post)(?:.*code)?/i,data_type:"/contact/postalcode/billing"},{name:/.*(?:zip|postal|post)(?:.*code)?/i,data_type:"/contact/postalcode"},{name:/bill.*city/i,data_type:"/contact/city/billing"},{name:/business.*city/i,data_type:"/contact/city/business"},{name:/home.*city/i,data_type:"/contact/city/home"},{name:/city/i,data_type:"/contact/city"},{name:/bill.*country/i,data_type:"/contact/country/billing"},{name:/business.*country/i,data_type:"/contact/country/business"},{name:/home.*country/i,data_type:"/contact/country/home"},{name:/country/i,data_type:"/contact/country"},{name:/bill.*state/i,data_type:"/contact/state/billing"},{name:/business.*state/i,data_type:"/contact/state/business"},{name:/home.*state/i,data_type:"/contact/state/home"},{name:/state/i,data_type:"/contact/state"},{name:/bill.*addr.*2/i,data_type:"/contact/postaladdressAdditional/billing"},{name:/home.*addr.*2/i,data_type:"/contact/postaladdressAdditional/home"},{name:/(?:addr.*2)|(?:(?:ad.*)?line.*2)/i,label:/.*address.*(?:line)?.*2.*/,data_type:"/contact/postaladdressAdditional"},{name:/bill.*addr.*3/i,data_type:"/contact/postaladdress3/billing"},{name:/home.*addr.*3/i,data_type:"/contact/postaladdress3/home"},{name:/(?:addr.*3)|(?:(?:ad.*)?line.*3)/i,label:/.*address.*(?:line)?.*3.*/,data_type:"/contact/postaladdress3"},{name:/bill.*addr/i,data_type:"/contact/postaladdress/billing"},{name:/home.*addr/i,data_type:"/contact/postaladdress/home"},{name:/(?:addr.*1?)|(?:(?:ad.*)?line.*1?)/i,label:/.*address.*(?:line1?)?.*/,negative:/type/i,data_type:"/contact/postaladdress"},{name:/.*(?:comment|message).*/i,data_type:"/message"},{name:/.*(?:(?:(?:cc|card)?.*(?:(?:holder|owner).*)))|(?:name.*on.*card)|(?:issued.*to)|(?:(?:card|cc|payment).*name)/i,label:/(?:issued.*to)|(?:name.*on.*card)|(?:card.*name)|(?:card.*holder)/i,negative:/gift|placeholder|account|acct|first|last|num|cvv/i,data_type:"/financial/creditcard/issuedto"},{name:/.*(?:cc|card|credit.*card)?(?:(?:cvv|cvc|ccv|cv|cid|verify|verif.*(?:code|num)|verification|sec.*code|card.*sec.*num)|cvv).*/i,negative:/gift/i,data_type:"/financial/creditcard/verification"},{name:/.*(?:cc|card|credit.*card|payment).*(?:num|number|no)|ccard/i,label:/card.*number/i,negative:/gift|account|reward|acct|issue/i,data_type:"/financial/creditcard/number"},{name:/.*(?:cc|card|credit.*card).*(?:type|issuer)/i,negative:/gift/i,data_type:"/financial/creditcard/type"},{name:/.*(?:(?:(?:cc|card|billing)?.*(?:exp.*))|(?:(?:cc|card).*(?:exp.*)))(?:date.*)?(?:[m]{2}|mo|mon|month|mn)/i,negative:/gift|start|valid|birth/i,data_type:"/financial/creditcard/expirymonth"},{name:/.*(?:(?:(?:cc|card|billing)?.*(?:exp.*))|(?:(?:cc|card).*(?:exp.*)))(?:date.*)?(?:[y]{2,4}|yr|year)/i,negative:/gift|start|valid|birth/i,data_type:"/financial/creditcard/expiryyear"},{name:/.*(?:(?:(?:cc|card|billing)?.*(?:exp.*))|(?:(?:cc|card).*(?:exp.*))|expiration)/i,negative:/gift|year|yr|mon|mm|yy|start|valid|birth/i,data_type:"/financial/creditcard/expiry"},{name:/(?:birth.*year)|(?:dob[y]+)|(?:(?:dob|date).*year.*)|(?:year.*(?:born|birth))|(?:birthday[y]+r?)/i,negative:/exp/i,data_type:"/birthdate/birthyear"},{name:/(?:birth.*mon(?:th)?)|(?:dob[m]+)|(?:(?:dob|date).*mon(?:th)?.*)|(?:month.*(?:born|birth))|(?:birthday[m]+)/i,negative:/exp/i,data_type:"/birthdate/birthmonth"},{name:/(?:birth.*day)|(?:dob[d]+)|(?:(?:dob|date).*(?:day|date).*)|(?:day.*(?:born|birth))|(?:birthday[d]+)/i,data_type:"/birthdate/birthday"},{name:/(?:b|birth|dob)(?:day|date)/i,data_type:"/birthdate"},{name:/.*(?:co|comp|company|business)(?:name)/i,label:/(?:company|business|organization)(?:\s+name)?/i,data_type:"/company/name"},{name:/.*(?:customer).*(?:company).*/i,data_type:"/company/name"},{name:/^pin$/i,label:/^pin$/i,data_type:"/pin"}],password:[{name:/.*(?:cc|card|credit.*card)?(?:cvv|cvc|ccv|id|verify|verif.*(?:code|num)|verification|security.*code|card.*sec.*num).*/i,negative:/gift|password|pass/i,data_type:"/financial/creditcard/verification"},{name:/pin/i,label:/pin/i,data_type:"/pin"},{name:/(?:(?:confirm|new|create|re\-enter|verify)[\s]*)?password(?:(?:confirm|new|create|re\-enter)[\s]*)?/i,label:/(?:(?:confirm|new|create|re\-enter)[\s]*)?password/i,negative:/hint|old|current/i,data_type:"/password"},{name:/(?:old|current)[\s]*(?:pass|pwd)/i,label:/[\s]*(?:(?:current|old)[\s]*)password/i,data_type:"/passwordold"}],select:[{name:/(?:title|salutation)/i,data_type:"/nameperson/prefix"},{name:/.*(?:cc|card|credit.*card|payment).*(?:type|issuer)/i,negative:/gift/i,data_type:"/financial/creditcard/type",options:/visa|diner|amex|american[^<]*express/i,matchByOptions:!0},{name:/.*(?:(?:(?:cc|card|billing|payment)?.*(?:exp.*))|(?:(?:cc|card).*(?:exp.*)?)|exp.*)(?:date.*)?(?:[m]{2}|mo|mon|month|mn)/i,negative:/gift|start|valid|birth/i,data_type:"/financial/creditcard/expirymonth",options:/12|jan|feb/i},{name:/.*(?:(?:(?:cc|card|billing|payment)?.*(?:exp.*))|(?:(?:cc|card).*(?:exp.*)?)|exp.*)(?:date.*)?(?:[y]{2,4}|yr|year)/i,negative:/gift|start|valid|birth/i,data_type:"/financial/creditcard/expiryyear",options:/20[0-9]{2}/i},{name:/(?:birth.*year)|(?:dob[y]+)|(?:(?:dob|date).*year.*)|(?:year.*(?:born|birth))|(?:birthday[y]+r?)/i,negative:/exp/i,data_type:"/birthdate/birthyear"},{name:/(?:birth.*mon(?:th)?)|(?:dob[m]+)|(?:(?:dob|date).*mon(?:th)?.*)|(?:month.*(?:born|birth))|(?:birthday[m]+)/i,negative:/exp/i,data_type:"/birthdate/birthmonth"},{name:/(?:birth.*day)|(?:dob[d]+)|(?:(?:dob|date).*(?:day|date).*)|(?:day.*(?:born|birth))|(?:birthday[d]+)/i,data_type:"/birthdate/birthday"},{name:/(?:b|birth|dob)(?:day|date)/i,data_type:"/birthdate"},{name:/gender|sex/i,data_type:"/person/gender"},{name:/phone.*(?:country|countrycode).*/i,data_type:"/contact/phone/countrycode"},{name:/home.*(?:country|countrycode).*/i,data_type:"/contact/phone/home/countrycode"},{name:/bill.*country/i,data_type:"/contact/country/billing"},{name:/business.*country/i,data_type:"/contact/country/business"},{name:/home.*country/i,data_type:"/contact/country/home"},{name:/country/i,data_type:"/contact/country"},{name:/bill.*state/i,data_type:"/contact/state/billing"},{name:/business.*state/i,data_type:"/contact/state/business"},{name:/home.*state/i,data_type:"/contact/state/home"},{name:/state/i,data_type:"/contact/state"}],checkbox:[{name:/agree|tos|terms|service/i,data_type:"/agreetos"},{name:/(?:accept|agree|terms|(?:read)?rules|conditions|privacypolicy).*/i,data_type:"/agreetos"},{name:/.*(?:remember|persistent).*/i,label:/keepmesignedin/i,data_type:"/rememberme"}],radio:[{name:/gender|sex/i,label:/^(?:male|female)$/i,data_type:"/person/gender"}]},E=function(e){var t=e.match(/^user\[(.*)\]$/);return t?t[1]:e},A={nonAlphanumeric:/[^a-z0-9]+/gim,nonAlpha:/[^a-z]+/gim,spaces:/[\s]+/gim,startsWithDot:/^\./,trimSepartor:/(^\|\|)|(\|\|$)/g,textOrSelect:/text|select/i,email:/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~\-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~\-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9\-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i};
return v}),ABINEMASKME.define("abine/formObserver",["documentcloud/underscore","jquery","abine/core","abine/contentMessenger","abine/formAnalyzer","abine/timer"],function(e,t,n,i,r,a){function o(e){return e in c?c[e]:(e=e.substr(0,e.lastIndexOf("/")),e in c?c[e]:null)}function s(e){var t=e.dataType;return t?t in c?!0:(t=t.substr(0,t.lastIndexOf("/")),t in c):!1}var c={"/contact/email":r.EMAIL_FIELD,"/password":r.PASSWORD_FIELD,"/contact/phone":r.PHONE_FIELD,"/contact/phone/countrycode":r.PHONE_FIELD,"/contact/phone/areacode":r.PHONE_FIELD,"/contact/phone/exchange":r.PHONE_FIELD,"/contact/phone/local":r.PHONE_FIELD,"/contact/phone/number":r.PHONE_FIELD,"/contact/phone/extension":r.PHONE_FIELD,"/nameperson/friendly":r.USERNAME_FIELD,"/financial/creditcard/number":r.PAYMENT_FIELD,"/financial/creditcard/number/part1":r.PAYMENT_FIELD,"/financial/creditcard/number/part2":r.PAYMENT_FIELD,"/financial/creditcard/number/part3":r.PAYMENT_FIELD,"/financial/creditcard/number/part4":r.PAYMENT_FIELD,"/financial/creditcard/type":r.PAYMENT_FIELD,"/financial/creditcard/issuedto":r.PAYMENT_FIELD,"/financial/creditcard/expiry":r.PAYMENT_FIELD,"/financial/creditcard/expiryyear":r.PAYMENT_FIELD,"/financial/creditcard/expirymonth":r.PAYMENT_FIELD,"/financial/creditcard/verification":r.PAYMENT_FIELD},u=["focus.mm","click.mm","blur.mm","change.mm"],d=n.BaseClass.extend({initialize:function(t){if(this.id=e.uniqueId(),this.el=t.el,this.mappedFields=t.mappedFields,this.messenger=t.messenger||this,this.contentManager=t.contentManager,this.strategy=t.strategy,!this.el)throw"Error: FormObserver initialized without a form element.";this.triggerFormPresent(),this.bindToFormEvents()},getType:function(){return this.formType||(this.formType=r.getFormType(this.el)),this.formType},getFields:function(){return this.fields||(this.fields=r.getFields(this.el,this.mappedFields)),this.fields},triggerFormPresent:function(){formType=this.getType(),formType==r.LOGIN_FORM?this.trigger("loginFormPresent",{formObserver:this,fields:this.getFields()}):formType==r.REGISTRATION_FORM?this.trigger("registrationFormPresent",{formObserver:this,fields:this.getFields()}):formType==r.CHECKOUT_FORM&&this.trigger("checkoutFormPresent",{formObserver:this,fields:this.getFields()})},bindToFormEvents:function(){var n=u.join(" "),i=this.getFields();e(i).each(function(i){var r=s(i);if(r){if(this.strategy&&this.strategy.fieldTypeDisabled(i.dataType))return;t(i.element).bind(n,e.bind(function(t){if(!this.contentManager||this.contentManager.userIntent){if("focus"==t.type){if(i.element.getAttribute("mmHasFocus"))return;i.element.setAttribute("mmHasFocus","yes")}else if("blur"==t.type)return i.element.removeAttribute("mmHasFocus"),i.element.removeAttribute("mmHasFocusRemoved"),void 0;if(!i.element.getAttribute("mmautofilling")&&!i.element.getAttribute("mmIgnoreBlur")){if("click"==t.type||"focus"==t.type){if(i.element.getAttribute("mmIgnoreClickFocus"))return;i.element.setAttribute("mmIgnoreClickFocus","yes"),a.setTimeout(function(){i.element.removeAttribute("mmIgnoreClickFocus")},750)}var n=o(i.dataType);if(n){var r=l(n,t.type);r&&a.setTimeout(e.bind(function(){this.trigger(r,{formObserver:this,field:i,type:t.type,keyCode:"keydown"===t.type?t.keyCode:0})},this),0)}}}},this))}},this)},unbindFormEvents:function(){var n=u.join(" "),i=this.getFields();e(i).each(function(e){t(e.element).unbind(n)})}}),l=function(e,t){var n;return e==r.EMAIL_FIELD?n="emailField":e==r.PHONE_FIELD?n="phoneField":e==r.PASSWORD_FIELD?n="passwordField":e==r.USERNAME_FIELD?n="usernameField":e==r.PAYMENT_FIELD&&(n="paymentField"),"change"==t?n+="Changed":"focus"==t?n+="Focused":"blur"==t?n+="Blurred":"click"==t?n+="Clicked":"keydown"==t&&(n+="Keydown"),n};return{FormObserver:d,LOGIN_FORM:r.LOGIN_FORM,REGISTRATION_FORM:r.REGISTRATION_FORM,CHECKOUT_FORM:r.CHECKOUT_FORM,OTHER_FORM:r.OTHER_FORM}}),ABINEMASKME.define("abine/formStrategy",["jquery","documentcloud/underscore","abine/core","abine/formObserver","abine/timer","abine/formAnalyzer","abine/views/emailHelperPanel","abine/views/passwordHelperPanel","abine/views/phoneHelperPanel","abine/views/loginHelperPanel","abine/views/paymentHelperPanel","models","abine/config","abine/url"],function(e,t,n,i,r,a,o,s,c,u,d,l,h,f){var p=!1,m={fieldTypeDisabled:function(e){return"/contact/email"==e?this.emailDisabledHere():"/contact/phone"==e?this.phoneDisabledHere():"/password"==e?this.passwordDisabledHere():e.match(/creditcard|state|city|postal|country/)?this.cardDisabledHere():!1},emailDisabledHere:function(){return this.contentManager.preferences&&!this.contentManager.preferences.getPref("suggestProtectedEmail")},passwordDisabledHere:function(){return this.contentManager.preferences&&!this.contentManager.preferences.getPref("suggestStrongPassword")},phoneDisabledHere:function(){return this.contentManager.preferences&&!this.contentManager.preferences.getPref("suggestProtectedPhone")},cardDisabledHere:function(){return this.contentManager.preferences&&!this.contentManager.preferences.getPref("suggestProtectedCard")},disableAutoComplete:function(e){e.hasAttribute("autocomplete")&&!e.hasAttribute("oldautocomplete")?e.setAttribute("oldautocomplete",e.getAttribute("autocomplete")):e.hasAttribute("autocomplete")||e.setAttribute("oldautocomplete","remove"),e.setAttribute("autocomplete","off")},enableAutoComplete:function(e){e.hasAttribute("oldautocomplete")&&("remove"==e.getAttribute("oldautocomplete")?e.removeAttribute("autocomplete"):e.setAttribute("autocomplete",e.getAttribute("oldautocomplete")),e.removeAttribute("oldautocomplete"))},cleanupPanel:function(t,n,i){try{t.remove()}catch(r){}e(n).unbind("mm.closepanel"),this.contentManager.removePanels(t.iframe),i&&this.enableAutoComplete(n),n.hasAttribute("mmHasFocusRemoved")?(n.removeAttribute("mmHasFocusRemoved"),n.setAttribute("mmHasFocus","yes")):n.removeAttribute("mmIgnoreBlur")},canShowMaskMeHelper:function(e,t){var n=e.field.element,i=e.type;if("click"==i&&"register"==t&&p){if(n.hasAttribute("mmHasFocus"))return this.contentManager.isPanelShown(e.field)?!0:(n.removeAttribute("mmHasFocus"),n.setAttribute("mmHasFocusRemoved","yes"),this.disableAutoComplete(n),!1);n.removeAttribute("mmHasFocusRemoved"),n.setAttribute("mmHasFocus","yes")}return!0},bindFieldChangeObserver:function(){this.formObserver=this.formObserver||new i.FormObserver({el:this.formEl,mappedFields:this.mappedFields,contentManager:this.contentManager,strategy:this}),this.formObserver.on("emailFieldChanged",this.onFieldChanged,this),this.formObserver.on("usernameFieldChanged",this.onFieldChanged,this),this.formObserver.on("passwordFieldChanged",this.onFieldChanged,this),this.formObserver.on("phoneFieldChanged",this.onFieldChanged,this),this.formObserver.on("paymentFieldChanged",this.onFieldChanged,this)},onFieldChanged:function(e){var t=e.field;t.origin="change";var n={name:t.name,origin:t.origin,dataType:t.dataType,value:t.value};this.contentManager.messenger.send("contentManager:formFieldChanged",{fieldData:n,formData:a.getFormData(this.formEl,this.contentManager.href)})}},g={bindFormObserver:function(){this.formObserver=this.formObserver||new i.FormObserver({el:this.formEl,mappedFields:this.mappedFields,contentManager:this.contentManager,strategy:this}),this.formObserver.on("emailFieldFocused",this.onEmailFieldActivity,this),this.formObserver.on("emailFieldClicked",this.onEmailFieldActivity,this),this.formObserver.on("passwordFieldFocused",this.onPasswordFieldActivity,this),this.formObserver.on("passwordFieldClicked",this.onPasswordFieldActivity,this),this.formObserver.on("phoneFieldFocused",this.onPhoneFieldActivity,this),this.formObserver.on("phoneFieldClicked",this.onPhoneFieldActivity,this),this.formObserver.on("paymentFieldFocused",this.onPaymentFieldActivity,this),this.formObserver.on("paymentFieldClicked",this.onPaymentFieldActivity,this)},cleanup:function(){this.formObserver&&(this.formObserver.unbindFormEvents(),this.formObserver.off())},processDynamicPanelForField:function(e){var t=this.contentManager.preferences.getPref("dynamicPanels"),n=t?JSON.parse(t):"",i=!1;if(n&&n.panels&&(i=this.contentManager.getPanelForDataType(n.panels,e))){parseInt(i.masked_emails)>0&&(i.dontShow=!0);var r=parseFloat(i.show_rate),a=Math.random();a>r&&(i.dontShow=!0)}return{json:n,dynamicPanel:i}},onEmailFieldActivity:function(n){if(!this.emailDisabledHere()&&this.canShowMaskMeHelper(n,"register")){if(this.contentManager.isPanelShown(n.field))return this.contentManager.closeCurrentPanel(),void 0;if(!this.contentManager.preferences.getPref("hasRegistered")||this.contentManager.preferences.getPref("authToken")){var i=this.formObserver,r=n.field.element;if(this.disableAutoComplete(r),!r.hasAttribute("mmautofilling")&&!r.hasAttribute("mmclosedfield")){var a=this.processDynamicPanelForField("/contact/email");if(a.dynamicPanel&&a.dynamicPanel.dontShow&&!this.contentManager.preferences.isPrefTrue("hasRegistered"))return!1;this.contentManager.createPanel({style:{},secured:!0,field:n.field,ready:t.bind(function(s,c){var u=new o({field:n.field,formEl:this.formEl,contentManager:this.contentManager,fields:i.getFields(),dynamicPanel:a.dynamicPanel,dynamicPanelsJSON:a.json,hasRegistered:this.contentManager.preferences.isPrefTrue("hasRegistered"),domain:this.contentManager.domain,el:e("<div></div>",s).get(0)});u.iframe=c,e(r).one("mm.closepanel",t.bind(u.closePanel,u)),u.bind("remove",function(){this.cleanupPanel(u,r,p)},this),u.bind("render resize",function(){this.contentManager.autoResizePanels()},this),e("body",s).append(u.el)},this)})}}}},onPasswordFieldActivity:function(n){if(!this.passwordDisabledHere()&&this.canShowMaskMeHelper(n,"register")){if(this.contentManager.isPanelShown(n.field))return this.contentManager.closeCurrentPanel(),void 0;if(!this.contentManager.preferences.getPref("hasRegistered")||this.contentManager.preferences.getPref("authToken")){var i=n.field.element;if("text"!=i.getAttribute("type")&&(!this.contentManager.preferences.getPref("hasRegistered")||this.contentManager.preferences.getPref("suggestStrongPassword"))){var r=this.formObserver;if(this.disableAutoComplete(i),!i.hasAttribute("mmautofilling")&&!i.hasAttribute("mmclosedfield")){var a=this.processDynamicPanelForField("/password");if(a.dynamicPanel&&a.dynamicPanel.dontShow&&!this.contentManager.preferences.isPrefTrue("hasRegistered"))return!1;this.contentManager.createPanel({style:{},secured:!0,field:n.field,ready:t.bind(function(o,c){var u=new s({field:n.field,formEl:this.formEl,contentManager:this.contentManager,fields:r.getFields(),dynamicPanel:a.dynamicPanel,dynamicPanelsJSON:a.json,hasRegistered:this.contentManager.preferences.isPrefTrue("hasRegistered"),domain:this.contentManager.domain,el:e("<div></div>",o).get(0)});u.iframe=c,e(i).one("mm.closepanel",t.bind(u.closePanel,u)),u.bind("remove",function(){this.cleanupPanel(u,i,p)},this),u.bind("render resize",function(){this.contentManager.autoResizePanels()},this),e("body",o).append(u.el)},this)})}}}}},onPhoneFieldActivity:function(n){if(!this.phoneDisabledHere()&&this.canShowMaskMeHelper(n,"register")){if(this.contentManager.isPanelShown(n.field))return this.contentManager.closeCurrentPanel(),void 0;if(!this.contentManager.preferences.getPref("hasRegistered")||this.contentManager.preferences.getPref("authToken")){var i=this.formObserver,r=n.field.element;if(this.disableAutoComplete(r),!r.hasAttribute("mmautofilling")&&!r.hasAttribute("mmclosedfield")){var a=this.processDynamicPanelForField("/contact/phone");if(a.dynamicPanel&&a.dynamicPanel.dontShow&&!this.contentManager.preferences.isPrefTrue("entitledToPhone"))return!1;this.contentManager.createPanel({style:{},secured:!0,field:n.field,ready:t.bind(function(o,s){var u=new c({field:n.field,formEl:this.formEl,contentManager:this.contentManager,dynamicPanel:a.dynamicPanel,dynamicPanelsJSON:a.json,entitledToPhone:this.contentManager.preferences.isPrefTrue("entitledToPhone"),hasRegistered:this.contentManager.preferences.isPrefTrue("hasRegistered"),fields:i.getFields(),domain:this.contentManager.domain,el:e("<div></div>",o).get(0)});u.iframe=s,e(r).one("mm.closepanel",t.bind(u.closePanel,u)),u.bind("remove",function(){this.cleanupPanel(u,r,p)},this),u.bind("render resize",function(){this.contentManager.autoResizePanels()},this),e("body",o).append(u.el)},this)})}}}},onPaymentFieldActivity:function(n){if("select"!=n.field.fieldType&&!this.cardDisabledHere()&&this.canShowMaskMeHelper(n,"register")){if(this.contentManager.isPanelShown(n.field))return this.contentManager.closeCurrentPanel(),void 0;if(this.contentManager.preferences.getPref("suggestProtectedCard")&&(!this.contentManager.preferences.getPref("hasRegistered")||this.contentManager.preferences.getPref("authToken"))){var i=this.formObserver,r=n.field.element;if(this.disableAutoComplete(r),!n.field.element.hasAttribute("mmautofilling")&&!n.field.element.hasAttribute("mmclosedfield")){var a=this.processDynamicPanelForField("/creditcard");if(a.dynamicPanel&&a.dynamicPanel.dontShow&&!this.contentManager.preferences.isPrefTrue("hasEnabledPayments"))return!1;this.contentManager.createPanel({style:{},secured:!0,panelWidth:400,field:n.field,ready:t.bind(function(o,s){var c=new d({field:n.field,formEl:this.formEl,contentManager:this.contentManager,authToken:this.contentManager.preferences.getPref("authToken"),beginnerMode:this.contentManager.preferences.getPref("beginnerMode"),hasRegistered:this.contentManager.preferences.isPrefTrue("hasRegistered"),entitledToPayments:this.contentManager.preferences.isPrefTrue("entitledToPayments"),hasEnabledPayments:this.contentManager.preferences.isPrefTrue("hasEnabledPayments"),dynamicPanel:a.dynamicPanel,dynamicPanelsJSON:a.json,fields:i.getFields(),domain:this.contentManager.domain,el:e("<div></div>",o).get(0)});c.iframe=s,e(r).one("mm.closepanel",t.bind(c.closePanel,c)),c.bind("remove",function(){this.cleanupPanel(c,r,p)},this),c.bind("render resize",function(){this.contentManager.autoResizePanels()},this),this.contentManager.notificationViews&&t.each(this.contentManager.notificationViews,function(e){e.style.display="block"}),e("body",o).append(c.el)},this)})}}}}},y=n.BaseClass.extend({initialize:function(e){if(!e.el)throw"RegistrationFormHelper expects a form element";this.formEl=e.el,this.contentManager=e.contentManager,this.preferences=e.preferences,this.mappedFields=e.mappedFields,this.bindFormObserver(),this.bindFieldChangeObserver()},bindFieldChangeObserver:function(){},bindFormObserver:function(){}});t.extend(y.prototype,g,m);var v=n.BaseClass.extend({initialize:function(e){if(!e.el)throw"ChangePasswordHelper expects a form element";this.formEl=e.el,this.contentManager=e.contentManager,this.preferences=e.preferences,this.bindFormObserver(),this.bindFieldChangeObserver(),this.tryToAutoFillOldPassword()},bindFieldChangeObserver:function(){},bindFormObserver:function(){},tryToAutoFillOldPassword:function(){if(this.contentManager.domain){var n=this.formObserver.getFields(),i=new l.Site({domain:this.contentManager.domain});i.loadAccounts(!1,t.bind(function(r){if(!r&&i.accounts&&i.accounts.length>0){var a=t.filter(n,function(e){return e.dataType&&"/passwordold"==e.dataType?!0:!1}),o=i.accounts.at(0),s=o.accountFields.find(function(e){return e.has("dataType")&&"/password"==e.get("dataType")?!0:!1});t.each(a,function(t){s&&e(t.element).focus().val(s.get("value")).blur()})}},this))}}});t.extend(v.prototype,g,m);var b=n.BaseClass.extend({initialize:function(e){if(!e.el)throw"LoginHelper expects a form element";this.formEl=e.el,this.contentManager=e.contentManager,this.preferences=e.preferences,this.mappedFields=e.mappedFields,this.site=e.site,this.bindFieldChangeObserver(),this.formObserver.on("passwordFieldFocused",this.onPasswordFieldActivity,this),this.formObserver.on("passwordFieldBlurred",this.onPasswordFieldActivity,this),this.contentManager.preferences.getPref("helpMeLogin")&&this.tryToAutoFillLogins()},cleanup:function(){this.formObserver&&(this.formObserver.unbindFormEvents(),this.formObserver.off())},bindFieldChangeObserver:function(){},onPasswordFieldActivity:function(){this.autofilled&&this.autofilled--},onEmailFieldActivity:function(n){if(this.autofilled)return this.autofilled--,void 0;if(!this.emailDisabledHere()&&this.canShowMaskMeHelper(n,"login")){if(this.contentManager.isPanelShown(n.field))return this.contentManager.closeCurrentPanel(),void 0;var i=this.formObserver,r=n.field.element;this.disableAutoComplete(r),r.hasAttribute("mmautofilling")||r.hasAttribute("mmclosedfield")||this.contentManager.createPanel({style:{},field:n.field,ready:t.bind(function(o,s){var c=new u({field:n.field,formEl:this.formEl,protocol:a.getProtocol(this.formEl,this.contentManager.href),page_domain:a.getPageDomain(this.contentManager.href),form_domain:a.getFormDomain(this.formEl,this.contentManager.href),fields:i.getFields(),contentManager:this.contentManager,domain:this.contentManager.domain,el:e("<div></div>",o).get(0)});c.iframe=s,e(r).one("mm.closepanel",t.bind(c.closePanel,c)),c.bind("remove",function(){this.cleanupPanel(c,r,p)},this),c.bind("render resize",function(){this.contentManager.autoResizePanels()},this),e("body",o).append(c.el)},this)})}},tryToAutoFillLogins:function(){var n=this.formObserver.getFields();if(this.contentManager.domain&&!this.contentManager.isLocked()){var i=this.site;if(i.accounts&&i.accounts.length>0){if(!this.contentManager.preferences.getPref("helpMeLogin")){var o=[];i.accounts.forEach(function(e){"login"==e.get("type")&&o.push(e)}),i.accounts.remove(o)}var s=t.find(i.accounts.models,function(e){return e.getLoginForAccount()?!0:void 0});s&&(this.contentManager.userIntent&&(this.autofilled=2),this.formObserver.on("emailFieldFocused",this.onEmailFieldActivity,this),this.formObserver.on("emailFieldClicked",this.onEmailFieldActivity,this),this.formObserver.on("usernameFieldClicked",this.onEmailFieldActivity,this),this.formObserver.on("usernameFieldFocused",this.onEmailFieldActivity,this),t.each(n,t.bind(function(e){e.dataType&&e.dataType.match(/email|nameperson/)&&this.disableAutoComplete(e.element)},this)));var c={};t.each(n,t.bind(function(e){e.dataType&&(c[e.dataType]=e)},this));var u=null,d=a.getProtocol(this.formEl,this.contentManager.href),l=a.getFormDomain(this.formEl,this.contentManager.href),h=a.getPageDomain(this.contentManager.href),p=l==h||f.getTLD(l)==f.getTLD(h)||""==l;if(i.accounts.forEach(t.bind(function(e){if(!u){if(e.get("protocol")&&""!=e.get("protocol")){if("https"==e.get("protocol")&&"https"!=d||e.get("form_domain")!=l||f.getTLD(e.get("page_domain"))!=f.getTLD(h))return!1}else if(!p||-1==this.contentManager.document.location.protocol.indexOf("https")||"https"!=d)return!1;u=e}},this)),u){var m={};u.accountFields.each(function(e){e.has("dataType")&&(m[e.get("dataType")]=e.get("value"))}),t.each(t.keys(c),t.bind(function(n){var i=c[n].element;i.setAttribute("mmautofilling","now"),n in m?"/password"===n&&"text"===i.type?(e(i).focus(),r.setTimeout(t.bind(function(){e("[type='password']",this.formEl).val(m[n]).blur()},this),100)):i.value=m[n]:("/contact/email"==n&&"/nameperson/friendly"in m&&(i.value=m["/nameperson/friendly"]),"/nameperson/friendly"==n&&"/contact/email"in m&&(i.value=m["/contact/email"])),this.contentManager.triggerKeyboardEvent("keydown",i),this.contentManager.triggerKeyboardEvent("keyup",i),this.contentManager.triggerKeyboardEvent("keypress",i),i.removeAttribute("mmautofilling")},this))}}}}});t.extend(b.prototype,m);var E=n.BaseClass.extend({initialize:function(e){if(!e.el)throw"OtherHelper expects a form element";this.formEl=e.el,this.contentManager=e.contentManager,this.preferences=e.preferences,this.mappedFields=e.mappedFields,this.bindFieldChangeObserver(),this.bindFormObserver()},bindFormObserver:function(){},bindFieldChangeObserver:function(){}});t.extend(E.prototype,g,m);var A=n.BaseClass.extend({initialize:function(e){if(!e.el)throw"CheckoutHelper expects a form element";this.formEl=e.el,this.contentManager=e.contentManager,this.preferences=e.preferences,this.mappedFields=e.mappedFields,this.bindFieldChangeObserver(),this.bindFormObserver()},bindFormObserver:function(){},bindFieldChangeObserver:function(){}});return t.extend(A.prototype,g,m),{RegistrationHelper:y,LoginHelper:b,OtherHelper:E,CheckoutHelper:A,ChangePasswordHelper:v}}),ABINEMASKME.define("abine/licenseServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core","abine/responseCodes"],function(e,t,n,i,r){var a=n.protocol+n.licenseServerHost,o=a+"/api/v2/reset_password_email",s=a+"/api/v2/users",c=a+"/api/v2/sessions",u=a+"/api/v2/touches",d=a+"/api/v2/activated_cards",l=a+"/api/v2/completed_postinstall",h=a+"/api/v2/uninstall",f=a+"/api/v2/billing_info",p=a+"/api/v2/feedback_email",m="/api/v2/send_unlock_email",g=a+"/api/v2/referral",y=a+"/api/v2/panel_data",v=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},resendUnlockEmail:function(e,t){this.server.makeRequest({server:"license",action:"resendUnlockEmail",defaults:{},required:["email"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:m,type:"POST"})},sendPanelActivity:function(e,t){this.server.makeRequest({server:"license",action:"sendPanelActivity",defaults:{},required:["panel_data"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:y,type:"POST"})},register:function(e,t){this.server.makeRequest({server:"license",action:"register",defaults:{},required:["user","application"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"POST"})},signIn:function(e,t){this.server.makeRequest({server:"license",action:"signIn",defaults:{},required:["user_login","application"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:c,type:"POST"})},refreshEntitlements:function(e,t){this.server.makeRequest({server:"license",action:"refreshEntitlements",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"GET"})},referralCode:function(e,t){this.server.makeRequest({server:"license",action:"referralCode",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:g,type:"GET"})},changePassword:function(e,t){this.server.makeRequest({server:"license",action:"changePassword",defaults:{},required:["user"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"PUT"})},changeEmail:function(e,t){this.server.makeRequest({server:"license",action:"changeEmail",defaults:{},required:["user"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"PUT"})},changeEmailPassword:function(e,t){this.server.makeRequest({server:"license",action:"changeEmailPassword",defaults:{},required:["user"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"PUT"})},deleteUser:function(e,t){this.server.makeRequest({server:"license",action:"deleteUser",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"DELETE"})},makeDailyTouch:function(e,t){this.server.makeRequest({server:"license",action:"makeDailyTouch",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:u,type:"POST"})},sendResetPasswordEmail:function(e,t){this.server.makeRequest({server:"license",action:"sendResetPasswordEmail",defaults:{},required:["email"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})},sendFeedbackEmail:function(e,t){this.server.makeRequest({server:"license",action:"sendFeedbackEmail",defaults:{browserUserAgent:ABINEMASKME.userAgent},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:p,type:"POST"})},billingInfo:function(e,t){this.server.makeRequest({server:"license",action:"billingInfo",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:f,type:"GET"})},saveActivatedCardsDate:function(e,t){this.server.makeRequest({server:"license",action:"saveActivatedCardsDate",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:d,type:"PUT"})},savePostInstallCompletedDate:function(e,t){this.server.makeRequest({server:"license",action:"savePostInstallCompletedDate",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:l,type:"PUT"})},uninstall:function(e,t){this.server.makeRequest({server:"license",action:"uninstall",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:h,type:"PUT"})}});return v}),ABINEMASKME.define("abine/lruCache",[],function(){var e=function(e){var t={},n=e,e=0,i=null,r=null;this.add=function(a,o){var s={id:a,data:o,previous:null,next:i};if(t[a]=s,i&&(i.previous=s),i=s,e===n){var c=r;r=r.previous,r.next=null,delete t[c.id],delete c}else 0===e&&(r=s),e++},this.fetch=function(n){var a=t[n];if(a){if(e>1){var o=a.previous,s=a.next;r==a?r=o:i!=a&&(o.next=s,s.previous=o),a.previous=null,a.next=i,i.previous=a,i=a}return a.data}return null}};return e}),ABINEMASKME.define("abine/mappingServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core"],function(e,t,n,i,r){var a=n.protocol+n.mappingServerHost,o=a+"/api/v2/mappings/manifest",s=a+"/api/v2/mappings/latest",c=a+"/api/v2/mappings/masked",u=a+"/api/v2/panels",d=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},sendPanelActivity:function(e,t){this.server.makeRequest({server:"mapping",action:"getMappingManifest",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})},sendFormData:function(e,t){this.server.makeRequest({server:"mapping",action:"sendFormData",defaults:{},required:["updates"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:c,type:"POST"})},getMappingManifest:function(e,t){this.server.makeRequest({server:"mapping",action:"getMappingManifest",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})},getFormMappings:function(e,t){this.server.makeRequest({server:"mapping",action:"getFormMappings",defaults:{},required:["signatures"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"POST"})},getPanels:function(e,t){this.server.makeRequest({server:"mapping",action:"getPanels",defaults:{},required:["browser","tag","user_state"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:u,type:"GET"})}});return d}),ABINEMASKME.define("abine/pageEvents",["abine/core","abine/securityManager","abine/config","storage","abine/timer","persistence","abine/modules/license","abine/window"],function(e,t,n,i,r,a,o,s){var c=null,u=null,d=function(){};u="development"==n.environment?/.*/i:/^(.+\.)?abine\.com$/i;var l=e.BaseClass.extend({initialize:function(){},processAction:function(e,t){if(t=t||d,e.host.match(u))switch(e.action){case"reloadAdminPage":this.reloadAdminPage(e.params,t);break;case"enableEntitlements":this.enableEntitlements(e.params,t);break;case"openAdminPage":this.openAdminPage(e.params,t);break;case"resetPasswordSuccess":this.resetPasswordSuccess(e.params,t);break;case"updateDisposable":this.updateDisposable(e.params,t);break;case"refreshLastFourCardDigits":this.refreshLastFourCardDigits(e.params,t);break;case"getVersion":t({version:ABINEMASKME.config.version,tag:ABINEMASKME.config.tags[0]});break;default:t()}else t()},reloadAdminPage:function(e,t){s.createTab({localUrl:"pages/index.html"},t)},enableEntitlements:function(e,t){o.enableEntitlements(e,t)},openAdminPage:function(e,t){var n=e&&e.page?"#"+e.page:"";s.createTab({localUrl:"pages/index.html"+n},t)},resetPasswordSuccess:function(e,n){i.purgeDatabase(function(){i.Preference.setDefaults(function(){i.Preference.batchCreateOrModify([{key:"resetPasswordInProgress",value:"true"},{key:"autoOpenEditUser",value:"false"}],function(){t.on("background:securityManager:initialized",function(){r.setTimeout(function(){s.createTab({localUrl:"pages/index.html#userLogin"},n)},4e3)}),t.load(c,!0)})})})},updateDisposable:function(e,t){i.DisposableEmail.indexFromServer(null,function(){t()})},refreshLastFourCardDigits:function(e,t){o.refreshLastFourCardDigits(e,t)}});return new l({})}),ABINEMASKME.define("abine/views/panelBase",["documentcloud/underscore","jquery","duckbone/core","abine/timer","models","abine/window","abine/contentMessenger","abine/formAnalyzer","abine/timer","abine/config","abine/proxies"],function(e,t,n,i,r,a,o,s,c,u,d){var l=300,h=13,f=38,p=40,m=8,g=46,y={"short":"jan,feb,mar,apr,may,jun,jul,aug,sep,oct,nov,dec".split(","),"long":"january,february,march,april,may,june,july,august,september,october,november,december".split(",")},v=n.View.extend({render:function(){return this.model?(this.renderTemplate(),c.setTimeout(e.bind(function(){this.trigger("render")},this),50),this):this},autoResize:function(){c.setTimeout(e.bind(function(){this.trigger("resize")},this),50)},triggerRender:function(){c.setTimeout(e.bind(function(){this.trigger("render")},this),50)},ignoreBlur:function(e){return"undefined"==typeof e?this.field.element.getAttribute("mmIgnoreBlur"):(e===!1?this.field.element.removeAttribute("mmIgnoreBlur"):this.field.element.setAttribute("mmIgnoreBlur","true"),void 0)},bindHeaderClose:function(){t(this.el).bind("mousedown",e.bind(function(t){this.ignoreBlur(!0);var n=t.target.className.split(" ");e.contains(n,"close-header")?this.closeHeader():("close-icon"==t.target.className||"close-dd"==t.target.className)&&this.closePanel()},this))},bindFieldBlur:function(){t(this.field.element).unbind("blur.mmpanel").bind("blur.mmpanel",e.bind(function(){this.ignoreBlur()?i.setTimeout(e.bind(function(){t(this.field.element).focus(),this.ignoreBlur(!1)},this),1):this.closePanel()},this))},bindKeyDown:function(){t(this.field.element).unbind("keydown.mmpanel").bind("keydown.mmpanel",e.bind(function(e){return e.keyCode===h?(e.preventDefault(),e.stopPropagation(),!1):void 0}))},bindKeyUp:function(){t(this.field.element).unbind("keyup.mmpanel").bind("keyup.mmpanel",e.bind(function(e){if(e.keyCode===f)this.highlightOption(this.selectedField||0===this.selectedField?this.selectedField-1:-1);else if(e.keyCode===p)this.highlightOption(this.selectedField||0===this.selectedField?this.selectedField+1:0);else{if(e.keyCode===h&&(this.selectedField||0===this.selectedField))return e.selectedField=this.selectedField,this.trigger("enter"+this.selectedField,e,this.selectedField),!1;String.fromCharCode(e.keyCode).match(/\w/)&&e.currentTarget.value.length>=5&&!this.doNotCloseOnTyping&&(this.closePanel(),delete this.selectedField)}},this))},cleanupPanel:function(){},bindPanelTextInput:function(n){t(this.field.element).add(n).unbind("blur.mmpanel").bind("blur.mmpanel",e.bind(function(i){this.ignoreBlur()?(this.ignoreBlur(!1),i.target.element!==this.field.element&&c.setTimeout(e.bind(function(){t(n).focus()},this),1)):this.closePanel()},this))},bindBaseEvents:function(){this.bindHeaderClose(),this.bindFieldBlur(),this.bindKeyDown(),this.bindKeyUp()},highlightOption:function(n){var i=e(t(this.el).find(".mmKeyOption")).filter(function(e){return t(e).hasClass("mmKeyOption")&&"none"!==t(e).css("display")&&t(e).is("a")&&!t(e).hasClass("disabled")});n=(n+i.length)%i.length,(this.selectedField||0===this.selectedField)&&t(i[this.selectedField].children[0]).removeClass("hover"),t(i[n].children[0]).addClass("hover"),this.selectedField=n},applyFadingStyle:function(){var e=l/1e3+"s",t="opacity ease "+e+", margin-top ease "+e;
this.el.style.transition=this.el.style.WebkitTransition=this.el.style.MozTransition=this.el.style.OTransition=this.el.style.MsTransition=t},fadeIn:function(){this.el.style.opacity="0.0",this.el.style.marginTop="50px",i.setTimeout(e.bind(function(){this.el.style.opacity="1.0",this.el.style.marginTop="0px"},this),100)},fadeOut:function(){try{this.el.style.opacity="1.0",this.el.style.marginTop="0px"}catch(t){}i.setTimeout(e.bind(function(){try{this.el.style.opacity="0.0",this.el.style.marginTop="50px"}catch(e){}},this),100);try{delete this.contentManager._currentPanelField}catch(t){}i.setTimeout(e.bind(function(){this.trigger("remove")},this),100+l)},triggerPanelFillEvent:function(e){this.messenger=this.messenger||new o.ContentMessenger,e.field.origin=e.origin;var n={disposableGUID:e.field.disposableGUID,name:e.field.name,origin:e.field.origin,dataType:e.field.dataType,value:e.field.value};t(this.options.formEl).attr("maskMeFilled","yes"),this.messenger.send("panel:fill",{fieldData:n,formData:s.getFormData(this.options.formEl,e.domain)})},fillPhoneFieldsWith:function(e,t,n){var i,r,a,o,s;return 1===parseInt(t)?(r=n.substr(0,3),o=n.substr(3,3),s=n.substr(6,4),i="("+r+") "+o+"-"+s,a=o+"-"+s):(i="+"+t+n,a="+"+t+n),this.fillFieldsByType(e,"/contact/phone",i),this.fillFieldsByType(e,"/contact/phone/number",a),this.fillFieldsByType(e,"/contact/phone/countrycode",t),this.fillFieldsByType(e,"/contact/phone/areacode",r),this.fillFieldsByType(e,"/contact/phone/exchange",o),this.fillFieldsByType(e,"/contact/phone/local",s),i},isVisible:function(e){return t(e).is(":visible")&&"hidden"!=t(e).css("visibility")},fillPaymentFieldsWith:function(e,t,n,i,r,a,o){function s(t,n){for(var i=0;n.length>i&&!c.fillFieldsByType(e,t,n[i]);i++);}var c=this,u=[n];-1!=n.toLowerCase().indexOf("master")&&(u=["master","master card","mastercard"]),s("/financial/creditcard/type",u),this.fillFieldsByType(e,"/financial/creditcard/number",t),this.fillFieldsByType(e,"/financial/creditcard/number/part1",t.substr(0,4)),this.fillFieldsByType(e,"/financial/creditcard/number/part2",t.substr(4,4)),this.fillFieldsByType(e,"/financial/creditcard/number/part3",t.substr(8,4)),this.fillFieldsByType(e,"/financial/creditcard/number/part4",t.substr(12,4)),this.fillFieldsByType(e,"/financial/creditcard/issuedto",i),this.fillFieldsByType(e,"/financial/creditcard/verification",o),this.fillFieldsByType(e,"/financial/creditcard/expiry",r+"/"+a);var d=[r];return d.push(parseInt(r)),d.push(y.short[parseInt(r)-1]),d.push(y.long[parseInt(r)-1]),s("/financial/creditcard/expirymonth",d),s("/financial/creditcard/expiryyear",[a,parseInt(a)%100]),t},fillFieldsByType:function(n,r,a,o){var s=!1,c=!1,u=this,d=e(n).filter(function(e){return e.dataType==r&&u.isVisible(e.element)});e(d).each(e.bind(function(e){t(e.element).val(""),e.element.setAttribute("mmautofilling","now")},this));var u=this;return e(d).each(e.bind(function(d){function l(e){if(u.options.contentManager&&u.options.contentManager.triggerKeyboardEvent&&(u.options.contentManager.triggerKeyboardEvent("keydown",t(e.element)[0]),u.options.contentManager.triggerKeyboardEvent("keyup",t(e.element)[0]),u.options.contentManager.triggerKeyboardEvent("keypress",t(e.element)[0])),c)try{t(e.element).change()}catch(n){}o&&(e.disposableGUID=o.disposableGUID,u.triggerPanelFillEvent({domain:o.domain,origin:o.origin,field:e}))}if("/password"==r&&"text"==d.element.type){try{t(d.element).focus()}catch(h){}var f=d.element.form;i.setTimeout(e.bind(function(){var i=t("[type='password']",f);if(i.length>0){var r=e(n).find(function(e){return e.element==i[0]});i.focus().val(a).css({color:"#0000aa","background-color":"#ffffee"}),l(r)}},this),100)}else{a+="";try{t(d.element).focus().val(a)}catch(h){t(d.element).val(a)}if(t(d.element).val()==a){if(s=!0,c="select"==d.fieldType,"select"==d.fieldType&&r.match(/month/i)){var p=d.element.selectedIndex,m=d.element.options[d.element.options.length-1].value;11==parseInt(m)&&(d.element.selectedIndex=p-1)}}else if(d.element.options){a=a.toLowerCase();for(var g=d.element.options,y=0;g.length>y;y++){var v=g[y].text.toLowerCase(),b=g[y].value;if(b&&b.toLowerCase()==a||v==a||-1!=v.indexOf(a)){g[y].selected=!0,c="select"==d.fieldType,s=!0;break}}}this.markFieldFilled(d),l(d)}},this)),e(d).each(e.bind(function(e){e.element.removeAttribute("mmautofilling")},this)),s},markFieldFilled:function(e){t(e.element).css({color:"#0000aa","background-color":"#ffffee"})},hidePanel:function(){this.trigger("hide")},closePanel:function(e){e&&e.preventDefault(),this.cleanupPanel(),this.field&&(t(this.field.element).unbind("blur.mmpanel"),this.ignoreBlur(!1),t(this.field.element).unbind("keydown.mmpanel"),t(this.field.element).unbind("keyup.mmpanel"),t(this.field.element).bind("keyup.mmpanel",function(e){e.keyCode!==m&&e.keyCode!==g||0!==e.currentTarget.value.length||e.target.click()})),this.fadeOut()},clickedInsideOfTarget:function(e,t){for(;t.parentNode&&t.id!=e;)t=t.parentNode;return t.id==e?!0:!1},performActions:function(t){this.messenger=this.messenger||new o.ContentMessenger,e.each(this.panelSectionActionMap[t.currentTarget.id],e.bind(function(n){(n.target_id&&""!=n.target_id&&this.clickedInsideOfTarget(n.target_id,t.target)||n.target_id&&""==n.target_id||!n.target_id)&&("open_registration_page"==n.name?this.getStarted(t,{type:this.options.dynamicPanel.field_type,action:n.name}):"open_page"==n.name?d.securityManager.openPage(n.extra,!1):"trigger_click"==n.name?this.messenger.send("update:panelActivity:click",{panelId:this.options.dynamicPanel.id}):"trigger_conversion"==n.name?this.messenger.send("update:panelActivity:conversion",{panelId:this.options.dynamicPanel.id}):"dismiss_panel"==n.name?this.closePanel():"change_show_rate"==n.name?(e.each(this.options.dynamicPanelsJSON.panels,e.bind(function(e){e.field_type==this.options.dynamicPanel.field_type&&(e.show_rate=n.extra)},this)),this.contentManager.preferences.setPref("dynamicPanels",JSON.stringify(this.options.dynamicPanelsJSON))):"no_action"==n.name||("open_plans_page"==n.name?this.openPlansPage(null,{type:this.options.dynamicPanel.field_type,action:n.name}):"open_activate_cards_page"==n.name&&this.openActivateCardsPage(null,{type:this.options.dynamicPanel.field_type,action:n.name})))},this))},setupDynamicPanel:function(){this.panelPositions=this.options.dynamicPanel.panel_positions,this.panelSections=[],this.panelSectionActionMap={},e.each(this.panelPositions,e.bind(function(t){var n=t.panel_section;n.has_action=t.panel_actions.length>0,this.panelSectionActionMap[n.id]=[],e.each(t.panel_actions,e.bind(function(e){this.panelSectionActionMap[n.id].push(e)},this)),this.panelSections.push(n)},this))},closeHeader:function(e){e&&e.preventDefault(),this.ignoreExplicitClose||t(this.field.element).attr("mmclosedfield",!0),this.closePanel(e)},getStarted:function(e,t){this.messenger=this.messenger||new o.ContentMessenger,this.messenger.send("window:createTab",{localUrl:"pages/index.html#userRegistration",panelData:t}),this.closePanel()},openSetupEmailPage:function(){this.messenger=this.messenger||new o.ContentMessenger,this.messenger.send("window:createTab",{localUrl:"pages/index.html#editUser/email"}),this.closePanel()},openActivateCardsPage:function(e,t){this.messenger=this.messenger||new o.ContentMessenger,this.messenger.send("window:createTab",{localUrl:"pages/index.html#payments",panelData:t}),this.closePanel()},openPlansPage:function(e,t){var n=this.contentManager.preferences.getPref("authToken");if(n&&""!=n&&ABINEMASKME.contentuser.shieldedEmails.length>0){var i=u.protocol+u.licenseServerHost+"/subscriptions/id_me?auth_token="+n+"&email="+ABINEMASKME.contentuser.shieldedEmails.at(0).get("email");d.securityManager.openPage(i,!1,t)}},openLoginPage:function(){this.messenger=this.messenger||new o.ContentMessenger,this.messenger.send("window:createTab",{localUrl:"pages/index.html#userLogin"}),this.closePanel()},getStartedWithPhone:function(e){e&&e.preventDefault();var t=function(){a.createTab({forceReload:!0,localUrl:"pages/index.html#userInfo"})};if(this.contentManager.preferences.isPrefTrue("entitledToPhone"))d.securityManager.openPage("editUser/phone",!0);else{var n=this.contentManager.preferences.getPref("authToken");if(n&&""!=n)if(ABINEMASKME.contentuser.shieldedEmails.length>0){var i=u.protocol+u.licenseServerHost+"/subscriptions/id_me?auth_token="+n+"&email="+ABINEMASKME.contentuser.shieldedEmails.at(0).get("email")+"&feature=phone";this.contentManager.preferences.hasPref("regEmail")&&this.contentManager.preferences.hasPref("regPassword")?i+="&notsetup=3":this.contentManager.preferences.hasPref("regEmail")?i+="&notsetup=1":this.contentManager.preferences.hasPref("regPassword")&&(i+="&notsetup=2"),d.securityManager.openPage(i,!1)}else t();else t()}this.closePanel(e)},getStartedWithPayments:function(e){e&&e.preventDefault();var t=function(){a.createTab({forceReload:!0,localUrl:"pages/index.html#userInfo"})};if(this.contentManager.preferences.isPrefTrue("entitledToPayments"))d.securityManager.openPage("payments",!0);else{var n=this.contentManager.preferences.getPref("authToken");if(n&&""!=n)if(ABINEMASKME.contentuser.shieldedEmails.length>0){var i=u.protocol+u.licenseServerHost+"/subscriptions/id_me?auth_token="+n+"&email="+ABINEMASKME.contentuser.shieldedEmails.at(0).get("email")+"&feature=cards";this.contentManager.preferences.hasPref("regEmail")&&this.contentManager.preferences.hasPref("regPassword")?i+="&notsetup=3":this.contentManager.preferences.hasPref("regEmail")?i+="&notsetup=1":this.contentManager.preferences.hasPref("regPassword")&&(i+="&notsetup=2"),d.securityManager.openPage(i,!1)}else t();else t()}this.closePanel(e)},setupPhone:function(e){this.messenger=this.messenger||new o.ContentMessenger,this.messenger.send("window:createTab",{localUrl:"pages/index.html#userInfo"}),this.closePanel(e)}});return v}),ABINEMASKME.define("abine/password",[],function(){var e="ABCDEFGHJKLMNOPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",t=10,n=1,i=2,r=4,a=8,o={generateRandomPassword:function(o,s,c){o=o||e,(!s||1>s)&&(s=t);var u="",d=o.length;c=c||n|i|a;var l="ABCDEFGHJKLMNOPQRSTUVWXYZ".charAt(Math.floor(26*Math.random()))+"ABCDEFGHJKLMNOPQRSTUVWXYZ".charAt(Math.floor(26*Math.random())),h="0123456789".charAt(Math.floor(10*Math.random()))+"0123456789".charAt(Math.floor(10*Math.random())),f="`~!@#$%^&*()_-+={}|[]\\:\";'<>?,/".charAt(Math.floor(32*Math.random()));c&n||(l=""),c&i||(h=""),c&r||(f=""),c&a&&(f=".");for(var p=Math.floor(Math.random()*(s-(l.length+f.length+h.length))),m=p+l.length+f.length+h.length-1,g=0;s>g;g++)if(p>g||g>m)u+=o.charAt(Math.floor(Math.random()*d));else{if(g!=p)continue;u+=l+f+h}return u},generateSpecialCharsPassword:function(){return this.generateRandomPassword(null,null,n|i|r)},generateNoSpecialCharsPassword:function(){return this.generateRandomPassword(null,null,n|i)},generateNoDigitsPassword:function(){return this.generateRandomPassword(null,null,n)}};return o}),ABINEMASKME.define("abine/passwordScore",["abine/intl"],function(e){var t=100,n=75,i=50,r=25,a={scoreComp8SpecialHelper:function(e){if(!e)return 0;var t=0;return e.length>2?t+=29:e.length>1?t+=25:e.length>0&&(t+=17),t},scoreComp8:function(e){var t=0,n=e.length;t+=4*n,t+=this.scoreComp8SpecialHelper(e.match(/[A-Z]/g)),t+=this.scoreComp8SpecialHelper(e.match(/[0-9]/g)),t+=this.scoreComp8SpecialHelper(e.match(/\W/g));var i=e.match(/[a-z]/g);return n>3&&!i&&(t-=17),t},scoreBasic16:function(e){var t=0,n=e.length;return t+=n>8?8*(n-8)+32:4*n},scorePassword:function(e){return Math.min(Math.max(this.scoreComp8(e),this.scoreBasic16(e))/2,100)},calculateScore:function(e){return this.scorePassword(e)},calculateStrengthForTitle:function(a){var o="",s="",c="";return a===t?(s="Excellent",c="green"):a>=n?(s="Strong",c="green"):a>=i?(s="Good",c="green"):a>=r?(s="Ok",c="gold"):(s="Weak",c="red"),o="<span style='color:"+c+";'>"+e.getText("mm_user_registration_password"+s)+"</span>"},calculateProgressForContent:function(e){var a="",o="";e===t?a="progress-striped active":e>=n&&(a="progress-striped"),o=e>=i?"bar-success":e>=r?"bar-warning":"bar-danger";var s="<div class='password_strength progress "+a+"'><div class='bar "+o+"' style='width: "+e+"%;'></div></div></div>";return s}};return a}),ABINEMASKME.define("abine/paymentHeuristics",["documentcloud/underscore","jquery"],function(e){function t(e,t,n,i){i=i||0,len=e.length;for(var r=i;len>r;r++)if(obj=e[r],obj&&obj[t]===n)return r;return null}var n={apply:function(e,t){var n=!1;for(var i in e)if(e[i].dataType&&0==e[i].dataType.indexOf("/financial")){n=!0;break}n&&(this.fixMissingPaymentFields(e,t),this.fixOrphanedPaymentFields(e,t),this.fixDuplicatePaymentFields(e,t))},fixMissingPaymentFields:function(n,i){var r="/financial/creditcard/number",a=e(n).filter(function(e){return e.dataType&&e.dataType===r});if(0==a.length)for(var o=t(i,"dataType","/financial/creditcard/expirymonth",0),s=o-1;s>=0;s--)if("undefined"!=typeof i[s]&&!i[s].dataType){var c=i[s].name+":"+i[s].id;if(i[s].element.getAttribute("maxlength")>=16||c&&c.match(/num|card/i)&&!c.match(/cvs|cv|code|sec/i)){i[s].dataType="/financial/creditcard/number",a.push(i[s]);break}}if(0==a.length){for(var u=-1,d=0,s=0;i.length>s;s++)if("undefined"!=typeof i[s]&&!i[s].dataType)if(4==i[s].element.getAttribute("maxlength")){if(-1==u&&(u=s),d++,4==d)break}else 4>d&&(u=-1,d=0);if(4==d){for(var s=u;u+4>s;s++)i[s].dataType="/financial/creditcard/number/part"+(s-u+1),a.push(i[s]);r="/financial/creditcard/number/part4"}}if(a.length>0){var l=e(n).filter(function(e){return e.dataType&&0==e.dataType.indexOf("/financial/creditcard/expiry")});if(2>l.length){var h=e(n).filter(function(e){return e.dataType&&0==e.dataType.indexOf("/financial/creditcard/expirymonth")});if(0==h.length)for(var f=t(i,"dataType",r,0),s=f+1,p=0;i.length>s&&4>p;s++)if("select"==i[s].fieldType&&p++,i[s].element&&i[s].element.innerHTML.match(/jan|feb|dec|\b12\b|\b11\b/i)){i[s].dataType="/financial/creditcard/expirymonth",h.push(i[s]);break}var m=e(n).filter(function(e){return e.dataType&&0==e.dataType.indexOf("/financial/creditcard/expiryyear")});if(0==m.length)for(var f=t(i,"dataType",r,0),s=f+1,p=0;i.length>s&&5>p;s++)if("select"==i[s].fieldType&&p++,i[s].element&&i[s].element.innerHTML.match(/20[0-9]{2}|year/i)){i[s].dataType="/financial/creditcard/expiryyear",m.push(i[s]);break}}var g=e(n).filter(function(e){return e.dataType&&0==e.dataType.indexOf("/financial/creditcard/verification")});if(0==g.length)for(var f=t(i,"dataType",r,0),s=f+1;i.length>s&&f+5>s;s++)if(i[s].name&&i[s].name.match(/cvv|cid|cvs/i)||i[s].id&&i[s].id.match(/cvv|cid|cvs/i)){i[s].dataType="/financial/creditcard/verification";break}}},fixDuplicatePaymentFields:function(e,n){var i=!1,r=0,a={};for(var o in e){var s=e[o].dataType;if(s&&0==s.indexOf("/financial")){if(s in a){i=!0;break}a[s]=1}}for(;i;){i=!1;var c=t(n,"dataType","/financial/creditcard/number",r);if(null==c)break;var u=t(n,"dataType","/financial/creditcard/verification",c+1),d=t(n,"dataType","/financial/creditcard/expirymonth",c+1),l=t(n,"dataType","/financial/creditcard/expiryyear",c+1),h=t(n,"dataType","/financial/creditcard/number",c+1);if(null!==h){if(i=!0,!(h>l||h>d)){for(var o=1;h>o;o++)n[o].dataType&&0==n[o].dataType.indexOf("/financial")&&-1==n[o].dataType.indexOf("/issuedto")&&-1==n[o].dataType.indexOf("/type")&&(n[o].dataType=null);r=c;continue}n[h].dataType=null}var f=t(n,"dataType","/financial/creditcard/verification",u+1);null!==f&&(i=!0,n[f].dataType=null);var p=t(n,"dataType","/financial/creditcard/expirymonth",d+1);null!==p&&(i=!0,n[p].dataType=null);var m=t(n,"dataType","/financial/creditcard/expiryyear",l+1);null!==m&&(i=!0,n[m].dataType=null)}},fixOrphanedPaymentFields:function(t){var n=e(t).filter(function(e){return e.dataType&&"/financial/creditcard/verification"===e.dataType}),i=e(t).filter(function(e){return e.dataType&&"/financial/creditcard/type"===e.dataType}),r=e(t).filter(function(e){return e.dataType&&("/financial/creditcard/number"===e.dataType||"/financial/creditcard/number/part4"===e.dataType)}),a=e(t).filter(function(e){return e.dataType&&"/financial/creditcard/issuedto"===e.dataType}),o=e(t).filter(function(e){return e.dataType&&0==e.dataType.indexOf("/financial/creditcard/expiry")});n.length>0&&0==r.length&&e(n).each(function(e){e.dataType=null}),a.length>0&&0==r.length&&e(a).each(function(e){e.dataType=null}),i.length>0&&0==r.length&&e(i).each(function(e){e.dataType=null}),o.length>0&&0==r.length&&e(o).each(function(e){e.dataType=null}),r.length>0&&0==o.length&&e(r).each(function(e){e.dataType=null})}};return n}),ABINEMASKME.define("abine/paymentsServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core"],function(e,t,n,i,r){var a=n.protocol+n.paymentsServerHost,o=a+"/api/v2/payment",s=a+"/api/v2/cards",c=a+"/api/v2/cards/guids",u=a+"/api/v2/cardStates",d=a+"/api/v2/authorizations",l=a+"/api/v2/resendGiftCardEmail",h=a+"/api/v2/smartTransactions",f=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},getAuthorizations:function(e,t){this.server.makeRequest({server:"payments",action:"getAuthorizations",defaults:{card_id:""},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:d,type:"GET"})},getSmartTransactions:function(e,t){this.server.makeRequest({server:"payments",action:"getSmartTransactions",defaults:{card_id:"",card_number:""},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:h,type:"GET"})},getCardStatesForGuids:function(e,t){this.server.makeRequest({server:"payments",action:"getCardStatesForGuids",defaults:{guids:""},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:u,type:"GET"})},getCardsForGuids:function(e,t){this.server.makeRequest({server:"payments",action:"getCardsForGuids",defaults:{guids:""},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:c,type:"GET"})},getCardsForClient:function(e,t){this.server.makeRequest({server:"payments",action:"getCardsForClient",defaults:{},required:[],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"GET"})},deactivateCard:function(e,t){this.server.makeRequest({server:"payments",action:"deactivateCard",defaults:{},required:["request_id","card_id"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"PUT"})},resendGiftCardEmail:function(e,t){this.server.makeRequest({server:"payments",action:"resendGiftCardEmail",defaults:{},required:["card_guid","recipient_email","sender_name"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:l,type:"GET"})},createCard:function(e,t){this.server.makeRequest({server:"payments",action:"createCard",defaults:{},required:["request_id","amount","domain"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})}});return f}),ABINEMASKME.define("abine/phoneHeuristics",["documentcloud/underscore","jquery"],function(e){function t(e,t,n,i){i=i||0,len=e.length;for(var r=i;len>r;r++)if(obj=e[r],obj&&obj[t]===n)return obj;return null}var n={apply:function(e,t){var n=!1;for(var i in e)if(e[i].dataType&&e[i].dataType.indexOf("contact/phone")>0){n=!0;break}this.fixUnknownPhoneFieldsWithMaxLengths(e,t),this.fixUnknownPhoneFieldsWithSizes(e,t),n&&(this.fixUnknownPhoneFieldsWithAreaCode(e,t),this.fixThreePhoneFieldsInnaRow(e,t),this.fixOrphanedPaymentFields(e,t),this.normalizeAllPhoneFields(e))},fixUnknownPhoneFieldsWithAreaCode:function(e,n,i){var i=i||1,r=t(n,"dataType","/contact/phone/areacode",i);if(!r)return e;var a=n[r.position+1]?n[r.position+1].key:null,o=n[r.position+2]?n[r.position+2].key:null;return a&&o?(null==e[a].dataType&&null==e[o].dataType&&(e[a].dataType="/contact/phone/exchange",e[o].dataType="/contact/phone/local"),this.fixUnknownPhoneFieldsWithAreaCode(e,n,i+3)):e},fixUnknownPhoneFieldsWithMaxLengths:function(e,n,i){i=i||1;var r=t(n,"maxlength",3,i);if(!r)return e;var a=n[r.position+1]?n[r.position+1].key:null,o=n[r.position+2]?n[r.position+2].key:null;return a&&o?(3===e[a].maxlength&&4===e[o].maxlength&&(e[r.key].dataType="/contact/phone/areacode",e[a].dataType="/contact/phone/exchange",e[o].dataType="/contact/phone/local"),this.fixUnknownPhoneFieldsWithMaxLengths(e,n,i+3)):e},fixUnknownPhoneFieldsWithSizes:function(e,n,i){i=i||1;var r=t(n,"size",3,i);if(!r)return e;var a=n[r.position+1]?n[r.position+1].key:null,o=n[r.position+2]?n[r.position+2].key:null;return a&&o?(3===e[a].size&&4===e[o].size&&(e[r.key].dataType="/contact/phone/areacode",e[a].dataType="/contact/phone/exchange",e[o].dataType="/contact/phone/local"),this.fixUnknownPhoneFieldsWithSizes(e,n,i+3)):e},fixThreePhoneFieldsInnaRow:function(t,n){var i=e(n).filter(function(e){return e?e.dataType&&e.dataType.indexOf("contact/phone")>0:!1});return e(i).each(function(e){if(!(e.dataType&&"/contact/phone/exchange"===e.dataType||e.dataType&&"/contact/phone/local"===e.dataType)){var i=n[e.position+1]?n[e.position+1].key:null,r=n[e.position+2]?n[e.position+2].key:null;if(i&&r){var a=t[i],o=t[r];a.dataType===e.dataType&&o.dataType===e.dataType&&null==a.label&&null==o.label&&(t[e.key].dataType="/contact/phone/areacode",t[i].dataType="/contact/phone/exchange",t[r].dataType="/contact/phone/local")}}}),t},normalizeAllPhoneFields:function(t){var n,i=["/contact/phone/mobile","/contact/phone/home","/contact/phone/work"];for(var r in t)n=t[r],e(i).include(n.dataType)&&(n.dataType="/contact/phone")},fixOrphanedPaymentFields:function(t){var n=e(t).filter(function(e){return e.dataType&&"/contact/phone/areacode"===e.dataType}),i=e(t).filter(function(e){return e.dataType&&"/contact/phone/exchange"===e.dataType}),r=e(t).filter(function(e){return e.dataType&&"/contact/phone/local"===e.dataType});(0===n.length||0===i.length||0===r.length)&&(e(i).each(function(e){e.dataType="/contact/phone"}),e(r).each(function(e){e.dataType="/contact/phone"}));var a=e(t).filter(function(e){return e.dataType&&"/contact/phone"===e.dataType});n.length>0&&a.length>0&&e(a).each(function(e){e.dataType="/contact/phone/number"})}};return n}),ABINEMASKME.define("abine/phoneServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core"],function(e,t,n,i,r){var a=n.protocol+n.phoneServerHost,o=a+"/api/v2/shieldedphones",s=a+"/api/v2/shieldedphones/verify",c=a+"/api/v2/call_log/update",u=a+"/api/v2/call_log",d=a+"/api/v2/migrate",l=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},createPhone:function(e,t){this.server.makeRequest({server:"phone",action:"createPhone",defaults:{},required:["country_code","number","verification_method"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})},verifySecret:function(e,t){this.server.makeRequest({server:"phone",action:"verifySecret",defaults:{},required:["id","secret"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:s,type:"POST"})},updatePhoneLog:function(e,t){this.server.makeRequest({server:"phone",action:"updatePhoneLog",defaults:{},required:["id","is_allowed","caller","phone_auth_token"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:c,type:"POST"})},getPhoneLog:function(e,t){this.server.makeRequest({server:"phone",action:"getPhoneLog",defaults:{},required:["id","phone_auth_token"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:u,type:"POST"})},migratePhone:function(e,t){this.server.makeRequest({server:"phone",action:"migratePhone",defaults:{},required:["phone_auth_token"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:d,type:"PUT"})}});return l}),ABINEMASKME.define("abine/proxies",["documentcloud/underscore","abine/core","abine/contentMessenger","abine/timer"],function(e,t,n,i){function r(t){o||(o=t||new n.ContentMessenger({eventAggregator:ABINEMASKME.eventAggregator||window.eventAggregator}),e.each(s,function(e){e.connect()}))}function a(){o&&(e.each(s,function(e){e.disconnect()}),o=null)}var o,s=[],c=t.BaseClass.extend({initialize:function(t){var n=this;e.each(t.methods,function(e){n.addMethod(e)}),e.each(t.asyncMethods,function(e){n.addAsyncMethod(e)}),this._require=t.require,this._events=t.events,s.push(this),o&&this.connect()},connect:function(){var e=""+Math.random();this._proxyId=e,this._connected=!1;var t=this;o.on("background:stub:events:"+e,function(e){return"stub:connected"==e.name?(t._connected=!0,void 0):(t.trigger(e.name,e.payload),void 0)}),o.send("contentManager:proxy:connect",{proxyId:e,require:this._require,events:this._events})},disconnect:function(){o.send("contentManager:proxy:disconnect",{proxyId:this._proxyId}),this._connected=!1},addMethod:function(e){this[e]=function(){var t=function(){},n=arguments;arguments.length>0&&"function"==typeof arguments[arguments.length-1]?(t=arguments[arguments.length-1],n=Array.prototype.slice.call(arguments,0,-1)):n=Array.prototype.slice.call(arguments,0),this.call({method:e,params:n},t)}},addAsyncMethod:function(e){this[e]=function(){var t=function(){},n=arguments;arguments.length>0&&"function"==typeof arguments[arguments.length-1]?(t=arguments[arguments.length-1],n=Array.prototype.slice.call(arguments,0,-1)):n=Array.prototype.slice.call(arguments,0),this.callAsync({method:e,params:n},t)}},call:function(e,t){var n=""+Math.random();e.proxyId=this._proxyId,e.callId=n,e.require=this._require,t&&o.once("background:stub:response:"+n,function(e){t(e)});var r=this,a=100,s=function(){return a--,!r._connected&&a>0?(i.setTimeout(s,50),void 0):(o.send("contentManager:proxy:call",e),void 0)};s()},callAsync:function(e,t){var n=""+Math.random();e.proxyId=this._proxyId,e.callId=n,e.require=this._require,t&&o.once("background:stub:response:"+n,function(e){t(e.err,e.data)});var r=this,a=100,s=function(){return a--,!r._connected&&a>0?(i.setTimeout(s,50),void 0):(o.send("contentManager:proxy:callAsync",e),void 0)};s()}}),u=new c({require:"abine/securityManager",methods:["isLocked","hasPassword","lock","setPassword","isInitialized","sync","hasRegisteredSync","recheckPassword","openWindow","needsToChangePassword","emailEntered","authenticate","reloadPreference","enableEntitlements","refreshEntitlements","openPage"],asyncMethods:["unlock","passwordValidationRequired","clearAutoUnlockPassword","setAutoUnlockPassword"],events:["background:securityManager:unlocked","background:securityManager:locked","background:securityManager:passwordChanged","background:securityManager:showDecrypting","background:securityManager:invalidPassword","background:securityManager:sync","background:securityManager:serverAuthSuccess","background:securityManager:serverAuthFailed","background:securityManager:entitlementsRefreshed","background:securityManager:entitlementsRefreshError","background:securityManager:fakelocked"]}),d=new c({require:"abine/modules/license",methods:[],asyncMethods:["register","signIn","changePassword","changeEmail","deleteUser","activatedCards","sendResetPasswordEmail","refreshLastFourCardDigits","sendFeedbackEmail","refreshEntitlements","resendUnlockEmail","autoRegister","sendResetPasswordEmail","changeEmailPassword","postInstallCompleted","referralCode"],events:[]}),l=new c({require:"abine/modules/sync",methods:[],asyncMethods:["sync"],events:[]}),h=new c({require:"abine/modules/phone",methods:[],asyncMethods:["clearPhoneData"],events:[]}),f=new c({require:"abine/preregister",methods:[],asyncMethods:["checkForRegistration"],events:[]}),p=new c({require:"abine/pageEvents",asyncMethods:["processAction"],methods:[],events:[]}),m=new c({require:"abine/modules/payments",asyncMethods:["resendGiftCardEmail","retrieveDisposableCardBalance"],methods:[],events:[]});return{Proxy:c,connect:r,disconnect:a,securityManager:u,licenseModule:d,syncModule:l,phoneModule:h,preregModule:f,pageEventsModule:p,paymentsModule:m}}),ABINEMASKME.define("abine/responseCodes",[],function(){return{UNKNOWN_ERROR:"unknown error",SUCCESS:"successful",ERROR:"error",MISSING_PARAMETERS:"missing parameters",UNAUTHORIZED:"unauthorized bad token",NO_ACCESS_FOR_FEATURE:"no access to requested feature",INVALID_PASSWORD:"invalid password",ACCOUNT_ALREADY_EXISTS:"account already exists for that email",SAVE_NEW_USER_ERROR:"error saving new user",FAILED_CREATING_TARGET_EMAIL:"failed to create target email",FAILED_TO_UPDATE_USER:"error updating user",NO_ACCOUNT_FOUND_FOR_EMAIL:"no account found for email",ACCOUNT_MARKED_FOR_DELETION:"account has been marked for deletion",ACCOUNT_HAS_BEEN_LOCKED:"account has been locked",WRONG_PASSWORD:"wrong password",INVALID_EMAIL_ADDRESS:"invalid email address",NO_RECURLY_ACCOUNT_FOUND:"no recurly account found",VERSION_NOT_ALLOWED:"version not allowed",DOWNGRADE_SCHEMA_NOT_ALLOWED:"downgrade of schema_version is not allowed",SAVE_CLIENT_DATA_ERROR:"errors saving client data",DESTROY_CLIENT_DATA_ERROR:"errors destroying client data",NO_CLIENT_DATA_FOUND:"no client data found",USER_EXISTS_FOR_CLIENT_DATA_DELETION:"cannot destroy client data when user exists",UPGRADE_REQUIRED:"upgrade required",PHONE_NOT_FOUND:"phone not found",NO_DISPOSABLE_PHONE:"no disposable phone",FAILED_TO_SAVE_PHONE:"failed to save phone",PHONE_ALREADY_VALIDATED:"phone already validated",NO_NUMBERS_AVAILABLE:"no numbers available",FAILED_TO_SEND_VERIFICATION_CODE:"failed to send verification code",WRONG_VERIFICATION_CODE:"wrong verification code",OLD_PHONE_NOT_FOUND:"old phone not found",COUNTRY_NOT_SUPPORTED:"country not supported",COUNTRY_CHANGE_NOT_SUPPORTED:"country change not supported",ERROR_CREATING_DISPOSABLE:"error creating disposable",MISSING_USER_PARAMS_ERROR_CODE:"missing user params",NO_BILLING_ACCOUNT_FOR_USER_ERROR_CODE:"no billing account for user",REQUEST_ALREADY_EXISTS_ERROR_CODE:"request already exists",NO_CARDS_AVAILABLE_ERROR_CODE:"no cards available",REQUESTED_AMOUNT_OVER_LIMIT_ERROR_CODE:"requested amount over limit",REQUESTED_AMOUNT_BELOW_MINIMUM_ERROR_CODE:"requested amount below minimum",REQUESTED_AMOUNT_INVALID_ERROR_CODE:"requested amount invalid",BILLING_FAILED_ERROR_CODE:"billing failed",BILLING_DECLINED_ERROR_CODE:"billing declined",NO_CARD_FOUND_ERROR_CODE:"no card found",NO_BILLING_TRANSACTION_FOUND_ERROR_CODE:"no billing transaction found",FRAUD_SOFT_LIMIT_REACHED:"fraud soft limit",REFUND_FAILED_ERROR_CODE:"refund failed",PROVIDER_CANCEL_FAILED_ERROR_CODE:"provider cancel failed",PROVIDER_READ_FAILED_ERROR_CODE:"provider read failed",PROVIDER_CARD_CREATION_FAILED_ERROR_CODE:"provider card creation failed",FRAUD_HARD_LIMIT_REACHED:"fraud hard limit reached",CARD_ALREADY_DEACTIVATED_ERROR_CODE:"card already deactivated",FRAUD_VERIFIED_SOFT_LIMIT_REACHED:"fraud verified soft limit",FRAUD_PLATFORM_UNAVAILABLE:"fraud verification unavailable",FRAUD_HIGH_RISK_COUNTRY_ERROR_CODE:"high risk country ban",BILLING_IN_NON_US_ERROR_CODE:"billing in non us",GREY_LISTED_ERROR_CODE:"grey listed user",GLOBAL_SOFT_LIMIT_REACHED:"global soft limit",DUPLICATE_CARD_ERROR_CODE:"duplicate card used ban",TOO_MANY_REJECTS:"target mail has been rejected too many times"}}),ABINEMASKME.define("abine/securityManager",["documentcloud/underscore","abine/core","abine/crypto","storage","persistence","abine/timer","abine/config","abine/window","abine/responseCodes"],function(e,t,n,i,r,a,o,s,c){function u(e){var t=n.createKeyAndIV(e,e);return n.sha256(n.encrypt(t,e))}function d(e,t){var i=n.createKeyAndIV(t,t);return n.encrypt(i,e)}function l(e,t){var i=n.createKeyAndIV(t,t);return n.decrypt(i,e)}function h(){P={length:0}}function f(e,t,i){var r;if(e){var a=i+":"+t;a in P||(P[a]=n.createKeyAndIV(i,t),P.length++,P.length>C&&p()),r=P[a],r._accessTime=Date.now()}else r=n.createKeyAndIV(i,t);return r}function p(){a.clearTimeout(x),x=a.setTimeout(function(){var e=-1,t=null;for(var n in P)"length"!=n&&(e>P[n]._accessTime||-1==e)&&(e=P[n]._accessTime,t=n);t&&(delete P[t],P.length--,P.length>C&&p())},1e3)}function m(t,n,a){n=n||I(),r.flush(function(){e.async.parallel([i.AccountField.migrateToAccountIdSalt,i.Preference.encryptAuthToken],function(){n(null,t),a||O.trigger("background:securityManager:unlocked",t)
})})}function g(t){function n(e){return 0===e.key.indexOf("Salt.")}i.Preference.listCached(n,function(n){var a={};e.each(n,function(e){a[e.key.substr(5)]=e.value});for(var o in i){var s=i[o];if(s.meta&&s.meta.secured){var c=!1;o in a||(a[o]=O.salt(),r.add(new i.Preference({key:"Salt."+o,value:a[o]})),c=!0),s.meta.salt=a[o],c&&s.encryptAll()}}r.flush(t)})}var y=null,v=null,b=!0,E=!1,A=!1,_=!1,S=!1,T=!1,M=null,w=!1,k=12e4,C=1e3,P={length:0},x=null,I=function(){},N=t.BaseClass.extend({initialize:function(){this.useEncryption=o.crypt},getServerPassword:function(e){return u(u(e))},load:function(e,t){e&&(this.messenger=e);var a=function(){h(),g(function(){T=!0,i.Preference.findBy("key","requirePasswordToShowPassword",function(e){w=!e||e.isTrue(),i.Preference.findBy("key","hasRegisteredSync",function(e){_=e&&e.isTrue();var n=function(){O.trigger("background:securityManager:initialized")};b?n():E?m({serverPassword:u(y)},n,t):m(null,n,t)})})})};i.Preference.findBy("key","hasPassword",function(e){!e||e.isFalse()?(b=!1,E=!1,i.Preference.findBy("key","defaultPassword",function(e){e?(y=e.value,a()):(y=n.sha256(""+Math.random()),r.add(new i.Preference({key:"defaultPassword",value:y})),r.flush(function(){O.encryptAll(),a()}))})):(E=!0,i.Preference.findBy("key","autoUnlockPassword",function(e){e?i.Preference.findBy("key","password",function(t){b=!1,y=l(e.value,t.value),M=Date.now(),r.clean(),a()}):(b=!0,y=null,a())}))})},refreshEntitlements:function(){O.trigger("background:securityManager:refreshEntitlements")},enableEntitlements:function(e){O.trigger("background:securityManager:enableEntitlements",e)},openPage:function(e,t,n){n&&(ABINEMASKME.lastPanel||(ABINEMASKME.lastPanel={}),ABINEMASKME.lastPanel[n.action]=n.type),t?s.createTab({localUrl:"pages/index.html#"+e}):s.createTab({url:e,force:!0})},openWindow:function(e,t,n){s.openWindow(e,t,n)},isLocked:function(){return b},hasPassword:function(){return E},hasRegisteredSync:function(){return _},needsToChangePassword:function(){return S},passwordValidationRequired:function(t){t=t||I,i.Preference.findBy("key","regPassword",e.bind(function(e){return this.hasPassword()&&w&&!e?k>=Date.now()-M?(M=Date.now(),t(!1),void 0):(t(!0),void 0):(t(!1),void 0)},this))},emailEntered:function(e){O.trigger("background:securityManager:emailEntered",{email:e})},serverAuthSuccess:function(){_=!0,S=!1,O.trigger("background:securityManager:serverAuthSuccess")},serverAuthFailed:function(){O.trigger("background:securityManager:serverAuthFailed")},authenticate:function(e){var t=u(e),n=u(t);O.trigger("background:securityManager:authenticate",{serverPassword:n})},unlock:function(e,t,a){return a=a||I,i.Preference.createOrModify({key:"autoLockOnRestart",value:t?"true":"false"},function(t){i.Preference.findBy("key","password",function(o){var s=u(e),l=u(s);o&&o.value==n.sha256(s)?(h(),y=s,M=Date.now(),b=!1,r.clean(),t.isFalse()&&r.add(new i.Preference({key:"autoUnlockPassword",value:d(u(e),n.sha256(u(e)))})),r.flush(function(){m({serverPassword:l},a)})):a({errorCode:c.INVALID_PASSWORD})})}),!0},lock:function(e){return e=e||I,!b&&E?(i.Preference.findBy("key","regPassword",function(t){t?(O.trigger("background:securityManager:fakelocked"),e()):(y=null,h(),b=!0,r.clean(),i.Preference.findBy("key","autoUnlockPassword",function(t){t?(r.remove(t),r.flush(function(){e(),O.trigger("background:securityManager:locked")})):(e(),O.trigger("background:securityManager:locked"))}))}),!0):(e(),!1)},setAutoUnlockPassword:function(e,t){t=t||I,i.Preference.createOrModify({key:"autoUnlockPassword",value:d(u(e),n.sha256(u(e)))},t)},clearAutoUnlockPassword:function(e){i.Preference.findBy("key","autoUnlockPassword",function(t){t?(r.remove(t),r.flush(function(){e()})):e()})},sync:function(){return!b&&E?(O.trigger("background:securityManager:sync"),!0):!1},refreshLastFourCardDigits:function(){O.trigger("background:securityManager:refreshLastFourCardDigits")},recheckPassword:function(e){return!b&&E&&u(e)==y?(M=Date.now(),!0):!1},setPassword:function(t,a){if(a=a||function(){},b||!t||""==t)return a(),void 0;var o=u(t);i.Preference.findOrCreate({key:"autoLockOnRestart",value:"false"},function(s){i.Preference.all().filter("key","in",["password","hasPassword","autoUnlockPassword"]).list(function(c){e.each(c,function(e){r.remove(e)}),r.add(new i.Preference({key:"hasPassword",value:"true"})),r.add(new i.Preference({key:"password",value:n.sha256(o)})),s.isFalse()&&r.add(new i.Preference({key:"autoUnlockPassword",value:d(o,n.sha256(o))})),r.flush(function(){A=!0,h(),v=o,O.encryptAll(function(){h(),A=!1,y=o,v=null,E=!0;var e=u(o);O.trigger("background:securityManager:passwordChanged",{password:t,serverPassword:e}),a()})})})})},salt:function(){return n.salt()},encrypt:function(e,t,i){if(!y||!this.useEncryption)return t;var r=f(i,e,v||y);return n.encrypt(r,t)},decrypt:function(e,t,i){if(!y||!this.useEncryption)return t;var r=f(i,e,y);return n.decrypt(r,t)},isInitialized:function(){return T},reloadPreference:function(){i.Preference.findOrCreate({key:"autoLockOnRestart",value:"true"},function(e){e.isFalse()?i.Preference.createOrModify({key:"autoUnlockPassword",value:d(y,n.sha256(y))},function(){}):i.Preference.findBy("key","autoUnlockPassword",function(e){e&&(r.remove(e),r.flush())})}),i.Preference.findBy("key","requirePasswordToShowPassword",function(e){w=!e||e.isTrue()})},encryptAll:function(t){if(!T)return this.once("background:securityManager:initialized",e.bind(this.encryptAll,this,t)),void 0;var n=null,r=0;t&&(n=function(){r--,0>=r&&t()});for(var a in i){var o=i[a];o.meta&&o.meta.secured&&(r++,o.encryptAll(n))}}}),O=new N;return O}),ABINEMASKME.define("abine/server",["documentcloud/underscore","abine/ajax","abine/config","storage","abine/core","abine/responseCodes","abine/window","persistence","abine/timer","abine/securityManager"],function(e,t,n,i,r,a,o,s){var c=function(){},u=function(e,t){i.Preference.findBy("key","authToken",function(n){i.Preference.findBy("key","installAuthToken",function(i){var r=!n||n.isEmpty()||n.isEncrypted()?null:n.value,a=!i||i.isEmpty()?null:i.value;r&&(e.data.auth_token=r),a&&(e.data.install_auth_token=a),t.call(this,e)})})},d=function(e,t){e.data.client_application.version=n.version,e.data.client_application.environment=n.environment,e.data.client_application.tag=n.tags[0],e.data.client_application.browser=n.browser,e.data.client_application.build_num=n.buildNum,e.data.client_application.user_agent=ABINEMASKME.userAgent,e.data.client_application.product="MaskMe",e.data.client_application.device="Extension",t.call(this,e)},l=r.BaseClass.extend({makeRequest:function(n){n.defaults=n.defaults||{},n.required=n.required||[],n.data=e.defaults(n.data||{},n.defaults),n.type=n.type||"POST",n.dataType=n.dataType||"json";var r=n.success||c,o=n.error||c;return n.data.client_application||(n.data.client_application={}),n.success=e.bind(function(e,t,n){var i=n.status,a=e.data;r(a,i)},this),n.error=e.bind(function(t){var r=t.status,c={error_code:a.UNKNOWN_ERROR};try{c=JSON.parse(t.responseText)}catch(u){}var d=c.error_code;500==r&&(d=a.UNKNOWN_ERROR),d==a.UNAUTHORIZED&&i.Preference.findBy("key","authToken",e.bind(function(e){e&&!e.isEncrypted()&&(e.value="",s.flush(),"refreshEntitlements"!=n.action&&"signIn"!=n.action&&this.openLoginPage())},this)),o(r,d,c)},this),this.hasRequiredParams(n.required,n.data)?(u(n,function(e){d(e,function(e){t.ajax(e)})}),void 0):(true&&ABINEMASKME.log.error("[ERROR HANDLER]#["+n.server+"]#["+n.action+"]# client missing required parameters"),o(422,a.MISSING_PARAMETERS,{}),void 0)},openLoginPage:e.debounce(function(){o.createTab({doNotOpenNewTab:!0,localUrl:"pages/index.html#userLogin"})},3500,!0),hasRequiredParams:function(t,n){var i=!0;return e.each(t,e.bind(function(t){(!e.has(n,t)||this.isEmpty(n[t]))&&(i=!1)},this)),i},isEmpty:function(e){return null===e||void 0===e||0/0===e||""===e}}),h=l.extend({makeRequest:function(e){if(!e.url)throw"server calls must have a url";e.data=e.data||{},e.type=e.type||"POST",e.dataType=e.dataType||"json";var t=e.success||c,n=e.error||c;e.success=function(e,n,i){var r=i.status,a=e.data;t(a,r,this)},e.error=function(e){var t=e.status,i={error_code:a.UNKNOWN_ERROR};try{i=JSON.parse(e.responseText)}catch(r){}var o=i.error_code;500==t&&(o=a.UNKNOWN_ERROR),n(t,o,i)},e.data.client_application||(e.data.client_application={}),this.lastRequest=e,this.tokenSet=!1;var i=this;u(e,function(e){d(e,function(){i.tokenSet=!0,i.waitingRequest&&(i.waitingRequest(),delete i.waitingRequest)})}),this.trigger("request:made")},respondWithSuccess:function(t,n,i){return this.tokenSet?(this.lastRequest.success.call(this.lastRequest,t,n,i),delete this.lastRequest,void 0):(this.waitingRequest=e.bind(this.respondWithSuccess,this,t,n,i),void 0)},respondWithError:function(t,n,i){return this.tokenSet?(this.lastRequest.error=!0,this.lastRequest.error.call(this.lastRequest,t,n,i),delete this.lastRequest,void 0):(this.waitingRequest=e.bind(this.respondWithError,this,t,n,i),void 0)}});return{server:l,mock:h}}),ABINEMASKME.define("abine/storageMixins",["documentcloud/underscore","persistence"],function(e,t){var n={index:function(e,n){var i=this;if(i.meta.cached&&i.cached){var r=t.getCachedEntities(i);i.respondWithEntities(r,e,n)}else if(i.cachingQueryInProgress)i.waitingCallbacks.push({req:e,cb:n});else{i.cachingQueryInProgress=!0,i.waitingCallbacks=[];try{this.all().list(null,function(r){i.meta.cached&&(i.cached=!0);var a=i.waitingCallbacks;delete i.cachingQueryInProgress,delete i.waitingCallbacks;try{i.respondWithEntities(r,e,n)}catch(o){true&&ABINEMASKME.log.error(o)}for(var s=0;a.length>s;s++)try{r=t.getCachedEntities(i),i.respondWithEntities(r,a[s].req,a[s].cb)}catch(o){true&&ABINEMASKME.log.error(o)}})}catch(a){true&&ABINEMASKME.log.error(a);var o=i.waitingCallbacks;delete i.cachingQueryInProgress,delete i.waitingCallbacks;for(var s=0;o.length>s;s++)try{i.respondWithEntities([],o[s].req,o[s].cb)}catch(a){true&&ABINEMASKME.log.error(a)}}}},isCached:function(){return this.meta.cached&&this.cached},show:function(e,t){var n=e.params[0];this.load(n,function(n){t?t.call(this,n):e.returnEntities&&e.returnEntities(n)})},create:function(e,n){var i=this;e.payload.createdAt=new Date,e.payload.modifiedAt=new Date;var r=new i(e.payload);t.add(r),t.flush(null,function(){n?n.call(this,r):e.returnEntities&&e.returnEntities(r)})},update:function(n,i){var r=n.params[0];n.payload.modifiedAt=new Date,this.load(r,function(r){e.extend(r,n.payload),t.flush(null,function(){i?i.call(this,r):n.returnEntities&&n.returnEntities(r)})})},destroy:function(e,n){var i=e.params[0];this.load(i,function(i){t.remove(i),t.flush(null,function(){n?n.call():e.returnStatus&&e.returnStatus("ok")})})},respondWithEntities:function(e,t,n){n?n.call(this,e):t&&t.returnEntities&&t.returnEntities(e)},respondWithJSON:function(e,t,n){n?n.call(null,e):t.returnJSON&&t.returnJSON(e)},listCached:function(t,n,i,r){if(!this.meta.cached)throw"listCached cannot be used with entities that do not have caching enabled.";"function"==typeof t?(i=t,r=n,t=null):r||(r=i,i=null),this.index(null,function(a){var o=[];e.each(a,function(e){t&&e[t]!=n||i&&!i(e)||o.push(e)}),r&&r(o)})},initCache:function(e){this.meta.cached&&!this.cached?this.index(null,function(){e()}):e()},updatePushVersion:function(t,n){this.meta.cached?this.listCached("pushVersion",0,function(i){e.each(i,function(e){e.pushVersion=t}),n()}):this.all().filter("pushVersion","=",0).list(function(i){e.each(i,function(e){e.pushVersion=t}),n()})}};return{DefaultActions:n}}),ABINEMASKME.define("abine/storageRouter",["documentcloud/underscore","persistence","abine/core","abine/fixtures","abine/backgroundMessenger"],function(e,t,n,i,r){var a={dbName:"idme_data",dbDescription:"Storage for the idme extension",dbSizeInBytes:5242880},o=/:([\w\d]+)/g,s=/\*([\w\d]+)/g,c=/[-[\]{}()+?.,\\^$|#\s]/g,u=n.BaseClass.extend({initialize:function(t){t=t||{};var n=this,i=t.ready||function(){};this.routes=[],this.storage={},e.defaults(t,a),this.messenger=t.messenger||new r.BackgroundMessenger,u.initialized?(n.startListener(),i.call()):(t.ready=function(){n.startListener(),i.call()},u.initializeWebSQLStorage(t))},initializeMemoryStorage:function(e){t.store.memory.config(t),e.call(this)},startListener:function(){this.messenger.on("all",this.messageHandler,this)},registerEntity:function(t,n){this.storage[n]=t,e(t.routes).each(function(t,i){if(!t||!i)throw"Bad routes on entity "+n;if(e.isRegExp(i)||(i=i.replace(c,"\\$&").replace(o,"([^/]*)").replace(s,"(.*?)"),i=new RegExp("^"+i+"$","i")),!i)throw"Bad route for "+t;this.routes.push([i,n,t])},this)},messageHandler:function(t,n,i){var r=t.split(":")[0];if(e(["create","read","update","delete"]).include(r)){var a=t.replace(/\:/g,"/");a=a.replace(/\/\//g,":");var o=e(this.routes).find(function(e){return a.match(e[0])}),s=this.storage[o[1]],c=o[2],u=o[0].exec(a).slice(1),l=new d({entityName:o[1],route:t,payload:n,sender:i,params:u,messenger:this.messenger});return s[c].call(s,l),l}},send:function(){return this.messageHandler.apply(this,arguments)}});u.initializeWebSQLStorage=function(e){var n=e.ready||function(){};if(u.initialized)return n(),void 0;if(t.store.websql.config(t,e.dbName,e.dbDescription,e.dbSizeInBytes),e.noMigrations)e.fixtures?i.createFixtures(function(){n()}):n();else{var r=(Date.now(),function(){n()});t.migrations.init(function(){t.migrate(function(){e.fixtures?i.createFixtures(r):r()})})}u.initialized=!0};var d=n.BaseClass.extend({initialize:function(e){e=e||{},this.route=e.route,this.params=e.params,this.entityName=e.entityName,this.sender=e.sender||"background",this.messenger=e.messenger,this.payload=e.payload},getReturnRoute:function(){var e=this.route.split(":");return e[0]="response",e.join(":")},getReturnErrorRoute:function(){var e=this.route.split(":");return e[0]="error",e.join(":")},returnErrObj:function(e){return e=e||{},this.messenger.send(this.getReturnErrorRoute(this.route),e,this.sender),!0},returnError:function(e,t){t=t||500,e=e||"Server error";var n={error:!0,message:e,status:t};return this.messenger.send(this.getReturnErrorRoute(this.route),n,this.sender),!0},returnStatus:function(e){var t={status:e};return this.messenger.send(this.getReturnRoute(this.route),t,this.sender),!0},returnEntities:function(t){var n;t&&0!=t.length?e.isArray(t)&&1==t.length?n=t[0].toJSON():e.isArray(t)&&t.length>1?n=e(t).map(function(e){return e.toJSON()}):e.isObject(t)&&(n=t.toJSON()):n=[],this.messenger.send(this.getReturnRoute(this.route),n,this.sender)},returnJSON:function(e){this.messenger.send(this.getReturnRoute(this.route),e,this.sender)}});return{StorageRouter:u,StorageRequest:d}}),ABINEMASKME.define("abine/stubs",["documentcloud/underscore","abine/core"],function(e,t){function n(e,t){ABINEMASKME.require([e.require],function(n){t in c&&e.require in c[t]?c[t][e.require].addProxy(e.proxyId):(c[t]||(c[t]={}),c[t][e.require]||(c[t][e.require]=new d(n,e,t)),u++),s.send("background:stub:events:"+e.proxyId,{name:"stub:connected",payload:null},t)})}function i(t,n){n in c&&(e.each(e.keys(c[n]),function(e){u--,c[n][e].cleanup(),delete c[n][e]}),delete c[n])}function r(e){s=e,e.on("contentManager:proxy:connect",n),e.on("contentManager:proxy:disconnect",i),e.on("contentManager:proxy:call",function(e,t){t in c&&e.require in c[t]&&c[t][e.require].call(e,t)}),e.on("contentManager:proxy:callAsync",function(e,t){t in c&&e.require in c[t]&&c[t][e.require].callAsync(e,t)})}function a(e){i(null,e)}function o(){s&&(s.off("contentManager:proxy:connect"),s.off("contentManager:proxy:disconnect"),s.off("contentManager:proxy:call"),s.off("contentManager:proxy:callAsync"),s=null);for(var e in c)c[e].cleanup();c={}}var s,c={},u=0,d=t.BaseClass.extend({initialize:function(t,n,i){this.realObj=t,this._proxyIds=[n.proxyId],this._events={};var r=this;e.each(n.events,function(n){r._events[n]=function(t){e.each(r._proxyIds,function(e){s.send("background:stub:events:"+e,{name:n,payload:t},i)})},t.on(n,r._events[n])})},addProxy:function(e){this._proxyIds.push(e)},call:function(e,t){var n=e.callId,i=this.realObj[e.method].apply(this.realObj,e.params);s.send("background:stub:response:"+n,i,t)},callAsync:function(e,t){var n=e.callId,i=function(e,i){s.send("background:stub:response:"+n,{err:e,data:i},t)};e.params=e.params||[],e.params.push(i),this.realObj[e.method].apply(this.realObj,e.params)},cleanup:function(){var t=this.realObj;e.each(this._events,function(e,n){t.off(n,e)})}});return{tabClosed:a,start:r,stop:o}}),ABINEMASKME.define("abine/syncMerge",["documentcloud/underscore","abine/core","storage","persistence","abine/sync/preference","abine/sync/site","abine/sync/shielded_email","abine/sync/shielded_phone","abine/sync/account","abine/sync/disposableEmail","abine/sync/disposablePhone","abine/sync/disposableCard","abine/sync/shieldedCard"],function(e,t,n,i,r,a,o,s,c,u,d,l,h){var f=t.BaseClass.extend({initialize:function(){},migrateServerData:function(e,t){if(ABINEMASKME.schemaVersion>e){for(var n=i.migrations.Migrator.migrations,r=[],a=e+1;ABINEMASKME.schemaVersion>=a;a++)r.unshift(n[a]);for(;r.length>0;){var o=r.pop();o.body.upForSync&&o.body.upForSync(t)}}},mergeClientData:function(t,f,p,m){this.migrateServerData(p,t),e.defer(function(){n.Preference.findBy("key","lastSync",function(e){var p=0;e&&e.value&&(p=parseInt(e.value)),p=new Date(p),n.Preference.findBy("key","lastDataVersion",function(e){var n=0;e&&e.value&&(n=parseInt(e.value)),i.flush(function(){i.clean(),new r(t,p,n,f).merge(function(){new a(t,p,n,f).merge(function(){new h(t,p,n,f).merge(function(){new o(t,p,n,f).merge(function(){new s(t,p,n,f).merge(function(){new c(t,p,n,f).merge(function(){new l(t,p,n,f).merge(function(){new u(t,p,n,f).mergeSpareEmails(function(){new d(t,p,n,f).mergeSparePhones(function(){i.flush(function(){m.call()})})})})})})})})})})})})})})}});return{SyncMerge:f}}),ABINEMASKME.define("abine/syncServer",["documentcloud/underscore","abine/ajax","abine/config","abine/server","abine/core"],function(e,t,n,i,r){var a=n.protocol+n.serverHost,o=a+"/api/v2/client_data",s=r.BaseClass.extend({initialize:function(e){this.options=this.options||e||{},this.server=this.options.server||new i.server},getClientDataHeaderFromServer:function(e,t){this.server.makeRequest({server:"sync",action:"getClientDataHeaderFromServer",defaults:{},required:["schema_version"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"GET"})},getClientDataFromServer:function(e,t){this.server.makeRequest({server:"sync",action:"getClientDataFromServer",defaults:{},required:["id"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o+"/"+e.id,type:"GET"})},pushClientDataToServer:function(e,t){this.server.makeRequest({server:"sync",action:"pushClientDataToServer",defaults:{},required:["client_data"],success:function(e){t.call(this,null,e)},error:function(e,n,i){t.call(this,{status:e,errorCode:n,responseJSON:i})},data:e,url:o,type:"POST"})}});return s}),ABINEMASKME.define("abine/storage/account",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/formAnalyzer","persistence/security","persistence/autodate","persistence/caching"],function(e,t,n,i,r){function a(t,n){t.accountFields=[],i.AccountField.getLatestForAccountId(t.id,function(i){t.accountFields=e(i).map(function(e){return e.toJSON()}),n(t)})}function o(t,n){t.disposableEmails=[],i.DisposableEmail.listCached("accountId",t.id,function(i){t.disposableEmails=e(i).map(function(e){return e.toJSON()}),n(t)})}function s(t,n){t.disposablePhones=[],i.DisposablePhone.listCached("accountId",t.id,function(i){t.disposablePhones=e(i).map(function(e){return e.toJSON()}),n(t)})}var c=t.define("Accounts",{name:"TEXT",description:"TEXT",siteId:"TEXT",type:"TEXT",active:"INTEGER",deleted:"INTEGER",createdAt:"DATE",modifiedAt:"DATE",protectionLevel:"INTEGER",protectionsJSON:"TEXT",pushVersion:"INTEGER",protocol:"TEXT",page_domain:"TEXT",form_domain:"TEXT"});return c.secure(t.security.TABLE_SALT,["name","description","type","protocol","page_domain","form_domain"]),c.autoDate(),c.enableCaching(),e.extend(c.prototype,{cleanRemoveAccountsAndHistory:function(n){var r=this.id;t.remove(this),t.flush(function(){i.AccountField.listCached("accountId",r,function(a){e.async.forEach(a,function(e,n){t.remove(e),t.flush(function(e,t){n(t)})},function(a){a&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[cleanRemove]# error event in AccountField.listCached async.forEach"),i.AccountActivity.all().filter("accountId","=",r).list(function(i){e.async.forEach(i,function(e,n){t.remove(e),t.flush(function(e,t){n(t)})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[cleanRemove]# error event in AccountActivity.all.filter async.forEach"),n&&n()})})})})})},cleanRemove:function(n){var r=this.id;"fill"==this.type?(t.remove(this),t.flush(function(){i.AccountField.listCached("accountId",r,function(i){e.async.forEach(i,function(e,n){t.remove(e),t.flush(function(e,t){n(t)})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[cleanRemove]# error event in Account.listCached async.forEach"),n&&n()})})})):i.DisposableEmail.all().filter("accountId","=",r).list(e.bind(function(i){e.async.forEach(i,function(e,n){e.destroyOnServer(function(i){"0"==i.statusCode||"7"==i.statusCode?(t.remove(e),t.flush(function(e,t){n(t)})):n(i)})},e.bind(function(e){e?(true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[cleanRemove]# error event in DisposableEmail.all.filter async.forEach"),n&&n(e)):this.cleanRemoveAccountsAndHistory(n)},this))},this))},updateInfo:function(e,n){var a=this;a.active=1,"fill"===a.type&&(a.type=e===r.LOGIN_FORM?"login":"register"),i.Site.load(a.siteId,function(e){function r(e){return e.accountId==a.id&&1==e.latest&&e.dataType in{"/contact/email":1,"/nameperson/friendly":1}}a.description=e.domain+" "+a.type+" account",a.modifiedAt=new Date,e.modifiedAt=new Date,t.add(e),i.AccountField.listCached(r,function(e){a.name=e&&e.length>0?e[0].value:"password account",t.flush(n)})})},countPasswordDuplicates:function(t,n){function r(e){return e.accountId!=o.id&&1!=e.deleted&&"/password"==e.dataType}var a=[],o=this;i.AccountField.listCached(r,function(i){var r=e(i).uniq(!1,function(e){return e.toJSON().accountId});a=e(r).filter(function(e){return e.toJSON().value===t}),n(a.length)})},computePhoneAndEmailArrays:function(t){i.AccountField.getLatestForAccountId(this.id,e.bind(function(n){var i={goodEmails:[],badEmails:[],goodPhones:[],badPhones:[]};e.async.forEach(n,function(e,t){"/contact/email"===e.dataType?"disposable"!==e.origin?i.badEmails.push(e):i.goodEmails.push(e):"/contact/phone"===e.dataType&&("disposable"!==e.origin?i.badPhones.push(e):i.goodPhones.push(e)),t()},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[computePhoneAndEmailArrays]# error while computing privacy status of account fields"),t(i)})},this))},computeFullyProtected:function(n,r){this.protectionsJSON&&!n?(this.protections=JSON.parse(this.protectionsJSON),r(this.protectionLevel,this.protections)):i.AccountField.getLatestForAccountId(this.id,e.bind(function(n){var i=!1,a=!1,o=null;this.protections={emails:0,phones:0,passwords:0,email:0,phone:0,password:0};for(var s=0;n.length>s;s++){var c=n[s];"/contact/email"===c.dataType?(this.protections.emails++,"disposable"!==c.origin?a=!0:(i=!0,this.protections.email++)):"/contact/phone"===c.dataType?(this.protections.phones++,"disposable"!==c.origin?a=!0:(i=!0,this.protections.phone++)):"/password"==c.dataType&&(this.protections.passwords++,o=c.value)}this.protectionLevel=a?i?1:0:2,o?this.countPasswordDuplicates(o,e.bind(function(n){n>0?this.protectionLevel=i?1:0:(this.protections.password=this.protections.passwords,a&&(this.protectionLevel=1)),this.protectionsJSON=JSON.stringify(this.protections),t.flush(e.bind(function(){r(this.protectionLevel,this.protections)},this))},this)):(this.protectionsJSON=JSON.stringify(this.protections),t.flush(e.bind(function(){r(this.protectionLevel,this.protections)},this)))},this))},fieldIsAnExposedEmail:function(e){return"/contact/email"===e.dataType&&"disposable"!==e.origin},fieldIsAnExposedPhone:function(e){return"/contact/phone"===e.dataType&&"disposable"!==e.origin}}),e.extend(c,n.DefaultActions,{routes:{"read/account/all":"indexWithSite","read/account/passwords/:id":"isPasswordReused","read/account/all/:type":"filterByTypeWithSiteAndFields","read/account/:id":"showWithFieldsAndDisposables","create/account":"create","update/account/:id":"update","delete/account/:id":"deepDestroy","delete/account/exceptEmail/:id":"destroyExceptEmail"},filterByTypeWithSiteAndFields:function(t,n){var r=[],a=function(){return!0},o=t.params[0].split(",");if(o.length>0){var s={};e.each(o,function(e){s[e]=e}),a=function(e){return e.type in s?!0:!1}}i.Account.listCached(a,function(a){e.async.forEach(a,function(t,n){if(!t)return n(),void 0;var a=t.toJSON();i.Site.load(a.siteId,function(t){if(!t)return n(),void 0;a.site=t.toJSON();var o=function(e){return e.accountId==a.id&&0==e.deleted&&1==e.latest&&e.dataType in{"/contact/email":1,"/contact/phone":1,"/password":1,"/nameperson/friendly":1}?!0:!1};i.AccountField.listCached(o,function(t){a.accountFields=e.map(t,function(e){return e.toJSON()}),r.push(a),n()})})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[filterByTypeWithSiteAndFields]# error event in Account.listCached async.forEach"),n?n.call(this,r):t.returnJSON&&t.returnJSON(r)})})},indexWithSite:function(t,n){var r=[];i.Account.index(null,function(a){e.async.forEach(a,function(e,t){var n=e.toJSON();i.Site.load(n.siteId,function(e){n.site=e.toJSON(),r.push(n),t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[indexWithSite]# error event in Account.index async.forEach"),n?n.call(this,r):t.returnJSON&&t.returnJSON(r)})})},showWithFields:function(t,n){var r;i.Account.load(t.params[0],function(a){r=a.toJSON(),r.siteId=r.siteId||"0",i.Site.load(r.siteId,function(a){r.site=a?a.toJSON():null,i.AccountField.getLatestForAccountId(r.id,function(a){r.accountFields=e(a).map(function(e){return e.toJSON()}),n?n.call(i.Account,r):t.returnJSON&&t.returnJSON(r)})})})},deepDestroy:function(e,t){i.Account.load(e.params[0],function(n){n.cleanRemove(function(n){t?t.call(n):n?e.returnError("error"):e.returnStatus("ok")})})},destroyExceptEmail:function(e,t){i.Account.load(e.params[0],function(n){n.cleanRemoveAccountsAndHistory(function(n){t?t.call(n):n?e.returnError("error"):e.returnStatus("ok")})})},showWithFieldsAndDisposables:function(e,t){var n;i.Account.load(e.params[0],function(r){n=r.toJSON(),n.siteId=n.siteId||"0",i.Site.load(n.siteId,function(i){n.site=i?i.toJSON():null,a(n,function(){o(n,function(){s(n,function(){c.respondWithJSON(n,e,t)})})})})})},isPasswordReused:function(t){var n,r;i.AccountField.load(t.params[0],function(a){function o(e){return 1==e.latest&&e.accountId!=n.accountId&&1!=e.deleted&&"/password"==e.dataType}n=a.toJSON(),r=[],i.AccountField.listCached(o,function(i){var a=e(i).uniq(!1,function(e){return e.toJSON().accountId});r=e(a).filter(function(e){return e.toJSON().value===n.value}),t.returnJSON({timesReused:r.length})})})}}),i.Account=c,c}),ABINEMASKME.define("abine/storage/accountActivity",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate"],function(e,t,n,i){var r=t.define("AccountActivity",{accountId:"TEXT",accountFieldId:"TEXT",activityType:"TEXT",extraActivityTypes:"TEXT",protectionLevel:"INT",createdAt:"DATE",modifiedAt:"DATE",deleted:"INT",url:"TEXT",pushVersion:"INTEGER"});return r.secure(t.security.TABLE_SALT,["activityType","url","extraActivityTypes"]),r.autoDate(),e.extend(r,n.DefaultActions,{routes:{"read/accountActivity/all":"indexWithAccount","read/accountActivity/:id":"show","create/accountActivity":"create","update/accountActivity/:id":"update","delete/accountActivity/:id":"destroyHidden"},destroyHidden:function(e,n){r.load(e.params[0],function(r){r.deleted=1,i.Account.load(r.accountId,function(i){i.modifiedAt=new Date,t.flush(function(){n?n():e.returnStatus&&e.returnStatus(0)})})})},indexWithAccount:function(t,n){var a=[];i.Site.initCache(function(){i.Account.initCache(function(){i.AccountField.initCache(function(){r.all().filter("deleted","=",0).limit(200).list(function(o){e.async.forEach(o,function(e,t){var n=e.toJSON();"login"==n.activityType?t():i.Account.load(n.accountId,function(e){n.account=e.toJSON(),n.accountFieldId?i.AccountField.load(n.accountFieldId,function(r){r&&(n.accountField=r.toJSON()),i.Site.load(e.siteId,function(e){n.account.site=e?e.toJSON():{},a.push(n),t()})}):i.Site.load(e.siteId,function(e){n.account.site=e?e.toJSON():{},a.push(n),t()})})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/accountActivity]#[indexWithAccount]# error event in AccountActivity.all.filter async.forEach"),r.respondWithJSON(a,t,n)})})})})})}}),i.AccountActivity=r,r}),ABINEMASKME.define("abine/storage/accountField",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/security","persistence/autodate","persistence/caching"],function(e,t,n,i){var r=t.define("AccountField",{accountId:"TEXT",createdAt:"DATE",dataType:"TEXT",latest:"INTEGER",name:"TEXT",modifiedAt:"DATE",origin:"TEXT",value:"TEXT",version:"INTEGER",deleted:"INT",pushVersion:"INTEGER"});r.secure(t.security.CUSTOM_SALT,["name","origin","value"],"accountId"),r.autoDate(),r.enableCaching(),e.extend(r.prototype,{passwordReuseCount:function(t){r.getPasswordReuseMap(e.bind(function(e){this.value in e?t(e[this.value].sites.length):t(0)},this))},cleanRemove:function(n){function a(e){return e.accountId===o}var o=this.accountId,s="/password"===this.dataType&&1===this.latest;r.listCached(a,e.bind(function(r){1===r.length?i.Account.load(o,e.bind(function(i){i.cleanRemove(e.bind(function(i){i?n&&n(i):(t.remove(this),t.flush(e.bind(function(e,t){t&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[filterByTypeWithSiteAndFields]# error event in Account.listCached async.forEach"),n&&n()},this)))},this))},this)):(t.remove(this),t.flush(e.bind(function(e,r){r&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account]#[filterByTypeWithSiteAndFields]# error event in Account.listCached async.forEach"),s?i.Account.load(o,function(e){e.type="passwordless",t.flush(function(){n&&n()})}):n&&n()},this)))},this))}});var a=!1;return e.extend(r,n.DefaultActions,{routes:{"create/accountField":"createVersioned","update/accountField/:id":"updateVersioned","delete/accountField/:id":"deepDestroy","read/accountField/passwords":"indexPasswordFields","delete/accountField/account/:id":"destroyWithAccount","delete/accountField/version/:id":"destroyVersioned"},deepDestroy:function(e,t){r.load(e.params[0],function(n){n.cleanRemove(function(n){t?t.call(n):n?e.returnError("error"):e.returnStatus("ok")})})},destroyWithAccount:function(e){i.Account.load(e.params[0],function(t){t&&t.cleanRemove(function(t){t?e.returnError(t):e.returnStatus("ok")})})},getPasswordReuseMap:function(t){function n(e){return 0==e.deleted}function a(e){return 1==e.latest&&"/password"==e.dataType}var o={};r.listCached(a,function(r){var a={};e.each(r,function(e){e.accountId in a||(a[e.accountId]=[]),a[e.accountId].push(e)}),i.Account.listCached(n,function(n){e.async.forEach(n,function(t,n){if(!(t.id in a))return n(),void 0;var r=e.filter(a[t.id],function(e){return"strong"==e.origin||"fill"!=t.type});if(0==r.length)return n(),void 0;var s=r[0].toJSON();o[s.value]||(o[s.value]={sites:[],fields:[]}),o[s.value].fields.push(s),i.Site.load(t.siteId,function(e){e&&(s.site=e.toJSON(),o[s.value].sites.push(e.domain)),n()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/account_field]#[getPasswordReuseMap]# errorwhile calculating password reuse"),t(o)})})})},indexPasswordFields:function(t,n){var i=[];this.getPasswordReuseMap(function(a){for(var o in a)i=i.concat(a[o].fields);e(i).each(function(e){e.reuse=a[e.value].sites}),r.respondWithJSON(i,t,n)})},smartCorrectDataType:function(e){("/contact/email"==e.payload.dataType||"/nameperson/friendly"==e.payload.dataType)&&(e.payload.dataType=e.payload.value.match(/.+\@.+\..+/i)?"/contact/email":"/nameperson/friendly")},updateAccountAndSiteModifiedDate:function(e,n){i.Account.load(e,function(e){e?(e.touch(),i.Site.load(e.siteId,function(e){e&&e.touch(),t.flush(function(){n&&n()})})):t.flush(function(){n&&n()})})},updateVersioned:function(e,n){r.load(e.params[0],function(i){if(i.value==e.payload.value)n?n.call(this,i,!0):e.returnEntities&&e.returnEntities(i);
else{i.latest=0,e.payload.version=i.version+1,delete e.payload.id,e.payload.createdAt=new Date,e.payload.modifiedAt=new Date;var a=new r(e.payload);t.add(a),r.updateAccountAndSiteModifiedDate(i.accountId,function(){n?n.call(this,a,!0):e.returnEntities&&e.returnEntities(a)})}})},createVersioned:function(n,i){var a,o=1;r.smartCorrectDataType(n),r.getLatestForAccountId(n.payload.accountId,function(s){var c=null;if(e.each(s,function(e){c||e.dataType!=n.payload.dataType||(c=e)}),c){if(c.value===n.payload.value)return n.payload.modifiedAt=new Date,n.payload.version=c.version+1,n.params=[c.id],""==n.payload.origin&&delete n.payload.origin,r.update(n,function(){i?i(c):n.returnEntities&&n.returnEntities(c)}),void 0;o=c.version+1,c.latest=0}n.payload.version=o,n.payload.latest=1,n.payload.createdAt=n.payload.createdAt||new Date,n.payload.modifiedAt=n.payload.modifiedAt||new Date,a=new r(n.payload),t.add(a),r.updateAccountAndSiteModifiedDate(n.payload.accountId,function(){i?i.call(this,a,!0):n.returnEntities&&n.returnEntities(a)})})},rollbackVersioned:function(n,a){var o=null,s=function(){null==o&&"/password"==n.payload.dataType?i.Account.load(n.payload.accountId,function(e){e.type="passwordless",t.flush(function(){a?a.call(this,o):n.returnEntities&&n.returnEntities(o)})}):a?a.call(this,o):n.returnEntities&&n.returnEntities(o)};r.getLatestForAccountId(n.payload.accountId,function(i){function a(e){return e.accountId==n.payload.accountId&&e.version==c.version-1}var c=null;if(e.each(i,function(e){c||e.dataType!=n.payload.dataType||(c=e)}),c){if(1>=c.version)return c.latest=0,t.flush(s),void 0;r.listCached(a,function(i){var r=null;e.each(i,function(e){r||e.dataType!=n.payload.dataType||(r=e)}),r?(r.latest=1,r.version=c.version,c.version--,c.latest=0,o=r):(c.version=c.version-1,o=c),t.flush(s)})}else s()})},destroyVersioned:function(e,n){var i=e.params[0];this.load(i,function(i){i.latest=0,i.modifiedAt=new Date,t.flush(function(){n?n.call(this,i):e.returnStatus&&e.returnStatus("ok")})})},getLatestForAccountId:function(e,t){function n(t){return t.accountId==e&&1==t.latest}i.AccountField.listCached(n,function(e){t(e)})},migrateToAccountIdSalt:function(n,o){return a&&!o?(n&&n(!1),void 0):(i.Preference.findOrCreate({key:"usingAccountIdSalt",value:"false"},function(s){return a=!0,s.isTrue()&&!o?(n&&n(!1),void 0):(t.clean(),i.Preference.createOrModify({key:"usingAccountIdSalt",value:"true"},function(){r.meta.saltColumn="id",r.index(null,function(i){r.meta.saltColumn="accountId",e.each(i,function(t){e.each(r.meta.secureFields,function(e){t.markDirty(e)})}),t.flush(function(){n&&n(!0)})})}),void 0)}),void 0)}}),i.AccountField=r,r}),ABINEMASKME.define("abine/storage/cardTransaction",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/paymentsServer","abine/config","abine/responseCodes"],function(e,t,n,i,r,a,o){var s=function(){};return e.extend(s,n.DefaultActions,{routes:{"read/cardTransaction/card/:id":"getTransactionsForCard"},getTransactionsForCard:function(t,n){this.paymentsServer=this.paymentsServer||new r;var a=t.params[0];i.DisposableCard.listCached("guid",a,e.bind(function(i){i?-1==i[0].number.indexOf("*")?this.paymentsServer.getSmartTransactions({card_id:a,card_number:i[0].number},function(i,r){i?t.returnErrObj(i):(r.smart_transactions?e.each(r.smart_transactions,function(e){e.date=e.date.replace("+00:00","-04:00")}):t.returnErrObj({errorCode:o.UNKNOWN_ERROR}),s.respondWithJSON(r.smart_transactions,t,n))}):s.respondWithJSON([],t,n):t.returnErrObj({errorCode:o.UNKNOWN_ERROR})},this))},getAuthorizationsForCard:function(t,n){this.paymentsServer=this.paymentsServer||new r;var i=t.params[0];this.paymentsServer.getAuthorizations({card_id:i},function(i,r){i?t.returnErrObj(i):(r.authorizations&&e.each(r.authorizations.authorization,function(e){e.authorization_date_time=e.authorization_date_time.replace("+00:00","-04:00"),e.balance=r.available_balance}),s.respondWithJSON(r.authorizations?r.authorizations.authorization:null,t,n))})}}),i.CardTransaction=s,s}),ABINEMASKME.define("abine/storage/disposableCard",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/paymentsServer","abine/config","abine/crypto","persistence/autodate","persistence/caching"],function(e,t,n,i,r){var a=t.define("DisposableCards",{shielded_card_id:"INTEGER",active:"INTEGER",guid:"INTEGER",gift:"INTEGER",recipient_email:"TEXT",number:"TEXT",domain:"TEXT",expiry_month:"TEXT",expiry_year:"TEXT",cvc:"TEXT",original_amount:"TEXT",amount_refunded:"TEXT",type:"TEXT",serverCreatedAt:"TEXT",activeToDate:"TEXT",createdAt:"DATE",modifiedAt:"DATE",request_id:"TEXT",deactivate_request_id:"TEXT",pushVersion:"INTEGER"});return a.secure(t.security.TABLE_SALT,["number","type","expiry_month","domain","expiry_year","cvc","activeToDate"]),a.autoDate(),a.enableCaching(),e.extend(a,n.DefaultActions,{routes:{"read/disposableCard/all":"indexWithActive","read/disposableCard/allLocal":"indexLocal","read/disposableCard/server":"indexFromServer","read/disposableCard/:id":"show","read/disposableCard/domain/:id":"getCardsForDomain","delete/disposableCard/:id":"destroy","create/disposableCard":"createOnServer","update/disposableCard/deactivate/:id":"deactivateCard","update/disposableCard/:id":"update"},indexLocal:function(t,n,i){a.index(null,e.bind(function(r){var o=e.map(r,function(e){var t=e.toJSON();return t.err=i,t});a.respondWithJSON(o,t,n)},this))},indexWithActive:function(n,i){this.paymentsServer=this.paymentsServer||new r,a.index(null,e.bind(function(r){var o=[],s={};e.each(r,function(e){o.push(e.guid),s[e.guid]=e}),this.paymentsServer.getCardStatesForGuids({guids:o.join(",")},function(o,c){o||c.card_states&&e.each(c.card_states,function(e){e.guid&&s[e.guid]&&(s[e.guid].active=e.active?1:0,s[e.amount_refunded]=e.amount_refunded)}),t.flush(function(){var t=e.map(r,function(e){var t=e.toJSON();return t.err=o,t});a.respondWithJSON(t,n,i)})})},this))},indexFromServer:function(n,a){this.paymentsServer=this.paymentsServer||new r,this.paymentsServer.getCardsForClient({},e.bind(function(r,o){r?n.returnErrObj(r):i.DisposableCard.index(null,e.bind(function(r){var s={},c=[];e.each(r,function(e){e.number&&e.number.length>0?s[e.guid]=e:t.remove(e)}),e.each(o.cards,function(e){s[e.card_guid]?(s[e.card_guid].active=e.active?1:0,s[e.card_guid].amount_refunded=e.amount_refunded):c.push(e.card_guid)}),this.paymentsServer.getCardsForGuids({guids:c.join(",")},function(r,o){r?n.returnErrObj(r):e.async.forEach(o.cards,function(e,n){var r=new i.DisposableCard({original_amount:e.requested_amount,gift:e.gift?1:0,recipient_email:e.recipient_email,request_id:e.request_id,domain:e.domain,guid:e.card_guid,amount:e.requested_amount,number:e.card_number,amount_refunded:e.amount_refunded,expiry_year:e.expiry_year,expiry_month:e.expiry_month,cvc:e.cvc,active:e.active?1:0,type:e.type,serverCreatedAt:e.created_at,activeToDate:e.active_to_date});t.add(r),n()},function(){t.flush(function(){i.DisposableCard.index(n,a)})})})},this))},this))},getCardsForDomain:function(e,t){var n=e.params[0];i.DisposableCard.listCached(function(e){return e.domain==n&&e.number&&e.number.length>0},function(n){t?t.call(this,n):e.returnEntities&&e.returnEntities(n)})},updateOnDatabase:function(){},createFromDatabase:function(e,t){t?t(e.payload):a.create(e)},deactivateCard:function(n,o){this.paymentsServer=this.paymentsServer||new r,i.DisposableCard.load(n.params[0],e.bind(function(e){return e&&0!=e.active?(e.deactivate_request_id=a.generateRequestId(),n.payload.deactivate_request_id=e.deactivate_request_id,t.flush(),this.paymentsServer.deactivateCard({request_id:e.deactivate_request_id,card_id:n.payload.guid},function(e,t){e?n.returnError("Failed to deactivate card",e.errorCode):(n.payload.amount_refunded=t.amount_refunded,n.payload.active=0,a.update(n,o))}),void 0):(n.returnError?n.returnError("Failed to deactivate card",422):o&&o(),void 0)},this))},generateRequestId:function(){return t.createUUID()},createOnServer:function(e,n){this.paymentsServer=this.paymentsServer||new r;var o=new i.DisposableCard({request_id:a.generateRequestId(),domain:e.payload.domain,gift:e.payload.gift?1:0,original_amount:e.payload.amount,createdAt:new Date,modifiedAt:new Date}),s={amount:o.original_amount,request_id:o.request_id,domain:o.domain};e.payload.months&&(s.months=e.payload.months),e.payload.gift&&(s.gift={sender_name:e.payload.senderName,receiver_name:e.payload.firstName+" "+e.payload.lastName,recipient_email:e.payload.recipient_email},o.recipient_email=e.payload.recipient_email),t.add(o),t.flush(),this.paymentsServer.createCard(s,function(i,r){i?(t.remove(o),t.flush(function(){e.returnErrObj(i)})):(o.guid=r.card_id,o.number=r.card.card_number,o.expiry_year=r.card.expiry_year,o.expiry_month=r.card.expiry_month,o.cvc=r.card.cvc,o.original_amount=r.card.original_amount,o.active=1,o.type=r.card.type,o.serverCreatedAt=r.card.created_at,o.activeToDate=r.card.active_to_date,t.flush(null,function(){n?n.call(this,o):e.returnEntities&&e.returnEntities(o)}))})}}),i.DisposableCard=a,a}),ABINEMASKME.define("abine/storage/disposableEmail",["documentcloud/underscore","persistence","abine/storageMixins","abine/emailServer","storage","abine/saveForms","abine/config"],function(e,t,n,i,r,a,o){var s=t.define("DisposableEmails",{accountId:"TEXT",guid:"TEXT",targetId:"INT",targetGuid:"TEXT",user:"TEXT",domain:"TEXT",active:"INTEGER",createdAt:"DATE",mails:"INTEGER",label:"TEXT",modifiedAt:"DATE",pushVersion:"INTEGER"});return s.secure(t.security.TABLE_SALT,["user","domain","label"]),s.autoDate(),s.enableCaching("user"),e.extend(s.prototype,{getAddress:function(){return this.user+"@"+this.domain},destroyOnServer:function(e){s.destroyOnServer({params:[this.id],returnError:e},function(){e({statusCode:"0"})})}}),e.extend(s,n.DefaultActions,{routes:{"read/disposableEmail/all":"indexFromServer","read/disposableEmail/allLocal":"indexLocal","read/disposableEmail/:id":"showWithSite","read/disposableEmail/site/:id":"getEmailsForSite","read/disposableEmail/domain/:id":"getEmailsForDomain","create/disposableEmail":"createOnServer","update/disposableEmail/:id":"updateOnServer","delete/disposableEmail/:id":"destroyOnServer"},getEmailsForSite:function(t,n){var i=t.params[0];r.Account.listCached("siteId",i,function(i){function a(e){return e.accountId in o}var o={};e.each(i,function(e){o[e.id]=!0}),r.DisposableEmail.listCached(a,function(e){n?n.call(this,e):t.returnEntities&&t.returnEntities(e)})})},getEmailsForDomain:function(t,n){var i=t.params[0];r.Site.listCached("domain",i,function(i){0===i.length&&t.returnEntities([]),e.each(i,function(i){r.Account.listCached("siteId",i.id,function(i){function a(e){return e.accountId in o}var o={};e.each(i,function(e){o[e.id]=!0}),r.DisposableEmail.listCached(a,function(e){n?n.call(this,e):t.returnEntities&&t.returnEntities(e)})})})})},indexWithSite:function(t,n,i){var a=[];s.index(null,function(o){e.async.forEach(o,function(t,n){var o=t.toJSON();o.site={domain:"Unknown",name:"Unknown"},o.err=i,a.push(o),o.accountId&&""!=o.accountId?r.Account.load(o.accountId,function(t){t?(o.account=t.toJSON(),o.account.accountFields=[],r.AccountField.getLatestForAccountId(o.account.id,function(t){o.account.accountFields=e(t).map(function(e){return e.toJSON()}),r.Site.load(o.account.siteId,function(e){e&&(o.site=e.toJSON()),n()})})):n()}):n()},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/disposableEmail]#[indexWithSite]# error event in disposableEmail.index async.forEach"),s.respondWithJSON(a,t,n)})})},showWithSite:function(e,t){var n;r.DisposableEmail.load(e.params[0],function(i){n=i.toJSON(),n.site={domain:"Unknown",name:"Unknown"},n.accountId?r.Account.load(n.accountId,function(i){i?r.Site.load(i.siteId).one(function(i){i&&(n.site=i.toJSON()),s.respondWithJSON(n,e,t)}):s.respondWithJSON(n,e,t)}):s.respondWithJSON(n,e,t)})},indexLocal:function(t,n){r.ShieldedEmail.index(null,e.bind(function(i){i.length>0?(i[0],r.DisposableEmail.index(null,function(i){var r=e.map(i,function(e){return e.toJSON()});s.respondWithJSON(r,t,n)})):s.respondWithJSON([],t,n)},this))},indexFromServer:function(n,a){this.emailServer=this.emailServer||new i,r.ShieldedEmail.index(null,e.bind(function(i){if(i.length>0){var o=i[0];this.emailServer.readDisposables({guid:o.guid},function(i,o){i?(true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/disposableEmail]#[indexFromServer]# error event in server.makeRequest"),s.indexWithSite(n,a,i)):r.DisposableEmail.index(null,function(i){var r={};e.each(i,function(e){r[e.guid]=e});var c={};e.each(o.webmails,function(e){c[e.disposable]||(c[e.disposable]=[]),c[e.disposable].push(e)}),e.each(o.disposable_emails,function(e){r[e.guid]&&(r[e.guid].mails=e.num_mails,r[e.guid].active=e.active)}),t.flush(function(){var t=e.map(i,function(e){var t=e.toJSON();return c[t.user+"@"+t.domain]&&(t.webmails=c[t.user+"@"+t.domain]),t});s.respondWithJSON(t,n,a)})})})}else s.respondWithJSON([],n,a)},this))},createOnServer:function(t,n){this.emailServer=this.emailServer||new i;var c=a.fillAccountTabIdMap[t.sender],u=null;c&&(u=c.accountId),r.DisposableEmail.findBy("accountId",u,e.bind(function(i){if(i)n?n(i):t.returnEntities(i);else{var a=e.bind(function(){this.emailServer.generateDisposable({guid:t.payload.targetGuid,domain:o.disposableDomain},function(e,i){e?(true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/disposableEmail]#[createOnServer]# error event in server.generateDisposable"),t.returnError(e)):(t.payload.guid=i.guid,t.payload.domain=i.domain,t.payload.user=i.user,t.payload.active=1,t.payload.createdAt=i.created,s.create(t,n))})},this);t.payload.label&&"MaskMe Feedback"==t.payload.label?r.DisposableEmail.findBy("label","MaskMe Feedback",function(e){e?n?n(e):t.returnEntities(e):a()}):a()}},this))},updateOnServer:function(t,n){var r=t.params[0];this.emailServer=this.emailServer||new i,s.load(r,e.bind(function(e){e.active!=t.payload.active?1===t.payload.active?this.emailServer.enableDisposable({guid:e.guid},function(e){e?(true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/disposableEmail]#[updateOnServer]# error event in emailServer.enableDisposable"),t.returnError(e)):s.update(t,n)}):0===t.payload.active&&this.emailServer.disableDisposable({guid:e.guid},function(e){e?(true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/disposableEmail]#[updateOnServer]# error event in emailServer.disableDisposable"),t.returnError(e)):s.update(t,n)}):s.update(t,n)},this))},destroyOnServer:function(t,n){var a=t.params[0];s.load(a,e.bind(function(a){this.emailServer=this.emailServer||new i,this.emailServer.disableAndDeleteDisposable({guid:a.guid},function(i,o){function c(e){return e.accountId==a.accountId&&e.value==u}if(i)true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/disposableEmail]#[destroyOnServer]# error event in emailServer.disableAndDeleteDisposable"),t.returnError(o);else{var u=a.user+"@"+a.domain;r.AccountField.listCached(c,function(i){e.async.forEach(i,function(e,t){var n={params:[e.id]};r.AccountField.destroy(n,t)},function(){s.destroy(t,n)})})}})},this))}}),r.DisposableEmail=s,s}),ABINEMASKME.define("abine/storage/disposablePhone",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate","persistence/caching"],function(e,t,n,i){var r=t.define("DisposablePhones",{accountId:"TEXT",shielded_phone_id:"INTEGER",rails_id:"INTEGER",country_code:"TEXT",number:"TEXT",createdAt:"DATE",modifiedAt:"DATE",pushVersion:"INTEGER",isSuspended:"TEXT",nextBillingDate:"DATE"});return r.secure(t.security.TABLE_SALT,["country_code","number"]),r.autoDate(),r.enableCaching(),e.extend(r.prototype,{getPrettyNumber:function(){var e="("+this.getAreaCode()+") "+this.getExchange()+"-"+this.getLocal();return e},getAreaCode:function(){return this.number.substr(0,3)},getExchange:function(){return this.number.substr(3,3)},getLocal:function(){return this.number.substr(6,4)}}),e.extend(r,n.DefaultActions,{routes:{"read/disposablePhone/all":"index","read/disposablePhone/:id":"show","read/disposablePhone/site/:id":"getPhonesForSite","delete/disposablePhone/:id":"destroy","create/disposablePhone":"createFromDatabase","update/disposablePhone/:id":"updateOnDatabase"},getPhonesForSite:function(t,n){var r=t.params[0];i.Account.listCached("siteId",r,function(r){function a(e){return e.accountId in o}var o={};e.each(r,function(e){o[e.id]=!0}),i.DisposablePhone.listCached(a,function(e){n?n.call(this,e):t.returnEntities&&t.returnEntities(e)})})},updateOnDatabase:function(){},createFromDatabase:function(e,t){i.DisposablePhone.all().one(function(n){n&&(e.payload.number=n.number,e.payload.country_code=n.country_code,r.create(e,t))})}}),i.DisposablePhone=r,r}),ABINEMASKME.define("abine/storage/export",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/config","abine/responseCodes"],function(e,t,n,i){var r=function(){};return e.extend(r,n.DefaultActions,{routes:{"read/export/:id":"index"},index:function(e,t){function n(){r.respondWithJSON({data:JSON.stringify(a),webappHost:ABINEMASKME.config.webappHost,num_emails:a.emails.length,num_cards:a.cards.length,num_accounts:a.accounts.length,setupDone:a.setupDone,setupEmailPassword:a.setupEmailPassword,setupPassword:a.setupPassword,setupEmail:a.setupEmail},e,t)}var a={MaskMeExport:!0,accounts:[],emails:[],cards:[],date:(new Date).toISOString()},o=this;i.Preference.findBy("key","regEmail",function(e){i.Preference.findBy("key","regPassword",function(t){a.setupEmail=!!e,a.setupPassword=!!t,a.setupEmailPassword=a.setupEmail&&a.setupPassword,a.setupDone=!a.setupEmail&&!a.setupPassword,a.setupDone?o.loadAccounts(a,function(){o.loadEmails(a,function(){o.loadCards(a,n)})}):n()})})},loadEmails:function(t,n){i.ShieldedEmail.index(null,function(r){r.length>0&&(t.email=r[0].email,t.guid=r[0].guid),i.DisposableEmail.index(null,function(i){e.each(i,function(e){t.emails.push({email:e.user+"@"+e.domain,guid:e.guid,label:e.label})}),n()})})},loadCards:function(t,n){i.DisposableCard.index(null,function(i){e.each(i,function(e){t.cards.push({guid:e.guid,domain:e.domain,number:e.number})}),n()})},loadAccounts:function(t,n){function r(e){return"login"==e.type||"register"==e.type}i.Account.listCached(r,function(r){return 0==r.length?(n(),void 0):(e.async.forEachSeries(r,function(n,r){i.Site.load(n.siteId,function(a){function o(e){return e.accountId==n.id&&1==e.latest&&e.dataType in{"/contact/email":1,"/nameperson/friendly":1,"/password":1}}function s(e){return e?("object"!=typeof e&&(e=new Date(parseInt(e))),e.toISOString()):null}return a?(i.AccountField.listCached(o,function(i){var o=s(n.createdAt),c=s(n.modifiedAt),u={id:n.id,domain:a.domain,page_host:n.page_domain,form_host:n.form_domain,protocol:n.protocol&&n.protocol.match(/^http[s]?/)?n.protocol:null,createdAt:o,modifiedAt:c,pushed:0};e.each(i,function(e){"/contact/email"==e.dataType?u.email=u.email||e.value:"/nameperson/friendly"==e.dataType?u.username=u.username||e.value:"/password"==e.dataType&&(u.password=u.password||e.value)}),(u.username||u.email||u.password)&&t.accounts.push(u),r()}),void 0):(r(),void 0)})},n),void 0)})}}),i.Export=r,r}),ABINEMASKME.define("abine/fixtures",["documentcloud/underscore","persistence","storage","abine/saveForms","abine/formSubmitDetector"],function(e,t,n,i,r){return{createFixtures:function(e){this.createRidiculousDatabase(100,3),e()},getRandomInteger:function(e){return Math.floor(Math.random()*e)},getRandomString:function(e,t){t=t||"abcdefghijklmnopqrstuvwxyz1234567890";for(var n="",i=0;12>i;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},generateFieldsForAccount:function(e,t,n){var i={value:this.getRandomString(10)+"@"+(t?"opayq.com":"gmail.com"),dataType:"/contact/email",origin:t?"disposable":"",name:"email"},r={value:i.value,dataType:"/contact/email",origin:t?"disposable":"",name:"confirm_email"},a={value:this.getRandomString(10,"0123456789"),dataType:"/contact/phone",origin:e?"disposable":"",name:"phone"},o={value:n?this.getRandomString(12):["password","tedted","iloveabine","maskme","a"][this.getRandomInteger(5)],dataType:"/password",origin:n?"strong":"",name:"password"},s={value:o.value,dataType:"/password",origin:n?"strong":"",name:"confirm_password"};return[i,r,a,o,s]},asyncCreateAccounts:function(e){if(e.length>0){var t=e.shift();r.formSubmitDetector.trigger("background:fixtureSubmit",t)}},createRidiculousDatabase:function(t,n){for(var r=[],a=0;t>a;a++)for(var o="http://"+this.getRandomString(10)+[".com",".net",".org"][Math.floor(3*Math.random())],s=0;n>s;s++)r.push({data:{data:this.generateFieldsForAccount(0==this.getRandomInteger(3),0==this.getRandomInteger(3),0==this.getRandomInteger(3)),pageUrl:o,type:"registrationForm",url:o},fixture:!0,tabId:null});i.on("background:saveForm:finished",e.bind(function(){this.asyncCreateAccounts(r)},this)),this.asyncCreateAccounts(r)}}}),ABINEMASKME.define("abine/storage/formData",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate"],function(e,t,n,i){var r=t.define("FormData",{formId:"INTEGER",dataType:"TEXT",createdAt:"DATE",value:"TEXT",latest:"INTEGER",origin:"TEXT",domain:"TEXT",form_signature:"TEXT",formType:"TEXT",field_signature:"TEXT"});return e.extend(r,n.DefaultActions,{routes:{"read/formData/all":"index","read/formData/:id":"show","create/formData":"create","update/formData/:id":"update","delete/formData/:id":"destroy"}}),i.FormData=r,r}),ABINEMASKME.define("abine/storage/mappedField",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate"],function(e,t,n,i){var r=t.define("MappedField",{formId:"TEXT",signature:"TEXT",dataType:"TEXT"});return e.extend(r,n.DefaultActions,{routes:{"read/mappedField/all":"index","read/mappedField/:id":"show","create/mappedField":"create","update/mappedField/:id":"update","delete/mappedField/:id":"destroy"}}),i.MappedField=r,r}),ABINEMASKME.define("abine/storage/mappedForm",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/lruCache","persistence/autodate"],function(e,t,n,i,r){var a=t.define("MappedForm",{domain:"TEXT",signature:"TEXT",mapping_signature:"TEXT",formType:"TEXT"}),o=10,s=new r(o);return e.extend(a,n.DefaultActions,{routes:{"read/mappedForm/all":"index","read/mappedForm/:id":"show","read/mappedForm/site/:id":"mappingsForSite","create/mappedForm":"create","update/mappedForm/:id":"update","delete/mappedForm/:id":"destroy"},mappingsForSite:function(t,n){var r=t.params[0],a=[];if("null"==r)return t.returnJSON?t.returnJSON([]):n&&n(),void 0;var o=s.fetch(r);o?t.returnJSON(o):i.MappedForm.query("domain = '"+r+"'",function(n){e.async.forEach(n,function(e,t){i.MappedField.query("formId = '"+e.id+"'",function(n){e.fields=n,a.push(e),t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/mappedForm]#[mappingsForSite]# error event in MappedForm.query async.forEach"),s.add(r,a),t.returnJSON(a)})})},clearCache:function(){delete s,s=new r(o)}}),i.MappedForm=a,a}),ABINEMASKME.define("abine/storage/panelActivity",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate"],function(e,t,n,i){var r=t.define("PanelActivity",{panelId:"INTEGER",impressions:"INTEGER",clicks:"INTEGER",users:"INTEGER",completions:"INTEGER",masks:"INTEGER",discloses:"INTEGER",closes:"INTEGER"});return e.extend(r.prototype,{reset:function(){this.impressions=0,this.clicks=0,this.completions=0,this.users=0,this.masks=0,this.discloses=0,this.closes=0,t.flush()},hasData:function(){return this.impressions+this.clicks+this.completions+this.masks+this.discloses+this.closes>0},isMarketingPanel:function(){return 1e6>this.panelId}}),e.extend(r,n.DefaultActions,{routes:{"read/panelActivity/all":"index","read/panelActivity/:id":"showByPanelId","create/panelActivity":"create","update/panelActivity/click":"addClick","update/panelActivity/conversion":"addConversion","update/panelActivity/impression":"addImpression","update/panelActivity/masked":"addMasked","update/panelActivity/disclosed":"addDisclosed","update/panelActivity/closed":"addClosed","update/panelActivity/:id":"update","delete/panelActivity/:id":"destroy"},createPanelActivity:function(e){var n=new i.PanelActivity({panelId:e,impressions:0,users:0,clicks:0,masks:0,discloses:0,closes:0,completions:0});return t.add(n),n},addImpression:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.impressions++,t.flush()},this))},addClick:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.clicks++,t.flush()},this))},addMasked:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.masks++,t.flush()},this))},addDisclosed:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.discloses++,t.flush()},this))},addClosed:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.closes++,t.flush()},this))},addConversion:function(n){i.PanelActivity.findBy("panelId",n.payload.panelId,e.bind(function(e){e=e||this.createPanelActivity(n.payload.panelId),e.completions++,t.flush()},this))},showByPanelId:function(e,t){i.PanelActivity.findBy("panelId",e.params[0],function(n){t?t.call(this,n):e.returnEntities&&e.returnEntities(n)})}}),i.PanelActivity=r,r}),ABINEMASKME.define("abine/storage/phoneLog",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/ajax","abine/config","abine/phoneServer","abine/responseCodes"],function(e,t,n,i,r,a,o,s){var c=function(){};return e.extend(c,n.DefaultActions,{routes:{"create/phoneLog":"createOnServer","read/phoneLog/all":"indexFromServer","update/phoneLog/:id":"updateOnServer"},createOnServer:function(){},updateOnServer:function(t,n){this.phoneServer=this.phoneServer||new o,i.ShieldedPhone.index(null,e.bind(function(i){var r=e.find(i,function(e){return"true"==e.is_validated||1==e.is_validated?!0:void 0});r?this.phoneServer.updatePhoneLog({id:r.rails_id,phone_auth_token:r.auth_token,is_allowed:t.payload.is_allowed,label:t.payload.label,caller:t.payload.caller},e.bind(function(i,a){i?t.returnErrObj(i):this.updateSuspendedState(r,a,t,e.bind(function(){c.respondWithJSON(t.payload,t,n)},this))},this)):(true&&ABINEMASKME.log.error("[ERROR LOGIC]#[abine/storage/phoneLog]#[updateOnServer]# error event in updateOnServer - no validated phone"),t.returnErrObj({errorCode:s.PHONE_NOT_FOUND}))},this))},indexFromServer:function(t,n){this.phoneServer=this.phoneServer||new o,i.ShieldedPhone.index(null,e.bind(function(i){var r=e.find(i,function(e){return"true"==e.is_validated||1==e.is_validated?!0:void 0});r?this.phoneServer.getPhoneLog({id:r.rails_id,phone_auth_token:r.auth_token},e.bind(function(e,i){e?t.returnErrObj(e):this.updateSuspendedState(r,i,t,function(){c.respondWithJSON(i.callers,t,n)})},this)):t.returnErrObj({errorCode:s.PHONE_NOT_FOUND})},this))},updateSuspendedState:function(e,n,r,a){i.DisposablePhone.findBy("shielded_phone_id",e.id,function(e){e.isSuspended=n.suspended?"true":"false",e.nextBillingDate=n.nextBillingDate?new Date(n.nextBillingDate):null,t.flush(a)})}}),i.PhoneLog=c,c}),ABINEMASKME.define("abine/storage/preference",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/config","persistence/autodate","persistence/caching"],function(e,t,n,i){var r=t.define("Preferences",{key:"TEXT",value:"TEXT",description:"TEXT",deleted:"BOOL",category:"TEXT",createdAt:"DATE",modifiedAt:"DATE",pushVersion:"INTEGER"});r.secure(t.security.ROW_SALT,["value"],null,{field:"key",value:{authToken:1}}),r.autoDate(),r.enableCaching("key");var a=[{key:"rememberAccounts",value:"true",description:"Save my accounts when I register or login to a site.",category:"logins"},{key:"rememberOnlyMaskMe",value:"false",description:"Only remember accounts MaskMe helped to generate.",category:"logins"},{key:"loginAssist",value:"true",description:"Help me login to websites MaskMe has saved accounts for.",category:"hidden"},{key:"suggestProtectedEmail",value:"true",description:"Suggest when I should mask my email address.",category:"forms"},{key:"suggestProtectedPhone",value:"true",description:"Suggest when I should mask my phone number.",category:"forms"},{key:"suggestStrongPassword",value:"false",description:"Suggest when I should create a stronger password.",category:"forms"},{key:"suggestProtectedCard",value:"true",description:"Suggest when I should mask my credit card",category:"hidden"},{key:"confirmProtectedCard",value:"true",description:"Make me confirm before creating a masked card",category:"hidden"},{key:"shareUsage",value:"false",description:"Anonymously and securely share my usage data with Abine.",category:"hidden"},{key:"autoOpenEditUser",value:"true",description:"Open the Edit User page automatically.",category:"hidden"},{key:"showNotifications",value:"true",description:"Show MaskMe notifications (at top right of screen) as I browse the web.",category:"notifications"},{key:"countNotifications",value:"0",description:"Count notifications (at 10 notifications, fadeout will become quicker)",category:"hidden"},{key:"helpMeLogin",value:"true",description:"Automatically fill in my login information when I visit websites.",category:"logins"},{key:"hasRegistered",value:"false",description:"",category:"hidden"},{key:"hasRegisteredSync",value:"false",description:"",category:"hidden"},{key:"hasEnabledPayments",value:"false",description:"",category:"hidden"},{key:"autoLockOnRestart",value:"false",description:"Auto-lock MaskMe when I restart my browser.",category:"privacy"},{key:"enableSyncButton",value:"true",description:"Show the sync button in the navigation bar.",category:"hidden"},{key:"requirePasswordToShowPassword",value:"true",description:"Prompt for MaskMe password to view my sensitive account information.",category:"privacy"},{key:"enablePrivacyTimeline",value:"false",description:"Enable privacy timeline",category:"privacy"},{key:"shouldSendErrorReports",value:"true",description:"Send anonymous error reports to MaskMe servers.",category:"privacy"},{key:"entitledToSync",value:"false",description:"",category:"hidden"},{key:"entitledToPhone",value:"false",description:"",category:"hidden"},{key:"entitledToPayments",value:"false",description:"",category:"hidden"}];e.extend(r.prototype,{setTrue:function(){this.value="true"},setFalse:function(){this.value="false"},isTrue:function(){return 1==this.value||"true"===this.value},isFalse:function(){return!this.isTrue()},isEmpty:function(){return!this.value||""==this.value||"null"==(this.value+"").toLowerCase()},isEncrypted:function(){return!this.isEmpty()&&0===this.value.indexOf("ENC:")}}),e.extend(r,n.DefaultActions,{routes:{"read/preference/all":"index","read/preference/name/:key":"showOneByKey","read/preference/prefspage":"showForPrefsPage","read/preference/:id":"show","create/preference":"create","update/preference/restore":"restore","update/preference/:id":"update","delete/preference/:id":"destroy"},showOneByKey:function(e,t){r.findBy("key",e.params[0],function(n){t?t.call(this,n):e&&e.returnEntities&&e.returnEntities(n)})},showForPrefsPage:function(e,t){function n(e){return"hidden"!=e.category}r.listCached(n,function(n){t?t.call(this,n):e&&e.returnEntities&&e.returnEntities(n)})},encryptAuthToken:function(e){e=e||function(){},r.findBy("key","authToken",function(n){n&&n.value&&""!=n.value?(n.markDirty("value"),t.add(n),t.flush(function(){e()})):e()}),e()},getSync:function(e){var t=null;return i.Preference.isCached()&&i.Preference.findBy("key",e,function(e){t=e}),t},findOrCreate:function(e,n){n=n||o,i.Preference.findBy("key",e.key,function(r){if(r)n(r);else{e.createdAt=e.createdAt||new Date,e.modifiedAt=e.modifiedAt||new Date,e.category=e.category||"hidden",e.deleted=e.deleted||0;var a=new i.Preference(e);t.add(a),t.flush(function(){n(a)})}})},createOrModify:function(e,n){n=n||o,i.Preference.findBy("key",e.key,function(r){r?r.value=e.value:(e.createdAt=e.createdAt||new Date,e.modifiedAt=e.modifiedAt||new Date,e.category=e.category||"hidden",e.deleted=e.deleted||0,r=new i.Preference(e),t.add(r)),t.flush(function(){n(r)})})},batchFindBy:function(t,n){n=n||o;var i={};e.async.forEach(t,e.bind(function(e,t){this.findBy(e.by,e.value,function(n){i[e.value]=n,t()})},this),function(){n(i)})},batchCreateOrModify:function(t,n){n=n||o,e.async.forEach(t,e.bind(function(e,t){this.createOrModify(e,function(){t()})},this),function(){n()})},restore:function(n,i){this.index(null,function(r){e.each(a,function(t){var n=e.find(r,function(e){return e.key==t.key
});if(n&&n.category&&"hidden"!=n.category&&""!=n.category&&(n.value="rememberAccounts"==n.key||"suggestStrongPassword"==n.key?!0:t.value,"requirePasswordToShowPassword"==n.key)){var i=e.find(r,function(e){return"regPassword"==e.key});n.value=i?!1:t.value}}),t.flush(function(){i?i.call(this,r):n&&n.returnEntities&&n.returnEntities(r)})})},setDefaults:function(n){this.index(null,function(o){e.each(a,function(n){var i=e.find(o,function(e){return e.key==n.key});i?(i.description=n.description,i.category=n.category):t.add(new r(n))}),t.flush(function(a,s){s&&true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/preference]#[setDefaults]# error event while flushing preference updating, "+s);var c=e.find(o,function(e){return"usingAccountIdSalt"==e.key});c?n():i.AccountField.all().count(function(e){0==e?(t.add(new r({key:"usingAccountIdSalt",value:"true"})),t.flush(function(){n()})):n()})})})}});var o=function(){};return i.Preference=r,r}),ABINEMASKME.define("abine/storage/registry",["abine/timer","abine/storageRouter","storage"],function(e,t,n){return{registerStorageEntities:function(e){e.registerEntity(n.Account,"account"),e.registerEntity(n.AccountActivity,"accountActivity"),e.registerEntity(n.AccountField,"accountField"),e.registerEntity(n.DisposableCard,"disposableCard"),e.registerEntity(n.DisposableEmail,"disposableEmail"),e.registerEntity(n.DisposablePhone,"disposablePhone"),e.registerEntity(n.FormData,"formData"),e.registerEntity(n.MappedForm,"mappedForm"),e.registerEntity(n.MappedField,"mappedField"),e.registerEntity(n.PanelActivity,"panelActivity"),e.registerEntity(n.Preference,"preference"),e.registerEntity(n.ShieldedCard,"shieldedCard"),e.registerEntity(n.ShieldedEmail,"shieldedEmail"),e.registerEntity(n.ShieldedPhone,"shieldedPhone"),e.registerEntity(n.Site,"site"),e.registerEntity(n.PhoneLog,"phoneLog"),e.registerEntity(n.CardTransaction,"cardTransaction"),e.registerEntity(n.Webmail,"webmail"),e.registerEntity(n.Export,"export")},emptyDatabase:function(i,r){t.StorageRouter.initializeWebSQLStorage({dbName:"idme_test",dbDescription:"Storage for the unit tests",dbSizeInBytes:5242880,ready:function(){var t=11;n.Account.all().destroyAll(function(){t--}),n.AccountActivity.all().destroyAll(function(){t--}),n.AccountField.all().destroyAll(function(){t--}),n.DisposableCard.all().destroyAll(function(){t--}),n.DisposableEmail.all().destroyAll(function(){t--}),n.DisposablePhone.all().destroyAll(function(){t--}),n.Preference.all().destroyAll(function(){t--}),n.FormData.all().destroyAll(function(){t--}),n.MappedForm.all().destroyAll(function(){t--}),n.MappedField.all().destroyAll(function(){t--}),n.ShieldedCard.all().destroyAll(function(){t--}),n.ShieldedEmail.all().destroyAll(function(){t--}),n.ShieldedPhone.all().destroyAll(function(){t--}),n.Site.all().destroyAll(function(){t--});var i=function(){t>0?e.setTimeout(i,50):r.call()};e.setTimeout(i,50)}})}}}),ABINEMASKME.define("abine/storage/shieldedCard",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/eventLogger","persistence/autodate","persistence/caching","abine/config","abine/licenseServer"],function(e,t,n,i,r,a,o,s,c){var u=t.define("ShieldedCards",{last_four:"TEXT",first_name:"TEXT",last_name:"TEXT",month:"TEXT",year:"TEXT",card_type:"TEXT",address1:"TEXT",address2:"TEXT",city:"TEXT",state_abbreviation:"TEXT",zip:"TEXT",createdAt:"DATE",modifiedAt:"DATE",pushVersion:"INTEGER"});return u.secure(t.security.TABLE_SALT,["last_four","address1","address2","city","state_abbreviation","zip","card_type","month","year"]),u.autoDate(),u.enableCaching(),e.extend(u.prototype,{}),e.extend(u,n.DefaultActions,{routes:{"read/shieldedCard/all":"index","read/shieldedCard/:id":"show","create/shieldedCard":"createFromServer","update/shieldedCard/:id":"update","delete/shieldedCard/:id":"destroy"},createFromServer:function(e,t){i.Preference.findBy("key","authToken",function(n){!n||n.isEmpty()||n.isEncrypted(),this.licenseServer=this.licenseServer||new c,this.licenseServer.billingInfo({},function(n,i){n?true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/shieldedCard]#[createFromServer]# error event in shieldedCard.createFromServer call to license server"):(e.payload.first_name=i.first_name,e.payload.last_name=i.last_name,e.payload.month=i.month,e.payload.year=i.year,e.payload.card_type=i.card_type,e.payload.zip=i.zip,e.payload.last_four=i.last_four,e.payload.address1=i.address1,e.payload.address2=i.address2,e.payload.city=i.city,e.payload.state_abbreviation=i.state,u.create(e,t))})})},updateWithSecret:function(e,t){t()},showWithRefresh:function(e,t){u.load(e.params[0],function(n){n.refresh(function(){u.show(e,t)})})},indexWithRefresh:function(t,n){u.index(null,function(i){e.async.forEach(i,function(e,t){e.refresh(t)},function(e){e&&r.error("[ERROR CALLBACK][abine/storage/shieldedCard][indexWithRefresh]: error event in ShieldedCard.index async forEach"),u.index(t,n)})})}}),i.ShieldedCard=u,u}),ABINEMASKME.define("abine/storage/shieldedEmail",["documentcloud/underscore","persistence","abine/storageMixins","abine/config","abine/emailServer","storage","persistence/autodate","persistence/caching"],function(e,t,n,i,r,a){var o=t.define("ShieldedEmails",{guid:"TEXT",userId:"INT",email:"TEXT",active:"BOOL",createdAt:"DATE",modifiedAt:"DATE",pushVersion:"INTEGER"});return o.secure(t.security.TABLE_SALT,["email"]),o.autoDate(),o.enableCaching("email"),e.extend(o,n.DefaultActions,{routes:{"read/shieldedEmail/all":"index","read/shieldedEmail/:id":"show","create/shieldedEmail":"createWithServerInfo","delete/shieldedEmail/:id":"destroy"},getDefault:function(e,t){o.index(e,function(n){var i=n?n[0]:null;o.respondWithEntities(i,e,t)})},createWithServerInfo:function(e,t){this.emailServer=this.emailServer||new r,this.emailServer.readTarget({target_email:e.payload.email},function(n,i){n?true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/shieldedEmail]#[createOnServer]# error event in emailServer.readTarget"):(e.payload.guid=i.guid,e.payload.active=i.active,o.create(e,t))})},changeUserEmail:function(n,i){o.index(null,function(r){e.each(r,function(e){t.remove(e)}),t.flush(function(){o.create(n,i)})})}}),a.ShieldedEmail=o,o}),ABINEMASKME.define("abine/storage/shieldedPhone",["documentcloud/underscore","persistence","abine/storageMixins","storage","persistence/autodate","persistence/caching","abine/phoneServer","abine/config"],function(e,t,n,i,r,a,o){var s=t.define("ShieldedPhones",{country_code:"TEXT",number:"TEXT",is_validated:"TEXT",rails_id:"INTEGER",auth_token:"TEXT",createdAt:"DATE",modifiedAt:"DATE",pushVersion:"INTEGER"});return s.secure(t.security.TABLE_SALT,["country_code","number"]),s.autoDate(),s.enableCaching(),e.extend(s.prototype,{refresh:function(e){e()},getPrettyNumber:function(){var e="("+this.getAreaCode()+") "+this.getExchange()+"-"+this.getLocal();return e},getAreaCode:function(){return this.number.substr(0,3)},getExchange:function(){return this.number.substr(3,3)},getLocal:function(){return this.number.substr(6,4)}}),e.extend(s,n.DefaultActions,{routes:{"read/shieldedPhone/all":"indexWithRefresh","read/shieldedPhone/:id":"showWithRefresh","create/shieldedPhone":"createOnServer","update/shieldedPhone/secret":"updateWithSecret","delete/shieldedPhone/:id":"destroy"},createOnServer:function(e,t){this.phoneServer=this.phoneServer||new o,this.phoneServer.createPhone({country_code:e.payload.country_code?e.payload.country_code:"1",number:e.payload.number,verification_method:e.payload.verification_method},function(n,i){n?t?t(n):e.returnErrObj(n):(e.payload.rails_id=i.phone.id,e.payload.is_validated=""+i.phone.is_validated,e.payload.country_code=""+i.phone.country_code,t?t(e.payload):s.create(e))})},updateWithSecret:function(n){this.phoneServer=this.phoneServer||new o;var r={id:n.payload.rails_id,secret:n.payload.secret};i.ShieldedPhone.all().filter("is_validated","=","true").one(e.bind(function(e){e&&(r.phone_auth_token=e.auth_token,r.old_rails_id=e.rails_id),this.phoneServer.verifySecret(r,function(r,a){r?n.returnErrObj(r):i.ShieldedPhone.load(n.payload.id,function(r){r.auth_token=a.phone.auth_token,r.is_validated=""+a.phone.is_validated,e&&t.remove(e),t.flush(function(){i.DisposablePhone.all().destroyAll(null,function(){i.ShieldedPhone.all().filter("is_validated","=","false").destroyAll(null,function(){var e=new i.DisposablePhone({country_code:a.phone.disposable_phones[0].country_code,number:a.phone.disposable_phones[0].number,rails_id:a.phone.disposable_phones[0].id,shielded_phone_id:r.id,accountId:""});t.add(e),t.flush(function(){n.returnJSON({shielded_phone:r.toJSON(),disposable_phone:e.toJSON()})})})})})})})},this))},showWithRefresh:function(e,t){s.load(e.params[0],function(n){n.refresh(function(){s.show(e,t)})})},indexWithRefresh:function(t,n){s.index(null,function(i){e.async.forEach(i,function(e,t){e.refresh(t)},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/shieldedPhone]#[indexWithRefresh]# error event in ShieldedPhone.index async forEach"),s.index(t,n)})})}}),i.ShieldedPhone=s,s}),ABINEMASKME.define("abine/storage/site",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/url","persistence/security","persistence/autodate"],function(e,t,n,i,r){function a(e){return function(t){return t.siteId==e&&0==t.deleted&&"fill"!=t.type&&"passwordless"!=t.type}}function o(e){return function(t){return t.siteId==e}}function s(t,n){t.accounts=[],i.Account.listCached(a(t.id),function(i){t.accounts=e(i).map(function(e){return e.toJSON()}),n(t)})}function c(t,n){t.accounts=[],i.Account.listCached(o(t.id),function(i){t.accounts=e(i).map(function(e){return e.toJSON()}),n(t)})}function u(t,n){t.fullyProtected=!0,i.Account.listCached(o(t.id),function(i){e.async.forEach(i,function(e,n){e.computeFullyProtected(!1,function(e,i){t.protections||(t.protections={totalEmails:0,totalPhones:0,totalPasswords:0,password:1,email:1,phone:1}),t.protections.totalEmails|=i.emails?1:0,t.protections.totalPhones|=i.phones?1:0,t.protections.totalPasswords|=i.passwords?1:0,t.protections.password&=i.password===i.passwords?1:0,t.protections.email&=i.email===i.emails?1:0,t.protections.phone&=i.phone===i.phones?1:0,2>e&&(t.fullyProtected=!1),n()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[addIsFullyProtectedToSiteJSON]# error event in calculating protection status"),n(t)})})}function d(t,n){i.Account.listCached(o(t.id),function(i){e.async.forEach(i,function(n,i){t.privacyStatus||(t.privacyStatus={goodEmails:[],badEmails:[],goodPhones:[],badPhones:[]}),n.computePhoneAndEmailArrays(function(n){e(n.goodEmails).each(function(e){t.privacyStatus.goodEmails.push(e)}),e(n.badEmails).each(function(e){t.privacyStatus.badEmails.push(e)}),e(n.goodPhones).each(function(e){t.privacyStatus.goodPhones.push(e)}),e(n.goodEmails).each(function(e){t.privacyStatus.badPhones.push(e)}),i()})},function(i){i&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[addPrivacyStatusToSiteJSON]# error event while computing phone and email arrays"),t.privacyStatus.goodEmails=e.uniq(t.privacyStatus.goodEmails,!1,function(e){return e.value}),t.privacyStatus.badEmails=e.uniq(t.privacyStatus.badEmails,!1,function(e){return e.value}),t.privacyStatus.goodPhones=e.uniq(t.privacyStatus.goodPhones,!1,function(e){return e.value}),t.privacyStatus.badPhones=e.uniq(t.privacyStatus.badPhones,!1,function(e){return e.value}),l(t,function(e){n(e)})})})}function l(t,n){function r(e){return 0==e.deleted&&"fill"!=e.type}var a={},o=[];i.Account.listCached(r,function(r){e.async.forEach(r,function(e,t){i.Site.load(e.siteId,function(n){function r(t){return t.id==e.id&&1==t.latest&&"/password"==t.dataType}i.AccountField.listCached(r,function(e){var i=null;e.length>0&&(i=e[0]),i?(i=i.toJSON(),i.site=n.toJSON(),e.push(i),a[i.value]||(a[i.value]=[]),a[i.value].push(n.domain),t()):t()})})},function(i){i&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[addPasswordsWithReuseToSiteJSON]# error event while calculating password reuse"),e(o).each(function(e){e.reuse=a[e.value]}),t.privacyStatus.passwords=e(o).filter(function(e){return e.site.id===t.id}),n(t)})})}function h(t,n){t.accountFields=[],i.AccountField.getLatestForAccountId(t.id,function(i){t.accountFields=e(i).map(function(e){return e.toJSON()}),n(t)})}function f(t,n){t.disposableEmails=[],i.DisposableEmail.listCached("accountId",t.id,function(i){t.disposableEmails=e(i).map(function(e){return e.toJSON()}),n(t)})}function p(t,n){t.disposablePhones=[],i.DisposablePhone.listCached("accountId",t.id,function(i){t.disposablePhones=e(i).map(function(e){return e.toJSON()}),n(t)})}function m(e,t){e.privacyStatus=[],i.Account.load(e.id,function(n){n.computePhoneAndEmailArrays(function(n){e.privacyStatus=n,t(e)})})}var g=t.define("Sites",{name:"TEXT",createdAt:"DATE",domain:"TEXT",blacklisted:"INTEGER",modifiedAt:"DATE",pushVersion:"INTEGER"});return g.secure(t.security.TABLE_SALT,["name","domain"]),g.autoDate(),g.enableCaching("domain"),e.extend(g.prototype,{cleanRemove:function(n,r){var a=this.id;i.Account.listCached("siteId",a,e.bind(function(i){e.async.forEach(i,function(e,t){r?e.cleanRemoveAccountsAndHistory(function(e){t(e)}):e.cleanRemove(function(e){t(e)})},e.bind(function(e){e?(true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[cleanRemove]# error event in Account.listCached async forEach"),n(e)):r?n():(t.remove(this),t.flush(function(e,t){t&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[cleanRemove]# error while flushing"),n()}))},this))},this))}}),e.extend(g,n.DefaultActions,{routes:{"read/site/all":"indexWithAccounts","read/site/blacklisted":"showForBlacklist","read/site/:id":"showWithRelations","read/site/domain/:id":"showWithAccountsForDomain","read/site/history/:id":"showAccountFieldHistory","create/site":"create","create/site/domain/:id":"findOrCreateForDomain","update/site/blacklist/domain/:id":"blacklistForDomain","update/site/:id":"update","delete/site/:id":"deepDestroy"},deepDestroy:function(e,t){i.Site.load(e.params[0],function(n){n.cleanRemove(function(n){t?t.call(n):n?e.returnError("error"):e.returnStatus("ok")})})},showAccountFieldHistory:function(t){var n=t.params[0];i.Account.listCached("siteId",n,function(n){var r=[];e.async.forEach(n,function(t,n){function a(e){return e.accountId===t.id}i.AccountField.listCached(a,function(i){var a=e(i).map(function(e){return e=e.toJSON(),e.accountType=t.type,e});r=r.concat(a),n()})},function(n){n&&true&&ABINEMASKME.log.error("[ERROR HANDLER]#[abine/storage/site]#[showAccountFieldHistory]# error event in Account.listCached async forEach"),r=e(r).sortBy(function(e){return e.accountId}),t.returnJSON(r)})})},indexWithAccounts:function(t,n){var r=[];i.Account.listCached(null,null,function(a){var o={},s={},c={},d={};e.each(a,function(e){s[e.id]=[],o[e.siteId]||(o[e.siteId]=[]),o[e.siteId].push(e)}),i.AccountField.listCached("latest",1,function(a){e.each(a,function(e){s[e.accountId]||(s[e.accountId]=[]),s[e.accountId].push(e)}),i.DisposableEmail.listCached(null,null,function(a){e.each(a,function(e){e.accountId&&e.accountId in s&&(c[e.accountId]||(c[e.accountId]=[]),c[e.accountId].push(e))}),i.DisposablePhone.listCached(null,null,function(i){e.each(i,function(e){e.accountId&&e.accountId in s&&(d[e.accountId]||(d[e.accountId]=[]),d[e.accountId].push(e))}),g.listCached("blacklisted",0,function(i){e.async.forEach(i,function(t,n){var i=t.toJSON();i.accounts=[],o[i.id]&&(i.accounts=e(o[i.id]).map(function(e){return e.toJSON()})),i.accounts.length>0?(r.push(i),e.async.parallel([function(e){u(i,function(){e()})},function(t){e.async.forEach(i.accounts,function(t,n){t.accountFields=[],s[t.id]&&(t.accountFields=e(s[t.id]).map(function(e){return e.toJSON()})),t.disposableEmails=[],c[t.id]&&(t.disposableEmails=e(c[t.id]).map(function(e){return e.toJSON()})),t.disposablePhones=[],d[t.id]&&(t.disposablePhones=e(d[t.id]).map(function(e){return e.toJSON()})),n()},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[indexWithAccounts]# error event in Site.listCached async forEach 1"),t(e)})}],function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[indexWithAccounts]# error event in async.parallel"),n(e)})):n()},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[indexWithAccounts]# error event in Site.listCached async forEach 2"),g.respondWithJSON(r,t,n)})})})})})})},showForBlacklist:function(e,t){this.listCached("blacklisted",1,function(n){g.respondWithJSON(n,e,t)})},showWithRelations:function(t,n){g.findBy("id",t.params[0],function(i){i&&1!=i.blacklisted?(i=i.toJSON(),s(i,function(){e.async.forEach(i.accounts,function(e,t){h(e,function(){f(e,function(){p(e,function(){m(e,function(){t()})})})})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[showWithRelations]# error event in addLoginAccountsToSiteJSON async forEach"),d(i,function(e){g.respondWithJSON(e,t,n)})})})):g.respondWithJSON({},t,n)})},showWithAccountsForDomain:function(t,n){var i=t.params[0];g.findBy("domain",i,function(r){r?1==r.blacklisted||"1"==r.blacklisted?g.respondWithJSON({domain:i,blacklisted:1,accounts:[]},t,n):(r=r.toJSON(),s(r,function(){e.async.forEach(r.accounts,function(e,t){h(e,function(){t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[showWithAccountsForDomain]# error event in addLoginAccountsToSiteJSON async forEach"),g.respondWithJSON(r,t,n)})})):g.respondWithJSON({domain:i,blacklisted:0,accounts:[]},t,n)})},blacklistForDomain:function(n,i){var a=n.payload.domain||n.params[0],o=t.getEntityByAlternatePK(g,a);o?o.cleanRemove(e.bind(function(r){r?n.returnError("error"):(o.blacklisted=1,t.flush(e.bind(function(e,t){t&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[cleanRemove]# error while flushing"),i?i():n.returnStatus("ok")},this)))},this),!0):g.findBy("domain",a,function(o){o?o.cleanRemove(e.bind(function(r){r?n.returnError("error"):(o.blacklisted=1,t.flush(e.bind(function(e,t){t&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[cleanRemove]# error while flushing"),i?i():n.returnStatus("ok")},this)))},this),!0):g.create({payload:{name:n.payload.name||r.getSiteName(a),domain:a,blacklisted:1,createdAt:new Date,modifiedAt:new Date}},function(e){g.respondWithJSON(e,n,i)})})},findOrCreateForDomain:function(t,n){g.findOrCreate(t,function(i){i=i.toJSON(),c(i,function(){e.async.forEach(i.accounts,function(e,t){h(e,function(){t()})},function(e){e&&true&&ABINEMASKME.log.error("[ERROR CALLBACK]#[abine/storage/site]#[findOrCreateForDomain]# error event in addAccountsToSiteJSON async forEach"),g.respondWithJSON(i,t,n)})})})},findOrCreate:function(e,t){e.params=e.params||[];var n=e.payload.domain||e.params[0];g.findBy("domain",n,function(i){i?t(i):g.create({payload:{name:e.payload.name||r.getSiteName(n),domain:n,blacklisted:e.payload.blacklisted?1:0,createdAt:new Date,modifiedAt:new Date}},function(e){1==e.blacklisted&&(e={}),t(e)})})}}),i.Site=g,g}),ABINEMASKME.define("abine/storage/webmail",["documentcloud/underscore","persistence","abine/storageMixins","storage","abine/ajax","abine/config","abine/emailServer","abine/responseCodes"],function(e,t,n,i,r,a,o){var s=function(){};return e.extend(s,n.DefaultActions,{routes:{"read/webmail/all":"indexFromServer","read/webmail/:id":"showFromServer"},showFromServer:function(e,t){this.emailServer=this.emailServer||new o,this.emailServer.getMail({mid:e.params[0]},function(n,i){n?e.returnErrObj(n):s.respondWithJSON(i.email,e,t)})},indexFromServer:function(e,t){this.emailServer=this.emailServer||new o,this.emailServer.getInbox({},function(n,i){n?e.returnErrObj(n):s.respondWithJSON(i.inbox,e,t)})}}),i.Webmail=s,s}),ABINEMASKME.define("storage",["persistence","documentcloud/underscore"],function(e,t){var n={dumpToJSON:function(){var t=[];for(var i in n)"meta"in n[i]&&t.push(n[i]);e.dump(t,function(e){JSON.stringify(e)})},purgeDatabase:function(i){e.clean();var r=[];for(var a in n)"meta"in n[a]&&r.push(n[a]);t.async.forEach(r,function(t,n){e.transaction(function(e){e.executeSql("delete from "+t.meta.name,null,function(){n()})})},function(){i()})}};return n}),ABINEMASKME.require("abine/storage/account"),ABINEMASKME.require("abine/storage/accountActivity"),ABINEMASKME.require("abine/storage/accountField"),ABINEMASKME.require("abine/storage/disposableCard"),ABINEMASKME.require("abine/storage/disposableEmail"),ABINEMASKME.require("abine/storage/disposablePhone"),ABINEMASKME.require("abine/storage/formData"),ABINEMASKME.require("abine/storage/mappedForm"),ABINEMASKME.require("abine/storage/mappedField"),ABINEMASKME.require("abine/storage/panelActivity"),ABINEMASKME.require("abine/storage/phoneLog"),ABINEMASKME.require("abine/storage/preference"),ABINEMASKME.require("abine/storage/shieldedCard"),ABINEMASKME.require("abine/storage/shieldedEmail"),ABINEMASKME.require("abine/storage/shieldedPhone"),ABINEMASKME.require("abine/storage/site"),ABINEMASKME.require("abine/storage/cardTransaction"),ABINEMASKME.require("abine/storage/webmail"),ABINEMASKME.require("abine/storage/export"),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t,n,i){t.defineMigration(1,{up:function(){this.createTable("AccountActivity",function(e){e.text("accountId",32),e.text("activityType"),e.date("createdAt"),e.date("modifiedAt"),e.text("url"),e.text("accountFieldId"),e.integer("deleted"),e.text("extraActivityTypes"),e.integer("protectionLevel"),e.integer("pushVersion")}),this.createTable("Accounts",function(e){e.integer("active",1),e.date("createdAt"),e.integer("deleted",1),e.text("description"),e.date("modifiedAt"),e.text("name"),e.text("siteId",32),e.text("type"),e.integer("pushVersion"),e.integer("protectionLevel"),e.text("protectionsJSON"),e.text("protocol"),e.text("page_domain"),e.text("form_domain")}),this.createTable("AccountField",function(e){e.text("accountId",32),e.date("createdAt"),e.text("dataType"),e.text("name"),e.integer("latest",1),e.date("modifiedAt"),e.text("origin"),e.text("value"),e.integer("version",16),e.integer("deleted"),e.integer("pushVersion")}),this.createTable("DisposableEmails",function(e){e.text("accountId"),e.integer("active"),e.date("createdAt"),e.text("domain"),e.text("guid"),e.date("modifiedAt"),e.integer("targetId"),e.text("targetGuid"),e.text("user"),e.integer("mails"),e.text("label"),e.integer("pushVersion")}),this.createTable("DisposablePhones",function(e){e.text("accountId"),e.integer("shielded_phone_id"),e.integer("rails_id"),e.text("country_code"),e.text("number"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion"),e.text("isSuspended"),e.date("nextBillingDate")}),this.createTable("FormData",function(e){e.integer("formId"),e.text("dataType"),e.date("createdAt"),e.text("form_signature"),e.text("value"),e.integer("latest",1),e.text("origin"),e.text("domain"),e.text("formType"),e.text("field_signature")}),this.createTable("Preferences",function(e){e.text("key"),e.text("value"),e.text("description"),e.text("category"),e.integer("deleted"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("ShieldedEmails",function(e){e.text("email"),e.text("guid"),e.integer("active"),e.integer("userId"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("ShieldedPhones",function(e){e.text("country_code"),e.text("number"),e.integer("rails_id"),e.text("is_validated"),e.text("auth_token"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("ShieldedCards",function(e){e.text("last_four"),e.text("first_name"),e.text("last_name"),e.text("month"),e.text("year"),e.text("card_type"),e.text("address1"),e.text("address2"),e.text("city"),e.text("state_abbreviation"),e.text("zip"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("DisposableCards",function(e){e.integer("shielded_card_id"),e.integer("guid"),e.integer("active"),e.integer("gift"),e.text("recipient_email"),e.text("number"),e.text("request_id"),e.text("deactivate_request_id"),e.text("expiry_year"),e.text("expiry_month"),e.text("cvc"),e.text("type"),e.text("domain"),e.text("amount_refunded"),e.text("original_amount"),e.text("serverCreatedAt"),e.text("activeToDate"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("Sites",function(e){e.date("createdAt"),e.text("domain"),e.text("name"),e.date("modifiedAt"),e.integer("blacklisted"),e.integer("pushVersion")}),this.createTable("MappedForm",function(e){e.text("domain"),e.text("signature"),e.text("mapping_signature"),e.text("formType")}),this.createTable("MappedField",function(e){e.integer("formId"),e.text("signature"),e.text("dataType")}),this.createTable("PanelActivity",function(e){e.integer("panelId"),e.integer("impressions"),e.integer("clicks"),e.integer("users"),e.integer("completions"),e.integer("masks"),e.integer("discloses"),e.integer("closes")}),this.skipAll()},down:function(){this.dropTable("AccountActivity"),this.dropTable("Accounts"),this.dropTable("AccountFields"),this.dropTable("FormData"),this.dropTable("DisposableEmails"),this.dropTable("DisposablePhones"),this.dropTable("Preferences"),this.dropTable("ShieldedEmails"),this.dropTable("ShieldedPhones"),this.dropTable("Sites"),this.dropTable("MappedForm"),this.dropTable("MappedField"),this.dropTable("PanelActivity")},postMigrate:function(e){i.Preference.setDefaults(e)}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(2,{up:function(){this.addColumn("Accounts","type","TEXT"),this.executeSql("UPDATE Accounts SET type='form_submit'")},down:function(){this.removeColumn("Accounts","type")},upForSync:function(t){t.Accounts&&e.each(t.Accounts,function(e){e.type="form_submit"})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(3,{up:function(){this.addColumn("AccountActivity","accountFieldId","TEXT")},down:function(){this.removeColumn("AccountActivity","accountFieldId")}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(4,{up:function(){this.addColumn("AccountActivity","deleted","INT"),this.executeSql("UPDATE AccountActivity SET deleted = 0")},down:function(){this.removeColumn("AccountActivity","deleted")},upForSync:function(t){t.AccountActivity&&e.each(t.AccountActivity,function(e){e.deleted=0})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(5,{up:function(){this.addColumn("AccountActivity","extraActivityTypes","TEXT"),this.addColumn("AccountActivity","protectionLevel","INT"),this.executeSql("UPDATE AccountActivity SET protectionLevel='0'")},down:function(){this.removeColumn("AccountActivity","extraActivityTypes"),this.removeColumn("AccountActivity","protectionLevel")},upForSync:function(t){t.AccountActivity&&e.each(t.AccountActivity,function(e){e.protectionLevel=0})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(6,{up:function(){this.addColumn("Sites","blacklisted","INTEGER"),this.executeSql("UPDATE Sites SET blacklisted='0'")},down:function(){this.removeColumn("Sites","blacklisted")},upForSync:function(t){t.Sites&&e.each(t.Sites,function(e){e.blacklisted=0})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(7,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(8,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(9,{up:function(){this.addColumn("AccountField","deleted","INT"),this.executeSql("UPDATE AccountField SET deleted = 0"),this.executeSql("UPDATE AccountField SET deleted = 1 where AccountField.accountId in (select id from Accounts where deleted = 1)")},down:function(){this.removeColumn("AccountField","deleted")},upForSync:function(t){t.AccountField&&e.each(t.AccountField,function(n){n.deleted=0,t.Accounts&&e.each(t.Accounts,function(e){1==e.deleted&&e.id==n.accountId&&(n.deleted=1)})})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(10,{up:function(){this.addColumn("DisposableEmails","mails","INTEGER"),this.executeSql("UPDATE DisposableEmails SET mails='0'")},down:function(){this.removeColumn("DisposableEmails","mails")},upForSync:function(t){t.DisposableEmails&&e.each(t.DisposableEmails,function(e){e.mails=0})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(11,{up:function(){this.addColumn("DisposableEmails","label","TEXT")},down:function(){this.removeColumn("DisposableEmails","label")}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(12,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(13,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(14,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(15,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(16,{up:function(){this.addColumn("AccountActivity","pushVersion","INTEGER"),this.addColumn("AccountField","pushVersion","INTEGER"),this.addColumn("Accounts","pushVersion","INTEGER"),this.addColumn("DisposableEmails","pushVersion","INTEGER"),this.addColumn("DisposablePhones","pushVersion","INTEGER"),this.addColumn("Preferences","pushVersion","INTEGER"),this.addColumn("ShieldedEmails","pushVersion","INTEGER"),this.addColumn("ShieldedPhones","pushVersion","INTEGER"),this.addColumn("Sites","pushVersion","INTEGER")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(17,{up:function(){this.addColumn("Accounts","protectionLevel","INTEGER"),this.addColumn("Accounts","protectionsJSON","TEXT")},down:function(){this.removeColumn("Accounts","protectionLevel"),this.removeColumn("Accounts","protectionsJSON")}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(18,{up:function(){this.createTable("MappedForm",function(e){e.text("domain"),e.text("signature"),e.text("mapping_signature"),e.text("formType")}),this.createTable("MappedField",function(e){e.integer("formId"),e.text("signature"),e.text("dataType")})},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(19,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t,n,i){t.defineMigration(20,{up:function(){i.ShieldedPhone.all().list(function(n){e.each(n,function(e){t.remove(e)})}),i.DisposablePhone.all().list(function(n){e.each(n,function(e){t.remove(e)})}),t.flush(),this.addColumn("ShieldedPhones","rails_id","INTEGER"),this.addColumn("ShieldedPhones","is_validated","TEXT"),this.addColumn("ShieldedPhones","auth_token","TEXT"),this.addColumn("ShieldedPhones","country_code","TEXT"),this.removeColumn("ShieldedPhones","countryCode"),this.removeColumn("ShieldedPhones","areaCode"),this.removeColumn("ShieldedPhones","voiceEmail"),this.removeColumn("ShieldedPhones","active"),this.removeColumn("ShieldedPhones","userId"),this.removeColumn("ShieldedPhones","guid"),this.addColumn("DisposablePhones","rails_id","INTEGER"),this.addColumn("DisposablePhones","country_code","TEXT"),this.addColumn("DisposablePhones","shielded_phone_id","INTEGER"),this.removeColumn("DisposablePhones","guid"),this.removeColumn("DisposablePhones","countryCode"),this.removeColumn("DisposablePhones","areaCode"),this.removeColumn("DisposablePhones","extension"),this.removeColumn("DisposablePhones","targetId"),this.removeColumn("DisposablePhones","targetGuid"),this.removeColumn("DisposablePhones","twilioSid"),this.removeColumn("DisposablePhones","active")},down:function(){this.removeColumn("ShieldedPhones","railsId"),this.removeColumn("ShieldedPhones","authToken")
}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(21,{up:function(){this.executeSql("delete from Preferences where id in (select c.id from Preferences c where c.id in (select b.id from Preferences b where b.id not in (select a.id from (SELECT id, key, count(*) as cnt FROM preferences group by key order by modifiedAt desc) a where a.cnt > 1) and b.key in (select a.key from (SELECT id, key, count(*) as cnt FROM preferences group by key order by modifiedAt desc) a where a.cnt > 1)))")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(22,{up:function(){this.addColumn("Preferences","category","TEXT"),this.executeSql("UPDATE Preferences SET category='hidden'")},down:function(){},upForSync:function(t){t.Preferences&&e.each(t.Preferences,function(e){e.category="hidden"})}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(23,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(24,{})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(25,{up:function(){this.executeSql("DELETE FROM MappedForm"),this.executeSql("DELETE FROM MappedField")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(26,{up:function(){try{this.createTable("ShieldedCards",function(e){e.text("last_four"),e.text("first_name"),e.text("last_name"),e.text("month"),e.text("year"),e.text("card_type"),e.text("address1"),e.text("address2"),e.text("city"),e.text("state_abbreviation"),e.text("zip"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")}),this.createTable("DisposableCards",function(e){e.integer("shielded_card_id"),e.integer("guid"),e.integer("active"),e.text("number"),e.text("domain"),e.text("request_id"),e.text("deactivate_request_id"),e.text("expiry_year"),e.text("expiry_month"),e.text("cvc"),e.text("type"),e.text("original_amount"),e.text("serverCreatedAt"),e.text("activeToDate"),e.date("createdAt"),e.date("modifiedAt"),e.integer("pushVersion")})}catch(e){}},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(27,{up:function(){this.createTable("FormData",function(e){e.integer("formId"),e.text("dataType"),e.date("createdAt"),e.text("form_signature"),e.text("value"),e.integer("latest",1),e.text("origin"),e.text("domain"),e.text("formType"),e.text("field_signature")})},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(28,{up:function(){this.createTable("PanelActivity",function(e){e.integer("panelId"),e.integer("impressions"),e.integer("clicks"),e.integer("users"),e.integer("completions")})},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(29,{up:function(){t.transaction(function(e){try{e.executeSql("ALTER TABLE DisposableCards ADD gift INTEGER")}catch(t){}})},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t,n,i){t.defineMigration(30,{up:function(){var e=new i.Preference({key:"enablePrivacyTimeline",value:"true",category:"privacy",description:"Enable privacy timeline"});t.add(e),t.flush()},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(31,{up:function(){this.addColumn("DisposableCards","amount_refunded","TEXT")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage","abine/phoneServer"],function(e,t,n,i,r){t.defineMigration(32,{up:function(){i.ShieldedPhone.all().list(null,function(t){var n=new r;e.each(t,function(e){n.migratePhone({phone_auth_token:e.auth_token},function(){})})})},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(33,{up:function(){this.addColumn("DisposableCards","recipient_email","TEXT")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(34,{up:function(){this.addColumn("DisposablePhones","isSuspended","TEXT"),this.addColumn("DisposablePhones","nextBillingDate","DATE")},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(35,{up:function(){this.addColumn("PanelActivity","masks","INTEGER"),this.addColumn("PanelActivity","discloses","INTEGER"),this.addColumn("PanelActivity","closes","INTEGER"),t.flush()},down:function(){}})}),ABINEMASKME.require(["documentcloud/underscore","persistence","persistence/migrations","storage"],function(e,t){t.defineMigration(36,{up:function(){this.addColumn("Accounts","protocol","TEXT"),this.addColumn("Accounts","page_domain","TEXT"),this.addColumn("Accounts","form_domain","TEXT")},down:function(){}})}),ABINEMASKME.define("abine/sync/account",["documentcloud/underscore","persistence","abine/sync/base","storage","abine/sync/accountField","abine/sync/accountActivity","abine/sync/disposableEmail","abine/sync/disposablePhone"],function(e,t,n,i,r,a,o,s){var c=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="Accounts",this._indexes={"name.site.type":["name","siteId","type"]},this.prepare(),this.accountFieldSync=new r(arguments[0],arguments[1],arguments[2],arguments[3]),this.accountActivitySync=new a(arguments[0],arguments[1],arguments[2],arguments[3]),this.disposableEmailSync=new o(arguments[0],arguments[1],arguments[2],arguments[3]),this.disposablePhoneSync=new s(arguments[0],arguments[1],arguments[2],arguments[3])},mergeDependents:function(e,t,n,i){var r=4,a=function(){r--,0==r?i():n.pendingAsyncOperations--};this.accountFieldSync.merge(e,t,n,a),this.accountActivitySync.merge(e,t,n,a),this.disposableEmailSync.merge(e,t,n,a),this.disposablePhoneSync.merge(e,t,n,a)},updateDependents:function(e,t,n){this.updateDependentPushVersion(i.AccountField,"accountId",e,t,n),this.updateDependentPushVersion(i.AccountActivity,"accountId",e,t,n),this.updateDependentPushVersion(i.DisposableEmail,"accountId",e,t,n),this.updateDependentPushVersion(i.DisposablePhone,"accountId",e,t,n)},deleteDependents:function(e,t,n){this.deleteDependentEntities(i.AccountField,"accountId",e,t,n),this.deleteDependentEntities(i.AccountActivity,"accountId",e,t,n),this.deleteDependentEntities(i.DisposableEmail,"accountId",e,t,n),this.deleteDependentEntities(i.DisposablePhone,"accountId",e,t,n)},merge:function(n){var r={numNoChange:0,numChanged:0,numDeleted:0,numAdded:0,pendingAsyncOperations:1},a=function(){r.pendingAsyncOperations--,0==r.pendingAsyncOperations&&n(r)};i.Account.all().list(e.bind(function(n){e.each(n,e.bind(function(e){var n=e.id,o=this.getByPK(n)||this.getByIndex("name.site.type",e.name,e.siteId,e.type);if(o){var s=o.id;o._processed=!0,this.canUpdateOldRecord(e,o)?(this.fixDates(o),s!=n?(this.updatePushVersion(o),t.add(new i.Account(o)),t.remove(e),r.numAdded++,r.numDeleted++):(e.active=o.active,e.deleted=o.deleted,e.description=o.description,e.createdAt=o.createdAt,e.modifiedAt=o.modifiedAt,e.pushVersion=o.pushVersion,e.protocol=o.protocol?o.protocol:null,e.page_domain=o.page_domain?o.page_domain:null,e.form_domain=o.form_domain?o.form_domain:null,this.updatePushVersion(e),r.numChanged++),this.mergeDependents(n,s,r,a)):(r.numNoChange++,this.updatePushVersion(e),this.updateDependents(n,r,a))}else this.canDeleteOldRecord(e)?(t.remove(e),r.numDeleted++,this.deleteDependents(n,r,a)):(r.numNoChange++,this.updatePushVersion(e),this.updateDependents(n,r,a))},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.Account(e)),r.numAdded++,this.mergeDependents(null,e.id,r,a))},this)),a()},this))}});return c}),ABINEMASKME.define("abine/sync/accountActivity",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="AccountActivity",this._indexes={account:["accountId"]},this.prepare()},merge:function(e,t,n,i){n.pendingAsyncOperations++,e?this.mergeAccountActivities(e,t,n,i):this.addAccountActivities(t,n,i)},mergeAccountActivities:function(n,r,a,o){i.AccountActivity.all().filter("accountId","=",n).list(e.bind(function(i){e.each(i,e.bind(function(e){var i=this.getByPK(e.id);if(i){i._processed=!0;var o=!1;n!=r&&(e.accountId=r,o=!0),this.canUpdateOldRecord(e,i)&&(this.fixDates(i),e.activityType=i.activityType,e.createdAt=i.createdAt,e.modifiedAt=i.modifiedAt,e.url=i.url,e.deleted=i.deleted,e.extraActivityTypes=i.extraActivityTypes,e.protectionLevel=i.protectionLevel,e.pushVersion=i.pushVersion,e.accountFieldId=i.accountFieldId,o=!0),this.updatePushVersion(e),o?a.numChanged++:a.numNoChange++}else n!=r?(a.numDeleted++,t.remove(e)):(a.numNoChange++,this.updatePushVersion(e))},this)),this.addAccountActivities(r,a,o)},this))},addAccountActivities:function(n,r,a){var o=this.getEntitiesByIndex(this._entityName,"account",n);e.each(o,e.bind(function(e){e._processed||(e._processed=!0,this.fixDates(e),this.updatePushVersion(e),t.add(new i.AccountActivity(e)),r.numAdded++)},this)),a()}});return r}),ABINEMASKME.define("abine/sync/accountField",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="AccountField",this._indexes={account:["accountId"],"account.name.datatype.latest":["accountId","name","dataType","latest"]},this._usingAccountIdSalt=!1;var e=this.getEntityByIndex("Preferences","key","usingAccountIdSalt");e&&"true"==e.value&&(this._usingAccountIdSalt=!0),this.prepare()},decrypt:function(e){e._decrypted||(this._usingAccountIdSalt?this.Entity.decryptForMerge(e):this.Entity.decryptForMerge(e,e.id.substr(0,16).toLowerCase()),e._decrypted=!0)},merge:function(e,t,n,i){n.pendingAsyncOperations++,e?this.mergeAccountFields(e,t,n,i):this.addAccountFields(t,n,i)},mergeAccountFields:function(n,r,a,o){i.AccountField.all().filter("accountId","=",n).filter("latest","=",1).list(e.bind(function(s){e.each(s,e.bind(function(e){var o=this.getByPK(e.id)||this.getByIndex("account.name.datatype.latest",r,e.name,e.dataType,1);if(o){o._processed=!0;var s=!1;n!=r&&(e.accountId=r,s=!0),this.canUpdateOldRecord(e,o)?o.value==e.value?o.deleted!=e.deleted?(e.deleted=o.deleted,e.pushVersion=o.pushVersion,this.updatePushVersion(e),s=!0):(a.numNoChange++,this.updatePushVersion(e)):(delete o.id,o.version=e.version+1,o.latest=1,e.latest=0,o.accountId=r,e.accountId=r,e.pushVersion=o.pushVersion,this.updatePushVersion(o),this.updatePushVersion(e),this.fixDates(o),t.add(new i.AccountField(o)),s=!0):this.updatePushVersion(e),s?a.numChanged++:a.numNoChange++}else this.canDeleteOldRecord(e)?(e.deleted=1,a.numDeleted++,this.updatePushVersion(e)):(a.numNoChange++,this.updatePushVersion(e))},this)),this.addAccountFields(r,a,o)},this))},addAccountFields:function(n,r,a){var o=this.getEntitiesByIndex(this._entityName,"account",n);e.each(o,e.bind(function(e){e._processed||1!=e.latest||(e._processed=!0,this.fixDates(e),e.version=1,this.updatePushVersion(e),t.add(new i.AccountField(e)),r.numAdded++)},this)),a()}});return r}),ABINEMASKME.define("abine/sync/base",["documentcloud/underscore","abine/core","persistence","storage"],function(e,t,n,i){var r=t.BaseClass.extend({initialize:function(e,t,n,i){this._newData=e,this._lastSync="number"==typeof t?t:Math.floor(t.getTime()/1e3),this._lastSyncVersion=n,this._currentServerVersion=i,this._indexes={},this._entityName="invalid entity name",this._encryptedEntity=!1},initializeEntity:function(){var e=this._entityName;if(!this.Entity){this._encryptedEntity=!1,this._salt=null;for(var t in i)if(i[t].meta&&i[t].meta.name==e){if(this.Entity=i[t],this._encryptedEntity=this.Entity.meta.secured,"Preferences"in this._newData){var n=this.getEntityByIndex("Preferences","key","Salt."+t);n&&(this._salt=n.value)}return}}},decrypt:function(e){!e._decrypted&&this.Entity.meta.secured&&(this.Entity.decryptForMerge(e,this._salt),e._decrypted=!0)},prepare:function(){var t=this._entityName,n=this._indexes;if(this.initializeEntity(),!(t+":indexes"in this._newData)&&t in this._newData){var i={},r={},a=this;e.each(this._newData[t],function(o){if(i[o.id]=o,a._encryptedEntity){if(!("Preferences"==t||o.createdAt>a._lastSync||o.modifiedAt>a._lastSync||o.pushVersion>a._lastSyncVersion))return;a.decrypt(o)}for(var s in n){s in r||(r[s]={});for(var c=[],u=0;n[s].length>u;u++)c.push(o[n[s][u]]);var d=c.join(":");d in r[s]?e.isArray(r[s][d])?r[s][d].push(o.id):r[s][d]=[r[s][d],o.id]:r[s][d]=o.id}}),this._newData[t]=i,this._newData[t+":indexes"]=r}},canUpdateOldRecord:function(e,t){var n;try{n=t.modifiedAt>Math.floor(e.modifiedAt.getTime()/1e3)}catch(i){true&&ABINEMASKME.log.error("Error during sync for entity '"+this._entityName+"' "+i),n=!0}return n&&this.decrypt(t),n},canDeleteOldRecord:function(e){return e.createdAt&&Math.floor(e.createdAt.getTime()/1e3)<this._lastSync},canRetainNewRecord:function(e){var t=e.createdAt&&e.createdAt>this._lastSync||e.pushVersion&&e.pushVersion>this._lastSyncVersion;return t&&this.decrypt(e),t},updatePushVersion:function(e){e.pushVersion||(e.pushVersion=this._currentServerVersion+1)},getEntityByPK:function(e,t){return e in this._newData&&t in this._newData[e]?this._newData[e][t]:null},getEntityByIndex:function(e,t){for(var n=[],i=2;arguments.length>i;i++)n.push(arguments[i]);n=n.join(":");var r=e+":indexes";return r in this._newData&&t in this._newData[r]&&n in this._newData[r][t]?this._newData[e][this._newData[r][t][n]]:null},getEntitiesByIndex:function(t,n){for(var i=[],r=2;arguments.length>r;r++)i.push(arguments[r]);i=i.join(":");var a=t+":indexes",o=[];if(a in this._newData&&n in this._newData[a]&&i in this._newData[a][n]){var s=this._newData[a][n][i];e.isArray(s)||(s=[s]);for(var r=0;s.length>r;r++)o.push(this._newData[t][s[r]])}return o},getByPK:function(e){return this.getEntityByPK(this._entityName,e)},getByIndex:function(){var t=e.toArray(arguments);return t.unshift(this._entityName),this.getEntityByIndex.apply(this,t)},fixDependentEntityFK:function(t,n,i,r,a,o){a.pendingAsyncOperations++,t.all().filter(n,"=",i).list(function(t){t&&t.length>0&&e.each(t,function(e){e[n]=r,e.skipDateChange=!0,a.numChanged++}),o()})},deleteDependentEntities:function(e,t,n,i,r){i.pendingAsyncOperations++,e.all().filter(t,"=",n).destroyAll(function(){r()})},updateDependentPushVersion:function(t,n,i,r,a){r.pendingAsyncOperations++,t.all().filter(n,"=",i).list(e.bind(function(t){e(t).each(e.bind(function(e){this.updatePushVersion(e)},this)),a()},this))},fixDates:function(e){e.createdAt&&1e10>e.createdAt&&(e.createdAt*=1e3),e.modifiedAt&&1e10>e.modifiedAt&&(e.modifiedAt*=1e3)},merge:function(){throw'Abstract method "merge" called'}});return r}),ABINEMASKME.define("abine/sync/disposableCard",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="DisposableCards",this._indexes={card:["number","cvc"]},this.prepare()},merge:function(n){i.DisposableCard.all().list(e.bind(function(r){var a=0,o=0,s=0,c=0;e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("card",e.number,e.cvc);n?(n._processed=!0,this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.DisposableCard(n)),t.remove(e),o++,s++):(e.active=n.active,e.guid=n.guid,e.number=n.number,e.domain=n.domain,e.expiry_month=n.expiry_month,e.expiry_year=n.expiry_year,e.cvc=n.cvc,e.original_amount=n.original_amount,e.type=n.type,e.serverCreatedAt=n.serverCreatedAt,e.activeToDate=n.activeToDate,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e),a++)):(c++,this.updatePushVersion(e))):this.canDeleteOldRecord(e)?(t.remove(e),s++):(c++,this.updatePushVersion(e))},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.DisposableCard(e)),o++)},this)),n({numNoChange:c,numChanged:a,numDeleted:s,numAdded:o})},this))}});return r}),ABINEMASKME.define("abine/sync/disposableEmail",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="DisposableEmails",this._indexes={account:["accountId"],email:["user","domain"]},this.prepare()},merge:function(e,t,n,i){n.pendingAsyncOperations++,e?this.mergeDisposableEmails(e,t,n,i):this.addDisposableEmails(t,n,i)},mergeSpareEmails:function(n){i.DisposableEmail.all().filter("accountId","=","").list(e.bind(function(r){e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("email",e.user,e.domain);n?(n._processed=!0,this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.DisposableEmail(n)),t.remove(e)):(e.active=n.active,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.targetId=n.targetId,e.targetGuid=n.targetGuid,e.pushVersion=n.pushVersion,e.label=n.label,this.updatePushVersion(e))):this.updatePushVersion(e)):this.canDeleteOldRecord(e)?t.remove(e):this.updatePushVersion(e)},this)),this.addSpareDisposableEmails(n)},this))},mergeDisposableEmails:function(n,r,a,o){i.DisposableEmail.all().filter("accountId","=",n).list(e.bind(function(s){e.each(s,e.bind(function(e){var o=this.getByPK(e.id)||this.getByIndex("email",e.user,e.domain);if(o){o._processed=!0;var s=!1;n!=r&&(e.accountId=r,s=!0),this.canUpdateOldRecord(e,o)?(this.fixDates(o),o.id!=e.id?(this.updatePushVersion(o),t.add(new i.DisposableEmail(o)),t.remove(e),a.numAdded++,a.numDeleted++,s=!1,a.numNoChange--):(e.active=o.active,e.createdAt=o.createdAt,e.modifiedAt=o.modifiedAt,e.targetId=o.targetId,e.targetGuid=o.targetGuid,e.pushVersion=o.pushVersion,this.updatePushVersion(e),s=!0)):this.updatePushVersion(e),s?a.numChanged++:a.numNoChange++}else this.canDeleteOldRecord(e)?(t.remove(e),a.numDeleted++):(a.numNoChange++,this.updatePushVersion(e))},this)),this.addDisposableEmails(r,a,o)},this))},addSpareDisposableEmails:function(n){var r=this.getEntitiesByIndex(this._entityName,"account","");e.each(r,e.bind(function(e){e._processed||(e._processed=!0,this.fixDates(e),this.updatePushVersion(e),t.add(new i.DisposableEmail(e)))},this)),n()},addDisposableEmails:function(n,r,a){var o=this.getEntitiesByIndex(this._entityName,"account",n);e.each(o,e.bind(function(e){e._processed||(e._processed=!0,this.fixDates(e),this.updatePushVersion(e),t.add(new i.DisposableEmail(e)),r.numAdded++)},this)),a()}});return r}),ABINEMASKME.define("abine/sync/disposablePhone",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="DisposablePhones",this._indexes={account:["accountId"],phone:["country_code","number"]},this.prepare()},merge:function(e,t,n,i){n.pendingAsyncOperations++,e?this.mergeAccountActivities(e,t,n,i):this.addAccountActivities(t,n,i)},mergeSparePhones:function(n){i.DisposablePhone.all().filter("accountId","=","").list(e.bind(function(r){e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("phone",e.country_code,e.number);n?(n._processed=!0,this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.DisposablePhone(n)),t.remove(e)):(e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e))):this.updatePushVersion(e)):this.canDeleteOldRecord(e)?t.remove(e):this.updatePushVersion(e)},this)),this.addSpareDisposablePhones(n)},this))},mergeAccountActivities:function(n,r,a,o){i.DisposablePhone.all().filter("accountId","=",n).list(e.bind(function(s){e.each(s,e.bind(function(e){var o=this.getByPK(e.id)||this.getByIndex("phone",e.country_code,e.number);if(o){o._processed=!0;var s=!1;n!=r&&(e.accountId=r,s=!0),this.canUpdateOldRecord(e,o)?(this.fixDates(o),o.id!=e.id?(this.updatePushVersion(e),t.add(new i.DisposablePhone(o)),t.remove(e),a.numAdded++,a.numDeleted++,s=!1,a.numNoChange--):(e.createdAt=o.createdAt,e.modifiedAt=o.modifiedAt,e.pushVersion=o.pushVersion,this.updatePushVersion(e),s=!0)):this.updatePushVersion(e),s?a.numChanged++:a.numNoChange++}else this.canDeleteOldRecord(e)?(t.remove(e),a.numDeleted++):(a.numNoChange++,this.updatePushVersion(e))},this)),this.addAccountActivities(r,a,o)},this))},addSpareDisposablePhones:function(n){var r=this.getEntitiesByIndex(this._entityName,"account","");e.each(r,e.bind(function(e){e._processed||(e._processed=!0,this.fixDates(e),this.updatePushVersion(e),t.add(new i.DisposablePhone(e)))},this)),n()},addAccountActivities:function(n,r,a){var o=this.getEntitiesByIndex(this._entityName,"account",n);e.each(o,e.bind(function(e){e._processed||(e._processed=!0,this.fixDates(e),this.updatePushVersion(e),t.add(new i.DisposablePhone(e)),r.numAdded++)},this)),a()}});return r}),ABINEMASKME.define("abine/sync/preference",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=/^(lastSync|lastDataVersion|lastTouch|authToken|Salt\..+|usingAccountIdSalt|entitledToSync|entitledToPhone|autoUnlockPassword)$/,a=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="Preferences",this._indexes={key:["key"]},this.removeDuplicates(),this.prepare()},merge:function(n){i.Preference.all().list(e.bind(function(a){var o=0,s=0,c=0,u=0;e.each(a,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("key",e.key);return e.key.match(r)?(n&&(n._processed=!0),u++,void 0):(n?(n._processed=!0,0==this._lastSync||this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.Preference(n)),t.remove(e),s++,c++):(e.value=n.value,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.deleted=n.deleted,e.description=n.description,e.pushVersion=n.pushVersion,this.updatePushVersion(e),o++)):(u++,this.updatePushVersion(e))):this.canDeleteOldRecord(e)?(t.remove(e),c++):(u++,this.updatePushVersion(e)),void 0)},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.Preference(e)),s++)},this)),n({numNoChange:u,numChanged:o,numDeleted:c,numAdded:s})},this))},removeDuplicates:function(){var t=this._entityName,n={},i={},r=this._newData[t],a=!1;e.each(r,function(e){e.key in n?(a=!0,n[e.key]++,i[e.key].modifiedAt<e.modifiedAt&&(i[e.key]=e)):(n[e.key]=1,i[e.key]=e)}),a&&(this._newData[t]=[],e.each(r,e.bind(function(e){(1==n[e.key]||i[e.key]==e)&&this._newData[t].push(e)},this)))}});return a}),ABINEMASKME.define("abine/sync/shieldedCard",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="ShieldedCards",this._indexes={card:["last_four","month","year"]},this.prepare()},merge:function(n){i.ShieldedCard.all().list(e.bind(function(r){var a=0,o=0,s=0,c=0;e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("card",e.last_four,e.month,e.year);n?(n._processed=!0,this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.ShieldedCard(n)),t.remove(e),o++,s++):(e.last_four=n.last_four,e.first_name=n.first_name,e.last_name=n.last_name,e.month=n.month,e.year=n.year,e.card_type=n.card_type,e.zip=n.zip,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e),a++)):(c++,this.updatePushVersion(e))):this.canDeleteOldRecord(e)?(t.remove(e),s++):(c++,this.updatePushVersion(e))},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.ShieldedCard(e)),o++)},this)),n({numNoChange:c,numChanged:a,numDeleted:s,numAdded:o})},this))}});return r}),ABINEMASKME.define("abine/sync/shielded_email",["documentcloud/underscore","persistence","abine/sync/base","storage","abine/eventLogger"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="ShieldedEmails",this._indexes={email:["email"],userId:["userId"]},this.prepare()},merge:function(n){i.ShieldedEmail.all().list(e.bind(function(r){var a=0,o=0,s=0,c=0;e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("email",e.email)||this.getByIndex("userId",e.userId);n?(n._processed=!0,0==this._lastSync||this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.ShieldedEmail(n)),t.remove(e),o++,s++):(e.email=n.email,e.guid=n.guid,e.active=n.active,e.userId=n.userId,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e),a++)):(c++,this.updatePushVersion(e))):this.canDeleteOldRecord(e)?(t.remove(e),s++):(c++,this.updatePushVersion(e))},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.ShieldedEmail(e)),o++)},this)),n({numNoChange:c,numChanged:a,numDeleted:s,numAdded:o})},this))}});return r}),ABINEMASKME.define("abine/sync/shielded_phone",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="ShieldedPhones",this._indexes={phone:["country_code","number"]},this.prepare()},merge:function(n){i.ShieldedPhone.all().list(e.bind(function(r){var a=0,o=0,s=0,c=0;e.each(r,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("phone",e.country_code,e.number);n?(n._processed=!0,this.canUpdateOldRecord(e,n)?(this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.ShieldedPhone(n)),t.remove(e),o++,s++):(e.is_validated=n.is_validated,e.rails_id=n.rails_id,e.auth_token=n.auth_token,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e),a++)):(c++,this.updatePushVersion(e))):this.canDeleteOldRecord(e)?(t.remove(e),s++):(c++,this.updatePushVersion(e))},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.ShieldedPhone(e)),o++)},this)),n({numNoChange:c,numChanged:a,numDeleted:s,numAdded:o})},this))}});return r}),ABINEMASKME.define("abine/sync/site",["documentcloud/underscore","persistence","abine/sync/base","storage"],function(e,t,n,i){var r=n.extend({initialize:function(){this.constructor.__super__.initialize.apply(this,arguments),this._entityName="Sites",this._indexes={domain:["domain"]},this.prepare()},merge:function(n){var r={numNoChange:0,numChanged:0,numDeleted:0,numAdded:0,pendingAsyncOperations:1},a=function(){r.pendingAsyncOperations--,0==r.pendingAsyncOperations&&n(r)};i.Site.all().list(e.bind(function(n){e.each(n,e.bind(function(e){var n=this.getByPK(e.id)||this.getByIndex("domain",e.domain);if(n){if(n._processed=!0,this.canUpdateOldRecord(e,n))this.fixDates(n),n.id!=e.id?(this.updatePushVersion(n),t.add(new i.Site(n)),t.remove(e),r.numAdded++,r.numDeleted++,this.fixDependentEntityFK(i.Account,"siteId",e.id,n.id,r,a)):(e.blacklisted=1==n.blacklisted?1:0,e.createdAt=n.createdAt,e.modifiedAt=n.modifiedAt,e.pushVersion=n.pushVersion,this.updatePushVersion(e),r.numChanged++);else if(r.numNoChange++,this.updatePushVersion(e),n.id!=e.id){var o=this._newData.Accounts;if(o)for(var s=0;o.length>s;s++)o[s].siteId==n.id&&(o[s].siteId=e.id)}}else this.canDeleteOldRecord(e)?(t.remove(e),r.numDeleted++):(this.updatePushVersion(e),r.numNoChange++)},this)),e.each(this._newData[this._entityName],e.bind(function(e){e._processed||this.canRetainNewRecord(e)&&(this.fixDates(e),this.updatePushVersion(e),t.add(new i.Site(e)),r.numAdded++)},this)),a()},this))}});return r}),ABINEMASKME.define("abine/modules/license",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","abine/ajax","abine/config","abine/securityManager","abine/licenseServer","abine/responseCodes","modules","abine/browserSyncStorage","abine/intl"],function(e,t,n,i,r,a,o,s,c,u,d,l,h,f){var p=function(){},m=864e5,g=function(){var e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e},y=n.BaseClass.extend({initialize:function(e){this.options=e,this.licenseServer=this.options.licenseServer||new u},setMessenger:function(e){this.messenger=e},resendUnlockEmail:function(t,n){n=n||p,this.licenseServer.resendUnlockEmail({email:t.email},e.bind(function(e,t){e?n(e,t):n(null,t)},this))},startDailyTouch:function(t){t=t||p,r.Preference.findBy("key","lastTouch",e.bind(function(n){if(n&&n.value){var r=new Date(parseInt(n.value));r.valueOf()<g().valueOf()?this.makeDailyActiveTouch(!1,t):this.startDailyActiveTouchTimeout(t)}else t(),i.setTimeout(e.bind(function(){this.makeDailyActiveTouch(!0,function(){})},this),3e5)},this))},makeDailyActiveTouch:function(t,n){n=n||p;var i={};i.install=!!t,r.Preference.batchFindBy([{by:"key",value:"authToken"},{by:"key",value:"installAuthToken"}],e.bind(function(t){var a=t.authToken,o=t.installAuthToken;!a||a.isEmpty()||a.isEncrypted()||(i.auth_token=a.value),o&&!o.isEmpty()&&(i.install_auth_token=o.value),this.licenseServer.makeDailyTouch(i,e.bind(function(t,i){t?this.startDailyActiveTouchTimeout(function(){n(t)}):this.writeDailyTouchPref(e.bind(function(){this.startDailyActiveTouchTimeout(function(){i.install_auth_token?r.Preference.createOrModify({key:"installAuthToken",value:i.install_auth_token},n):n()})},this))},this))},this))},removeDailyTouchPref:function(e){r.Preference.findBy("key","lastTouch",function(t){t?(a.remove(t),a.flush(e)):e()})},startDailyActiveTouchTimeout:function(t){t=t||p;var n=g().valueOf()+m,r=n-Date.now()+36e5+144e5*Math.random();this.dailyActiveTimeout&&i.clearTimeout(this.dailyActiveTimeout),this.dailyActiveTimeout=i.setTimeout(e.bind(function(){this.makeDailyActiveTouch()},this),r),t()},writeDailyTouchPref:function(e){e=e||p,r.Preference.findOrCreate({key:"lastTouch"},function(t){t.value=Math.floor(g().valueOf()),t.modifiedAt=g(),a.flush(function(){e()})})},generateString:function(e,t){t=t||"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";for(var n="",i=0;e>i;i++)n+=t.charAt(Math.floor(Math.random()*t.length));return n},generateRandomPassword:function(){return this.generateString(5)+this.generateString(2,"!$%.-_#")+this.generateString(5)},generateRandomEmail:function(){return this.generateString(12)+"@default.abine.com"},autoRegister:function(t,n){n=n||p,r.Preference.findBy("key","hasRegistered",e.bind(function(t){return t&&t.isTrue()?(n(),void 0):(r.Preference.findBy("key","registerInProgress",e.bind(function(t){return t?(n(),void 0):(r.Preference.findOrCreate({key:"regEmail"},e.bind(function(t){r.Preference.findOrCreate({key:"regPassword"},e.bind(function(i){r.Preference.batchCreateOrModify([{key:"requirePasswordToShowPassword",value:"false"},{key:"postinstallFlowNotCompleted",value:"true"}],e.bind(function(){t.value=this.generateRandomEmail(),i.value=this.generateRandomPassword(),h.set({regEmail:t.value,regPassword:i.value}),a.flush(e.bind(function(){this.register({email:t.value,password:i.value,password_confirmation:i.value,password_hint:f.getText("mm_pwhint_default")},n)},this))},this))},this))},this)),void 0)},this)),void 0)},this))},register:function(t,n){n=n||p;var i=t.password_hint,o=t.password;t.password=c.getServerPassword(o),t.password_confirmation=c.getServerPassword(t.password_confirmation),t.tag=s.tags[0],r.Preference.createOrModify({key:"registerInProgress",value:"true"},e.bind(function(s){this.licenseServer.register({user:t,application:"manageme"},e.bind(function(u,d){u?(t.password=o,t.password_confirmation=o,a.remove(s),a.flush(e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:register:failed",{err:u,serverData:d}),n(u,d)
},this))):(h.set({hasRegistered:!0}),r.Preference.batchCreateOrModify([{key:"authToken",value:d.auth_token},{key:"installAuthToken",value:d.install_auth_token},{key:"hasRegistered",value:"true"},{key:"passwordHint",value:i},{key:"rememberAccounts",value:"true"},{key:"suggestStrongPassword",value:"true"}],e.bind(function(){l.panelsModule.panelConversionCheck("open_registration_page",e.bind(function(){l.panelsModule.getNewPanels("registered",e.bind(function(){this.updateEntitlementPrefs(d.user.licenses,e.bind(function(){a.flush(e.bind(function(){c.setPassword(o,e.bind(function(){r.ShieldedEmail.create({payload:{email:t.email,guid:d.guid,userId:d.user.id}},e.bind(function(){r.DisposableEmail.create({payload:{user:d.welcome_mail.user,domain:d.welcome_mail.domain,label:"MaskMe News",guid:d.welcome_mail.guid,created_at:d.welcome_mail.created_at}},e.bind(function(){a.remove(s),a.flush(e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),this.messenger.broadcastToAllTabs("broadcast:register:success",{}),n()},this))},this))},this))},this))},this))},this))},this))},this))},this)))},this))},this))},signIn:function(t,n){n=n||p;var i=t.password;t.password=c.getServerPassword(i),r.Preference.findBy("key","regEmail",e.bind(function(a){a&&(t.reg_email=a.value),this.licenseServer.signIn({application:"manageme",user_login:t},e.bind(function(o,s){if(o)t.password=i,n(o,s);else{var u=e.bind(function(){r.Preference.batchCreateOrModify([{key:"authToken",value:s.auth_token},{key:"installAuthToken",value:s.install_auth_token},{key:"resetPasswordInProgress",value:"false"},{key:"passwordHint",value:s.password_hint}],e.bind(function(){this.updateEntitlementPrefs(s.user.licenses,e.bind(function(){this.updateHasEnabledPaymentsPref(s.user.activated_cards_at,e.bind(function(){c.setPassword(i),r.ShieldedEmail.changeUserEmail({payload:{email:s.user.email,userId:s.user.id,guid:s.guid}},e.bind(function(){r.Preference.findBy("key","hasRegistered",e.bind(function(t){!t||t.isFalse()?(h.set({hasRegistered:!0}),r.Preference.batchCreateOrModify([{key:"rememberAccounts",value:"true"},{key:"suggestStrongPassword",value:"true"},{key:"hasRegistered",value:"true"}],e.bind(function(){r.Preference.findBy("key","entitledToPhone",e.bind(function(t){l.panelsModule.getNewPanels(t&&t.isTrue()?"premium":"registered",e.bind(function(){l.syncModule.sync({silent:!0},e.bind(function(e){e||l.syncModule.saveLastSyncParams(),this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n()},this))},this))},this))},this))):(this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n())},this))},this))},this))},this))},this))},this);a&&a.value!=s.user.email?r.purgeDatabase(e.bind(function(){r.Preference.setDefaults(e.bind(function(){r.Preference.createOrModify({key:"autoOpenEditUser",value:"false"},e.bind(function(){c.once("background:securityManager:initialized",function(){u()}),c.load(null,!0)},this))},this))},this)):u()}},this))},this))},changePassword:function(t,n){var i=!1,o=t.password;t.current_password=c.getServerPassword(t.current_password),t.password=c.getServerPassword(o),t.password_confirmation=c.getServerPassword(t.password_confirmation);var s=t.password_hint;t.silent||this.messenger.broadcast("background:criticalprocess:start",{header:f.getText("mm_modal_pwHeader"),body:f.getText("mm_modal_pwBody")});var u=e.bind(function(e){t.password=o,t.password_confirmation=o,n(e,t),t.silent||this.messenger.broadcast("background:criticalprocess:error",{body:f.getText("mm_modal_pwError")})},this);t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:20}),l.syncModule.sync({silent:!0},e.bind(function(p){return p&&p.errorCode!=d.NO_ACCESS_FOR_FEATURE?(u(p),void 0):(t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:55}),this.licenseServer.changePassword({user:t},e.bind(function(d,p){d?u(d):(t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:80}),r.Preference.findBy("key","regPassword",e.bind(function(u){u&&(i=!0,a.remove(u),h.remove("regPassword"),r.Preference.createOrModify({key:"requirePasswordToShowPassword",value:"true"},function(){})),r.Preference.batchCreateOrModify([{key:"authToken",value:p.auth_token},{key:"passwordHint",value:s}],e.bind(function(){t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:90}),c.setPassword(o,e.bind(function(){l.syncModule.sync({silent:!0},e.bind(function(e){if(!t.silent){var r=f.getText("mm_modal_pwFirstSuccess");i||(r=f.getText("mm_modal_pwSuccess")),this.messenger.broadcast("background:criticalprocess:end",{header:f.getText("mm_modal_pwSuccessHeader"),body:r})}this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n(null,p)},this))},this))},this))},this)))},this)),void 0)},this))},changeEmail:function(t,n){n=n||p;var i=!1;t.silent||this.messenger.broadcast("background:criticalprocess:start",{header:f.getText("mm_modal_emHeader"),body:f.getText("mm_modal_emBody")});var o=t.current_password;t.current_password=c.getServerPassword(t.current_password),t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:20}),this.licenseServer.changeEmail({user:{email:t.email,current_password:t.current_password}},e.bind(function(s,c){s?(t.silent||(s.responseJSON&&s.responseJSON.data&&s.responseJSON.data.errors&&s.responseJSON.data.errors.email&&"has already been taken"===s.responseJSON.data.errors.email[0]?this.messenger.broadcast("background:criticalprocess:error",{body:f.getText("mm_modal_emAlreadyTaken",t.email)}):this.messenger.broadcast("background:criticalprocess:error",{body:f.getText("mm_modal_emError")})),t.current_password=o,n(s)):(t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:70}),r.Preference.createOrModify({key:"authToken",value:c.auth_token},e.bind(function(){r.Preference.findBy("key","regEmail",e.bind(function(o){o&&(i=!0,a.remove(o),h.remove("regEmail"),a.flush()),r.ShieldedEmail.changeUserEmail({payload:{email:c.user.email,guid:c.guid,userId:c.user.id}},e.bind(function(){l.syncModule.sync({silent:!0},e.bind(function(){if(!t.silent){var e=f.getText("mm_modal_emFirstSuccess");i||(e=f.getText("mm_modal_emSuccess")),this.messenger.broadcast("background:criticalprocess:end",{header:f.getText("mm_modal_emSuccessHeader"),body:e})}this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),this.messenger.broadcastToAllTabs("broadcast:register:success",{}),n(null,c)},this))},this))},this))},this)))},this))},changeEmailPassword:function(t,n){var i=t.password;t.current_password=c.getServerPassword(t.current_password),t.password=c.getServerPassword(i),t.password_confirmation=c.getServerPassword(t.password_confirmation);var o=t.password_hint;t.silent||this.messenger.broadcast("background:criticalprocess:start",{header:f.getText("mm_modal_acHeader"),body:f.getText("mm_modal_acBody")});var s=e.bind(function(e){t.password=i,t.password_confirmation=i,n(e,t),t.silent||this.messenger.broadcast("background:criticalprocess:error",{body:f.getText("mm_modal_acError")})},this);t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:30}),this.licenseServer.changeEmailPassword({user:t},e.bind(function(u,d){return u?(s(u),void 0):(t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:70}),r.Preference.findBy("key","regPassword",e.bind(function(s){s&&(a.remove(s),h.remove("regPassword"),r.Preference.createOrModify({key:"requirePasswordToShowPassword",value:"true"},function(){})),r.Preference.findBy("key","regEmail",e.bind(function(s){s&&(h.remove("regEmail"),a.remove(s)),r.ShieldedEmail.changeUserEmail({payload:{email:d.user.email,guid:d.guid,userId:d.user.id}},e.bind(function(){r.Preference.batchCreateOrModify([{key:"authToken",value:d.auth_token},{key:"passwordHint",value:o}],e.bind(function(){t.silent||this.messenger.broadcast("background:criticalprocess:update",{percent:90}),c.setPassword(i,e.bind(function(){var i="",r=[{img:"deviantart",url:"https://www.deviantart.com/join/?joinpoint=standard&utm_source=DA&utm_medium=UB&utm_campaign=DA_UB_JoinNow_091409&utm_content=JoinNow",tooltip:"deviantart.com - An online community for professional & amateur artists."},{img:"dribbble",url:"https://dribbble.com/signup/scouts#designer-signup",tooltip:"dribbble.com - A show & tell for graphic designers."},{img:"dropbox",url:"https://www.dropbox.com/",tooltip:"dropbox.com - Store all your stuff online & access it from anywhere."},{img:"ebay",url:"https://scgi.ebay.com/ws/eBayISAPI.dll?RegisterEnterInfo",tooltip:"ebay.com - Online auctions for just about anything."},{img:"imdb",url:"https://secure.imdb.com/register-imdb/form-v2?ref_=nb_usr_reg",tooltip:"imdb.com - Everything you want to know about movies."},{img:"kongregate",url:"http://www.kongregate.com/accounts/new",tooltip:"kongregate.com - Play free games online, right from your browser."},{img:"livingsocial",url:"https://login.livingsocial.com/signup",tooltip:"livingsocial.com - Daily deals for your city."},{img:"mapmyrun",url:"https://www.mapmyrun.com/auth/signup/",tooltip:"mapmyrun.com - Keep track of your runs & workouts."},{img:"nytimes",url:"https://myaccount.nytimes.com/register",tooltip:"nytimes.com - The respected news organization."},{img:"overstock",url:"https://www.overstock.com/myaccount",tooltip:"overstock.com - An online discount shopping website."},{img:"pandora",url:"http://www.pandora.com/account/register",tooltip:"pandora.com - A music streaming & discovery website."},{img:"pinterest",url:"https://pinterest.com/join/register/email/",tooltip:"pinterest.com - A photo-sharring, pinboard site for creative people around the world."},{img:"rdio",url:"https://www.rdio.com/account/signup/",tooltip:"rdio.com - A beautifully designed music streaming service."},{img:"rottentomatoes",url:"https://www.rottentomatoes.com/register/",tooltip:"rottentomatoes.com - Movie news & review ratings aggregation."},{img:"skype",url:"https://login.skype.com/account/signup-form",tooltip:"skype.com - Make phone or video calls from your computer."},{img:"twitter",url:"https://twitter.com/",tooltip:"twitter.com - A micro-blogging social network. tweet tweet."},{img:"vimeo",url:"https://vimeo.com/join",tooltip:"vimeo.com - A high quality video sharing website."},{img:"zappos",url:"https://secure-www.zappos.com/register?checkout=true",tooltip:"zappos.com - Buy shoes & clothing online, with free shipping & returns."}],i="<div style='margin-top:20px;text-align:center;'>",a=0;e.each(r,function(e){a>0&&0==a%6&&(i+="<br/>"),i+="<a href='"+e.url+"' target='_blank'><img src='https://d1p4fa0g2cgyhv.cloudfront.net/images/maskme/icons/maskme_"+e.img+".png' data-toggle='tooltip' data-animation='false' title='"+e.tooltip+"' /></a>",a++}),i+="</div>",t.silent||this.messenger.broadcast("background:criticalprocess:end",{header:f.getText("mm_modal_acSuccessHeader"),body:f.getText("mm_modal_acSuccess"),extra:i}),this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n(null,d)},this))},this))},this))},this))},this)),void 0)},this))},deleteUser:function(t,n){n=n||p,this.licenseServer.deleteUser({shielded_phone_id:t.shielded_phone_id,disposable_phone_id:t.disposable_phone_id,shielded_email_guid:t.shielded_email_guid},e.bind(function(t,i){t?(true&&ABINEMASKME.log.error("There was a problem deleting the user."),n(t,i)):r.Preference.batchCreateOrModify([{key:"authToken",value:null},{key:"uninstalled",value:"true"},{key:"autoLockOnRestart",value:"false"}],e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n(null,i)},this))},this))},refreshEntitlements:function(t){t=t||p,this.licenseServer.refreshEntitlements({},e.bind(function(n,i){n?t(n,i):this.updateEntitlementPrefs(i.user.licenses,e.bind(function(){this.updateHasEnabledPaymentsPref(i.user.activated_cards_at,e.bind(function(){a.flush(e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),t(null,i)},this))},this))},this))},this))},referralCode:function(t){t=t||p,this.licenseServer.referralCode({},e.bind(function(e,n){e?t(e,n):t(null,n)},this))},updateEntitlementPrefs:function(t,n){n=n||p;var i={entitledToSync:"sync",entitledToPhone:"protected_phone",entitledToPayments:"payments"},o={},s={},c=function(e){return e.key in i};r.Preference.listCached(c,e.bind(function(c){e.each(c,function(e){o[i[e.key]]=e});for(var u in i)i[u]in o||(o[i[u]]=new r.Preference({key:u,value:"false"}),a.add(o[i[u]]));var d=o.protected_phone.isTrue(),l=o.payments.isTrue();e.each(t,function(e){o[e.feature_code]&&o[e.feature_code].setTrue(),s[e.feature_code]=1}),e.each(e.keys(o),function(e){e in s||o[e].setFalse()}),d&&o.protected_phone.isFalse()&&(r.ShieldedPhone.all().destroyAll(),r.DisposablePhone.all().destroyAll()),!l&&o.payments&&o.payments.isTrue()&&this.refreshLastFourCardDigits(),l&&o.payments.setTrue(),e.each(c,function(e){a.forceAdd(e)}),a.flush(function(){n()})},this))},updateHasEnabledPaymentsPref:function(e,t){t=t||p(),r.Preference.findBy("key","hasEnabledPayments",function(n){n&&n.isTrue()!=Boolean(e)&&(e?n.setTrue():n.setFalse()),t()})},activatedCards:function(t,n){n=n||p,l.panelsModule.panelConversionCheck("open_activate_cards_page",e.bind(function(){this.licenseServer.saveActivatedCardsDate({},e.bind(function(t){t?n(t):r.Preference.batchCreateOrModify([{key:"suggestProtectedCard",value:"true",category:"forms"},{key:"hasEnabledPayments",value:"true"},{key:"confirmProtectedCard",value:"true",category:"forms"}],e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n()},this))},this))},this))},postInstallCompleted:function(t,n){n=n||p,r.Preference.findBy("key","postinstallFlowNotCompleted",e.bind(function(i){i&&(a.remove(i),a.flush(e.bind(function(){t.silent||this.licenseServer.savePostInstallCompletedDate({},e.bind(function(e){e?n(e):n()},this))},this)))},this))},sendResetPasswordEmail:function(t,n){n=n||p,this.licenseServer.sendResetPasswordEmail({email:t.email},e.bind(function(e,t){e?n(e,t):n(null,t)},this))},refreshLastFourCardDigits:function(t,n){n=n||p,this.licenseServer.billingInfo({},e.bind(function(t,i){t?n(t,i):r.ShieldedCard.index(null,e.bind(function(t){if(t&&t[0]){var o=t[0];o.last_four=i.last_four,o.first_name=i.first_name,o.last_name=i.last_name,o.month=i.month,o.year=i.year,o.card_type=i.card_type,o.zip=i.zip,a.flush(e.bind(function(){this.messenger.broadcast("broadcast:billinginfo:updated",{}),n(null,i)},this))}else r.ShieldedCard.create({payload:i},e.bind(function(){this.messenger.broadcast("broadcast:billinginfo:updated",{}),n(null,i)},this))},this))},this))},sendFeedbackEmail:function(t,n){n=n||p,this.licenseServer.sendFeedbackEmail(t,e.bind(function(e,t){e?n(e):n(null,t)},this))},enableEntitlements:function(t,n){n=n||p,t?r.Preference.batchCreateOrModify([{key:"entitledToSync",value:t.sync},{key:"entitledToPhone",value:t.phone},{key:"entitledToPayments",value:t.payments}],e.bind(function(){1==t.mask_me_plus?l.panelsModule.panelConversionCheck("open_plans_page",e.bind(function(){l.panelsModule.getNewPanels("premium",e.bind(function(){this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n()},this))},this)):(this.messenger.broadcastToAllTabs("broadcast:preference:reload",{}),n())},this)):n()}}),v=new y({});return l.licenseModule=v,v}),ABINEMASKME.define("abine/modules/panels",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","abine/ajax","abine/config","abine/securityManager","abine/mappingServer","abine/responseCodes","modules","abine/licenseServer"],function(e,t,n,i,r,a,o,s,c,u,d,l,h){var f=function(){},p=n.BaseClass.extend({initialize:function(e){this.mappingServer=e.mappingServer||new u,this.licenseServer=e.licenseServer||new h},ensureDynamicPanels:function(t){t=t||f,r.Preference.batchFindBy([{by:"key",value:"dynamicPanels"},{by:"key",value:"hasRegistered"},{by:"key",value:"entitledToPhone"}],e.bind(function(e){!e.dynamicPanels||e.dynamicPanels.isEmpty()?e.hasRegistered&&e.hasRegistered.isTrue()?e.entitledToPhone&&e.entitledToPhone.isTrue()?this.getNewPanels("premium",function(){t()}):this.getNewPanels("registered",function(){t()}):t():t()},this))},setupDynamicPanels:function(t,n){n=n||f,this.mappingServer.getPanels({browser:s.browser,tag:s.tags[0],user_state:t?t:"unregistered"},e.bind(function(e,t){e?n():r.Preference.createOrModify({key:"dynamicPanels",value:JSON.stringify(t)},function(){var e;t.panels.forEach(function(t){e=new r.PanelActivity({panelId:t.id,impressions:0,users:1,clicks:0,completions:0}),a.add(e)}),a.flush(function(){n()})})},this))},panelConversionCheck:function(t,n){n=n||f,r.Preference.findBy("key","dynamicPanels",function(i){if(i){var o=JSON.parse(i.value);if(o&&o.panels){var s="/nopanel";ABINEMASKME.lastPanel&&ABINEMASKME.lastPanel[t]&&(s=ABINEMASKME.lastPanel[t]);var c=e.find(o.panels,function(e){return e.field_type==s});c?r.PanelActivity.all().filter("panelId","=",c.id).one(function(e){e.completions++,a.flush(function(){n()})}):n()}else n()}else n()})},getNewPanels:function(t,n){n=n||f,this.sendPanelActivity(e.bind(function(){r.PanelActivity.all().list(e.bind(function(i){e.each(i,function(e){a.remove(e)}),a.flush(e.bind(function(){this.setupDynamicPanels(t,n)},this))},this))},this))},updatePanelShowRates:function(t){t=t||f,r.DisposableEmail.all().list(function(n){var i=n.length;r.Preference.findBy("key","dynamicPanels",function(n){if(n){var r=JSON.parse(n.value);e.each(r.panels,function(e){i>=e.masked_emails&&(e.masked_emails=0)}),n.value=JSON.stringify(r),a.flush(function(){t()})}else t()})})},sendPanelActivity:function(t){function n(){t&&t(),t=null}r.PanelActivity.all().list(e.bind(function(t){var i={},o={};r.Preference.findBy("key","shouldSendErrorReports",e.bind(function(r){r&&r.isTrue()?(e.each(t,function(e){e.isMarketingPanel()&&e.hasData()?(i.panel_data||(i.panel_data={}),i.panel_data[e.panelId]=e.toJSON()):!e.isMarketingPanel()&&e.hasData()&&(o.panel_data||(o.panel_data={}),o.panel_data[e.panelId]=e.toJSON())}),o.panel_data&&this.licenseServer.sendPanelActivity(o,function(i){i?n():(e.each(t,function(e){!e.isMarketingPanel()&&e.hasData()&&e.reset()}),a.flush(function(){n()}))}),this.mappingServer.sendPanelActivity(i,function(i){i?n():(e.each(t,function(e){e.isMarketingPanel()&&e.hasData()&&e.reset()}),a.flush(function(){n()}))})):n()},this))},this))}}),m=new p({});return l.panelsModule=m,m}),ABINEMASKME.define("abine/modules/mappings",["documentcloud/underscore","abine/core","abine/timer","storage","persistence","abine/ajax","abine/config","abine/securityManager","persistence/autodate","abine/mappingServer","modules"],function(e,t,n,i,r,a,o,s,c,u,d){var l=function(){},h=864e5,f=function(){var e=new Date;return e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setMilliseconds(0),e},p=t.BaseClass.extend({initialize:function(e){this.mappingServer=e.mappingServer||new u},startDailyMappingCheck:function(t){t=t||l,i.Preference.findBy("key","lastMappingCheck",e.bind(function(e){if(e&&e.value){var n=new Date(parseInt(e.value));n.valueOf()<(new Date).getTime()-h?this.makeDailyMappingCheck(t):this.startDailyMappingCheckTimeout(t)}else this.makeDailyMappingCheck(t)},this))},sendMaskedFormData:function(t){t=t||l,i.FormData.query(null,e.bind(function(n){var a=[];e.each(n,function(e){a.push({dataType:e.dataType,value:e.value,domain:e.domain,form_signature:e.form_signature,formType:e.formType,field_signature:e.field_signature})}),a.length>0?r.transaction(e.bind(function(n){n.executeSql("delete from FormData;"),i.Preference.findBy("key","shouldSendErrorReports",e.bind(function(e){e&&e.isTrue()?this.mappingServer.sendFormData({updates:a},function(){t()}):t()},this))},this)):t()},this))},makeDailyMappingCheck:function(t){t=t||l,d.panelsModule.updatePanelShowRates(e.bind(function(){this.sendMaskedFormData(e.bind(function(){d.panelsModule.sendPanelActivity(e.bind(function(){this.mappingServer.getMappingManifest({},e.bind(function(n,a){if(n)t();else{var o=[],s={},c=[],u=[],d=[],l=[];i.MappedForm.query(null,e.bind(function(n){function h(t){return e.each(t,function(e,n){t[n]="'"+e.replace(/\'/g,"''")+"'"}),t.join(",")}if(e.each(n,function(e){a.manifest[e.signature]&&(a.manifest[e.signature]!=e.mapping_signature?c.push(e.id):s[e.signature]=e.mapping_signature)}),c.length>0){var f=h(c);l.push("delete from MappedForm where id in ("+f+")"),l.push("delete from MappedField where formId in ("+f+")")}return e.each(e.keys(a.manifest),function(e){s[e]||o.push(e)}),0==o.length?(this.writeDailyMappingCheckPref(e.bind(function(){this.startDailyMappingCheckTimeout(function(){t()})},this)),void 0):(this.mappingServer.getFormMappings({signatures:o},e.bind(function(n,a){if(n)t();else{if(e.each(a.forms,function(t){if(e.indexOf(o,t.signature)>=0){var n=new i.MappedForm({domain:t.domain,signature:t.signature,mapping_signature:t.mapping_signature,formType:t.formType});u.push("("+h([n.id,n.domain,n.signature,n.mapping_signature,n.formType])+")"),e.each(t.fields,function(e){var t=new i.MappedField({formId:n.id,signature:e.signature,dataType:e.dataType});d.push("("+h([t.id,t.formId,t.signature,t.dataType])+")")})}}),u.length>0){var s=1;for("undefined"!=typeof Components&&(s=500);u.length>0;){var c=u.splice(0,s);l.push("insert into MappedForm values "+c.join(","))}for(;d.length>0;){var c=d.splice(0,s);l.push("insert into MappedField values "+c.join(","))}}r.transaction(e.bind(function(n){for(var i=(Date.now(),0);l.length>i;i++)n.executeSql(l[i]+";");r.flush(e.bind(function(){this.writeDailyMappingCheckPref(e.bind(function(){this.startDailyMappingCheckTimeout(function(){t()})},this))},this))},this))}},this)),void 0)},this))}},this))},this))},this))},this))},writeDailyMappingCheckPref:function(e){e=e||l,i.Preference.findOrCreate({key:"lastMappingCheck"},function(t){t.value=Math.floor(f().valueOf()),t.modifiedAt=f(),r.flush(function(){e()})})},removeDailyMappingCheckPref:function(e){e=e||l,i.Preference.findBy("key","lastMappingCheck",function(t){t?(r.remove(t),r.flush(function(){e()})):e()})},startDailyMappingCheckTimeout:function(t){t=t||l;var i=f().valueOf()+h;i-Date.now()+36e5+144e5*Math.random(),this.dailyMappingCheckTimeout&&n.clearTimeout(this.dailyMappingCheckTimeout),this.dailyMappingCheckTimeout=n.setTimeout(e.bind(function(){this.makeDailyMappingCheck()},this),h),t()}}),m=new p({});return d.mappingsModule=m,m}),ABINEMASKME.define("abine/modules/criticalProcess",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","modules"],function(e,t,n,i,r,a,o){var s=function(){},c=n.BaseClass.extend({initialize:function(e,t){t=t||s},setMessenger:function(e){this.messenger=e},start:function(e){this.messenger.broadcast("background:criticalprocess:start",e)},end:function(e){this.messenger.broadcast("background:criticalprocess:end",e)},update:function(e){this.messenger.broadcast("background:criticalprocess:update",e)},askForReview:function(e){this.messenger.broadcast("background:criticalprocess:review",e)},error:function(e){this.messenger.broadcast("background:criticalprocess:error",e)}}),u=new c({});return o.criticalProcess=u,u}),ABINEMASKME.define("abine/modules/sync",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","abine/ajax","abine/config","abine/securityManager","abine/syncMerge","persistence/autodate","abine/window","abine/licenseServer","abine/syncServer","abine/responseCodes","modules","abine/intl"],function(e,t,n,i,r,a,o,s,c,u,d,l,h,f,p,m,g){var y={AccountActivity:"all",AccountField:"latest = 1",Accounts:"all",DisposableEmails:"all",DisposablePhones:"all",DisposableCards:"all",Preferences:"key <> 'autoUnlockPassword'",ShieldedEmails:"all",ShieldedPhones:"all",ShieldedCards:"all",Sites:"all"},v=function(){},b=n.BaseClass.extend({initialize:function(e){this.options=e,this.syncServer=this.options.syncServer||new f},silentSync:function(e,t){this.sync({silent:!0},t)},sync:function(t,n){n=n||function(){},r.Preference.batchFindBy([{by:"key",value:"regEmail"},{by:"key",value:"regPassword"}],e.bind(function(i){var r=t&&t.silent;if(!r){var a=g.getText("mm_modal_didYouKnow");(i.regEmail||i.regPassword)&&(a=g.getText("mm_modal_remember")),m.criticalProcess.start({header:g.getText("mm_modal_syncingData"),body:g.getText("mm_modal_pleaseWaitSync"),extra:a})}var o=function(e){var i="",a="";e.errorCode==p.UPGRADE_REQUIRED?(a=g.getText("mm_modal_syncIC"),"Firefox"==s.browser?i+=g.getText("mm_modal_syncICMsgFF"):i=g.getText("mm_modal_syncICMsg")):e.errorCode==p.NO_CLIENT_DATA_FOUND?(a=g.getText("mm_modal_serversDown"),i=g.getText("mm_modal_syncSDMsg")):e.errorCode==p.MISSING_PARAMETERS?(a=g.getText("mm_modal_serversDown"),i=g.getText("mm_modal_syncSDMsg")):e.errorCode==p.DOWNGRADE_SCHEMA_NOT_ALLOWED?(a=g.getText("mm_modal_syncIC"),"Firefox"==s.browser?i+=g.getText("mm_modal_syncICMsgFF"):i=g.getText("mm_modal_syncICMsg")):e.errorCode==p.SAVE_CLIENT_DATA_ERROR?(a=g.getText("mm_modal_serversDown"),i=g.getText("mm_modal_syncSDMsg")):e.errorCode==p.UNKNOWN_ERROR?(a=g.getText("mm_modal_serversDown"),i=g.getText("mm_modal_syncSDMsg")):e.errorCode==p.UNAUTHORIZED?(a=g.getText("mm_modal_syncAF"),i=g.getText("mm_modal_syncAFMsg")):(a=g.getText("mm_modal_serversDown"),i=g.getText("mm_modal_syncSDMsg")),r||m.criticalProcess.error({body:i,header:a}),n(e,t)};this.syncPull(e.bind(function(a){a?o(a):(r||m.criticalProcess.update({percent:60}),this.syncPush(e.bind(function(e,a){if(e)o(e);else{if(!r){m.criticalProcess.update({percent:90});var s=g.getText("mm_modal_safeCloud");(i.regEmail||i.regPassword)&&(s=g.getText("mm_modal_safeCloudReg")),a&&parseInt(a)>0&&0==parseInt(a)%10&&m.criticalProcess.askForReview({}),m.criticalProcess.end({header:g.getText("mm_modal_syncSuccess"),body:s})}n(null,t)}},this)))},this))},this))},syncPull:function(t){t=t||function(){},this.syncServer.getClientDataHeaderFromServer({schema_version:ABINEMASKME.schemaVersion},e.bind(function(n,i){if(n)t(n);else{if(!i.client_data)return t(),void 0;r.Preference.findBy("key","lastDataVersion",e.bind(function(n){!n||n.isEmpty()||parseInt(i.client_data.version)>parseInt(n.value)?this.syncServer.getClientDataFromServer({id:i.client_data.id},e.bind(function(n,i){if(n)t(n);else{var r=new u.SyncMerge,a=i.client_data;r.mergeClientData(a.data,a.version,a.schema_version,e.bind(function(){this.saveLastDataVersion(i.client_data.version,t)},this))}},this)):this.updatePushVersion(parseInt(i.client_data.version)+1,t)},this))}},this))},updatePushVersion:function(t,n){n=n||v,e.defer(function(){r.Preference.updatePushVersion(t,function(){r.Site.updatePushVersion(t,function(){r.ShieldedEmail.updatePushVersion(t,function(){r.ShieldedPhone.updatePushVersion(t,function(){r.ShieldedCard.updatePushVersion(t,function(){r.Account.updatePushVersion(t,function(){r.AccountField.updatePushVersion(t,function(){r.AccountActivity.updatePushVersion(t,function(){r.DisposableEmail.updatePushVersion(t,function(){r.DisposablePhone.updatePushVersion(t,function(){r.DisposableCard.updatePushVersion(t,function(){a.flush(function(){n.call()})})})})})})})})})})})})})},saveLastSyncParams:function(t){t=t||v,r.Preference.findOrCreate({key:"lastSync"},e.bind(function(e){e.value=Date.now(),a.flush(function(e,n){t(n)})},this))},saveLastDataVersion:function(t,n){n=n||v,r.Preference.findOrCreate({key:"lastDataVersion"},e.bind(function(e){e.value=t,a.flush(function(e,i){n(i,t)})},this))},syncPush:function(t){t=t||v,this.isSyncDirty(e.bind(function(n){n?this.dumpDatabaseForSync(e.bind(function(n){this.syncServer.pushClientDataToServer({client_data:{data:n,schema_version:ABINEMASKME.schemaVersion}},e.bind(function(n,i){n?t(n):this.saveLastDataVersion(i.client_data.version,e.bind(function(n,i){this.saveLastSyncParams(e.bind(function(){t(n,i)},this))},this))},this))},this)):this.saveLastSyncParams(t)},this))},dumpDatabaseForSync:function(e){e=e||v,a.dumpDatabaseForSync(y,e)},isSyncDirty:function(t){t=t||v,r.Preference.findBy("key","lastLocalModifiedAt",e.bind(function(n){r.Preference.findBy("key","lastSync",e.bind(function(e){var i=0;e&&!e.isEmpty()&&(i=parseInt(e.value)),t(!n||parseInt(n.value)>i||d.dirtyStatePendingSave)},this))},this))}}),E=new b({});return E.ENTITIES_TO_SYNC=y,m.syncModule=E,E}),ABINEMASKME.define("abine/modules/payments",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","modules","abine/paymentsServer"],function(e,t,n,i,r,a,o,s){var c=function(){},u=n.BaseClass.extend({initialize:function(e){this.paymentsServer=e.paymentsServer||new s},resendGiftCardEmail:function(t,n){n=n||c,r.ShieldedCard.index(null,e.bind(function(i){if(i&&i[0]){var r=i[0].first_name+" "+i[0].last_name;this.paymentsServer.resendGiftCardEmail({card_guid:t.card_guid,sender_name:r,recipient_email:t.recipient_email},e.bind(function(e,t){e?n(e,t):n(null,t)},this))}},this))},retrieveDisposableCardBalance:function(e,t){t=t||c,this.paymentsServer.getAuthorizations({card_id:e.guid},function(e,n){e?t(e,n):t(null,n)})}}),d=new u({});return o.paymentsModule=d,d}),ABINEMASKME.define("abine/modules/phone",["documentcloud/underscore","jquery","abine/core","abine/timer","storage","persistence","modules","abine/phoneServer"],function(e,t,n,i,r,a,o,s){var c=function(){},u=n.BaseClass.extend({initialize:function(e){this.phoneServer=e.phoneServer||new s},clearPhoneData:function(t,n){n=n||c,r.ShieldedPhone.index(null,function(t){e.each(t,function(e){a.remove(e)}),r.DisposablePhone.index(null,function(t){e.each(t,function(e){a.remove(e)}),a.flush(function(){o.syncModule.sync({silent:!0},e.bind(function(){n(null,{})},this))})})})}}),d=new u({});return o.phoneModule=d,d}),ABINEMASKME.define("modules",[],function(){return{}}),ABINEMASKME.require("abine/modules/license"),ABINEMASKME.require("abine/modules/payments"),ABINEMASKME.require("abine/modules/panels"),ABINEMASKME.require("abine/modules/phone"),ABINEMASKME.require("abine/modules/mappings"),ABINEMASKME.require("abine/modules/criticalProcess"),ABINEMASKME.require("abine/modules/sync"),ABINEMASKME.require(["documentcloud/underscore","abine/window","abine/backgroundMessenger","abine/backgroundInit","abine/eventLogger","abine/stubs","abine/contextMenu"],function(e,t,n,i,r,a,o){function s(){try{chrome.runtime&&chrome.runtime.onMessageExternal&&chrome.runtime.onMessageExternal.addListener(function(e,t,n){if(t.id in ABINEMASKME.DNTME_EXTENSION_IDS||"development"==ABINEMASKME.config.environment)if(e.message&&"ping"!=e.message){if("open_dashboard"==e.message)c(),n({success:!0});else if("can_export"==e.message)n(!0);else if("export_to_dntme"==e.message)return ABINEMASKME.require(["abine/securityManager","storage"],function(e,t){e.isLocked()?n({success:!1,message:"unlock required"}):t.Export.index(null,function(e){n({success:!0,data:e})})}),!0}else n({installed:!0})});for(var e in ABINEMASKME.DNTME_EXTENSION_IDS)chrome.runtime.sendMessage(e,{message:"ping"})}catch(t){}}function c(){t.createTab({localUrl:"pages/index.html"})}function u(){chrome.tabs.query({url:chrome.extension.getURL("test/spec_runner.html")},function(e){1>e.length&&t.createTab({localUrl:"test/spec_runner.html"})})}ABINEMASKME.DNTME_EXTENSION_IDS={epanfjkfahimkgomnigadpkobaefekcd:1,amkeiedlemmabfclbdkalidkolgdphij:1},ABINEMASKME.userAgent=window.navigator.userAgent;var d=new n.BackgroundMessenger;i.once("storage:initialized",function(){chrome.browserAction.onClicked.addListener(function(){"development"===ABINEMASKME.config.environment&&u(),c()}),o.contextMenuHelper.init(d)}),i.initialize(d);var l=new n.BackgroundMessenger;l.on("test:respond",function(e,t){l.send("test:response",{status:"ok"},t)}),chrome.extension.onRequest.addListener(function(e,t){function n(e){if(!(e>=i.length)){if(i[e].file)var r=i[e];else var r={file:i[e],allFrames:!0,runAt:"document_idle"};chrome.tabs.executeScript(t.tab.id,r,function(){n(e+1)})}}if("injectContentScript"==e.eventName){var i=["almond-min.js","jquery-min.js","underscore-min.js","backbone-min.js"];i.push(e.payload),n(0)}else"processFormsInNewFrame"==e.eventName&&d.send("contentManager:processNewFrame",e.frame_id,t.tab.id)}),chrome.tabs.onRemoved.addListener(function(e){a.tabClosed(e)}),s();{Date.now()-ABINEMASKME.startTime}});