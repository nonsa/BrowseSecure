Function.prototype.delay=function(a,b,c){var d=this;return setTimeout(function(){d.apply(b,c)},a)};Function.prototype.periodical=function(a,b,c){var d=this;return setInterval(function(){d.apply(b,c)},a)};
window.onerror=function(a,b,c){var d=window.location.protocol+"//"+window.location.host;if(0>b.indexOf(d)||0<=b.indexOf(d)&&0<b.indexOf("background.html"))return!1;Crossrider.Utils.internalDebug("JAVASCRIPT ERROR");Crossrider.Utils.internalDebug("ERROR MESSAGE:"+a);Crossrider.Utils.internalDebug("ON FILE: "+b+" IN LINE NUMBER "+c);try{d="";if(0<a.indexOf(":"))var e=a.replace("Uncaught ","").trim().split(":"),d=e[0].trim(),a=e[1].trim();var f=chrome.extension.getURL("manifest.json").replace("manifest.json",
""),b=b.replace(f,""),j="msg="+escape(a)+"&errtype="+escape(d),j=j+("&fileName="+escape(b)+"&lineNumber="+escape(c));Crossrider._reportError(j)}catch(g){Crossrider.Utils.internalDebug("window.onerror Error : "+g.message)}return!1};
var Crossrider={manifest:{},_tabs:{},debug:!1,_userCode:"",_bgCode:"",_faye:{client:null,callbacks:{background:{}},asyncCallbacks:{}},_plugins:{},_contextMenus:{},_cookies:{},_tabsUrlsByIds:{},_onBeforeRequestUserCallbacksQueue:[],_notifications:{},_cookieInUpdate:{},_firstLoad:!1,_isBgFinishInit:!1,isStaging:!1,isDuringUpdate:!1,UPDATE_INTERVAL:360,init:function(){this._loadLocalManifest();this._initInternalMessaging();this._initStorage();chrome.tabs.onRemoved.addListener(function(a){this._unsubscribeAllInTab(a);
delete this._tabsUrlsByIds[a]}.bind(this));chrome.tabs.onSelectionChanged.addListener(this._onTabSelectionChanged.bind(this))},_setInstallationTime:function(a,b){try{var c=this._cookies[TableNames.USER_COOKIES].InstallationTime;"undefined"===typeof c?(c=a||Math.round((new Date).getTime()/1E3),this.setCookie("InstallationTime",c,new Date(2030,1,1,0,0,0,0),TableNames.USER_COOKIES,void 0,b)):b&&b()}catch(d){Crossrider.Utils.internalDebug("_setInstallationTime Error : "+d.message)}},_initStorage:function(){for(var a in TableNames)0>
a.toLowerCase().indexOf("length")&&(Crossrider._cookies[TableNames[a]]={});CookieStore.init(this.appID,[TableNames.USER_COOKIES,TableNames.INTERNAL_DB],function(){DataStore.init(this.appID,function(){DataStore.Plugins.getData(this._onPluginsRead.bind(this))}.bind(this))}.bind(this))},_onPluginsRead:function(a,b){this._plugins=a;b||CookieStore.getCookies(this._onCookiesRead.bind(this),[TableNames.USER_COOKIES,TableNames.INTERNAL_DB])},_onCookiesRead:function(a){for(var b in a)a.hasOwnProperty(b)&&
(this._cookies[b]=a[b]||{});this._cookies[TableNames.USER_COOKIES].hasOwnProperty("mysite")||(this._cookies[TableNames.USER_COOKIES].mysite={});this._startApplication()},_startApplication:function(){this.debug?(this._loadRemoteManifest(),!this._plugins.hasOwnProperty("plugins_version")||this._plugins.hasOwnProperty("plugins_version")&&0==this._plugins.plugins_version?this.downloadAndSavePluginsInfo(this.manifest.pluginsurl,this.manifest.pluginsver,!1,function(){this._getSiteCookies()}.bind(this)):
this._getSiteCookies()):DataStore.getData(this.appID,this._onAppDataLoad.bind(this))},_getSiteCookies:function(){if(void 0!==this.manifest.domain&&null!==this.manifest.domain){var a=this.manifest.domain;0!=a.indexOf("http")&&(a="http://"+a);chrome.cookies.getAll({url:a,domain:this.manifest.domain},function(a){if(a&&a.length)for(var c=0,d=a.length;c<d;c++){var e=a[c],f=void 0!==e.expirationDate?(new Date(1E3*e.expirationDate)).getTime():null;this._cookies[TableNames.USER_COOKIES].mysite[e.name]={value:e.value,
expires:f}}this.setToolbarUniqueID()}.bind(this))}else this.setToolbarUniqueID()},_setInstallationData:function(a){Crossrider._setInstallationParams(function(){Crossrider._setInstallationThankYouPage(function(){a()})})},_setInstallationParams:function(a){!Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallerParams")&&Crossrider.manifest.crossrider.hasOwnProperty("InstallerParams")?Crossrider.setCookie("InstallerParams",Crossrider.manifest.crossrider.InstallerParams,new Date(2030,
1,1,0,0,0,0),TableNames.USER_COOKIES,void 0,a):a()},_setInstallationThankYouPage:function(a){!Crossrider._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallationThankYouPage")&&Crossrider.manifest.crossrider.hasOwnProperty("InstallationThankYouPage")?Crossrider.setCookie("InstallationThankYouPage",Crossrider.manifest.crossrider.InstallationThankYouPage,new Date(2030,1,1,0,0,0,0),TableNames.USER_COOKIES,void 0,a):a()},_initAppAPI:function(){window.appAPI=new AppApi;window.appAPI.init(this._cookies);
chrome.cookies.onChanged.addListener(this._onCookieChange.bind(this));this._loadUserScript();this._loadBackgroundScript();this._firstLoad="false"!==localStorage.firstLoad;var a=this;if(this._firstLoad)this._setInstallationData(function(){a._setInstallationTime(void 0,function(){var b=document.createEvent("Events");b.initEvent("cr_ready",!0,!1);document.dispatchEvent(b);a._isBgFinishInit=!0;a.debug||(a._reportInstall(),a._reportUpdate(),a._sendDailyStats(),a._showThankyouPage(),localStorage.firstLoad=
"false")})});else{var b=document.createEvent("Events");b.initEvent("cr_ready",!0,!1);document.dispatchEvent(b);this._isBgFinishInit=!0}this.debug||this._checkNextUpdate.periodical(6E4,this)},_onAppDataLoad:function(a){var b=localStorage.crx_version;a.manifest&&a.app&&b===this.manifest.version?(this._parseManifestXML(a.manifest.value),this._user_script=a.app||{value:"",version:this.manifest.ver},this._bg_script=a.bg_script||{value:"",version:this.manifest.backgroundver},this._getSiteCookies()):this._updateAppAndManifest(!0)||
setTimeout(function(){Crossrider._onAppDataLoad(a)},6E4)},_loadLocalManifest:function(){var a=chrome.extension.getURL("manifest.json"),b=a.replace(/chrome\-extension\:\/\//,"");this.extensionID=b.substr(0,b.indexOf("/"));this.manifest=JSON.parse(Crossrider.Utils.fetchScript(a));this.manifest.platform="CH";this.debug=this.manifest.crossrider.hasOwnProperty("debug")?this.manifest.crossrider.debug:!1;this.appID=this.manifest.crossrider.appID;localStorage.hasOwnProperty("forceDebug")&&"true"===localStorage.getItem("forceDebug")&&
localStorage.hasOwnProperty("internaldebug_userCode")&&localStorage.hasOwnProperty("internaldebug_backgroundCode")&&(this.debug=this.manifest.crossrider.debug=!0,this.manifest.crossrider.user_script=localStorage.getItem("internaldebug_userCode"),this.manifest.crossrider.background_script=localStorage.getItem("internaldebug_backgroundCode"));this.manifest.crossrider.hasOwnProperty("is_staging")&&(this.isStaging=this.manifest.crossrider.is_staging)},getIntrnalDebugUrls:function(a){a({userCode:localStorage.hasOwnProperty("internaldebug_userCode")?
localStorage.getItem("internaldebug_userCode"):"",backgroundCode:localStorage.hasOwnProperty("internaldebug_backgroundCode")?localStorage.getItem("internaldebug_backgroundCode"):""})},switchInternalDebug:function(a,b){a?(localStorage.setItem("forceDebug",!0),localStorage.setItem("internaldebug_userCode",b.userCode),localStorage.setItem("internaldebug_backgroundCode",b.backgroundCode)):localStorage.setItem("forceDebug",!1);this.reload()},_loadRemoteManifest:function(a){var b=parseFloat(Crossrider.manifest.version).toString(),
b=b.replace(/\./g,"_"),c="https://crossrider.cotssl.net/plugin/apps/"+this.appID+"/manifest/"+b+"/ch/manifest.xml";this.isStaging&&(c="http://static-staging.crossrider.com/plugin/apps/"+this.appID+"/manifest/"+b+"/ch/manifest.xml");this.manifest&&this.manifest.manifest&&(c=this.manifest.manifest);a&&(c=0<c.indexOf("?")?c+("&rnd="+(new Date).getTime()):c+("?rnd="+(new Date).getTime()));(a=Crossrider.Utils.fetchScript(c))&&this._parseManifestXML(a);return a},getScript:function(a,b,c){b&&(a=0<a.indexOf("?")?
a+("&rnd="+(new Date).getTime()):a+("?rnd="+(new Date).getTime()));Crossrider.request({url:a,async:!0},function(d){"success"==d.call?c(d.response):setTimeout(function(){Crossrider.getScript(a,b,c)},6E4)}.bind(this))},saveNewPlugins:function(a,b,c,d,e){DataStore.Plugins.removeAllPlugins(function(){DataStore.Plugins.savePlugins(b,function(){var f=0;for(plugins_type in c)f++;for(plugins_type in c)c[plugins_type].sort(function(a,b){return b.order-a.order}),DataStore.Plugins.savePluginsTypeList(plugins_type,
a,c[plugins_type],function(){--f;if(0===f){for(var j={plugins_list_info:{},plugins_order:[],plugins_version:parseInt(a)},g=0,h=b.length;g<h;++g)j.plugins_list_info[b[g].id]={name:b[g].name,version:b[g].version,code:b[g].code};for(current_plugin_type in c){for(var l=[],g=0,h=c[current_plugin_type].length;g<h;++g)c[current_plugin_type][g].hasOwnProperty("id")&&l.push(c[current_plugin_type][g].id);j.plugins_order[current_plugin_type]=l.reverse().join(",").toString()}d||Crossrider._plugins.plugins_order[PluginTypes.BACKGROUND]!==
j.plugins_order[PluginTypes.BACKGROUND]&&(d=!0);this._onPluginsRead(j,!0);e&&e(!0,d)}}.bind(this))}.bind(this),function(){})}.bind(this))},downloadAndSavePluginsInfo:function(a,b,c,d){function e(a,c,e,s){for(var e={id:a.id,version:a.ver,name:a.name},m=0,n=a.targets.length;m<n;++m)j.hasOwnProperty(a.targets[m].run_at)&&(a.targets[m].run_at==PluginTypes.BACKGROUND&&s&&(h=!0),j[a.targets[m].run_at].push({id:e.id,order:a.targets[m].order,name:e.name}));e.code=c;f.push(e);f.length==g&&Crossrider.saveNewPlugins(b,
f,j,h,d)}var f=[],j={},g=0,h=!1;null===a||0===a.trim().length?DataStore.Plugins.removeAllPlugins(function(){d(!1)}):this.getScript(a,c,function(a){a=JSON.parse(a);if(a.hasOwnProperty("plugins_list")){for(var a=a.plugins_list,b=0;b<PluginTypes.LENGTH;++b)j[b]=[];for(var f=[],b=0,h=a.length;b<h;++b)if(a[b].enabled&&a[b].browsers.ch&&0<a[b].targets.length){for(var m=!1,n=0,t=a[b].targets.length;n<t&&!m;++n)m=j.hasOwnProperty(a[b].targets[n].run_at);m&&f.push(a[b])}a=f;g=a.length;if(0==f.length)d(!0);
else for(var u=this,b=0,h=g;b<h;++b)f=0,this._plugins.plugins_list_info.hasOwnProperty(a[b].id)&&(f=this._plugins.plugins_list_info[a[b].id].version),f<a[b].ver?this.getScript(a[b].url+"?ver="+a[b].ver,c,function(a,b){return function(c){e.apply(u,[a[b],c,a,true])}}(a,b)):e(a[b],this._plugins.plugins_list_info[a[b].id].code,a,!1)}else d(!1)}.bind(this))},_updateAppAndManifest:function(a,b){var c=this._loadRemoteManifest(b);if(!c)return!1;var d=Crossrider.Utils.toInt(this.manifest.ver),e=Crossrider.Utils.toInt(this.manifest.backgroundver),
f=Crossrider.Utils.toInt(this.manifest.pluginsver),j=this._user_script?Crossrider.Utils.toInt(this._user_script.version):0,g=this._bg_script?Crossrider.Utils.toInt(this._bg_script.version):0,h=d>j,l=e>g,r=f>this._plugins.plugins_version,k=this;DataStore.saveManifest(this.appID,c,function(){function c(b){b?setTimeout(function(){self.location.reload(!0)},500):a&&k._getSiteCookies()}function d(a){h&&"string"===typeof p?(k._user_script={value:p,version:k.manifest.ver},k._loadUserScript(),DataStore.saveApp(k.appID,
p,k.manifest.ver,function(){c(a)})):c(a)}function e(a){l&&"string"===typeof q?DataStore.saveBGApp(k.appID,q,k.manifest.backgroundver,function(){k._bg_script={value:q,version:k.manifest.backgroundver};d(!0)}):d(a)}function f(){r?Crossrider.downloadAndSavePluginsInfo(k.manifest.pluginsurl,k.manifest.pluginsver,b,function(a,b){e(b)}):e(!1)}function g(){--o;0==o&&(a||k._reportUpdate(j),f())}if(void 0===localStorage.crx_version||localStorage.crx_version!==k.manifest.version)localStorage.crx_version=k.manifest.version;
var p=null,q=null,o=0;h&&++o;l&&++o;if(0!=o||r)!h&&!l&&r?f():(h&&k.getScript(k.manifest.jslink,b,function(a){p=a;g()}),l&&k.getScript(k.manifest.backgroundjs,b,function(a){q=a;g()}))});return!0},_parseManifestXML:function(a){xDoc=(new DOMParser).parseFromString(a,"text/xml");for(var a=xDoc.getElementsByTagName("CrAppInfo")[0].childNodes,b=0,c=a.length;b<c;b++){var d=a[b];"undefined"!==typeof d&&d&&1===d.nodeType&&(this.manifest[d.nodeName.toLowerCase()]=0<d.childNodes.length?"NA"===d.childNodes[0].nodeValue?
null:d.childNodes[0].nodeValue:null)}this.manifest.updateinterval=this.manifest.hasOwnProperty("updateinterval")?parseInt(this.manifest.updateinterval):this.UPDATE_INTERVAL},_initInternalMessaging:function(){chrome.extension.onRequest.addListener(this._onRequest.bind(this));try{chrome.webRequest&&chrome.webRequest.onBeforeRequest.addListener(this._onBeforeRequest.bind(this),{urls:["<all_urls>"]},["blocking"])}catch(a){}},_onBeforeRequest:function(a){if(0==this._onBeforeRequestUserCallbacksQueue.length||
0!==a.url.indexOf("http")&&0!==a.url.indexOf("file"))return{cancel:!1};"main_frame"==a.type&&(this._tabsUrlsByIds[a.tabId]=a.url);for(var b={},c=!1,d=0,e=this._onBeforeRequestUserCallbacksQueue.length;d<e;++d){try{b=this._onBeforeRequestUserCallbacksQueue[d](a.url,this._tabsUrlsByIds[a.tabId])}catch(f){Crossrider.debug&&alert("appAPI.onRequest Error:\n\n"+f.message);b={};continue}if("undefined"!==typeof b){if(b.hasOwnProperty("redirectTo")&&"string"===typeof b.redirectTo&&0<b.redirectTo.length)return{redirectUrl:b.redirectTo};
b.hasOwnProperty("cancel")&&!0===b.cancel&&(c=!0)}}return{cancel:c}},_onRequest:function(a,b,c){var d=a.action;if(d&&"function"===typeof this[d]){var e=a.params&&"function"===typeof a.params.push?a.params:[];!0===a.passCallback&&e.push(c);("addUserScripts"===d||"getAppData"===d)&&e.push(b.tab);this[d].apply(this,e)}},_loadBackgroundScript:function(){if(this.debug){var a=this.manifest.crossrider.background_script;/^https?\:\/\//.test(a)||(a=chrome.extension.getURL(a));this._bg_script={value:Crossrider.Utils.fetchScript(a),
version:this.manifest.backgroundver}}void 0!==this._bg_script&&(this._bgCode=Crossrider.CodeParser.parse(this._bg_script.value),a="function _cr_crossrider_ready_to_run_the_user_background_code() { \n\n"+DataStore.Plugins.getPluginsCodeByType(PluginTypes.BACKGROUND,this._plugins,this.debug)+"\n\n"+this._bgCode+"\n\n };",Crossrider.Workers.execLocal(a,"background_script"))},_loadUserScript:function(){if(this.debug){Crossrider.Workers.reset();var a=this.manifest.crossrider.user_script;/^https?\:\/\//.test(a)||
(a=chrome.extension.getURL(a));this._parseUserScripts(Crossrider.Utils.fetchScript(a))}else this._parseUserScripts(this._user_script.value)},_parseUserScripts:function(a){this._userCode=Crossrider.CodeParser.reset().parse(a);Crossrider.Workers.types.forEach(function(a){var a=Crossrider.Workers[a],c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];d.code=Crossrider.CodeParser.parse(d.code)}});Crossrider.Workers.start()},addUserScripts:function(a){if(a&&a.id){this.debug&&this._loadUserScript();var b=Crossrider.CodeParser.includes.DOM.css;
a.selected?(void 0===this._cookies[TableNames.USER_COOKIES].mysite&&(this._cookies[TableNames.USER_COOKIES].mysite={}),chrome.tabs.get(a.id,function(a){a&&a.url.indexOf("http")==0&&chrome.tabs.sendRequest(a.id,{action:"initContentScript",passCallback:true,params:[b,JSON.stringify(this._cookies),this._bic]},function(){if(typeof this._userCode=="string"){var b=DataStore.Plugins.getPluginsCodeByType(PluginTypes.APP_CODE,this._plugins,this.debug)+"\n\n"+this._userCode;chrome.tabs.executeScript(a.id,{code:b,
allFrames:Crossrider.manifest.runiniframe==="true"})}}.bind(this))}.bind(this))):this._tabs[a.id]=!0}},getAppData:function(a,b){if(b&&b.id)if(Crossrider._isBgFinishInit)try{a({tabID:b.id,manifest:Crossrider.manifest,_cookies:Crossrider._cookies})}catch(c){if("attempting to use a disconnected port object"!==c.message.toLowerCase())throw c;}else setTimeout(function(){Crossrider.getAppData(a,b)},50)},_onTabSelectionChanged:function(a){this._tabs.hasOwnProperty(a)&&(delete this._tabs[a],this.addUserScripts({id:a,
selected:!0}))},request:function(a,b){return(new XHR({url:a.url,method:a.method,data:a.data,callback:b,async:void 0===a.async?!0:a.async})).send()},openURL:function(a,b){"current"===b?chrome.tabs.getSelected(null,function(b){b&&chrome.tabs.update(b.id,{url:a})}):chrome["tab"===b?"tabs":"windows"].create({url:a})},superAlert:function(a){alert(a)},connect:function(a){null===this._faye.client&&(this._faye.client=new Faye.Client("http://push.crossrider.com:8000/faye",{timeout:120}));"function"===typeof a&&
a()},publish:function(a,b){"string"!==typeof b&&(b=b.hasOwnProperty&&!b.length?JSON.stringify(b):b.toString());this._faye.client.publish(this._getChannelURL(a),b)},subscribe:function(a,b,c,d,e){if("function"===typeof b)return this._faye.callbacks.background[a]||(this._faye.callbacks.background[a]=this._faye.client.subscribe(this._getChannelURL(a),b)),e(),this._faye.callbacks.background[a];b=d?"asyncCallbacks":"callbacks";this._faye[b][c]||(this._faye[b][c]={});this._faye[b][c][a]||(this._faye[b][c][a]=
this._faye.client.subscribe(this._getChannelURL(a),function(b){chrome.tabs.sendRequest(c,{action:"respond",params:[a,b,d]})}));e();return this._faye[b][c][a]},unsubscribe:function(a,b,c){c=c?"asyncCallbacks":"callbacks";this._faye[c][b][a]&&(this._faye[c][b][a].cancel(),delete this._faye[c][b][a])},_unsubscribeAllInTab:function(a){if(this._faye.callbacks[a]){for(var b in this._faye.callbacks[a])this._faye.callbacks[a].hasOwnProperty(b)&&this.unsubscribe(b,a);delete this._faye.callbacks[a]}if(this._faye.asyncCallbacks[a]){for(b in this._faye.asyncCallbacks[a])this._faye.asyncCallbacks[a].hasOwnProperty(b)&&
this.unsubscribe(b,a,!0);delete this._faye.asyncCallbacks[a]}},_getChannelURL:function(a){return["/",(this.debug?"Debug":"")+"app",this.appID,"ZZZ-",a].join("")},getTableName:function(a){for(var b in TableNames)if(0>b.toLowerCase().indexOf("length")&&TableNames[b]===a)return a;return TableNames.USER_COOKIES},updateCookieExpiration:function(a,b,c){c=this.getTableName(c);CookieStore.updateCookieExpiration(a,b,c,function(){this._cookies[c][a].expires=b;this._broadcastAllTabs("updateCookieExpiration",
[a,b,c])}.bind(this))},setCookie:function(a,b,c,d,e,f){d=this.getTableName(d);if("mysite"!==a){var j=(new Date).getTime(),c=(new Date(c)).getTime();j>c?this._cookies[d][a]&&this.unsetCookie(a,d):CookieStore.setCookie(a,b,c,d,function(){this._cookies[d][a]={value:b,expires:c};this._broadcastAllTabs("updateCookie",[a,this._cookies[d][a],d],e);f&&f()}.bind(this),function(){this._broadcastAllTabs("unsetCookie",[a,d])}.bind(this))}},removeExpiredCookies:function(a){a=this.getTableName(a);CookieStore.removeExpiredCookies(a,
function(b){if(0<b.length){for(var c=0;c<b.length;++c){var d=b[c];0<=b.indexOf(d)&&this._cookies[a].hasOwnProperty(d)&&delete this._cookies[a][d]}this._broadcastAllTabs("removeExpiredCookies",[a,b])}}.bind(this))},unsetCookie:function(a,b,c){b=this.getTableName(b);this._cookies[b][a]&&CookieStore.unsetCookie(a,b,function(){c&&c();delete this._cookies[b][a];this._broadcastAllTabs("unsetCookie",[a,b])}.bind(this))},removeAllCookies:function(a){a=this.getTableName(a);CookieStore.clearData(a,!0);this._broadcastAllTabs("removeAllCookies",
[a])},setRealCookie:function(a,b,c){if(void 0!==this.manifest.domain&&null!==this.manifest.domain){var d=(new Date).getTime(),c=c?(new Date(c)).getTime():null;null!==c&&d>c?this._cookies[TableNames.USER_COOKIES].mysite[a]&&this.unsetRealCookie(a):(d=this.manifest.domain,0!=d.indexOf("http")&&(d="http://"+d),null!==c?chrome.cookies.set({url:d,name:a,value:b,expirationDate:Math.round(c/1E3),path:"/"}):chrome.cookies.set({url:d,name:a,value:b,path:"/"}),this._cookies[TableNames.USER_COOKIES].mysite[a]=
{value:b,expires:c})}},unsetRealCookie:function(a){if(void 0!==this.manifest.domain&&null!==this.manifest.domain&&this._cookies[TableNames.USER_COOKIES].mysite[a]){var b=this.manifest.domain;0!=b.indexOf("http")&&(b="http://"+b);chrome.cookies.remove({url:b,name:a});delete this._cookies[TableNames.USER_COOKIES].mysite[a]}},_onCookieChange:function(a){if(!(void 0===this.manifest.domain||null===this.manifest.domain||0>a.cookie.domain.indexOf(this.manifest.domain)))if(a.removed)void 0!==this._cookies[TableNames.USER_COOKIES].mysite[a.cookie.name]&&
delete this._cookies[TableNames.USER_COOKIES].mysite[a.cookie.name];else{var b=a.cookie.expirationDate?1E3*a.cookie.expirationDate:null,c=(new Date).getTime();if(null!==b&&c>b||a.cookie.session)b=null;this._cookies[TableNames.USER_COOKIES].mysite[a.cookie.name]={value:a.cookie.value,expires:b}}},_broadcastAllTabs:function(a,b,c,d){chrome.windows.getAll({populate:!0},function(e){e.forEach(function(e){e.tabs.forEach(function(e){(d||void 0===c||void 0!==c&&c!==e.id)&&chrome.tabs.sendRequest(e.id,{action:a,
params:b})})})});window.appAPI[a].apply(appAPI,b)},message:function(a,b,c){switch(a){case "active":chrome.tabs.getSelected(null,function(a){a&&0===a.url.indexOf("http")&&chrome.tabs.sendRequest(a.id,{action:"handleMessage",params:[b]})});break;case "all":chrome.windows.getAll({populate:!0},function(a){a.forEach(function(a){a.tabs.forEach(function(a){a&&chrome.tabs.sendRequest(a.id,{action:"handleMessage",params:[b]})})})});break;case "to_tab":chrome.tabs.get(c,function(a){a&&0===a.url.indexOf("http")&&
chrome.tabs.sendRequest(a.id,{action:"handleMessage",params:[b]})});break;case "background":window.appAPI.message.call(b)}},setBadgeText:function(a){chrome.browserAction.setBadgeText({text:a})},setBadgeBackgroundColor:function(a){chrome.browserAction.setBadgeBackgroundColor({color:a})},setIcon:function(a){var b="number"===typeof a&&(isNaN(a)||1>a||5<a),c="string"===typeof a&&0==a.length;if("undefined"===typeof a||b||c)a="icon1";if("number"===typeof a)a=chrome.extension.getURL("icons/actions/"+a+".png"),
chrome.browserAction.setIcon({path:a});else if("string"===typeof a){var d=document.createElement("canvas"),e=d.getContext("2d"),f=new Image;f.src=a;f.onload=function(){d.width=19;d.height=19;(19<f.width||19<f.height)&&e.scale(19/f.width,19/f.height);e.drawImage(f,0,0);var a=e.getImageData(0,0,d.width,d.height);chrome.browserAction.setIcon({imageData:a})}}},enablePopup:function(){chrome.browserAction.setPopup({popup:"popup.html"})},disablePopup:function(){chrome.browserAction.setPopup({popup:""})},
setTitle:function(a){chrome.browserAction.setTitle({title:a})},setToolbarUniqueID:function(a){localStorage.bic?(this._bic=localStorage.bic,"function"===typeof a?a(this._bic):this._initAppAPI()):chrome.cookies.get({url:"http://www.crossrider.com",name:"bic"},function(b){b&&b.value?localStorage.bic=this._bic=b.value:(localStorage.bic=this._bic=Crossrider.Utils.getUID(),b=new Date((new Date).getTime()+31536E7),chrome.cookies.set({url:"http://www.crossrider.com",domain:"www.crossrider.com",name:"bic",
value:this._bic,path:"/",expirationDate:b.getTime()}),this._reportFirstInstall());"function"===typeof a?a(this._bic):this._initAppAPI()}.bind(this))},getAppID:function(a){a(this.appID)},_showThankyouPage:function(){var a=!1;this._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallationThankYouPage")&&this._cookies[TableNames.USER_COOKIES].InstallationThankYouPage.value&&(a=!0);this.manifest.thanksurl&&this._firstLoad&&!a&&chrome.tabs.create({url:this.manifest.thanksurl},function(){})},_checkNextUpdate:function(){if(!Crossrider.isDuringUpdate){var a=
(new Date).getTime(),b=parseInt(localStorage.nextUpdate||a+6E4*this.manifest.updateinterval);localStorage.nextUpdate||(localStorage.nextUpdate=b);a>=b&&(Crossrider.clearExpiredCookies(),this._dailyCron())}},clearExpiredCookies:function(){Crossrider.removeExpiredCookies(TableNames.USER_COOKIES);Crossrider.removeExpiredCookies(TableNames.INTERNAL_DB)},_dailyCron:function(a){Crossrider.isDuringUpdate=!0;this._updateAppAndManifest(!1,a)?(Crossrider.isDuringUpdate=!1,Crossrider._sendDailyStats(),localStorage.nextUpdate=
(new Date).getTime()+6E4*this.manifest.updateinterval):setTimeout(function(){Crossrider._dailyCron(a)},6E4)},_sendDailyStats:function(){this._sendPixel("stats.gif?action=daily&"+this._getSharedQueryStringParametersForStats())},_reportFirstInstall:function(){this._sendPixel("install.gif?"+this._getSharedQueryStringParametersForStats())},_reportError:function(a){try{this.debug||this._sendPixel("ch-error.gif?"+this._getSharedQueryStringParametersForStats()+"&"+a)}catch(b){Crossrider.Utils.internalDebug("_reportError Error : "+
b.message)}},_reportInstall:function(){this._sendPixel("apps.gif?action=install&"+this._getSharedQueryStringParametersForStats())},_reportUninstall:function(){this._sendPixel("apps.gif?action=uninstall&"+this._getSharedQueryStringParametersForStats())},_reportUpdate:function(a){this._sendPixel("apps.gif?action=update&"+this._getSharedQueryStringParametersForStats()+"&oldver="+a)},_getSharedQueryStringParametersForStats:function(){try{var a=this.manifest.version.split("."),b=[a[0],a[1]].join("."),
c=this.manifest.ver,d=Math.round((new Date).getTime()/1E3),e=Math.round((new Date).getTime()/1E3);this._isBgFinishInit&&this._cookies&&(this._cookies[TableNames.USER_COOKIES].hasOwnProperty("InstallationTime")?e=this._cookies[TableNames.USER_COOKIES].InstallationTime.value:this._setInstallationTime(e));return"browser=chrome&ver="+b+"&bic="+this._bic+"&app="+this.appID+"&appver="+c+"&installtime="+e+"&curtime="+d+"&lifetime="+(d-e)}catch(f){Crossrider.Utils.internalDebug("_getSharedQueryStringParametersForStats Error : "+
f.message)}return""},_sendPixel:function(a){try{if(!Crossrider.debug){var b="http://stats.crossrider.com/";Crossrider.isStaging&&(b="http://staging.crossrider.com/");var b=b+a,c=document.getElementsByTagName("body")[0],d=document.createElement("img");d.src=b;d.onload=function(){c.removeChild(this)};c.appendChild(d)}}catch(e){Crossrider.Utils.internalDebug("_sendPixel Error : "+e.message)}},notification:function(a,b,c,d,e){c=c||chrome.extension.getURL("icons/notifications/icon1.png");a=webkitNotifications.createNotification(c,
a,b);this._notifications[d]=a;this.setNotificationEvents(a,d,e);a.show()},htmlNotification:function(a,b,c){a=webkitNotifications.createHTMLNotification(a);this._notifications[b]=a;this.setNotificationEvents(a,b,c);a.show()},hideNotification:function(a){(a=this._notifications[a])&&a.cancel()},setNotificationEvents:function(a,b,c){a.addEventListener("display",function(){c?chrome.tabs.sendRequest(c,{action:"handleNotificationEvent",params:["ondisplay",b]}):appAPI.handleNotificationEvent("ondisplay",
b)});a.addEventListener("close",function(){c?chrome.tabs.sendRequest(c,{action:"handleNotificationEvent",params:["onclose",b]}):appAPI.handleNotificationEvent("onclose",b);this._notifications[b]&&delete this._notifications[b]}.bind(this));a.addEventListener("error",function(){c?chrome.tabs.sendRequest(c,{action:"handleNotificationEvent",params:["onerror",b]}):appAPI.handleNotificationEvent("onerror",b)})},reload:function(){self.location.reload()},Workers:{DOM:{},BG:{},timers:{BG:null,DOM:null},_storage:{BG:{},
DOM:{}},types:["BG","DOM"],start:function(){this._getStoredRunTimes();this._cleanUp();this.types.forEach(function(a){this.timers[a]=this._run.periodical(6E4,this,[a])}.bind(this))},_run:function(a){var b=(new Date).getTime(),c;for(c in this[a])if(this[a].hasOwnProperty(c)){var d=this[a][c];0===d.last_run&&(d.last_run=b);if(b-d.last_run>=6E4*d.interval||0===b-d.last_run){this["DOM"===a?"_exec":"execLocal"](d.code,d.name);var e=(new Date).getTime();d.last_run=e;this._setLastRunTime(a,c,e)}}},_exec:function(a){chrome.tabs.getSelected(null,
function(b){b&&0===b.url.indexOf("http")&&"string"===typeof a&&0<a.length&&chrome.tabs.executeScript(b.id,{code:a})})},execLocal:function(a,b){var c=document.getElementsByTagName("body")[0],d=document.getElementById("bg_worker_"+b);d&&c.removeChild(d);d=document.createElement("script");d.setAttribute("type","text/javascript");d.innerHTML=a;c.appendChild(d)},reset:function(){this.types.forEach(function(a){null!==this.timers[a]&&clearInterval(this.timers[a]);for(var b in this[a])this[a].hasOwnProperty(b)&&
delete this[a][b]}.bind(this));this._storage={BG:{},DOM:{}};localStorage.workers=JSON.stringify(this._storage)},updateWorkers:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(void 0!==this[a][c]?(this[a][c].interval=b[c].interval,this[a][c].code=b[c].code):this[a][c]=b[c])},_cleanUp:function(){this.types.forEach(function(a){var b=Crossrider.CodeParser.worker_names[a],c;for(c in this[a])-1===b.indexOf(c)&&(this[a].hasOwnProperty(c)&&delete this[a][c],this._storage[a].hasOwnProperty(c)&&delete this._storage[a][c])}.bind(this));
localStorage.workers=JSON.stringify(this._storage)},_getStoredRunTimes:function(){var a=localStorage.workers;void 0!==a&&(this._storage=JSON.parse(a));this.types.forEach(function(a){for(var c in this._storage[a])if(this._storage[a].hasOwnProperty(c)&&this[a].hasOwnProperty(c))this[a].last_run=this._storage[a].last_run}.bind(this))},_setLastRunTime:function(a,b,c){this._storage[a][b]={last_run:c};localStorage.workers=JSON.stringify(this._storage)}},CodeParser:{includes:{BG:{js:[],css:[]},DOM:{js:[],
css:[]}},worker_names:{BG:[],DOM:[]},reset:function(){this.includes={BG:{js:[],css:[]},DOM:{js:[],css:[]}};this.worker_names={BG:[],DOM:[]};return this},parse:function(a,b){var c=this._parseWorkers(a,"dom_worker","DOM"),c=this._parseWorkers(c,"bg_worker","BG");return c=this._parseIncludes(c,b||"DOM")},_parseWorkers:function(a,b,c){if("string"===typeof a){var d={},a=a.replace(/\r/gi,""),e=a.match(RegExp("(^|\\n)@"+b+"\\s+\\w+\\s+\\d+\\s*\\n(\\n|.)*?@worker_end(\\n|$|\\s*?)","gi")),f;for(f in e){var j=
e[f],g=RegExp("@"+b+"\\s+\\w+\\s+\\d+\\s*\\n((.|\\n)*)\\n@worker_end(\\n|$|\\s*)"),h=j.match(RegExp("@"+b+"\\s+(\\w+)\\s+(\\d+)\\s*")),l=h[1];this.worker_names[c].push(l);h=h[2];g="bg_worker"===c?j.match(g)[1]:"(function(){\n"+j.match(g)[1]+"\n})()";d[l]={name:l,interval:h,code:g,last_run:0};l="";g=j.split("\n");h=g.length;""==g[g.length-1]&&h--;for(i=0;i<h;i++)l+="\n";a=a.replace(j,l);"bg_worker"===c&&(a=a.replace(/\s*appAPI\.callPageFunction\([^\)]+\)[\r\n;]?/gi,""))}Crossrider.Workers.updateWorkers(c,
d);return a}return""},_parseIncludes:function(a,b){var c=a.replace(/\r/gi,""),d=[],e=c.match(/^\s*@include\s*?["'](https?:\/\/(.*?))["']\s*?(iframe)?\s*$/gim),f=[],j;for(j in e){var g=e[j],h=g.match(/(https?\:\/\/.*)['"]/)[1];if(0>this.includes[b].js.indexOf(h)&&0>this.includes[b].css.indexOf(h)){var l=g.match(/\.*\.(css|js)/)[1];"js"===l&&f.push(h);this.includes[b][l].push(h)}h=RegExp("^"+g.replace("?","\\?").replace(".","\\."),"gim");c=c.replace(h,"")}e=0;for(j=f.length;e<j;e++)h=f[e],h=Crossrider.Utils.fetchScript(h),
d.push(this.parse(h,b));return d.join("\n")+c}},Utils:{fetchScript:function(a,b){if(void 0!==Crossrider.manifest.ver||Crossrider.debug)var c=Crossrider.debug?(new Date).getTime():Crossrider.manifest.ver,a=a+((0>a.indexOf("?")?"?":"&")+"crossriderVer="+c);return Crossrider.request({url:a,method:"get",async:!1,type:b})},internalDebug:function(){try{var a="["+(new Date).toDateString()+" "+(new Date).toLocaleTimeString()+"] ["+[Crossrider.manifest.version,Crossrider.manifest.ver].join(".")+"] ";0!=arguments.length&&
(1==arguments.length&&("string"==typeof arguments[0]||"number"==typeof arguments[0]||"boolean"==typeof arguments[0])?console.log(a+" "+arguments[0].toString()):console.log(a,arguments))}catch(b){Crossrider.debug&&console.log("Crossrider.Utils.internalDebug error >> "+b.message)}},getUID:function(){for(var a=(new Date).getTime().toString(16),b=[],c=0;c<32-a.length;c++)b[c]="0123456789abcdef".substr(Math.floor(16*Math.random()),1);return a+b.join("")},toInt:function(a){return"NA"===a||void 0===a?0:
parseInt(a.replace(/\./g,""))}}};