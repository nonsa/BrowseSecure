var AsyncAPI={_dom:{},_responseQueue:[],_responseQueueBusy:!1,init:function(a){this._api=a;window.addEventListener("message",this._handlePageFunction.bind(this),!1);this._dom.body=document.getElementsByTagName("body")[0];return this},_handlePageFunction:function(a){var c=a.origin,b=a.data;if(!(void 0!==this._api.manifest.domain&&0>c.indexOf(this._api.manifest.domain)||"asyncAPI"!==b.caller||b.appID!==this._api.appID)){var a=b.action.split("."),d,e;1===a.length?(d=this._api[a[0]],e=this._api):2===
a.length&&(d=this._api[a[0]][a[1]],e=this._api[a[0]]);"function"===typeof d&&("fbAPI"==a[0]||"push.subscribe"===b.action?(a=function(){for(var a=[b.action],c=0;c<arguments.length;c++)a.push(arguments[c]);this.sendResponse(a,b.iframe,b.ts)}.bind(this),b.params.push(a),"push.subscribe"===b.action&&b.params.push(!0),d.apply(e,b.params)):"cookie.get"===b.action||"db.setFromRemote"===b.action||"request.get"===b.action||"request.post"===b.action?(a=function(a){this.sendResponse([b.action,true,a],b.iframe,
b.ts)}.bind(this),b.params.push(a),a=function(a){this.sendResponse([b.action,false,a],b.iframe,b.ts)}.bind(this),b.params.push(a),d.apply(e,b.params)):("push.unsubscribe"===b.action&&b.params.push(!0),d=d.apply(e,b.params),this.sendResponse([b.action,d],b.iframe,b.ts)))}},sendResponse:function(a,c,b){if("QUEUE"!==a&&(this._responseQueue.push({args:a,iframe:c,ts:b}),this._responseQueueBusy))return;0<this._responseQueue.length?(this._responseQueueBusy=!0,a=this._responseQueue.shift(),c=a.args[0].replace(/\./g,
"_"),this._createResponseElement(c,a.ts).value=JSON.stringify({args:a.args}),!0===a.iframe?this._api.dom.callPageFunction("callCrossriderAsyncApi"+this._api.appID,c,a.ts):this._api.dom.callPageFunction("crossrider.AsyncAPI.onPageResponse",c,a.ts),setTimeout(this.sendResponse.bind(this),10,"QUEUE")):this._responseQueueBusy=!1},setTargetIframe:function(a){var c=document.createElement("script");c.type="text/javascript";c.innerHTML="function callCrossriderAsyncApi"+this._api.appID+'(action,ts){var el = document.getElementById("crossrider-response-element-'+
this._api.appID+'"+action+ts); var response = JSON.parse(el.value); el.parentNode.removeChild(el); document.getElementById("'+a+'").contentWindow.postMessage({caller:"asyncAPIResponse", appID:'+this._api.appID+', args:response.args, ts:ts},"*");}';this._dom.body.appendChild(c)},_createResponseElement:function(a,c){var b=document.createElement("textarea");b.id="crossrider-response-element-"+this._api.appID+a+c;b.style.display="none";this._dom.body.appendChild(b);return b}};