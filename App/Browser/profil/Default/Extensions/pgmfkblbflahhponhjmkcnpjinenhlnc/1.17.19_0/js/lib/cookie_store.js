var TableNames={USER_COOKIES:"cookies",INTERNAL_DB:"internaldb",TableNames_LENGTH:2},CookieStore={_db:null,init:function(a,b,d){b||(b=[TableNames.USER_COOKIES]);this._db=openDatabase("crossrider_cookies_"+a,1,"Crossrider Cookies Store",52428800);for(var c=b.length,a=0;a<b.length;++a)(function(a,b,g){a.transaction(function(h){h.executeSql("create table if not exists "+g[b]+"(name varchar(255) primary key, value longtext, created_at datetime default (datetime('now','localtime')), expires datetime)",
[],function(){a.transaction(function(a){a.executeSql("delete from "+g[b]+" where datetime(expires) < datetime('now')",[],function(){c--;0==c&&d()},function(){Crossrider.Utils.internalDebug("removing expired cookies on init",arguments)})})},function(){Crossrider.Utils.internalDebug("crate tables on init",arguments)})})})(this._db,a,b)},getTableName:function(a){for(var b in TableNames)if(0>b.toLowerCase().indexOf("length")&&TableNames[b]===a)return a;return TableNames.USER_COOKIES},getCookies:function(a,
b){var d={},c="",f=0;b||(b=[TableNames.USER_COOKIES]);for(var e=0;e<b.length;++e)c=b[e],this._db.transaction(function(c,e){return function(k){k.executeSql("select name,value,expires from "+c+" where datetime(expires) >= datetime('now')",[],function(k,l){for(var m={},i=0;i<l.rows.length;i++){var j=l.rows.item(i),n=JSON.parse(j.value);m[j.name]={value:n.value,expires:e._formatDateFromDateTime(j.expires)}}d[c]=m;f++;f==b.length&&a&&a(d)}.bind(this),function(){Crossrider.Utils.internalDebug("getCookies error, table name:"+
c,arguments)})}}(c,this))},setCookie:function(a,b,d,c,f){c=this.getTableName(c);this._db.transaction(function(e){var g=this._formatDateTimeFromDate(d),h=JSON.stringify({value:b});e.executeSql("replace into "+c+" (name,value,expires) values(?,?,?)",[a,h,g],f,function(){Crossrider.Utils.internalDebug(c+" set failed",arguments)})}.bind(this))},updateCookieExpiration:function(a,b,d,c){d=this.getTableName(d);this._db.transaction(function(f){var e=this._formatDateTimeFromDate(b);f.executeSql("update "+
d+" set expires == ? where name == ?",[e,a],c,function(){Crossrider.Utils.internalDebug(d+" update cookie expiration failed",arguments)})}.bind(this))},unsetCookie:function(a,b,d){b=this.getTableName(b);this._db.transaction(function(c){c.executeSql("delete from "+b+" where name = ?",[a],d,function(){Crossrider.Utils.internalDebug(b+" unset failed",arguments)})})},removeExpiredCookies:function(a,b){a=this.getTableName(a);this._db.transaction(function(d){d.executeSql("select * from "+a+" where datetime(expires) < datetime('now', 'localtime')",
[],function(c,f){if(0==f.rows.length)b([]);else{for(var e=[],g=0;g<f.rows.length;g++)e.push(f.rows.item(g).name);d.executeSql("delete from "+a+" where datetime(expires) < datetime('now', 'localtime')",[],function(){b(e)},function(){Crossrider.Utils.internalDebug("deleting expired "+a+" failed",arguments)})}},function(){Crossrider.Utils.internalDebug("fetching expired "+a+" failed",arguments)})})},clearData:function(a,b){var a=this.getTableName(a),d=b?"delete from ":"drop table ";this._db.transaction(function(b){b.executeSql(d+
a,[],function(){},function(){Crossrider.Utils.internalDebug(a+" clearing failed",arguments)})})},_formatDateTimeFromDate:function(a){var a=new Date(a),b=a.getMonth()+1,d=a.getDate(),c=a.getHours(),f=a.getMinutes(),e=a.getSeconds();10>b&&(b="0"+b.toString());10>d&&(d="0"+d.toString());10>c&&(c="0"+c.toString());10>f&&(f="0"+f.toString());10>e&&(e="0"+e.toString());return[[a.getFullYear(),b,d].join("-"),[c,f,e].join(":")].join(" ")},_formatDateFromDateTime:function(a){var b=a.split(" "),a=b[0].split("-"),
b=b[1].split(":");return(new Date(a[0],parseInt(a[1])-1,a[2],b[0],b[1],b[2])).getTime()}};