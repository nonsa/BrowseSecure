var DataStore={_db:null,init:function(a,b){this.Plugins=Plugins;this._db=openDatabase("crossrider_data_"+a,1,"Crossrider Data Store",20971520);this.Plugins.init(this._db,a,function(){this._db.transaction(function(a){a.executeSql("create table if not exists extension_code(data_type varchar(255) primary key, value longtext, app_id integer, version varchar(10), updated_at datetime default (datetime('now','localtime')))",[],function(){b()},function(){Crossrider.Utils.internalDebug("extension_code table create error",
arguments)})})}.bind(this))},getData:function(a,b){this._db.transaction(function(c){c.executeSql("select data_type,value,version from extension_code where app_id = ?",[a],function(a,c){for(var e={},g=0;g<c.rows.length;g++){var h=c.rows.item(g);e[h.data_type]={value:h.value,version:h.version}}b(e,!1)}.bind(this),function(){Crossrider.Utils.internalDebug("data load error",arguments)})}.bind(this))},saveApp:function(a,b,c,d){this._db.transaction(function(f){f.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, 'app',?,?,datetime('now'))",
[a,b,c],function(){"function"===typeof d&&d()},function(){Crossrider.Utils.internalDebug("app save error",arguments)})})},saveBGApp:function(a,b,c,d){this._db.transaction(function(f){f.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, 'bg_script',?,?,datetime('now'))",[a,b,c],function(){"function"===typeof d&&d()},function(){Crossrider.Utils.internalDebug("bg script save error",arguments)})})},saveManifest:function(a,b,c){this._db.transaction(function(d){d.executeSql("replace into extension_code (app_id, data_type, value, updated_at) values(?, 'manifest',?,datetime('now'))",
[a,b],function(){"function"===typeof c&&c()},function(){Crossrider.Utils.internalDebug("manifest save error",arguments)})})},clearData:function(){this._db.transaction(function(a){a.executeSql("drop table extension_code",[],function(){},function(){Crossrider.Utils.internalDebug("extension data clear error",arguments)})})}},PluginTypes={BACKGROUND:0,APP_CODE:1,LENGTH:2},Plugins={_db:null,_appID:-1,init:function(a,b,c){this._appID=b;this._db=a;this._db.transaction(function(a){a.executeSql("create table if not exists plugins(id integer primary key, name varchar(255), code longtext, version integer)",
[],function(){c()},function(){Crossrider.Utils.internalDebug("plugins table create error",arguments)})})},getData:function(a){this.getPlugins(function(b){var c={plugins_list_info:b,plugins_order:[],plugins_version:0};this._db.transaction(function(b){for(var f=[],e=0;e<PluginTypes.LENGTH;++e)f.push("plugins_"+e);b.executeSql("select data_type,value,version from extension_code where data_type in ('"+f.join("','")+"') and app_id = ?",[this._appID],function(b,d){for(var e="",f=0,k=d.rows.length;f<k;++f)e=
d.rows.item(f).data_type.replace("plugins_",""),e=parseInt(e),c.plugins_order[e]=d.rows.item(f).value;0<d.rows.length&&(c.plugins_version=parseInt(d.rows.item(0).version));a(c)}.bind(this),function(){Crossrider.Utils.internalDebug("Plugins.getData error",arguments)})}.bind(this))}.bind(this))},getPlugins:function(a){this._db.transaction(function(b){b.executeSql("select * from plugins",[],function(b,d){for(var f={},e=0;e<d.rows.length;e++){var g=d.rows.item(e);f[g.id]={name:g.name,version:g.version,
code:g.code}}a(f)}.bind(this),function(){Crossrider.Utils.internalDebug("getPlugins error",arguments)})}.bind(this))},getPluginsCodeByType:function(a,b,c){var d="object"===typeof b&&b.hasOwnProperty("plugins_order")&&b.hasOwnProperty("plugins_list_info");if("number"===typeof a&&d){a=b.plugins_order[a].split(",");plugins_code="";plugin_id=-1;for(var d=0,f=a.length;d<f;++d){plugin_id=parseInt(a[d]);if(!b.plugins_list_info.hasOwnProperty(plugin_id))return"";var e=plugins_code,g;g=plugin_id;var h=b.plugins_list_info[plugin_id];
if(c){var j="plugin"+g+"_exception",i=[];i.push("//Plugin "+h.name+"\n");i.push("try { \n\n");i.push(h.code);i.push("\n\n}catch("+j+"){ \n");i.push("alert('Error in Plugin:"+h.name+" (Id:"+g+", version: "+h.version+")\\n' + "+j+".message);");i.push("} \n\n");g=i.join("")}else g=h.code;plugins_code=e+(g+"\n\n")}return plugins_code}return""},removeAllPlugins:function(a){this._db.transaction(function(b){b.executeSql("delete from plugins",[],function(b){b.executeSql("delete from extension_code where data_type LIKE 'plugins_%' and app_id = ?",
[this._appID],function(){a()}.bind(this),function(){Crossrider.Utils.internalDebug("deleting plugins_list error",arguments)}.bind(this))}.bind(this),function(){Crossrider.Utils.internalDebug("deleting plugins table error",arguments)})}.bind(this))},savePluginsTypeList:function(a,b,c,d){for(var f=[],e=0,g=c.length;e<g;++e)c[e].hasOwnProperty("id")&&f.push(c[e].id);var h=f.reverse().join(",").toString();this._db.transaction(function(c){c.executeSql("replace into extension_code (app_id, data_type, value, version, updated_at) values(?, ?, ?,?,datetime('now'))",
[this._appID,"plugins_"+a,h,b],function(){d()}.bind(this),function(){Crossrider.Utils.internalDebug("failed to save plugins list",arguments)}.bind(this))}.bind(this))},savePlugins:function(a,b,c){for(var d=0,f=this,e=!1,g={},h=0,j=a.length;h<j&&!e;++h)f._db.transaction(function(a,h){return function(f){g=h[a];f.executeSql("replace into plugins(id, name, code, version) values(?, ?, ?, ?)",[g.id,g.name,g.code,g.version],function(){++d;b&&d==h.length&&b()}.bind(this),function(){Crossrider.Utils.internalDebug("failed to save plugin "+
g.name,arguments);c();e=!0}.bind(this))}.bind(f)}(h,a))}};