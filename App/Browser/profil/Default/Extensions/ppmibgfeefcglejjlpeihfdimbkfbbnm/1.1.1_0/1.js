// laobubu.net

var logmode=false;var logdata='';var configs=[{name:'User-Agent',descript:chrome.i18n.getMessage("ua_des"),value:'@AUTO',data:'FireFox 6.0=Mozilla/5.0 (Windows NT 5.1; rv:6.0.2) Gecko/20100101 Firefox/6.0.2\n'+'IE8(Windows XP)=Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0; CIBA; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.4506.2152; .NET CLR 3.5.30729)\n'+'IE6=Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\n'+'Mac Safari 4=Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_5_8; en-us) AppleWebKit/531.21.8 (KHTML, like Gecko) Version/4.0.4 Safari/5\n'+'Google Bot=Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\n'+'iPhone 3.0=Mozilla/5.0 (iPhone; U; CPU iPhone OS 3_0 like Mac OS X; en-us) AppleWebKit/528.18 (KHTML, like Gecko) Version/4.0 Mobile/7A341 Safari/528.16\n'+'iPhone 4S=Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_0 like Mac OS X; en-us) AppleWebKit/532.9 (KHTML, like Gecko) Version/4.0.5 Mobile/8A293 Safari/6531.22.7\n'+'Nokia C5-00(S60v3)=Mozilla/5.0 (SymbianOS/9.3; Series60/3.2 NokiaC5-00/032.010; Profile/MIDP-2.1 Configuration/CLDC-1.1 ) AppleWebKit/525 (KHTML, like Gecko ) Version/3.0 BrowserNG/7.2.6.2 3gpp-gba\n'+'HTC Legend(Android)=Mozilla/5.0 (Linux; U; Android 2.2; zh-cn; HTC Legend Build/FRF91) AppleWebKit/533.1 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.1\n'+'iPad=Mozilla/5.0 (iPad; U; CPU OS 3_2 like Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) Version/4.0.4 Mobile/7B334b Safari/531.21.10\n',auto:[{name:'Test If It Works',matches:[{what:'url',text:'http://lab.laobubu.net/chromeheaderedit/test.php',mode:'equal'}],value:'Laobubu/1.0 (HTTP Request Header Editor; zh-cn)Version/3.0'}]}];var t2=r('lche_config');if(t2!=null){configs=t2;}else{w('lche_config',configs);window.open('welcome.html');}
delete t2;function r(id){try{return JSON.parse(localStorage[id]);}catch(e){}return null;}
function w(id,d){localStorage[id]=JSON.stringify(d);}
function callback1(details){if(details.url.indexOf('http')!=0)return{};var s=details.requestHeaders;for(var iA=0;iA<configs.length;iA++){var i=configs[iA];if(i.value=='@AUTO'){if(i.auto.length>0){autoloop:for(var aiA=0;aiA<i.auto.length;aiA++){var ai=i.auto[aiA];var marchworked=0;var pass1=true,ignore=false;for(var aiiA=0;aiiA<ai.matches.length;aiiA++){var aii=ai.matches[aiiA];if(!udf(aii.enabled,true))continue;marchworked++;var aiim;switch(aii.what){case'url':aiim=details.url;break;case'referer':aiim=finda(s,'referer');if(aiim>=s.length)ignore=true;else aiim=s[aiim].value;break;default:ignore=true;}
if(ignore)break;aix1=aii.mode;if((aix1.length>1)&(aix1[0]=="!"))aix1=aix1.substring(1);switch(aix1){case'equal':pass1=pass1&(aii.text==aiim);break;case'iequal':pass1=pass1&(aii.text.toLowerCase()==aiim.toLowerCase());break;case'include':pass1=pass1&(aiim.indexOf(aii.text)>=0);break;case'iinclude':pass1=pass1&(aiim.toLowerCase().indexOf(aii.text.toLowerCase())>=0);break;case'regex':pass1=pass1&(aiim.match(aii.text)!=null);break;default:pass1=false;break;}
if(aii.mode!=aix1)pass1=!pass1;}
if(marchworked==0)continue;if(pass1&!ignore){if(ai.value=='@DEFAULT')break;var ii1=finda(s,i.name);if(ii1>=s.length)s[ii1]={};s[ii1].name=i.name;s[ii1].value=ai.value;if(ai.value=='@DELETE')delete s[ii1];else if(ai.value=='@BLANK')s[ii1].value='';break autoloop;}}}}else if(i.value!=='@DEFAULT'){var ii1=finda(s,i.name);if(ii1>=s.length)s[ii1]={};s[ii1].name=i.name;s[ii1].value=i.value;if(i.value=='@DELETE')delete s[ii1];else if(i.value=='@BLANK')s[ii1].value='';}}
r=[];for(var i=0;i<s.length;i++){if(typeof(s[i])!='undefined')r[r.length]=s[i];}
if(logmode){logdata+="\n\n\n==================================\n"+new Date()+"\n"+details.url+"\n==================================";for(var i=0;i<r.length;i++){logdata+="\n"+r[i].name+": "+r[i].value;}}
var trtn={requestHeaders:r};return trtn;}
function udf(v,def){if(typeof v=="undefined")return def;return v;}
function finda(arr,name){var i=0;for(;i<arr.length;i++){try{if(arr[i].name.toLowerCase()==name.toLowerCase())return i;}catch(e){}}
return i;}
chrome.webRequest.onBeforeSendHeaders.addListener(callback1,{urls:['http://*/*','https://*/*']},["requestHeaders","blocking"]);function flashboy(){if(!logmode)return;flashing=!flashing;chrome.browserAction.setBadgeText({text:(flashing)?'REC':''});setTimeout(flashboy,500);}
var flashing=false;chrome.extension.onRequest.addListener(function(request,sender,sendResponse){if(request.action=="load_config"){sendResponse({data:configs});}else if(request.action=="ua_query"){var newua=callback1({url:request.url,requestHeaders:[{name:'User-Agent',value:request.ua}]}).requestHeaders[0].value;sendResponse({newua:newua});}else if(request.action=="logmode_query"){sendResponse({data:logmode});}else if(request.action=="logmode"){logmode=request.logmode;chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,100]});chrome.browserAction.setBadgeText({text:''});if(logmode){logdata='';flashboy();}
sendResponse({msg:logmode});}else if(request.action=="logclean"){logdata='';sendResponse({msg:true});}else if(request.action=="logget"){sendResponse({msg:(logmode?logdata:null)});}else if(request.action=="save_config1"){var ct1=configs;configs=request.data;for(var i=0;i<ct1.length;i++){var j=finda(configs,ct1[i].name);if(j<configs.length){configs[j].value=ct1[i].value;}}
w('lche_config',configs);sendResponse({msg:chrome.i18n.getMessage("success")+" :)"});}else if(request.action=="update_someone"){configs[finda(configs,request.name)].value=request.value;w('lche_config',configs);sendResponse({msg:chrome.i18n.getMessage("success")+" :)"});}else if(request.action=="rawdestoryself"){localStorage.clear();if(confirm('RELOAD SYSTEM(Will use original config. file)?')){location.reload()}
window.open('chrome://settings/extensions');alert("I've died :(");sendResponse({msg:"I've died :("});}});